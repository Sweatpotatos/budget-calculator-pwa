/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={94:(e,t,n)=>{n.d(t,{gS:()=>Xg,rJ:()=>cg,db:()=>Zg,kd:()=>Wg,H9:()=>ug,GG:()=>Hg,aQ:()=>Yg,BN:()=>Qg});const s=function(e){const t=[];let n=0;for(let s=0;s<e.length;s++){let r=e.charCodeAt(s);r<128?t[n++]=r:r<2048?(t[n++]=r>>6|192,t[n++]=63&r|128):55296==(64512&r)&&s+1<e.length&&56320==(64512&e.charCodeAt(s+1))?(r=65536+((1023&r)<<10)+(1023&e.charCodeAt(++s)),t[n++]=r>>18|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128,t[n++]=63&r|128):(t[n++]=r>>12|224,t[n++]=r>>6&63|128,t[n++]=63&r|128)}return t},r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let t=0;t<e.length;t+=3){const r=e[t],i=t+1<e.length,o=i?e[t+1]:0,a=t+2<e.length,c=a?e[t+2]:0,u=r>>2,l=(3&r)<<4|o>>4;let h=(15&o)<<2|c>>6,d=63&c;a||(d=64,i||(h=64)),s.push(n[u],n[l],n[h],n[d])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,s=0;for(;n<e.length;){const r=e[n++];if(r<128)t[s++]=String.fromCharCode(r);else if(r>191&&r<224){const i=e[n++];t[s++]=String.fromCharCode((31&r)<<6|63&i)}else if(r>239&&r<365){const i=((7&r)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[s++]=String.fromCharCode(55296+(i>>10)),t[s++]=String.fromCharCode(56320+(1023&i))}else{const i=e[n++],o=e[n++];t[s++]=String.fromCharCode((15&r)<<12|(63&i)<<6|63&o)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let t=0;t<e.length;){const r=n[e.charAt(t++)],o=t<e.length?n[e.charAt(t)]:0;++t;const a=t<e.length?n[e.charAt(t)]:64;++t;const c=t<e.length?n[e.charAt(t)]:64;if(++t,null==r||null==o||null==a||null==c)throw new i;const u=r<<2|o>>4;if(s.push(u),64!==a){const e=o<<4&240|a>>2;if(s.push(e),64!==c){const e=a<<6&192|c;s.push(e)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class i extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(e){return function(e){const t=s(e);return r.encodeByteArray(t,!0)}(e).replace(/\./g,"")},a=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},c=()=>{var e;return null===(e=a())||void 0===e?void 0:e.config};class u{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}function l(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){try{return"object"==typeof indexedDB}catch(e){return!1}}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},s=`${this.service}/${e}`,r=this.errors[e],i=r?function(e,t){return e.replace(g,((e,n)=>{const s=t[n];return null!=s?String(s):`<${n}?>`}))}(r,n):"Error",o=`${this.serviceName}: ${i} (${s}).`;return new d(s,o,n)}}const g=/\{\$([^}]+)}/g;function m(e,t){if(e===t)return!0;const n=Object.keys(e),s=Object.keys(t);for(const r of n){if(!s.includes(r))return!1;const n=e[r],i=t[r];if(p(n)&&p(i)){if(!m(n,i))return!1}else if(n!==i)return!1}for(const e of s)if(!n.includes(e))return!1;return!0}function p(e){return null!==e&&"object"==typeof e}function y(e){return e&&e._delegate?e._delegate:e}class v{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const w="[DEFAULT]";class b{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new u;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),s=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(s)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(s)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:w})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch(e){}}}}clearInstance(e=w){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=w){return this.instances.has(e)}getOptions(e=w){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const s=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(s);return s}onInit(e,t){var n;const s=this.normalizeInstanceIdentifier(t),r=null!==(n=this.onInitCallbacks.get(s))&&void 0!==n?n:new Set;r.add(e),this.onInitCallbacks.set(s,r);const i=this.instances.get(s);return i&&e(i,s),()=>{r.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const s of n)try{s(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(s=e,s===w?void 0:s),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var s;return n||null}normalizeInstanceIdentifier(e=w){return this.component?this.component.multipleInstances?e:w:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class E{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new b(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const I=[];var T;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(T||(T={}));const _={debug:T.DEBUG,verbose:T.VERBOSE,info:T.INFO,warn:T.WARN,error:T.ERROR,silent:T.SILENT},S=T.INFO,D={[T.DEBUG]:"log",[T.VERBOSE]:"log",[T.INFO]:"info",[T.WARN]:"warn",[T.ERROR]:"error"},x=(e,t,...n)=>{if(t<e.logLevel)return;const s=(new Date).toISOString(),r=D[t];if(!r)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[r](`[${s}]  ${e.name}:`,...n)};class C{constructor(e){this.name=e,this._logLevel=S,this._logHandler=x,this._userLogHandler=null,I.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in T))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?_[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,T.DEBUG,...e),this._logHandler(this,T.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,T.VERBOSE,...e),this._logHandler(this,T.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,T.INFO,...e),this._logHandler(this,T.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,T.WARN,...e),this._logHandler(this,T.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,T.ERROR,...e),this._logHandler(this,T.ERROR,...e)}}let A,k;const N=new WeakMap,M=new WeakMap,O=new WeakMap,R=new WeakMap,L=new WeakMap;let P={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return M.get(e);if("objectStoreNames"===t)return e.objectStoreNames||O.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return V(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function F(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(B(this),e),V(N.get(this))}:function(...e){return V(t.apply(B(this),e))}:function(e,...n){const s=t.call(B(this),e,...n);return O.set(s,e.sort?e.sort():[e]),V(s)}:(e instanceof IDBTransaction&&function(e){if(M.has(e))return;const t=new Promise(((t,n)=>{const s=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",i),e.removeEventListener("abort",i)},r=()=>{t(),s()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",r),e.addEventListener("error",i),e.addEventListener("abort",i)}));M.set(e,t)}(e),n=e,(A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,P):e);var t,n}function V(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const s=()=>{e.removeEventListener("success",r),e.removeEventListener("error",i)},r=()=>{t(V(e.result)),s()},i=()=>{n(e.error),s()};e.addEventListener("success",r),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&N.set(t,e)})).catch((()=>{})),L.set(t,e),t}(e);if(R.has(e))return R.get(e);const t=F(e);return t!==e&&(R.set(e,t),L.set(t,e)),t}const B=e=>L.get(e),U=["get","getKey","getAll","getAllKeys","count"],j=["put","add","delete","clear"],q=new Map;function z(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(q.get(t))return q.get(t);const n=t.replace(/FromIndex$/,""),s=t!==n,r=j.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!r&&!U.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,r?"readwrite":"readonly");let o=i.store;return s&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),r&&i.done]))[0]};return q.set(t,i),i}var K;K=P,P={...K,get:(e,t,n)=>z(e,t)||K.get(e,t,n),has:(e,t)=>!!z(e,t)||K.has(e,t)};class ${constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const G="@firebase/app",H="0.9.13",Q=new C("@firebase/app"),W="@firebase/app-compat",X="@firebase/analytics-compat",Y="@firebase/analytics",J="@firebase/app-check-compat",Z="@firebase/app-check",ee="@firebase/auth",te="@firebase/auth-compat",ne="@firebase/database",se="@firebase/database-compat",re="@firebase/functions",ie="@firebase/functions-compat",oe="@firebase/installations",ae="@firebase/installations-compat",ce="@firebase/messaging",ue="@firebase/messaging-compat",le="@firebase/performance",he="@firebase/performance-compat",de="@firebase/remote-config",fe="@firebase/remote-config-compat",ge="@firebase/storage",me="@firebase/storage-compat",pe="@firebase/firestore",ye="@firebase/firestore-compat",ve="firebase",we="[DEFAULT]",be={[G]:"fire-core",[W]:"fire-core-compat",[Y]:"fire-analytics",[X]:"fire-analytics-compat",[Z]:"fire-app-check",[J]:"fire-app-check-compat",[ee]:"fire-auth",[te]:"fire-auth-compat",[ne]:"fire-rtdb",[se]:"fire-rtdb-compat",[re]:"fire-fn",[ie]:"fire-fn-compat",[oe]:"fire-iid",[ae]:"fire-iid-compat",[ce]:"fire-fcm",[ue]:"fire-fcm-compat",[le]:"fire-perf",[he]:"fire-perf-compat",[de]:"fire-rc",[fe]:"fire-rc-compat",[ge]:"fire-gcs",[me]:"fire-gcs-compat",[pe]:"fire-fst",[ye]:"fire-fst-compat","fire-js":"fire-js",[ve]:"fire-js-all"},Ee=new Map,Ie=new Map;function Te(e,t){try{e.container.addComponent(t)}catch(n){Q.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function _e(e){const t=e.name;if(Ie.has(t))return Q.debug(`There were multiple attempts to register component ${t}.`),!1;Ie.set(t,e);for(const t of Ee.values())Te(t,e);return!0}const Se=new f("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class De{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new v("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Se.create("app-deleted",{appName:this._name})}}function xe(e,t={}){let n=e;"object"!=typeof t&&(t={name:t});const s=Object.assign({name:we,automaticDataCollectionEnabled:!1},t),r=s.name;if("string"!=typeof r||!r)throw Se.create("bad-app-name",{appName:String(r)});if(n||(n=c()),!n)throw Se.create("no-options");const i=Ee.get(r);if(i){if(m(n,i.options)&&m(s,i.config))return i;throw Se.create("duplicate-app",{appName:r})}const o=new E(r);for(const e of Ie.values())o.addComponent(e);const a=new De(n,s,o);return Ee.set(r,a),a}function Ce(e,t,n){var s;let r=null!==(s=be[e])&&void 0!==s?s:e;n&&(r+=`-${n}`);const i=r.match(/\s|\//),o=t.match(/\s|\//);if(i||o){const e=[`Unable to register library "${r}" with version "${t}":`];return i&&e.push(`library name "${r}" contains illegal characters (whitespace or "/")`),i&&o&&e.push("and"),o&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void Q.warn(e.join(" "))}_e(new v(`${r}-version`,(()=>({library:r,version:t})),"VERSION"))}const Ae="firebase-heartbeat-store";let ke=null;function Ne(){return ke||(ke=function(e,t,{blocked:n,upgrade:s,blocking:r,terminated:i}={}){const o=indexedDB.open(e,t),a=V(o);return s&&o.addEventListener("upgradeneeded",(e=>{s(V(o.result),e.oldVersion,e.newVersion,V(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),r&&e.addEventListener("versionchange",(e=>r(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}("firebase-heartbeat-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(Ae)}}).catch((e=>{throw Se.create("idb-open",{originalErrorMessage:e.message})}))),ke}async function Me(e,t){try{const n=(await Ne()).transaction(Ae,"readwrite"),s=n.objectStore(Ae);await s.put(t,Oe(e)),await n.done}catch(e){if(e instanceof d)Q.warn(e.message);else{const t=Se.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});Q.warn(t.message)}}}function Oe(e){return`${e.name}!${e.options.appId}`}class Re{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new Pe(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){const e=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),t=Le();if(null===this._heartbeatsCache&&(this._heartbeatsCache=await this._heartbeatsCachePromise),this._heartbeatsCache.lastSentHeartbeatDate!==t&&!this._heartbeatsCache.heartbeats.some((e=>e.date===t)))return this._heartbeatsCache.heartbeats.push({date:t,agent:e}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null===this._heartbeatsCache||0===this._heartbeatsCache.heartbeats.length)return"";const e=Le(),{heartbeatsToSend:t,unsentEntries:n}=function(e,t=1024){const n=[];let s=e.slice();for(const r of e){const e=n.find((e=>e.agent===r.agent));if(e){if(e.dates.push(r.date),Fe(n)>t){e.dates.pop();break}}else if(n.push({agent:r.agent,dates:[r.date]}),Fe(n)>t){n.pop();break}s=s.slice(1)}return{heartbeatsToSend:n,unsentEntries:s}}(this._heartbeatsCache.heartbeats),s=o(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),s}}function Le(){return(new Date).toISOString().substring(0,10)}class Pe{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!h()&&new Promise(((e,t)=>{try{let n=!0;const s="validate-browser-context-for-indexeddb-analytics-module",r=self.indexedDB.open(s);r.onsuccess=()=>{r.result.close(),n||self.indexedDB.deleteDatabase(s),e(!0)},r.onupgradeneeded=()=>{n=!1},r.onerror=()=>{var e;t((null===(e=r.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=await Ne();return await t.transaction(Ae).objectStore(Ae).get(Oe(e))}catch(e){if(e instanceof d)Q.warn(e.message);else{const t=Se.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});Q.warn(t.message)}}}(this.app);return e||{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Me(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Me(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function Fe(e){return o(JSON.stringify({version:2,heartbeats:e})).length}_e(new v("platform-logger",(e=>new $(e)),"PRIVATE")),_e(new v("heartbeat",(e=>new Re(e)),"PRIVATE")),Ce(G,H,""),Ce(G,H,"esm2017"),Ce("fire-js",""),Ce("firebase","9.23.0","app");var Ve,Be="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Ue={},je=je||{},qe=Be||self;function ze(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function Ke(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var $e="closure_uid_"+(1e9*Math.random()>>>0),Ge=0;function He(e,t,n){return e.call.apply(e.bind,arguments)}function Qe(e,t,n){if(!e)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function We(e,t,n){return(We=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?He:Qe).apply(null,arguments)}function Xe(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function Ye(e,t){function n(){}n.prototype=t.prototype,e.$=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.ac=function(e,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return t.prototype[n].apply(e,r)}}function Je(){this.s=this.s,this.o=this.o}Je.prototype.s=!1,Je.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,$e)&&e[$e]||(e[$e]=++Ge))},Je.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Ze=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function et(e){const t=e.length;if(0<t){const n=Array(t);for(let s=0;s<t;s++)n[s]=e[s];return n}return[]}function tt(e,t){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(ze(n)){const t=e.length||0,s=n.length||0;e.length=t+s;for(let r=0;r<s;r++)e[t+r]=n[r]}else e.push(n)}}function nt(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}nt.prototype.h=function(){this.defaultPrevented=!0};var st=function(){if(!qe.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{qe.addEventListener("test",(()=>{}),t),qe.removeEventListener("test",(()=>{}),t)}catch(e){}return e}();function rt(e){return/^[\s\xa0]*$/.test(e)}function it(){var e=qe.navigator;return e&&(e=e.userAgent)?e:""}function ot(e){return-1!=it().indexOf(e)}function at(e){return at[" "](e),e}at[" "]=function(){};var ct,ut,lt,ht=ot("Opera"),dt=ot("Trident")||ot("MSIE"),ft=ot("Edge"),gt=ft||dt,mt=ot("Gecko")&&!(-1!=it().toLowerCase().indexOf("webkit")&&!ot("Edge"))&&!(ot("Trident")||ot("MSIE"))&&!ot("Edge"),pt=-1!=it().toLowerCase().indexOf("webkit")&&!ot("Edge");function yt(){var e=qe.document;return e?e.documentMode:void 0}e:{var vt="",wt=(ut=it(),mt?/rv:([^\);]+)(\)|;)/.exec(ut):ft?/Edge\/([\d\.]+)/.exec(ut):dt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ut):pt?/WebKit\/(\S+)/.exec(ut):ht?/(?:Version)[ \/]?(\S+)/.exec(ut):void 0);if(wt&&(vt=wt?wt[1]:""),dt){var bt=yt();if(null!=bt&&bt>parseFloat(vt)){ct=String(bt);break e}}ct=vt}qe.document&&dt?lt=yt()||parseInt(ct,10)||void 0:lt=void 0;var Et=lt;function It(e,t){if(nt.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,s=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(mt){e:{try{at(t.nodeName);var r=!0;break e}catch(e){}r=!1}r||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:Tt[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&It.$.h.call(this)}}Ye(It,nt);var Tt={2:"touch",3:"pen",4:"mouse"};It.prototype.h=function(){It.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var _t="closure_listenable_"+(1e6*Math.random()|0),St=0;function Dt(e,t,n,s,r){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!s,this.la=r,this.key=++St,this.fa=this.ia=!1}function xt(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function Ct(e,t,n){for(const s in e)t.call(n,e[s],s,e)}function At(e){const t={};for(const n in e)t[n]=e[n];return t}const kt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Nt(e,t){let n,s;for(let t=1;t<arguments.length;t++){for(n in s=arguments[t],s)e[n]=s[n];for(let t=0;t<kt.length;t++)n=kt[t],Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}}function Mt(e){this.src=e,this.g={},this.h=0}function Ot(e,t){var n=t.type;if(n in e.g){var s,r=e.g[n],i=Ze(r,t);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(xt(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function Rt(e,t,n,s){for(var r=0;r<e.length;++r){var i=e[r];if(!i.fa&&i.listener==t&&i.capture==!!n&&i.la==s)return r}return-1}Mt.prototype.add=function(e,t,n,s,r){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var o=Rt(e,t,s,r);return-1<o?(t=e[o],n||(t.ia=!1)):((t=new Dt(t,this.src,i,!!s,r)).ia=n,e.push(t)),t};var Lt="closure_lm_"+(1e6*Math.random()|0),Pt={};function Ft(e,t,n,s,r){if(s&&s.once)return Bt(e,t,n,s,r);if(Array.isArray(t)){for(var i=0;i<t.length;i++)Ft(e,t[i],n,s,r);return null}return n=Gt(n),e&&e[_t]?e.O(t,n,Ke(s)?!!s.capture:!!s,r):Vt(e,t,n,!1,s,r)}function Vt(e,t,n,s,r,i){if(!t)throw Error("Invalid event type");var o=Ke(r)?!!r.capture:!!r,a=Kt(e);if(a||(e[Lt]=a=new Mt(e)),(n=a.add(t,n,s,o,i)).proxy)return n;if(s=function(){const e=zt;return function t(n){return e.call(t.src,t.listener,n)}}(),n.proxy=s,s.src=e,s.listener=n,e.addEventListener)st||(r=o),void 0===r&&(r=!1),e.addEventListener(t.toString(),s,r);else if(e.attachEvent)e.attachEvent(qt(t.toString()),s);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(s)}return n}function Bt(e,t,n,s,r){if(Array.isArray(t)){for(var i=0;i<t.length;i++)Bt(e,t[i],n,s,r);return null}return n=Gt(n),e&&e[_t]?e.P(t,n,Ke(s)?!!s.capture:!!s,r):Vt(e,t,n,!0,s,r)}function Ut(e,t,n,s,r){if(Array.isArray(t))for(var i=0;i<t.length;i++)Ut(e,t[i],n,s,r);else s=Ke(s)?!!s.capture:!!s,n=Gt(n),e&&e[_t]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=Rt(i=e.g[t],n,s,r))&&(xt(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete e.g[t],e.h--))):e&&(e=Kt(e))&&(t=e.g[t.toString()],e=-1,t&&(e=Rt(t,n,s,r)),(n=-1<e?t[e]:null)&&jt(n))}function jt(e){if("number"!=typeof e&&e&&!e.fa){var t=e.src;if(t&&t[_t])Ot(t.i,e);else{var n=e.type,s=e.proxy;t.removeEventListener?t.removeEventListener(n,s,e.capture):t.detachEvent?t.detachEvent(qt(n),s):t.addListener&&t.removeListener&&t.removeListener(s),(n=Kt(t))?(Ot(n,e),0==n.h&&(n.src=null,t[Lt]=null)):xt(e)}}}function qt(e){return e in Pt?Pt[e]:Pt[e]="on"+e}function zt(e,t){if(e.fa)e=!0;else{t=new It(t,this);var n=e.listener,s=e.la||e.src;e.ia&&jt(e),e=n.call(s,t)}return e}function Kt(e){return(e=e[Lt])instanceof Mt?e:null}var $t="__closure_events_fn_"+(1e9*Math.random()>>>0);function Gt(e){return"function"==typeof e?e:(e[$t]||(e[$t]=function(t){return e.handleEvent(t)}),e[$t])}function Ht(){Je.call(this),this.i=new Mt(this),this.S=this,this.J=null}function Qt(e,t){var n,s=e.J;if(s)for(n=[];s;s=s.J)n.push(s);if(e=e.S,s=t.type||t,"string"==typeof t)t=new nt(t,e);else if(t instanceof nt)t.target=t.target||e;else{var r=t;Nt(t=new nt(s,e),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=t.g=n[i];r=Wt(o,s,!0,t)&&r}if(r=Wt(o=t.g=e,s,!0,t)&&r,r=Wt(o,s,!1,t)&&r,n)for(i=0;i<n.length;i++)r=Wt(o=t.g=n[i],s,!1,t)&&r}function Wt(e,t,n,s){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var r=!0,i=0;i<t.length;++i){var o=t[i];if(o&&!o.fa&&o.capture==n){var a=o.listener,c=o.la||o.src;o.ia&&Ot(e.i,o),r=!1!==a.call(c,s)&&r}}return r&&!s.defaultPrevented}Ye(Ht,Je),Ht.prototype[_t]=!0,Ht.prototype.removeEventListener=function(e,t,n,s){Ut(this,e,t,n,s)},Ht.prototype.N=function(){if(Ht.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],s=0;s<n.length;s++)xt(n[s]);delete t.g[e],t.h--}}this.J=null},Ht.prototype.O=function(e,t,n,s){return this.i.add(String(e),t,!1,n,s)},Ht.prototype.P=function(e,t,n,s){return this.i.add(String(e),t,!0,n,s)};var Xt=qe.JSON.stringify;function Yt(){var e=rn;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var Jt=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new Zt),(e=>e.reset()));class Zt{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function en(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}function tn(e){qe.setTimeout((()=>{throw e}),0)}let nn,sn=!1,rn=new class{constructor(){this.h=this.g=null}add(e,t){const n=Jt.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},on=()=>{const e=qe.Promise.resolve(void 0);nn=()=>{e.then(an)}};var an=()=>{for(var e;e=Yt();){try{e.h.call(e.g)}catch(e){tn(e)}var t=Jt;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}sn=!1};function cn(e,t){Ht.call(this),this.h=e||1,this.g=t||qe,this.j=We(this.qb,this),this.l=Date.now()}function un(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function ln(e,t,n){if("function"==typeof e)n&&(e=We(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=We(e.handleEvent,e)}return 2147483647<Number(t)?-1:qe.setTimeout(e,t||0)}function hn(e){e.g=ln((()=>{e.g=null,e.i&&(e.i=!1,hn(e))}),e.j);const t=e.h;e.h=null,e.m.apply(null,t)}Ye(cn,Ht),(Ve=cn.prototype).ga=!1,Ve.T=null,Ve.qb=function(){if(this.ga){var e=Date.now()-this.l;0<e&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Qt(this,"tick"),this.ga&&(un(this),this.start()))}},Ve.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},Ve.N=function(){cn.$.N.call(this),un(this),delete this.g};class dn extends Je{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:hn(this)}N(){super.N(),this.g&&(qe.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function fn(e){Je.call(this),this.h=e,this.g={}}Ye(fn,Je);var gn=[];function mn(e,t,n,s){Array.isArray(n)||(n&&(gn[0]=n.toString()),n=gn);for(var r=0;r<n.length;r++){var i=Ft(t,n[r],s||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function pn(e){Ct(e.g,(function(e,t){this.g.hasOwnProperty(t)&&jt(e)}),e),e.g={}}function yn(){this.g=!0}function vn(e,t,n,s){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var s=n[e];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return Xt(n)}catch(e){return t}}(e,n)+(s?" "+s:"")}))}fn.prototype.N=function(){fn.$.N.call(this),pn(this)},fn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},yn.prototype.Ea=function(){this.g=!1},yn.prototype.info=function(){};var wn={},bn=null;function En(){return bn=bn||new Ht}function In(e){nt.call(this,wn.Ta,e)}function Tn(e){const t=En();Qt(t,new In(t))}function _n(e,t){nt.call(this,wn.STAT_EVENT,e),this.stat=t}function Sn(e){const t=En();Qt(t,new _n(t,e))}function Dn(e,t){nt.call(this,wn.Ua,e),this.size=t}function xn(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return qe.setTimeout((function(){e()}),t)}wn.Ta="serverreachability",Ye(In,nt),wn.STAT_EVENT="statevent",Ye(_n,nt),wn.Ua="timingevent",Ye(Dn,nt);var Cn={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},An={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function kn(){}function Nn(e){return e.h||(e.h=e.i())}function Mn(){}kn.prototype.h=null;var On,Rn={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function Ln(){nt.call(this,"d")}function Pn(){nt.call(this,"c")}function Fn(){}function Vn(e,t,n,s){this.l=e,this.j=t,this.m=n,this.W=s||1,this.U=new fn(this),this.P=Un,e=gt?125:void 0,this.V=new cn(e),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Bn}function Bn(){this.i=null,this.g="",this.h=!1}Ye(Ln,nt),Ye(Pn,nt),Ye(Fn,kn),Fn.prototype.g=function(){return new XMLHttpRequest},Fn.prototype.i=function(){return{}},On=new Fn;var Un=45e3,jn={},qn={};function zn(e,t,n){e.L=1,e.v=cs(ss(t)),e.s=n,e.S=!0,Kn(e,null)}function Kn(e,t){e.G=Date.now(),Qn(e),e.A=ss(e.v);var n=e.A,s=e.W;Array.isArray(s)||(s=[String(s)]),Es(n.i,"t",s),e.C=0,n=e.l.J,e.h=new Bn,e.g=Er(e.l,n?t:null,!e.s),0<e.O&&(e.M=new dn(We(e.Pa,e,e.g),e.O)),mn(e.U,e.g,"readystatechange",e.nb),t=e.I?At(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),Tn(),function(e,t,n,s,r,i){e.info((function(){if(e.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+u+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+t+"\n"+n+"\n"+o}))}(e.j,e.u,e.A,e.m,e.W,e.s)}function $n(e){return!!e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function Gn(e,t,n){let s,r=!0;for(;!e.J&&e.C<n.length;){if(s=Hn(e,n),s==qn){4==t&&(e.o=4,Sn(14),r=!1),vn(e.j,e.m,null,"[Incomplete Response]");break}if(s==jn){e.o=4,Sn(15),vn(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}vn(e.j,e.m,s,null),Zn(e,s)}$n(e)&&s!=qn&&s!=jn&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,Sn(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),fr(t),t.M=!0,Sn(11))):(vn(e.j,e.m,n,"[Invalid Chunked Response]"),Jn(e),Yn(e))}function Hn(e,t){var n=e.C,s=t.indexOf("\n",n);return-1==s?qn:(n=Number(t.substring(n,s)),isNaN(n)?jn:(s+=1)+n>t.length?qn:(t=t.slice(s,s+n),e.C=s+n,t))}function Qn(e){e.Y=Date.now()+e.P,Wn(e,e.P)}function Wn(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=xn(We(e.lb,e),t)}function Xn(e){e.B&&(qe.clearTimeout(e.B),e.B=null)}function Yn(e){0==e.l.H||e.J||pr(e.l,e)}function Jn(e){Xn(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,un(e.V),pn(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Zn(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Cs(n.i,e)))if(!e.K&&Cs(n.i,e)&&3==n.H){try{var s=n.Ja.g.parse(t)}catch(e){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;mr(n),ir(n)}dr(n),Sn(18)}}else n.Fa=r[1],0<n.Fa-n.V&&37500>r[2]&&n.G&&0==n.A&&!n.v&&(n.v=xn(We(n.ib,n),6e3));if(1>=xs(n.i)&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else vr(n,11)}else if((e.K||n.g==e)&&mr(n),!rt(t))for(r=n.Ja.g.parse(t),t=0;t<r.length;t++){let u=r[t];if(n.V=u[0],u=u[1],2==n.H)if("c"==u[0]){n.K=u[1],n.pa=u[2];const t=u[3];null!=t&&(n.ra=t,n.l.info("VER="+n.ra));const r=u[4];null!=r&&(n.Ga=r,n.l.info("SVER="+n.Ga));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(s=1.5*l,n.L=s,n.l.info("backChannelRequestTimeoutMs_="+s)),s=n;const h=e.g;if(h){const e=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var i=s.i;i.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(As(i,i.h),i.h=null))}if(s.F){const e=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(s.Da=e,as(s.I,s.F,e))}}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var o=e;if((s=n).wa=br(s,s.J?s.pa:null,s.Y),o.K){ks(s.i,o);var a=o,c=s.L;c&&a.setTimeout(c),a.B&&(Xn(a),Qn(a)),s.g=o}else hr(s);0<n.j.length&&ar(n)}else"stop"!=u[0]&&"close"!=u[0]||vr(n,7);else 3==n.H&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?vr(n,7):rr(n):"noop"!=u[0]&&n.h&&n.h.Aa(u),n.A=0)}Tn()}catch(e){}}function es(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(ze(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(ze(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const s in e)t[n++]=s;return t}}}(e),s=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(ze(e)){for(var t=[],n=e.length,s=0;s<n;s++)t.push(e[s]);return t}for(s in t=[],n=0,e)t[n++]=e[s];return t}(e),r=s.length,i=0;i<r;i++)t.call(void 0,s[i],n&&n[i],e)}(Ve=Vn.prototype).setTimeout=function(e){this.P=e},Ve.nb=function(e){e=e.target;const t=this.M;t&&3==Js(e)?t.l():this.Pa(e)},Ve.Pa=function(e){try{if(e==this.g)e:{const l=Js(this.g);var t=this.g.Ia();if(this.g.da(),!(3>l)&&(3!=l||gt||this.g&&(this.h.h||this.g.ja()||Zs(this.g)))){this.J||4!=l||7==t||Tn(),Xn(this);var n=this.g.da();this.ca=n;t:if($n(this)){var s=Zs(this.g);e="";var r=s.length,i=4==Js(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Jn(this),Yn(this);var o="";break t}this.h.i=new qe.TextDecoder}for(t=0;t<r;t++)this.h.h=!0,e+=this.h.i.decode(s[t],{stream:i&&t==r-1});s.splice(0,r),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==n,function(e,t,n,s,r,i,o){e.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+t+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.W,l,n),this.i){if(this.aa&&!this.K){t:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!rt(a)){var u=a;break t}}u=null}if(!(n=u)){this.i=!1,this.o=3,Sn(12),Jn(this),Yn(this);break e}vn(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Zn(this,n)}this.S?(Gn(this,l,o),gt&&this.i&&3==l&&(mn(this.U,this.V,"tick",this.mb),this.V.start())):(vn(this.j,this.m,o,null),Zn(this,o)),4==l&&Jn(this),this.i&&!this.J&&(4==l?pr(this.l,this):(this.i=!1,Qn(this)))}else(function(e){const t={};e=(e.g&&2<=Js(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let s=0;s<e.length;s++){if(rt(e[s]))continue;var n=en(e[s]);const r=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const i=t[r]||[];t[r]=i,i.push(n)}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,(function(e){return e.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.o=3,Sn(12)):(this.o=0,Sn(13)),Jn(this),Yn(this)}}}catch(e){}},Ve.mb=function(){if(this.g){var e=Js(this.g),t=this.g.ja();this.C<t.length&&(Xn(this),Gn(this,e,t),this.i&&4!=e&&Qn(this))}},Ve.cancel=function(){this.J=!0,Jn(this)},Ve.lb=function(){this.B=null;const e=Date.now();0<=e-this.Y?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.j,this.A),2!=this.L&&(Tn(),Sn(17)),Jn(this),this.o=2,Yn(this)):Wn(this,this.Y-e)};var ts=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ns(e){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof ns){this.h=e.h,rs(this,e.j),this.s=e.s,this.g=e.g,is(this,e.m),this.l=e.l;var t=e.i,n=new ys;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),os(this,n),this.o=e.o}else e&&(t=String(e).match(ts))?(this.h=!1,rs(this,t[1]||"",!0),this.s=us(t[2]||""),this.g=us(t[3]||"",!0),is(this,t[4]),this.l=us(t[5]||"",!0),os(this,t[6]||"",!0),this.o=us(t[7]||"")):(this.h=!1,this.i=new ys(null,this.h))}function ss(e){return new ns(e)}function rs(e,t,n){e.j=n?us(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function is(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.m=t}else e.m=null}function os(e,t,n){t instanceof ys?(e.i=t,function(e,t){t&&!e.j&&(vs(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(ws(this,t),Es(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=ls(t,ms)),e.i=new ys(t,e.h))}function as(e,t,n){e.i.set(t,n)}function cs(e){return as(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function us(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function ls(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,hs),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function hs(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}ns.prototype.toString=function(){var e=[],t=this.j;t&&e.push(ls(t,ds,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.s)&&e.push(ls(t,ds,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(ls(n,"/"==n.charAt(0)?gs:fs,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",ls(n,ps)),e.join("")};var ds=/[#\/\?@]/g,fs=/[#\?:]/g,gs=/[#\?]/g,ms=/[#\?@]/g,ps=/#/g;function ys(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function vs(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var s=e[n].indexOf("="),r=null;if(0<=s){var i=e[n].substring(0,s);r=e[n].substring(s+1)}else i=e[n];t(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function ws(e,t){vs(e),t=Is(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function bs(e,t){return vs(e),t=Is(e,t),e.g.has(t)}function Es(e,t,n){ws(e,t),0<n.length&&(e.i=null,e.g.set(Is(e,t),et(n)),e.h+=n.length)}function Is(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}(Ve=ys.prototype).add=function(e,t){vs(this),this.i=null,e=Is(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},Ve.forEach=function(e,t){vs(this),this.g.forEach((function(n,s){n.forEach((function(n){e.call(t,n,s,this)}),this)}),this)},Ve.ta=function(){vs(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let s=0;s<t.length;s++){const r=e[s];for(let e=0;e<r.length;e++)n.push(t[s])}return n},Ve.Z=function(e){vs(this);let t=[];if("string"==typeof e)bs(this,e)&&(t=t.concat(this.g.get(Is(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},Ve.set=function(e,t){return vs(this),this.i=null,bs(this,e=Is(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},Ve.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},Ve.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var s=t[n];const i=encodeURIComponent(String(s)),o=this.Z(s);for(s=0;s<o.length;s++){var r=i;""!==o[s]&&(r+="="+encodeURIComponent(String(o[s]))),e.push(r)}}return this.i=e.join("&")};var Ts=class{constructor(e,t){this.g=e,this.map=t}};function _s(e){this.l=e||Ss,e=qe.PerformanceNavigationTiming?0<(e=qe.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(qe.g&&qe.g.Ka&&qe.g.Ka()&&qe.g.Ka().ec),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var Ss=10;function Ds(e){return!!e.h||!!e.g&&e.g.size>=e.j}function xs(e){return e.h?1:e.g?e.g.size:0}function Cs(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function As(e,t){e.g?e.g.add(t):e.h=t}function ks(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Ns(e){if(null!=e.h)return e.i.concat(e.h.F);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.F);return t}return et(e.i)}_s.prototype.cancel=function(){if(this.i=Ns(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var Ms=class{stringify(e){return qe.JSON.stringify(e,void 0)}parse(e){return qe.JSON.parse(e,void 0)}};function Os(){this.g=new Ms}function Rs(e,t,n){const s=n||"";try{es(e,(function(e,n){let r=e;Ke(e)&&(r=Xt(e)),t.push(s+n+"="+encodeURIComponent(r))}))}catch(e){throw t.push(s+"type="+encodeURIComponent("_badmap")),e}}function Ls(e,t,n,s,r){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,r(s)}catch(e){}}function Ps(e){this.l=e.fc||null,this.j=e.ob||!1}function Fs(e,t){Ht.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=Vs,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Ye(Ps,kn),Ps.prototype.g=function(){return new Fs(this.l,this.j)},Ps.prototype.i=function(e){return function(){return e}}({}),Ye(Fs,Ht);var Vs=0;function Bs(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function Us(e){e.readyState=4,e.l=null,e.j=null,e.A=null,js(e)}function js(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(Ve=Fs.prototype).open=function(e,t){if(this.readyState!=Vs)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,js(this)},Ve.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||qe).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},Ve.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Us(this)),this.readyState=Vs},Ve.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,js(this)),this.g&&(this.readyState=3,js(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==qe.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Bs(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},Ve.Xa=function(e){if(this.g){if(this.u&&e.value)this.response.push(e.value);else if(!this.u){var t=e.value?e.value:new Uint8Array(0);(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?Us(this):js(this),3==this.readyState&&Bs(this)}},Ve.Za=function(e){this.g&&(this.response=this.responseText=e,Us(this))},Ve.Ya=function(e){this.g&&(this.response=e,Us(this))},Ve.ka=function(){this.g&&Us(this)},Ve.setRequestHeader=function(e,t){this.v.append(e,t)},Ve.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},Ve.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Fs.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var qs=qe.JSON.parse;function zs(e){Ht.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Ks,this.L=this.M=!1}Ye(zs,Ht);var Ks="",$s=/^https?$/i,Gs=["POST","PUT"];function Hs(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Qs(e),Xs(e)}function Qs(e){e.F||(e.F=!0,Qt(e,"complete"),Qt(e,"error"))}function Ws(e){if(e.h&&void 0!==je&&(!e.C[1]||4!=Js(e)||2!=e.da()))if(e.v&&4==Js(e))ln(e.La,0,e);else if(Qt(e,"readystatechange"),4==Js(e)){e.h=!1;try{const o=e.da();e:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var s;if(s=0===o){var r=String(e.I).match(ts)[1]||null;!r&&qe.self&&qe.self.location&&(r=qe.self.location.protocol.slice(0,-1)),s=!$s.test(r?r.toLowerCase():"")}n=s}if(n)Qt(e,"complete"),Qt(e,"success");else{e.m=6;try{var i=2<Js(e)?e.g.statusText:""}catch(e){i=""}e.j=i+" ["+e.da()+"]",Qs(e)}}finally{Xs(e)}}}function Xs(e,t){if(e.g){Ys(e);const n=e.g,s=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||Qt(e,"ready");try{n.onreadystatechange=s}catch(e){}}}function Ys(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(qe.clearTimeout(e.A),e.A=null)}function Js(e){return e.g?e.g.readyState:0}function Zs(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case Ks:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function er(e){let t="";return Ct(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function tr(e,t,n){e:{for(s in n){var s=!1;break e}s=!0}s||(n=er(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):as(e,t,n))}function nr(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function sr(e){this.Ga=0,this.j=[],this.l=new yn,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=nr("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=nr("baseRetryDelayMs",5e3,e),this.hb=nr("retryDelaySeedMs",1e4,e),this.eb=nr("forwardChannelMaxRetries",2,e),this.xa=nr("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.dc||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new _s(e&&e.concurrentRequestLimit),this.Ja=new Os,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function rr(e){if(or(e),3==e.H){var t=e.W++,n=ss(e.I);if(as(n,"SID",e.K),as(n,"RID",t),as(n,"TYPE","terminate"),ur(e,n),(t=new Vn(e,e.l,t)).L=2,t.v=cs(ss(n)),n=!1,qe.navigator&&qe.navigator.sendBeacon)try{n=qe.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&qe.Image&&((new Image).src=t.v,n=!0),n||(t.g=Er(t.l,null),t.g.ha(t.v)),t.G=Date.now(),Qn(t)}wr(e)}function ir(e){e.g&&(fr(e),e.g.cancel(),e.g=null)}function or(e){ir(e),e.u&&(qe.clearTimeout(e.u),e.u=null),mr(e),e.i.cancel(),e.m&&("number"==typeof e.m&&qe.clearTimeout(e.m),e.m=null)}function ar(e){if(!Ds(e.i)&&!e.m){e.m=!0;var t=e.Na;nn||on(),sn||(nn(),sn=!0),rn.add(t,e),e.C=0}}function cr(e,t){var n;n=t?t.m:e.W++;const s=ss(e.I);as(s,"SID",e.K),as(s,"RID",n),as(s,"AID",e.V),ur(e,s),e.o&&e.s&&tr(s,e.o,e.s),n=new Vn(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=lr(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),As(e.i,n),zn(n,s,t)}function ur(e,t){e.na&&Ct(e.na,(function(e,n){as(t,n,e)})),e.h&&es({},(function(e,n){as(t,n,e)}))}function lr(e,t,n){n=Math.min(e.j.length,n);var s=e.h?We(e.h.Va,e.h,e):null;e:{var r=e.j;let t=-1;for(;;){const e=["count="+n];-1==t?0<n?(t=r[0].g,e.push("ofs="+t)):t=0:e.push("ofs="+t);let i=!0;for(let o=0;o<n;o++){let n=r[o].g;const a=r[o].map;if(n-=t,0>n)t=Math.max(0,r[o].g-100),i=!1;else try{Rs(a,e,"req"+n+"_")}catch(e){s&&s(a)}}if(i){s=e.join("&");break e}}}return e=e.j.splice(0,n),t.F=e,s}function hr(e){if(!e.g&&!e.u){e.ba=1;var t=e.Ma;nn||on(),sn||(nn(),sn=!0),rn.add(t,e),e.A=0}}function dr(e){return!(e.g||e.u||3<=e.A||(e.ba++,e.u=xn(We(e.Ma,e),yr(e,e.A)),e.A++,0))}function fr(e){null!=e.B&&(qe.clearTimeout(e.B),e.B=null)}function gr(e){e.g=new Vn(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=ss(e.wa);as(t,"RID","rpc"),as(t,"SID",e.K),as(t,"AID",e.V),as(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&as(t,"TO",e.qa),as(t,"TYPE","xmlhttp"),ur(e,t),e.o&&e.s&&tr(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.v=cs(ss(t)),n.s=null,n.S=!0,Kn(n,e)}function mr(e){null!=e.v&&(qe.clearTimeout(e.v),e.v=null)}function pr(e,t){var n=null;if(e.g==t){mr(e),fr(e),e.g=null;var s=2}else{if(!Cs(e.i,t))return;n=t.F,ks(e.i,t),s=1}if(0!=e.H)if(t.i)if(1==s){n=t.s?t.s.length:0,t=Date.now()-t.G;var r=e.C;Qt(s=En(),new Dn(s,n)),ar(e)}else hr(e);else if(3==(r=t.o)||0==r&&0<t.ca||!(1==s&&function(e,t){return!(xs(e.i)>=e.i.j-(e.m?1:0)||(e.m?(e.j=t.F.concat(e.j),0):1==e.H||2==e.H||e.C>=(e.cb?0:e.eb)||(e.m=xn(We(e.Na,e,t),yr(e,e.C)),e.C++,0)))}(e,t)||2==s&&dr(e)))switch(n&&0<n.length&&(t=e.i,t.i=t.i.concat(n)),r){case 1:vr(e,5);break;case 4:vr(e,10);break;case 3:vr(e,6);break;default:vr(e,2)}}function yr(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function vr(e,t){if(e.l.info("Error code "+t),2==t){var n=null;e.h&&(n=null);var s=We(e.pb,e);n||(n=new ns("//www.google.com/images/cleardot.gif"),qe.location&&"http"==qe.location.protocol||rs(n,"https"),cs(n)),function(e,t){const n=new yn;if(qe.Image){const s=new Image;s.onload=Xe(Ls,n,s,"TestLoadImage: loaded",!0,t),s.onerror=Xe(Ls,n,s,"TestLoadImage: error",!1,t),s.onabort=Xe(Ls,n,s,"TestLoadImage: abort",!1,t),s.ontimeout=Xe(Ls,n,s,"TestLoadImage: timeout",!1,t),qe.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=e}else t(!1)}(n.toString(),s)}else Sn(2);e.H=0,e.h&&e.h.za(t),wr(e),or(e)}function wr(e){if(e.H=0,e.ma=[],e.h){const t=Ns(e.i);0==t.length&&0==e.j.length||(tt(e.ma,t),tt(e.ma,e.j),e.i.i.length=0,et(e.j),e.j.length=0),e.h.ya()}}function br(e,t,n){var s=n instanceof ns?ss(n):new ns(n);if(""!=s.g)t&&(s.g=t+"."+s.g),is(s,s.m);else{var r=qe.location;s=r.protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port;var i=new ns(null);s&&rs(i,s),t&&(i.g=t),r&&is(i,r),n&&(i.l=n),s=i}return n=e.F,t=e.Da,n&&t&&as(s,n,t),as(s,"VER",e.ra),ur(e,s),s}function Er(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new zs(new Ps({ob:!0})):new zs(e.va)).Oa(e.J),t}function Ir(){}function Tr(){if(dt&&!(10<=Number(Et)))throw Error("Environmental error: no available transport.")}function _r(e,t){Ht.call(this),this.g=new sr(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!rt(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!rt(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new xr(this)}function Sr(e){Ln.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Dr(){Pn.call(this),this.status=1}function xr(e){this.g=e}function Cr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Ar(e,t,n){n||(n=0);var s=Array(16);if("string"==typeof t)for(var r=0;16>r;++r)s[r]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(r=0;16>r;++r)s[r]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],r=e.g[2];var i=e.g[3],o=t+(i^n&(r^i))+s[0]+3614090360&4294967295;o=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=(n=(r=(i=(t=n+(o<<7&4294967295|o>>>25))+((o=i+(r^t&(n^r))+s[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(t^n))+s[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^r&(i^t))+s[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=t+(i^n&(r^i))+s[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^t&(n^r))+s[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(t^n))+s[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^r&(i^t))+s[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=t+(i^n&(r^i))+s[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^t&(n^r))+s[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(t^n))+s[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^r&(i^t))+s[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=t+(i^n&(r^i))+s[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^t&(n^r))+s[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(t^n))+s[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^r&(i^t))+s[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=t+(r^i&(n^r))+s[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(t^n))+s[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=r+(t^n&(i^t))+s[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^t&(r^i))+s[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=t+(r^i&(n^r))+s[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(t^n))+s[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=r+(t^n&(i^t))+s[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^t&(r^i))+s[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=t+(r^i&(n^r))+s[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(t^n))+s[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=r+(t^n&(i^t))+s[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^t&(r^i))+s[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=t+(r^i&(n^r))+s[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(t^n))+s[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=r+(t^n&(i^t))+s[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^t&(r^i))+s[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=t+(n^r^i)+s[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(t^n^r)+s[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^t^n)+s[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^t)+s[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^r^i)+s[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(t^n^r)+s[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^t^n)+s[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^t)+s[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^r^i)+s[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(t^n^r)+s[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^t^n)+s[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^t)+s[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^r^i)+s[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(t^n^r)+s[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^t^n)+s[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^t)+s[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=t+(r^(n|~i))+s[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(t|~r))+s[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=r+(t^(i|~n))+s[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~t))+s[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=t+(r^(n|~i))+s[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(t|~r))+s[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=r+(t^(i|~n))+s[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~t))+s[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=t+(r^(n|~i))+s[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(t|~r))+s[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=r+(t^(i|~n))+s[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~t))+s[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(t=n+((o=t+(r^(n|~i))+s[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(t|~r))+s[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((r=i+((o=r+(t^(i|~n))+s[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~t))+s[9]+3951481745&4294967295,e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(r+(o<<21&4294967295|o>>>11))&4294967295,e.g[2]=e.g[2]+r&4294967295,e.g[3]=e.g[3]+i&4294967295}function kr(e,t){this.h=t;for(var n=[],s=!0,r=e.length-1;0<=r;r--){var i=0|e[r];s&&i==t||(n[r]=i,s=!1)}this.g=n}(Ve=zs.prototype).Oa=function(e){this.M=e},Ve.ha=function(e,t,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():On.g(),this.C=this.u?Nn(this.u):Nn(On),this.g.onreadystatechange=We(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void Hs(this,e)}if(e=n||"",n=new Map(this.headers),s)if(Object.getPrototypeOf(s)===Object.prototype)for(var r in s)n.set(r,s[r]);else{if("function"!=typeof s.keys||"function"!=typeof s.get)throw Error("Unknown input type for opt_headers: "+String(s));for(const e of s.keys())n.set(e,s.get(e))}s=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),r=qe.FormData&&e instanceof qe.FormData,!(0<=Ze(Gs,t))||s||r||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Ys(this),0<this.B&&((this.L=function(e){return dt&&"number"==typeof e.timeout&&void 0!==e.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=We(this.ua,this)):this.A=ln(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Hs(this,e)}},Ve.ua=function(){void 0!==je&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Qt(this,"timeout"),this.abort(8))},Ve.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Qt(this,"complete"),Qt(this,"abort"),Xs(this))},Ve.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Xs(this,!0)),zs.$.N.call(this)},Ve.La=function(){this.s||(this.G||this.v||this.l?Ws(this):this.kb())},Ve.kb=function(){Ws(this)},Ve.isActive=function(){return!!this.g},Ve.da=function(){try{return 2<Js(this)?this.g.status:-1}catch(e){return-1}},Ve.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},Ve.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),qs(t)}},Ve.Ia=function(){return this.m},Ve.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(Ve=sr.prototype).ra=8,Ve.H=1,Ve.Na=function(e){if(this.m)if(this.m=null,1==this.H){if(!e){this.W=Math.floor(1e5*Math.random()),e=this.W++;const r=new Vn(this,this.l,e);let i=this.s;if(this.U&&(i?(i=At(i),Nt(i,this.U)):i=this.U),null!==this.o||this.O||(r.I=i,i=null),this.P)e:{for(var t=0,n=0;n<this.j.length;n++){var s=this.j[n];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(t+=s)){t=n;break e}if(4096===t||n===this.j.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=lr(this,r,t),as(n=ss(this.I),"RID",e),as(n,"CVER",22),this.F&&as(n,"X-HTTP-Session-Id",this.F),ur(this,n),i&&(this.O?t="headers="+encodeURIComponent(String(er(i)))+"&"+t:this.o&&tr(n,this.o,i)),As(this.i,r),this.bb&&as(n,"TYPE","init"),this.P?(as(n,"$req",t),as(n,"SID","null"),r.aa=!0,zn(r,n,null)):zn(r,n,t),this.H=2}}else 3==this.H&&(e?cr(this,e):0==this.j.length||Ds(this.i)||cr(this))},Ve.Ma=function(){if(this.u=null,gr(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var e=2*this.S;this.l.info("BP detection timer enabled: "+e),this.B=xn(We(this.jb,this),e)}},Ve.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Sn(10),ir(this),gr(this))},Ve.ib=function(){null!=this.v&&(this.v=null,ir(this),dr(this),Sn(19))},Ve.pb=function(e){e?(this.l.info("Successfully pinged google.com"),Sn(2)):(this.l.info("Failed to ping google.com"),Sn(1))},Ve.isActive=function(){return!!this.h&&this.h.isActive(this)},(Ve=Ir.prototype).Ba=function(){},Ve.Aa=function(){},Ve.za=function(){},Ve.ya=function(){},Ve.isActive=function(){return!0},Ve.Va=function(){},Tr.prototype.g=function(e,t){return new _r(e,t)},Ye(_r,Ht),_r.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;Sn(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=br(e,null,e.Y),ar(e)},_r.prototype.close=function(){rr(this.g)},_r.prototype.u=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.v&&((n={}).__data__=Xt(e),e=n);t.j.push(new Ts(t.fb++,e)),3==t.H&&ar(t)},_r.prototype.N=function(){this.g.h=null,delete this.j,rr(this.g),delete this.g,_r.$.N.call(this)},Ye(Sr,Ln),Ye(Dr,Pn),Ye(xr,Ir),xr.prototype.Ba=function(){Qt(this.g,"a")},xr.prototype.Aa=function(e){Qt(this.g,new Sr(e))},xr.prototype.za=function(e){Qt(this.g,new Dr)},xr.prototype.ya=function(){Qt(this.g,"b")},Ye(Cr,(function(){this.blockSize=-1})),Cr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Cr.prototype.j=function(e,t){void 0===t&&(t=e.length);for(var n=t-this.blockSize,s=this.m,r=this.h,i=0;i<t;){if(0==r)for(;i<=n;)Ar(this,e,i),i+=this.blockSize;if("string"==typeof e){for(;i<t;)if(s[r++]=e.charCodeAt(i++),r==this.blockSize){Ar(this,s),r=0;break}}else for(;i<t;)if(s[r++]=e[i++],r==this.blockSize){Ar(this,s),r=0;break}}this.h=r,this.i+=t},Cr.prototype.l=function(){var e=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.i;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;4>t;++t)for(var s=0;32>s;s+=8)e[n++]=this.g[t]>>>s&255;return e};var Nr={};function Mr(e){return-128<=e&&128>e?function(e){var t=Nr;return Object.prototype.hasOwnProperty.call(t,e)?t[e]:t[e]=function(e){return new kr([0|e],0>e?-1:0)}(e)}(e):new kr([0|e],0>e?-1:0)}function Or(e){if(isNaN(e)||!isFinite(e))return Lr;if(0>e)return Ur(Or(-e));for(var t=[],n=1,s=0;e>=n;s++)t[s]=e/n|0,n*=Rr;return new kr(t,0)}var Rr=4294967296,Lr=Mr(0),Pr=Mr(1),Fr=Mr(16777216);function Vr(e){if(0!=e.h)return!1;for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return!1;return!0}function Br(e){return-1==e.h}function Ur(e){for(var t=e.g.length,n=[],s=0;s<t;s++)n[s]=~e.g[s];return new kr(n,~e.h).add(Pr)}function jr(e,t){return e.add(Ur(t))}function qr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function zr(e,t){this.g=e,this.h=t}function Kr(e,t){if(Vr(t))throw Error("division by zero");if(Vr(e))return new zr(Lr,Lr);if(Br(e))return t=Kr(Ur(e),t),new zr(Ur(t.g),Ur(t.h));if(Br(t))return t=Kr(e,Ur(t)),new zr(Ur(t.g),t.h);if(30<e.g.length){if(Br(e)||Br(t))throw Error("slowDivide_ only works with positive integers.");for(var n=Pr,s=t;0>=s.X(e);)n=$r(n),s=$r(s);var r=Gr(n,1),i=Gr(s,1);for(s=Gr(s,2),n=Gr(n,2);!Vr(s);){var o=i.add(s);0>=o.X(e)&&(r=r.add(n),i=o),s=Gr(s,1),n=Gr(n,1)}return t=jr(e,r.R(t)),new zr(r,t)}for(r=Lr;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),s=48>=(s=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,s-48),o=(i=Or(n)).R(t);Br(o)||0<o.X(e);)o=(i=Or(n-=s)).R(t);Vr(i)&&(i=Pr),r=r.add(i),e=jr(e,o)}return new zr(r,e)}function $r(e){for(var t=e.g.length+1,n=[],s=0;s<t;s++)n[s]=e.D(s)<<1|e.D(s-1)>>>31;return new kr(n,e.h)}function Gr(e,t){var n=t>>5;t%=32;for(var s=e.g.length-n,r=[],i=0;i<s;i++)r[i]=0<t?e.D(i+n)>>>t|e.D(i+n+1)<<32-t:e.D(i+n);return new kr(r,e.h)}(Ve=kr.prototype).ea=function(){if(Br(this))return-Ur(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var s=this.D(n);e+=(0<=s?s:Rr+s)*t,t*=Rr}return e},Ve.toString=function(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(Vr(this))return"0";if(Br(this))return"-"+Ur(this).toString(e);for(var t=Or(Math.pow(e,6)),n=this,s="";;){var r=Kr(n,t).g,i=((0<(n=jr(n,r.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(Vr(n=r))return i+s;for(;6>i.length;)i="0"+i;s=i+s}},Ve.D=function(e){return 0>e?0:e<this.g.length?this.g[e]:this.h},Ve.X=function(e){return Br(e=jr(this,e))?-1:Vr(e)?0:1},Ve.abs=function(){return Br(this)?Ur(this):this},Ve.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],s=0,r=0;r<=t;r++){var i=s+(65535&this.D(r))+(65535&e.D(r)),o=(i>>>16)+(this.D(r)>>>16)+(e.D(r)>>>16);s=o>>>16,i&=65535,o&=65535,n[r]=o<<16|i}return new kr(n,-2147483648&n[n.length-1]?-1:0)},Ve.R=function(e){if(Vr(this)||Vr(e))return Lr;if(Br(this))return Br(e)?Ur(this).R(Ur(e)):Ur(Ur(this).R(e));if(Br(e))return Ur(this.R(Ur(e)));if(0>this.X(Fr)&&0>e.X(Fr))return Or(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],s=0;s<2*t;s++)n[s]=0;for(s=0;s<this.g.length;s++)for(var r=0;r<e.g.length;r++){var i=this.D(s)>>>16,o=65535&this.D(s),a=e.D(r)>>>16,c=65535&e.D(r);n[2*s+2*r]+=o*c,qr(n,2*s+2*r),n[2*s+2*r+1]+=i*c,qr(n,2*s+2*r+1),n[2*s+2*r+1]+=o*a,qr(n,2*s+2*r+1),n[2*s+2*r+2]+=i*a,qr(n,2*s+2*r+2)}for(s=0;s<t;s++)n[s]=n[2*s+1]<<16|n[2*s];for(s=t;s<2*t;s++)n[s]=0;return new kr(n,0)},Ve.gb=function(e){return Kr(this,e).h},Ve.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],s=0;s<t;s++)n[s]=this.D(s)&e.D(s);return new kr(n,this.h&e.h)},Ve.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],s=0;s<t;s++)n[s]=this.D(s)|e.D(s);return new kr(n,this.h|e.h)},Ve.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],s=0;s<t;s++)n[s]=this.D(s)^e.D(s);return new kr(n,this.h^e.h)},Tr.prototype.createWebChannel=Tr.prototype.g,_r.prototype.send=_r.prototype.u,_r.prototype.open=_r.prototype.m,_r.prototype.close=_r.prototype.close,Cn.NO_ERROR=0,Cn.TIMEOUT=8,Cn.HTTP_ERROR=6,An.COMPLETE="complete",Mn.EventType=Rn,Rn.OPEN="a",Rn.CLOSE="b",Rn.ERROR="c",Rn.MESSAGE="d",Ht.prototype.listen=Ht.prototype.O,zs.prototype.listenOnce=zs.prototype.P,zs.prototype.getLastError=zs.prototype.Sa,zs.prototype.getLastErrorCode=zs.prototype.Ia,zs.prototype.getStatus=zs.prototype.da,zs.prototype.getResponseJson=zs.prototype.Wa,zs.prototype.getResponseText=zs.prototype.ja,zs.prototype.send=zs.prototype.ha,zs.prototype.setWithCredentials=zs.prototype.Oa,Cr.prototype.digest=Cr.prototype.l,Cr.prototype.reset=Cr.prototype.reset,Cr.prototype.update=Cr.prototype.j,kr.prototype.add=kr.prototype.add,kr.prototype.multiply=kr.prototype.R,kr.prototype.modulo=kr.prototype.gb,kr.prototype.compare=kr.prototype.X,kr.prototype.toNumber=kr.prototype.ea,kr.prototype.toString=kr.prototype.toString,kr.prototype.getBits=kr.prototype.D,kr.fromNumber=Or,kr.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return Ur(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var s=Or(Math.pow(n,8)),r=Lr,i=0;i<t.length;i+=8){var o=Math.min(8,t.length-i),a=parseInt(t.substring(i,i+o),n);8>o?(o=Or(Math.pow(n,o)),r=r.R(o).add(Or(a))):r=(r=r.R(s)).add(Or(a))}return r};var Hr=Ue.createWebChannelTransport=function(){return new Tr},Qr=Ue.getStatEventTarget=function(){return En()},Wr=Ue.ErrorCode=Cn,Xr=Ue.EventType=An,Yr=Ue.Event=wn,Jr=Ue.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},Zr=Ue.FetchXmlHttpFactory=Ps,ei=Ue.WebChannel=Mn,ti=Ue.XhrIo=zs,ni=Ue.Md5=Cr,si=Ue.Integer=kr;const ri="@firebase/firestore";class ii{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}ii.UNAUTHENTICATED=new ii(null),ii.GOOGLE_CREDENTIALS=new ii("google-credentials-uid"),ii.FIRST_PARTY=new ii("first-party-uid"),ii.MOCK_USER=new ii("mock-user");let oi="9.23.0";const ai=new C("@firebase/firestore");function ci(){return ai.logLevel}function ui(e,...t){if(ai.logLevel<=T.DEBUG){const n=t.map(di);ai.debug(`Firestore (${oi}): ${e}`,...n)}}function li(e,...t){if(ai.logLevel<=T.ERROR){const n=t.map(di);ai.error(`Firestore (${oi}): ${e}`,...n)}}function hi(e,...t){if(ai.logLevel<=T.WARN){const n=t.map(di);ai.warn(`Firestore (${oi}): ${e}`,...n)}}function di(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function fi(e="Unexpected state"){const t=`FIRESTORE (${oi}) INTERNAL ASSERTION FAILED: `+e;throw li(t),new Error(t)}function gi(e,t){e||fi()}function mi(e,t){return e}const pi={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class yi extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class vi{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class wi{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class bi{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(ii.UNAUTHENTICATED)))}shutdown(){}}class Ei{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class Ii{constructor(e){this.t=e,this.currentUser=ii.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const s=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let r=new vi;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new vi,e.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const t=r;e.enqueueRetryable((async()=>{await t.promise,await s(this.currentUser)}))},o=e=>{ui("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(ui("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new vi)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(ui("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(gi("string"==typeof t.accessToken),new wi(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return gi(null===e||"string"==typeof e),new ii(e)}}class Ti{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=ii.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class _i{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new Ti(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(ii.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Si{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Di{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(e,t){const n=e=>{null!=e.error&&ui("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.T;return this.T=e.token,ui("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const s=e=>{ui("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit((e=>s(e))),setTimeout((()=>{if(!this.appCheck){const e=this.I.getImmediate({optional:!0});e?s(e):ui("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(gi("string"==typeof e.token),this.T=e.token,new Si(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function xi(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class Ci{static A(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=xi(40);for(let s=0;s<n.length;++s)t.length<20&&n[s]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[s]%62))}return t}}function Ai(e,t){return e<t?-1:e>t?1:0}function ki(e,t,n){return e.length===t.length&&e.every(((e,s)=>n(e,t[s])))}function Ni(e){return e+"\0"}class Mi{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new yi(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new yi(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new yi(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new yi(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Mi.fromMillis(Date.now())}static fromDate(e){return Mi.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Mi(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Ai(this.nanoseconds,e.nanoseconds):Ai(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Oi{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Oi(e)}static min(){return new Oi(new Mi(0,0))}static max(){return new Oi(new Mi(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Ri{constructor(e,t,n){void 0===t?t=0:t>e.length&&fi(),void 0===n?n=e.length-t:n>e.length-t&&fi(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Ri.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Ri?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let s=0;s<n;s++){const n=e.get(s),r=t.get(s);if(n<r)return-1;if(n>r)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Li extends Ri{construct(e,t,n){return new Li(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new yi(pi.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new Li(t)}static emptyPath(){return new Li([])}}const Pi=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Fi extends Ri{construct(e,t,n){return new Fi(e,t,n)}static isValidIdentifier(e){return Pi.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Fi.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Fi(["__name__"])}static fromServerFormat(e){const t=[];let n="",s=0;const r=()=>{if(0===n.length)throw new yi(pi.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;s<e.length;){const t=e[s];if("\\"===t){if(s+1===e.length)throw new yi(pi.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[s+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new yi(pi.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,s+=2}else"`"===t?(i=!i,s++):"."!==t||i?(n+=t,s++):(r(),s++)}if(r(),i)throw new yi(pi.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Fi(t)}static emptyPath(){return new Fi([])}}class Vi{constructor(e){this.path=e}static fromPath(e){return new Vi(Li.fromString(e))}static fromName(e){return new Vi(Li.fromString(e).popFirst(5))}static empty(){return new Vi(Li.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Li.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Li.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Vi(new Li(e.slice()))}}class Bi{constructor(e,t,n,s){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=s}}function Ui(e){return e.fields.find((e=>2===e.kind))}function ji(e){return e.fields.filter((e=>2!==e.kind))}Bi.UNKNOWN_ID=-1;class qi{constructor(e,t){this.fieldPath=e,this.kind=t}}class zi{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new zi(0,$i.min())}}function Ki(e){return new $i(e.readTime,e.key,-1)}class $i{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new $i(Oi.min(),Vi.empty(),-1)}static max(){return new $i(Oi.max(),Vi.empty(),-1)}}function Gi(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Vi.comparator(e.documentKey,t.documentKey),0!==n?n:Ai(e.largestBatchId,t.largestBatchId))}const Hi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Qi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function Wi(e){if(e.code!==pi.FAILED_PRECONDITION||e.message!==Hi)throw e;ui("LocalStore","Unexpectedly lost primary lease")}class Xi{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&fi(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new Xi(((n,s)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,s)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,s)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof Xi?t:Xi.resolve(t)}catch(e){return Xi.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):Xi.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):Xi.reject(t)}static resolve(e){return new Xi(((t,n)=>{t(e)}))}static reject(e){return new Xi(((t,n)=>{n(e)}))}static waitFor(e){return new Xi(((t,n)=>{let s=0,r=0,i=!1;e.forEach((e=>{++s,e.next((()=>{++r,i&&r===s&&t()}),(e=>n(e)))})),i=!0,r===s&&t()}))}static or(e){let t=Xi.resolve(!1);for(const n of e)t=t.next((e=>e?Xi.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,s)=>{n.push(t.call(this,e,s))})),this.waitFor(n)}static mapArray(e,t){return new Xi(((n,s)=>{const r=e.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const c=a;t(e[c]).next((e=>{i[c]=e,++o,o===r&&n(i)}),(e=>s(e)))}}))}static doWhile(e,t){return new Xi(((n,s)=>{const r=()=>{!0===e()?t().next((()=>{r()}),s):n()};r()}))}}class Yi{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.v=new vi,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{t.error?this.v.reject(new eo(e,t.error)):this.v.resolve()},this.transaction.onerror=t=>{const n=io(t.target.error);this.v.reject(new eo(e,n))}}static open(e,t,n,s){try{return new Yi(t,e.transaction(s,n))}catch(e){throw new eo(t,e)}}get R(){return this.v.promise}abort(e){e&&this.v.reject(e),this.aborted||(ui("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new no(t)}}class Ji{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===Ji.S(l())&&li("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return ui("SimpleDb","Removing database:",e),so(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!h())return!1;if(Ji.C())return!0;const e=l(),t=Ji.S(e),n=0<t&&t<10,s=Ji.N(e),r=0<s&&s<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||r)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.k)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(e){return this.db||(ui("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{const n=e.target.result;t(n)},s.onblocked=()=>{n(new eo(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{const s=t.target.error;"VersionError"===s.name?n(new yi(pi.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new yi(pi.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new eo(e,s))},s.onupgradeneeded=e=>{ui("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.V.O(t,s.transaction,e.oldVersion,this.version).next((()=>{ui("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(e){this.F=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,s){const r="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.$(e);const t=Yi.open(this.db,e,r?"readonly":"readwrite",n),i=s(t).next((e=>(t.P(),e))).catch((e=>(t.abort(e),Xi.reject(e)))).toPromise();return i.catch((()=>{})),await t.R,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(ui("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Zi{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return so(this.L.delete())}}class eo extends yi{constructor(e,t){super(pi.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function to(e){return"IndexedDbTransactionError"===e.name}class no{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(ui("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(ui("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),so(n)}add(e){return ui("SimpleDb","ADD",this.store.name,e,e),so(this.store.add(e))}get(e){return so(this.store.get(e)).next((t=>(void 0===t&&(t=null),ui("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return ui("SimpleDb","DELETE",this.store.name,e),so(this.store.delete(e))}count(){return ui("SimpleDb","COUNT",this.store.name),so(this.store.count())}j(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new Xi(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new Xi(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}J(e,t){ui("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;const s=this.cursor(n);return this.W(s,((e,t,n)=>n.delete()))}X(e,t){let n;t?n=e:(n={},t=e);const s=this.cursor(n);return this.W(s,t)}Z(e){const t=this.cursor({});return new Xi(((n,s)=>{t.onerror=e=>{const t=io(e.target.error);s(t)},t.onsuccess=t=>{const s=t.target.result;s?e(s.primaryKey,s.value).next((e=>{e?s.continue():n()})):n()}}))}W(e,t){const n=[];return new Xi(((s,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{const r=e.target.result;if(!r)return void s();const i=new Zi(r),o=t(r.primaryKey,r.value,i);if(o instanceof Xi){const e=o.catch((e=>(i.done(),Xi.reject(e))));n.push(e)}i.isDone?s():null===i.K?r.continue():r.continue(i.K)}})).next((()=>Xi.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function so(e){return new Xi(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=io(e.target.error);n(t)}}))}let ro=!1;function io(e){const t=Ji.S(l());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new yi("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ro||(ro=!0,setTimeout((()=>{throw e}),0)),e}}return e}class oo{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){ui("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{ui("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){to(e)?ui("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await Wi(e)}await this.et(6e4)}))}}class ao{constructor(e,t){this.localStore=e,this.persistence=t}async nt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.st(t,e)))}st(e,t){const n=new Set;let s=t,r=!0;return Xi.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return ui("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,s).next((e=>{s-=e,n.add(t)}));r=!1})))).next((()=>t-s))}it(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((s=>this.localStore.localDocuments.getNextDocuments(e,t,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(e,r).next((()=>this.rt(s,n))).next((n=>(ui("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>r.size))}))))}rt(e,t){let n=e;return t.changes.forEach(((e,t)=>{const s=Ki(t);Gi(s,n)>0&&(n=s)})),new $i(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class co{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ut&&this.ut(e),e}}function uo(e){return null==e}function lo(e){return 0===e&&1/e==-1/0}function ho(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=go(t)),t=fo(e.get(n),t);return go(t)}function fo(e,t){let n=t;const s=e.length;for(let t=0;t<s;t++){const s=e.charAt(t);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function go(e){return e+""}function mo(e){const t=e.length;if(gi(t>=2),2===t)return gi(""===e.charAt(0)&&""===e.charAt(1)),Li.emptyPath();const n=t-2,s=[];let r="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&fi(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=e.substring(i,t),r+="\0";break;case"":r+=e.substring(i,t+1);break;default:fi()}i=t+2}return new Li(s)}co.ct=-1;const po=["userId","batchId"];function yo(e,t){return[e,ho(t)]}function vo(e,t,n){return[e,ho(t),n]}const wo={},bo=["prefixPath","collectionGroup","readTime","documentId"],Eo=["prefixPath","collectionGroup","documentId"],Io=["collectionGroup","readTime","prefixPath","documentId"],To=["canonicalId","targetId"],_o=["targetId","path"],So=["path","targetId"],Do=["collectionId","parent"],xo=["indexId","uid"],Co=["uid","sequenceNumber"],Ao=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ko=["indexId","uid","orderedDocumentKey"],No=["userId","collectionPath","documentId"],Mo=["userId","collectionPath","largestBatchId"],Oo=["userId","collectionGroup","largestBatchId"],Ro=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Lo=[...Ro,"documentOverlays"],Po=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Fo=Po,Vo=[...Fo,"indexConfiguration","indexState","indexEntries"];class Bo extends Qi{constructor(e,t){super(),this.ht=e,this.currentSequenceNumber=t}}function Uo(e,t){const n=mi(e);return Ji.M(n.ht,t)}function jo(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function qo(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function zo(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Ko{constructor(e,t){this.comparator=e,this.root=t||Go.EMPTY}insert(e,t){return new Ko(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Go.BLACK,null,null))}remove(e){return new Ko(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Go.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(e,n.key);if(0===s)return t+n.left.size;s<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new $o(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new $o(this.root,e,this.comparator,!1)}getReverseIterator(){return new $o(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new $o(this.root,e,this.comparator,!0)}}class $o{constructor(e,t,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!e.isEmpty();)if(r=t?n(e.key,t):1,t&&s&&(r*=-1),r<0)e=this.isReverse?e.left:e.right;else{if(0===r){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Go{constructor(e,t,n,s,r){this.key=e,this.value=t,this.color=null!=n?n:Go.RED,this.left=null!=s?s:Go.EMPTY,this.right=null!=r?r:Go.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,s,r){return new Go(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let s=this;const r=n(e,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(e,t,n),null):0===r?s.copy(null,t,null,null,null):s.copy(null,null,null,null,s.right.insert(e,t,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return Go.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,s=this;if(t(e,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===t(e,s.key)){if(s.right.isEmpty())return Go.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Go.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Go.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw fi();if(this.right.isRed())throw fi();const e=this.left.check();if(e!==this.right.check())throw fi();return e+(this.isRed()?0:1)}}Go.EMPTY=null,Go.RED=!0,Go.BLACK=!1,Go.EMPTY=new class{constructor(){this.size=0}get key(){throw fi()}get value(){throw fi()}get color(){throw fi()}get left(){throw fi()}get right(){throw fi()}copy(e,t,n,s,r){return this}insert(e,t,n){return new Go(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ho{constructor(e){this.comparator=e,this.data=new Ko(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,e[1])>=0)return;t(s.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Qo(this.data.getIterator())}getIteratorFrom(e){return new Qo(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Ho))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(e,s))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Ho(this.comparator);return t.data=e,t}}class Qo{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Wo(e){return e.hasNext()?e.getNext():void 0}class Xo{constructor(e){this.fields=e,e.sort(Fi.comparator)}static empty(){return new Xo([])}unionWith(e){let t=new Ho(Fi.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Xo(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return ki(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Yo extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Jo{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new Yo("Invalid base64 string: "+e):e}}(e);return new Jo(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Jo(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Ai(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Jo.EMPTY_BYTE_STRING=new Jo("");const Zo=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ea(e){if(gi(!!e),"string"==typeof e){let t=0;const n=Zo.exec(e);if(gi(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const s=new Date(e);return{seconds:Math.floor(s.getTime()/1e3),nanos:t}}return{seconds:ta(e.seconds),nanos:ta(e.nanos)}}function ta(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function na(e){return"string"==typeof e?Jo.fromBase64String(e):Jo.fromUint8Array(e)}function sa(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ra(e){const t=e.mapValue.fields.__previous_value__;return sa(t)?ra(t):t}function ia(e){const t=ea(e.mapValue.fields.__local_write_time__.timestampValue);return new Mi(t.seconds,t.nanos)}class oa{constructor(e,t,n,s,r,i,o,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class aa{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new aa("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof aa&&e.projectId===this.projectId&&e.database===this.database}}const ca={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ua={nullValue:"NULL_VALUE"};function la(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?sa(e)?4:_a(e)?9007199254740991:10:fi()}function ha(e,t){if(e===t)return!0;const n=la(e);if(n!==la(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return ia(e).isEqual(ia(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=ea(e.timestampValue),s=ea(t.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return na(e.bytesValue).isEqual(na(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ta(e.geoPointValue.latitude)===ta(t.geoPointValue.latitude)&&ta(e.geoPointValue.longitude)===ta(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ta(e.integerValue)===ta(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ta(e.doubleValue),s=ta(t.doubleValue);return n===s?lo(n)===lo(s):isNaN(n)&&isNaN(s)}return!1}(e,t);case 9:return ki(e.arrayValue.values||[],t.arrayValue.values||[],ha);case 10:return function(e,t){const n=e.mapValue.fields||{},s=t.mapValue.fields||{};if(jo(n)!==jo(s))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===s[e]||!ha(n[e],s[e])))return!1;return!0}(e,t);default:return fi()}}function da(e,t){return void 0!==(e.values||[]).find((e=>ha(e,t)))}function fa(e,t){if(e===t)return 0;const n=la(e),s=la(t);if(n!==s)return Ai(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return Ai(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ta(e.integerValue||e.doubleValue),s=ta(t.integerValue||t.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(e,t);case 3:return ga(e.timestampValue,t.timestampValue);case 4:return ga(ia(e),ia(t));case 5:return Ai(e.stringValue,t.stringValue);case 6:return function(e,t){const n=na(e),s=na(t);return n.compareTo(s)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),s=t.split("/");for(let e=0;e<n.length&&e<s.length;e++){const t=Ai(n[e],s[e]);if(0!==t)return t}return Ai(n.length,s.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=Ai(ta(e.latitude),ta(t.latitude));return 0!==n?n:Ai(ta(e.longitude),ta(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],s=t.values||[];for(let e=0;e<n.length&&e<s.length;++e){const t=fa(n[e],s[e]);if(t)return t}return Ai(n.length,s.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===ca.mapValue&&t===ca.mapValue)return 0;if(e===ca.mapValue)return 1;if(t===ca.mapValue)return-1;const n=e.fields||{},s=Object.keys(n),r=t.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let e=0;e<s.length&&e<i.length;++e){const t=Ai(s[e],i[e]);if(0!==t)return t;const o=fa(n[s[e]],r[i[e]]);if(0!==o)return o}return Ai(s.length,i.length)}(e.mapValue,t.mapValue);default:throw fi()}}function ga(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Ai(e,t);const n=ea(e),s=ea(t),r=Ai(n.seconds,s.seconds);return 0!==r?r:Ai(n.nanos,s.nanos)}function ma(e){return pa(e)}function pa(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ea(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?na(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,Vi.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const s of e.values||[])n?n=!1:t+=",",t+=pa(s);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",s=!0;for(const r of t)s?s=!1:n+=",",n+=`${r}:${pa(e.fields[r])}`;return n+"}"}(e.mapValue):fi();var t,n}function ya(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function va(e){return!!e&&"integerValue"in e}function wa(e){return!!e&&"arrayValue"in e}function ba(e){return!!e&&"nullValue"in e}function Ea(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ia(e){return!!e&&"mapValue"in e}function Ta(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return qo(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Ta(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Ta(e.arrayValue.values[n]);return t}return Object.assign({},e)}function _a(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Sa(e){return"nullValue"in e?ua:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?ya(aa.empty(),Vi.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:fi()}function Da(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?ya(aa.empty(),Vi.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?ca:fi()}function xa(e,t){const n=fa(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ca(e,t){const n=fa(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Aa{constructor(e){this.value=e}static empty(){return new Aa({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Ia(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Ta(t)}setAll(e){let t=Fi.emptyPath(),n={},s=[];e.forEach(((e,r)=>{if(!t.isImmediateParentOf(r)){const e=this.getFieldsMap(t);this.applyChanges(e,n,s),n={},s=[],t=r.popLast()}e?n[r.lastSegment()]=Ta(e):s.push(r.lastSegment())}));const r=this.getFieldsMap(t);this.applyChanges(r,n,s)}delete(e){const t=this.field(e.popLast());Ia(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ha(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let s=t.mapValue.fields[e.get(n)];Ia(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=s),t=s}return t.mapValue.fields}applyChanges(e,t,n){qo(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Aa(Ta(this.value))}}function ka(e){const t=[];return qo(e.fields,((e,n)=>{const s=new Fi([e]);if(Ia(n)){const e=ka(n.mapValue).fields;if(0===e.length)t.push(s);else for(const n of e)t.push(s.child(n))}else t.push(s)})),new Xo(t)}class Na{constructor(e,t,n,s,r,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=s,this.createTime=r,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Na(e,0,Oi.min(),Oi.min(),Oi.min(),Aa.empty(),0)}static newFoundDocument(e,t,n,s){return new Na(e,1,t,Oi.min(),n,s,0)}static newNoDocument(e,t){return new Na(e,2,t,Oi.min(),Oi.min(),Aa.empty(),0)}static newUnknownDocument(e,t){return new Na(e,3,t,Oi.min(),Oi.min(),Aa.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(Oi.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Aa.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Aa.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Oi.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Na&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Na(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ma{constructor(e,t){this.position=e,this.inclusive=t}}function Oa(e,t,n){let s=0;for(let r=0;r<e.position.length;r++){const i=t[r],o=e.position[r];if(s=i.field.isKeyField()?Vi.comparator(Vi.fromName(o.referenceValue),n.key):fa(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Ra(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!ha(e.position[n],t.position[n]))return!1;return!0}class La{constructor(e,t="asc"){this.field=e,this.dir=t}}function Pa(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Fa{}class Va extends Fa{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new Qa(e,t,n):"array-contains"===t?new Ja(e,n):"in"===t?new Za(e,n):"not-in"===t?new ec(e,n):"array-contains-any"===t?new tc(e,n):new Va(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new Wa(e,n):new Xa(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(fa(t,this.value)):null!==t&&la(this.value)===la(t)&&this.matchesComparison(fa(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return fi()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Ba extends Fa{constructor(e,t){super(),this.filters=e,this.op=t,this.lt=null}static create(e,t){return new Ba(e,t)}matches(e){return Ua(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.ft((e=>e.isInequality()));return null!==e?e.field:null}ft(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Ua(e){return"and"===e.op}function ja(e){return"or"===e.op}function qa(e){return za(e)&&Ua(e)}function za(e){for(const t of e.filters)if(t instanceof Ba)return!1;return!0}function Ka(e){if(e instanceof Va)return e.field.canonicalString()+e.op.toString()+ma(e.value);if(qa(e))return e.filters.map((e=>Ka(e))).join(",");{const t=e.filters.map((e=>Ka(e))).join(",");return`${e.op}(${t})`}}function $a(e,t){return e instanceof Va?function(e,t){return t instanceof Va&&e.op===t.op&&e.field.isEqual(t.field)&&ha(e.value,t.value)}(e,t):e instanceof Ba?function(e,t){return t instanceof Ba&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,s)=>e&&$a(n,t.filters[s])),!0)}(e,t):void fi()}function Ga(e,t){const n=e.filters.concat(t);return Ba.create(n,e.op)}function Ha(e){return e instanceof Va?function(e){return`${e.field.canonicalString()} ${e.op} ${ma(e.value)}`}(e):e instanceof Ba?function(e){return e.op.toString()+" {"+e.getFilters().map(Ha).join(" ,")+"}"}(e):"Filter"}class Qa extends Va{constructor(e,t,n){super(e,t,n),this.key=Vi.fromName(n.referenceValue)}matches(e){const t=Vi.comparator(e.key,this.key);return this.matchesComparison(t)}}class Wa extends Va{constructor(e,t){super(e,"in",t),this.keys=Ya(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Xa extends Va{constructor(e,t){super(e,"not-in",t),this.keys=Ya(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Ya(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>Vi.fromName(e.referenceValue)))}class Ja extends Va{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return wa(t)&&da(t.arrayValue,this.value)}}class Za extends Va{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&da(this.value.arrayValue,t)}}class ec extends Va{constructor(e,t){super(e,"not-in",t)}matches(e){if(da(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!da(this.value.arrayValue,t)}}class tc extends Va{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!wa(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>da(this.value.arrayValue,e)))}}class nc{constructor(e,t=null,n=[],s=[],r=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.dt=null}}function sc(e,t=null,n=[],s=[],r=null,i=null,o=null){return new nc(e,t,n,s,r,i,o)}function rc(e){const t=mi(e);if(null===t.dt){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>Ka(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),uo(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>ma(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>ma(e))).join(",")),t.dt=e}return t.dt}function ic(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Pa(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!$a(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ra(e.startAt,t.startAt)&&Ra(e.endAt,t.endAt)}function oc(e){return Vi.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function ac(e,t){return e.filters.filter((e=>e instanceof Va&&e.field.isEqual(t)))}function cc(e,t,n){let s=ua,r=!0;for(const n of ac(e,t)){let e=ua,t=!0;switch(n.op){case"<":case"<=":e=Sa(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=ua}xa({value:s,inclusive:r},{value:e,inclusive:t})<0&&(s=e,r=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];xa({value:s,inclusive:r},{value:e,inclusive:n.inclusive})<0&&(s=e,r=n.inclusive);break}return{value:s,inclusive:r}}function uc(e,t,n){let s=ca,r=!0;for(const n of ac(e,t)){let e=ca,t=!0;switch(n.op){case">=":case">":e=Da(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=ca}Ca({value:s,inclusive:r},{value:e,inclusive:t})>0&&(s=e,r=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ca({value:s,inclusive:r},{value:e,inclusive:n.inclusive})>0&&(s=e,r=n.inclusive);break}return{value:s,inclusive:r}}class lc{constructor(e,t=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.wt=null,this._t=null,this.startAt,this.endAt}}function hc(e){return new lc(e)}function dc(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function fc(e){const t=mi(e);if(null===t.wt){t.wt=[];const e=function(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}(t),n=function(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}(t);if(null!==e&&null===n)e.isKeyField()||t.wt.push(new La(e)),t.wt.push(new La(Fi.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.wt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.wt.push(new La(Fi.keyField(),e))}}}return t.wt}function gc(e){const t=mi(e);if(!t._t)if("F"===t.limitType)t._t=sc(t.path,t.collectionGroup,fc(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of fc(t)){const t="desc"===n.dir?"asc":"desc";e.push(new La(n.field,t))}const n=t.endAt?new Ma(t.endAt.position,t.endAt.inclusive):null,s=t.startAt?new Ma(t.startAt.position,t.startAt.inclusive):null;t._t=sc(t.path,t.collectionGroup,e,t.filters,t.limit,n,s)}return t._t}function mc(e,t,n){return new lc(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function pc(e,t){return ic(gc(e),gc(t))&&e.limitType===t.limitType}function yc(e){return`${rc(gc(e))}|lt:${e.limitType}`}function vc(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>Ha(e))).join(", ")}]`),uo(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>ma(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>ma(e))).join(",")),`Target(${t})`}(gc(e))}; limitType=${e.limitType})`}function wc(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Vi.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of fc(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const s=Oa(e,t,n);return e.inclusive?s<=0:s<0}(e.startAt,fc(e),t)||e.endAt&&!function(e,t,n){const s=Oa(e,t,n);return e.inclusive?s>=0:s>0}(e.endAt,fc(e),t))}(e,t)}function bc(e){return(t,n)=>{let s=!1;for(const r of fc(e)){const e=Ec(r,t,n);if(0!==e)return e;s=s||r.field.isKeyField()}return 0}}function Ec(e,t,n){const s=e.field.isKeyField()?Vi.comparator(t.key,n.key):function(e,t,n){const s=t.data.field(e),r=n.data.field(e);return null!==s&&null!==r?fa(s,r):fi()}(e.field,t,n);switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return fi()}}class Ic{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,s]of n)if(this.equalsFn(t,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),s=this.inner[n];if(void 0===s)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],e))return void(s[n]=[e,t]);s.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],e))return 1===n.length?delete this.inner[t]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(e){qo(this.inner,((t,n)=>{for(const[t,s]of n)e(t,s)}))}isEmpty(){return zo(this.inner)}size(){return this.innerSize}}const Tc=new Ko(Vi.comparator);function _c(){return Tc}const Sc=new Ko(Vi.comparator);function Dc(...e){let t=Sc;for(const n of e)t=t.insert(n.key,n);return t}function xc(e){let t=Sc;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Cc(){return kc()}function Ac(){return kc()}function kc(){return new Ic((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Nc=new Ko(Vi.comparator),Mc=new Ho(Vi.comparator);function Oc(...e){let t=Mc;for(const n of e)t=t.add(n);return t}const Rc=new Ho(Ai);function Lc(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:lo(t)?"-0":t}}function Pc(e){return{integerValue:""+e}}function Fc(e,t){return function(e){return"number"==typeof e&&Number.isInteger(e)&&!lo(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}(t)?Pc(t):Lc(e,t)}class Vc{constructor(){this._=void 0}}function Bc(e,t,n){return e instanceof qc?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&sa(t)&&(t=ra(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof zc?Kc(e,t):e instanceof $c?Gc(e,t):function(e,t){const n=jc(e,t),s=Qc(n)+Qc(e.gt);return va(n)&&va(e.gt)?Pc(s):Lc(e.serializer,s)}(e,t)}function Uc(e,t,n){return e instanceof zc?Kc(e,t):e instanceof $c?Gc(e,t):n}function jc(e,t){return e instanceof Hc?va(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class qc extends Vc{}class zc extends Vc{constructor(e){super(),this.elements=e}}function Kc(e,t){const n=Wc(t);for(const t of e.elements)n.some((e=>ha(e,t)))||n.push(t);return{arrayValue:{values:n}}}class $c extends Vc{constructor(e){super(),this.elements=e}}function Gc(e,t){let n=Wc(t);for(const t of e.elements)n=n.filter((e=>!ha(e,t)));return{arrayValue:{values:n}}}class Hc extends Vc{constructor(e,t){super(),this.serializer=e,this.gt=t}}function Qc(e){return ta(e.integerValue||e.doubleValue)}function Wc(e){return wa(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Xc{constructor(e,t){this.field=e,this.transform=t}}class Yc{constructor(e,t){this.version=e,this.transformResults=t}}class Jc{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Jc}static exists(e){return new Jc(void 0,e)}static updateTime(e){return new Jc(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Zc(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class eu{}function tu(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new hu(e.key,Jc.none()):new ou(e.key,e.data,Jc.none());{const n=e.data,s=Aa.empty();let r=new Ho(Fi.comparator);for(let e of t.fields)if(!r.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?s.delete(e):s.set(e,t),r=r.add(e)}return new au(e.key,s,new Xo(r.toArray()),Jc.none())}}function nu(e,t,n){e instanceof ou?function(e,t,n){const s=e.value.clone(),r=uu(e.fieldTransforms,t,n.transformResults);s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):e instanceof au?function(e,t,n){if(!Zc(e.precondition,t))return void t.convertToUnknownDocument(n.version);const s=uu(e.fieldTransforms,t,n.transformResults),r=t.data;r.setAll(cu(e)),r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function su(e,t,n,s){return e instanceof ou?function(e,t,n,s){if(!Zc(e.precondition,t))return n;const r=e.value.clone(),i=lu(e.fieldTransforms,s,t);return r.setAll(i),t.convertToFoundDocument(t.version,r).setHasLocalMutations(),null}(e,t,n,s):e instanceof au?function(e,t,n,s){if(!Zc(e.precondition,t))return n;const r=lu(e.fieldTransforms,s,t),i=t.data;return i.setAll(cu(e)),i.setAll(r),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,s):function(e,t,n){return Zc(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function ru(e,t){let n=null;for(const s of e.fieldTransforms){const e=t.data.field(s.field),r=jc(s.transform,e||null);null!=r&&(null===n&&(n=Aa.empty()),n.set(s.field,r))}return n||null}function iu(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&ki(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof zc&&t instanceof zc||e instanceof $c&&t instanceof $c?ki(e.elements,t.elements,ha):e instanceof Hc&&t instanceof Hc?ha(e.gt,t.gt):e instanceof qc&&t instanceof qc}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class ou extends eu{constructor(e,t,n,s=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class au extends eu{constructor(e,t,n,s,r=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function cu(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=e.data.field(n);t.set(n,s)}})),t}function uu(e,t,n){const s=new Map;gi(e.length===n.length);for(let r=0;r<n.length;r++){const i=e[r],o=i.transform,a=t.data.field(i.field);s.set(i.field,Uc(o,a,n[r]))}return s}function lu(e,t,n){const s=new Map;for(const r of e){const e=r.transform,i=n.data.field(r.field);s.set(r.field,Bc(e,i,t))}return s}class hu extends eu{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class du extends eu{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class fu{constructor(e,t,n,s){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const s=this.mutations[t];s.key.isEqual(e.key)&&nu(s,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=su(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=su(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Ac();return this.mutations.forEach((s=>{const r=e.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=t.has(s.key)?null:o;const a=tu(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(Oi.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Oc())}isEqual(e){return this.batchId===e.batchId&&ki(this.mutations,e.mutations,((e,t)=>iu(e,t)))&&ki(this.baseMutations,e.baseMutations,((e,t)=>iu(e,t)))}}class gu{constructor(e,t,n,s){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=s}static from(e,t,n){gi(e.mutations.length===n.length);let s=Nc;const r=e.mutations;for(let e=0;e<r.length;e++)s=s.insert(r[e].key,n[e].version);return new gu(e,t,n,s)}}class mu{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class pu{constructor(e,t){this.count=e,this.unchangedNames=t}}var yu,vu;function wu(e){if(void 0===e)return li("GRPC error has no .code"),pi.UNKNOWN;switch(e){case yu.OK:return pi.OK;case yu.CANCELLED:return pi.CANCELLED;case yu.UNKNOWN:return pi.UNKNOWN;case yu.DEADLINE_EXCEEDED:return pi.DEADLINE_EXCEEDED;case yu.RESOURCE_EXHAUSTED:return pi.RESOURCE_EXHAUSTED;case yu.INTERNAL:return pi.INTERNAL;case yu.UNAVAILABLE:return pi.UNAVAILABLE;case yu.UNAUTHENTICATED:return pi.UNAUTHENTICATED;case yu.INVALID_ARGUMENT:return pi.INVALID_ARGUMENT;case yu.NOT_FOUND:return pi.NOT_FOUND;case yu.ALREADY_EXISTS:return pi.ALREADY_EXISTS;case yu.PERMISSION_DENIED:return pi.PERMISSION_DENIED;case yu.FAILED_PRECONDITION:return pi.FAILED_PRECONDITION;case yu.ABORTED:return pi.ABORTED;case yu.OUT_OF_RANGE:return pi.OUT_OF_RANGE;case yu.UNIMPLEMENTED:return pi.UNIMPLEMENTED;case yu.DATA_LOSS:return pi.DATA_LOSS;default:return fi()}}(vu=yu||(yu={}))[vu.OK=0]="OK",vu[vu.CANCELLED=1]="CANCELLED",vu[vu.UNKNOWN=2]="UNKNOWN",vu[vu.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",vu[vu.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",vu[vu.NOT_FOUND=5]="NOT_FOUND",vu[vu.ALREADY_EXISTS=6]="ALREADY_EXISTS",vu[vu.PERMISSION_DENIED=7]="PERMISSION_DENIED",vu[vu.UNAUTHENTICATED=16]="UNAUTHENTICATED",vu[vu.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",vu[vu.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",vu[vu.ABORTED=10]="ABORTED",vu[vu.OUT_OF_RANGE=11]="OUT_OF_RANGE",vu[vu.UNIMPLEMENTED=12]="UNIMPLEMENTED",vu[vu.INTERNAL=13]="INTERNAL",vu[vu.UNAVAILABLE=14]="UNAVAILABLE",vu[vu.DATA_LOSS=15]="DATA_LOSS";class bu{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Eu}static getOrCreateInstance(){return null===Eu&&(Eu=new bu),Eu}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(e){this.onExistenceFilterMismatchCallbacks.forEach((t=>t(e)))}}let Eu=null;const Iu=new si([4294967295,4294967295],0);function Tu(e){const t=(new TextEncoder).encode(e),n=new ni;return n.update(t),new Uint8Array(n.digest())}function _u(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),s=t.getUint32(4,!0),r=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new si([n,s],0),new si([r,i],0)]}class Su{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Du(`Invalid padding: ${t}`);if(n<0)throw new Du(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Du(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Du(`Invalid padding when bitmap length is 0: ${t}`);this.It=8*e.length-t,this.Tt=si.fromNumber(this.It)}Et(e,t,n){let s=e.add(t.multiply(si.fromNumber(n)));return 1===s.compare(Iu)&&(s=new si([s.getBits(0),s.getBits(1)],0)),s.modulo(this.Tt).toNumber()}At(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}vt(e){if(0===this.It)return!1;const t=Tu(e),[n,s]=_u(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,s,e);if(!this.At(t))return!1}return!0}static create(e,t,n){const s=e%8==0?0:8-e%8,r=new Uint8Array(Math.ceil(e/8)),i=new Su(r,s,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.It)return;const t=Tu(e),[n,s]=_u(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,s,e);this.Rt(t)}}Rt(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Du extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class xu{constructor(e,t,n,s,r){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const s=new Map;return s.set(e,Cu.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new xu(Oi.min(),s,new Ko(Ai),_c(),Oc())}}class Cu{constructor(e,t,n,s,r){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Cu(n,t,Oc(),Oc(),Oc())}}class Au{constructor(e,t,n,s){this.Pt=e,this.removedTargetIds=t,this.key=n,this.bt=s}}class ku{constructor(e,t){this.targetId=e,this.Vt=t}}class Nu{constructor(e,t,n=Jo.EMPTY_BYTE_STRING,s=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=s}}class Mu{constructor(){this.St=0,this.Dt=Lu(),this.Ct=Jo.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(e){e.approximateByteSize()>0&&(this.Nt=!0,this.Ct=e)}Ot(){let e=Oc(),t=Oc(),n=Oc();return this.Dt.forEach(((s,r)=>{switch(r){case 0:e=e.add(s);break;case 2:t=t.add(s);break;case 1:n=n.add(s);break;default:fi()}})),new Cu(this.Ct,this.xt,e,t,n)}Ft(){this.Nt=!1,this.Dt=Lu()}Bt(e,t){this.Nt=!0,this.Dt=this.Dt.insert(e,t)}Lt(e){this.Nt=!0,this.Dt=this.Dt.remove(e)}qt(){this.St+=1}Ut(){this.St-=1}Kt(){this.Nt=!0,this.xt=!0}}class Ou{constructor(e){this.Gt=e,this.Qt=new Map,this.jt=_c(),this.zt=Ru(),this.Wt=new Ko(Ai)}Ht(e){for(const t of e.Pt)e.bt&&e.bt.isFoundDocument()?this.Jt(t,e.bt):this.Yt(t,e.key,e.bt);for(const t of e.removedTargetIds)this.Yt(t,e.key,e.bt)}Xt(e){this.forEachTarget(e,(t=>{const n=this.Zt(t);switch(e.state){case 0:this.te(t)&&n.$t(e.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(e.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(t);break;case 3:this.te(t)&&(n.Kt(),n.$t(e.resumeToken));break;case 4:this.te(t)&&(this.ee(t),n.$t(e.resumeToken));break;default:fi()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Qt.forEach(((e,n)=>{this.te(n)&&t(n)}))}ne(e){var t;const n=e.targetId,s=e.Vt.count,r=this.se(n);if(r){const i=r.target;if(oc(i))if(0===s){const e=new Vi(i.path);this.Yt(n,e,Na.newNoDocument(e,Oi.min()))}else gi(1===s);else{const r=this.ie(n);if(r!==s){const s=this.re(e,r);if(0!==s){this.ee(n);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(n,e)}null===(t=bu.instance)||void 0===t||t.notifyOnExistenceFilterMismatch(function(e,t,n){var s,r,i,o,a,c;const u={localCacheCount:t,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(u.bloomFilter={applied:0===e,hashCount:null!==(s=null==l?void 0:l.hashCount)&&void 0!==s?s:0,bitmapLength:null!==(o=null===(i=null===(r=null==l?void 0:l.bits)||void 0===r?void 0:r.bitmap)||void 0===i?void 0:i.length)&&void 0!==o?o:0,padding:null!==(c=null===(a=null==l?void 0:l.bits)||void 0===a?void 0:a.padding)&&void 0!==c?c:0}),u}(s,r,e.Vt))}}}}re(e,t){const{unchangedNames:n,count:s}=e.Vt;if(!n||!n.bits)return 1;const{bits:{bitmap:r="",padding:i=0},hashCount:o=0}=n;let a,c;try{a=na(r).toUint8Array()}catch(e){if(e instanceof Yo)return hi("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{c=new Su(a,i,o)}catch(e){return hi(e instanceof Du?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===c.It?1:s!==t-this.oe(e.targetId,c)?2:0}oe(e,t){const n=this.Gt.getRemoteKeysForTarget(e);let s=0;return n.forEach((n=>{const r=this.Gt.ue(),i=`projects/${r.projectId}/databases/${r.database}/documents/${n.path.canonicalString()}`;t.vt(i)||(this.Yt(e,n,null),s++)})),s}ce(e){const t=new Map;this.Qt.forEach(((n,s)=>{const r=this.se(s);if(r){if(n.current&&oc(r.target)){const t=new Vi(r.target.path);null!==this.jt.get(t)||this.ae(s,t)||this.Yt(s,t,Na.newNoDocument(t,e))}n.Mt&&(t.set(s,n.Ot()),n.Ft())}}));let n=Oc();this.zt.forEach(((e,t)=>{let s=!0;t.forEachWhile((e=>{const t=this.se(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(s=!1,!1)})),s&&(n=n.add(e))})),this.jt.forEach(((t,n)=>n.setReadTime(e)));const s=new xu(e,t,this.Wt,this.jt,n);return this.jt=_c(),this.zt=Ru(),this.Wt=new Ko(Ai),s}Jt(e,t){if(!this.te(e))return;const n=this.ae(e,t.key)?2:0;this.Zt(e).Bt(t.key,n),this.jt=this.jt.insert(t.key,t),this.zt=this.zt.insert(t.key,this.he(t.key).add(e))}Yt(e,t,n){if(!this.te(e))return;const s=this.Zt(e);this.ae(e,t)?s.Bt(t,1):s.Lt(t),this.zt=this.zt.insert(t,this.he(t).delete(e)),n&&(this.jt=this.jt.insert(t,n))}removeTarget(e){this.Qt.delete(e)}ie(e){const t=this.Zt(e).Ot();return this.Gt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}qt(e){this.Zt(e).qt()}Zt(e){let t=this.Qt.get(e);return t||(t=new Mu,this.Qt.set(e,t)),t}he(e){let t=this.zt.get(e);return t||(t=new Ho(Ai),this.zt=this.zt.insert(e,t)),t}te(e){const t=null!==this.se(e);return t||ui("WatchChangeAggregator","Detected inactive target",e),t}se(e){const t=this.Qt.get(e);return t&&t.kt?null:this.Gt.le(e)}ee(e){this.Qt.set(e,new Mu),this.Gt.getRemoteKeysForTarget(e).forEach((t=>{this.Yt(e,t,null)}))}ae(e,t){return this.Gt.getRemoteKeysForTarget(e).has(t)}}function Ru(){return new Ko(Vi.comparator)}function Lu(){return new Ko(Vi.comparator)}const Pu={asc:"ASCENDING",desc:"DESCENDING"},Fu={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Vu={and:"AND",or:"OR"};class Bu{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Uu(e,t){return e.useProto3Json||uo(t)?t:{value:t}}function ju(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function qu(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function zu(e,t){return ju(e,t.toTimestamp())}function Ku(e){return gi(!!e),Oi.fromTimestamp(function(e){const t=ea(e);return new Mi(t.seconds,t.nanos)}(e))}function $u(e,t){return function(e){return new Li(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Gu(e){const t=Li.fromString(e);return gi(fl(t)),t}function Hu(e,t){return $u(e.databaseId,t.path)}function Qu(e,t){const n=Gu(t);if(n.get(1)!==e.databaseId.projectId)throw new yi(pi.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new yi(pi.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Vi(Ju(n))}function Wu(e,t){return $u(e.databaseId,t)}function Xu(e){const t=Gu(e);return 4===t.length?Li.emptyPath():Ju(t)}function Yu(e){return new Li(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ju(e){return gi(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Zu(e,t,n){return{name:Hu(e,t),fields:n.value.mapValue.fields}}function el(e,t){let n;if(t instanceof ou)n={update:Zu(e,t.key,t.value)};else if(t instanceof hu)n={delete:Hu(e,t.key)};else if(t instanceof au)n={update:Zu(e,t.key,t.data),updateMask:dl(t.fieldMask)};else{if(!(t instanceof du))return fi();n={verify:Hu(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof qc)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof zc)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof $c)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Hc)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw fi()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:zu(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:fi()}(e,t.precondition)),n}function tl(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Jc.updateTime(Ku(e.updateTime)):void 0!==e.exists?Jc.exists(e.exists):Jc.none()}(t.currentDocument):Jc.none(),s=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)gi("REQUEST_TIME"===t.setToServerValue),n=new qc;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new zc(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new $c(e)}else"increment"in t?n=new Hc(e,t.increment):fi();const s=Fi.fromServerFormat(t.fieldPath);return new Xc(s,n)}(e,t))):[];if(t.update){t.update.name;const r=Qu(e,t.update.name),i=new Aa({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new Xo(t.map((e=>Fi.fromServerFormat(e))))}(t.updateMask);return new au(r,i,e,n,s)}return new ou(r,i,n,s)}if(t.delete){const s=Qu(e,t.delete);return new hu(s,n)}if(t.verify){const s=Qu(e,t.verify);return new du(s,n)}return fi()}function nl(e,t){return{documents:[Wu(e,t.path)]}}function sl(e,t){const n={structuredQuery:{}},s=t.path;null!==t.collectionGroup?(n.parent=Wu(e,s),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Wu(e,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(e){if(0!==e.length)return hl(Ba.create(e,"and"))}(t.filters);r&&(n.structuredQuery.where=r);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:ul(e.field),direction:ol(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=Uu(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function rl(e){let t=Xu(e.parent);const n=e.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){gi(1===s);const e=n.from[0];e.allDescendants?r=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=il(e);return t instanceof Ba&&qa(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new La(ll(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,uo(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Ma(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Ma(n,t)}(n.endAt)),function(e,t,n,s,r,i,o,a){return new lc(e,t,n,s,r,i,o,a)}(t,r,o,i,a,"F",c,u)}function il(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=ll(e.unaryFilter.field);return Va.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=ll(e.unaryFilter.field);return Va.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=ll(e.unaryFilter.field);return Va.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=ll(e.unaryFilter.field);return Va.create(r,"!=",{nullValue:"NULL_VALUE"});default:return fi()}}(e):void 0!==e.fieldFilter?function(e){return Va.create(ll(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return fi()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Ba.create(e.compositeFilter.filters.map((e=>il(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return fi()}}(e.compositeFilter.op))}(e):fi()}function ol(e){return Pu[e]}function al(e){return Fu[e]}function cl(e){return Vu[e]}function ul(e){return{fieldPath:e.canonicalString()}}function ll(e){return Fi.fromServerFormat(e.fieldPath)}function hl(e){return e instanceof Va?function(e){if("=="===e.op){if(Ea(e.value))return{unaryFilter:{field:ul(e.field),op:"IS_NAN"}};if(ba(e.value))return{unaryFilter:{field:ul(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ea(e.value))return{unaryFilter:{field:ul(e.field),op:"IS_NOT_NAN"}};if(ba(e.value))return{unaryFilter:{field:ul(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ul(e.field),op:al(e.op),value:e.value}}}(e):e instanceof Ba?function(e){const t=e.getFilters().map((e=>hl(e)));return 1===t.length?t[0]:{compositeFilter:{op:cl(e.op),filters:t}}}(e):fi()}function dl(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function fl(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class gl{constructor(e,t,n,s,r=Oi.min(),i=Oi.min(),o=Jo.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new gl(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ml{constructor(e){this.fe=e}}function pl(e,t){const n=t.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:yl(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())s.document=function(e,t){return{name:Hu(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ju(e,t.version.toTimestamp()),createTime:ju(e,t.createTime.toTimestamp())}}(e.fe,t);else if(t.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:vl(t.version)};else{if(!t.isUnknownDocument())return fi();s.unknownDocument={path:n.path.toArray(),version:vl(t.version)}}return s}function yl(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function vl(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function wl(e){const t=new Mi(e.seconds,e.nanoseconds);return Oi.fromTimestamp(t)}function bl(e,t){const n=(t.baseMutations||[]).map((t=>tl(e.fe,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const s=t.mutations[e+1];n.updateTransforms=s.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const s=t.mutations.map((t=>tl(e.fe,t))),r=Mi.fromMillis(t.localWriteTimeMs);return new fu(t.batchId,r,n,s)}function El(e){const t=wl(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?wl(e.lastLimboFreeSnapshotVersion):Oi.min();let s;var r;return void 0!==e.query.documents?(gi(1===(r=e.query).documents.length),s=gc(hc(Xu(r.documents[0])))):s=function(e){return gc(rl(e))}(e.query),new gl(s,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,Jo.fromBase64String(e.resumeToken))}function Il(e,t){const n=vl(t.snapshotVersion),s=vl(t.lastLimboFreeSnapshotVersion);let r;r=oc(t.target)?nl(e.fe,t.target):sl(e.fe,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:rc(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Tl(e){const t=rl({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?mc(t,t.limit,"L"):t}function _l(e,t){return new mu(t.largestBatchId,tl(e.fe,t.overlayMutation))}function Sl(e,t){const n=t.path.lastSegment();return[e,ho(t.path.popLast()),n]}function Dl(e,t,n,s){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:vl(s.readTime),documentKey:ho(s.documentKey.path),largestBatchId:s.largestBatchId}}class xl{getBundleMetadata(e,t){return Cl(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:wl(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return Cl(e).put({bundleId:(n=t).id,createTime:vl(Ku(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Al(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Tl(t.bundledQuery),readTime:wl(t.readTime)};var t}))}saveNamedQuery(e,t){return Al(e).put(function(e){return{name:e.name,readTime:vl(Ku(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Cl(e){return Uo(e,"bundles")}function Al(e){return Uo(e,"namedQueries")}class kl{constructor(e,t){this.serializer=e,this.userId=t}static de(e,t){const n=t.uid||"";return new kl(e,n)}getOverlay(e,t){return Nl(e).get(Sl(this.userId,t)).next((e=>e?_l(this.serializer,e):null))}getOverlays(e,t){const n=Cc();return Xi.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const s=[];return n.forEach(((n,r)=>{const i=new mu(t,r);s.push(this.we(e,i))})),Xi.waitFor(s)}removeOverlaysForBatchId(e,t,n){const s=new Set;t.forEach((e=>s.add(ho(e.getCollectionPath()))));const r=[];return s.forEach((t=>{const s=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);r.push(Nl(e).J("collectionPathOverlayIndex",s))})),Xi.waitFor(r)}getOverlaysForCollection(e,t,n){const s=Cc(),r=ho(t),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return Nl(e).j("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=_l(this.serializer,t);s.set(e.getKey(),e)}return s}))}getOverlaysForCollectionGroup(e,t,n,s){const r=Cc();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Nl(e).X({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=_l(this.serializer,t);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}we(e,t){return Nl(e).put(function(e,t,n){const[s,r,i]=Sl(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:el(e.fe,n.mutation)}}(this.serializer,this.userId,t))}}function Nl(e){return Uo(e,"documentOverlays")}class Ml{constructor(){}_e(e,t){this.me(e,t),t.ge()}me(e,t){if("nullValue"in e)this.ye(t,5);else if("booleanValue"in e)this.ye(t,10),t.pe(e.booleanValue?1:0);else if("integerValue"in e)this.ye(t,15),t.pe(ta(e.integerValue));else if("doubleValue"in e){const n=ta(e.doubleValue);isNaN(n)?this.ye(t,13):(this.ye(t,15),lo(n)?t.pe(0):t.pe(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ye(t,20),"string"==typeof n?t.Ie(n):(t.Ie(`${n.seconds||""}`),t.pe(n.nanos||0))}else if("stringValue"in e)this.Te(e.stringValue,t),this.Ee(t);else if("bytesValue"in e)this.ye(t,30),t.Ae(na(e.bytesValue)),this.Ee(t);else if("referenceValue"in e)this.ve(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ye(t,45),t.pe(n.latitude||0),t.pe(n.longitude||0)}else"mapValue"in e?_a(e)?this.ye(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Ee(t)):"arrayValue"in e?(this.Pe(e.arrayValue,t),this.Ee(t)):fi()}Te(e,t){this.ye(t,25),this.be(e,t)}be(e,t){t.Ie(e)}Re(e,t){const n=e.fields||{};this.ye(t,55);for(const e of Object.keys(n))this.Te(e,t),this.me(n[e],t)}Pe(e,t){const n=e.values||[];this.ye(t,50);for(const e of n)this.me(e,t)}ve(e,t){this.ye(t,37),Vi.fromName(e).path.forEach((e=>{this.ye(t,60),this.be(e,t)}))}ye(e,t){e.pe(t)}Ee(e){e.pe(2)}}function Ol(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}function Rl(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const s=Ol(255&e[n]);if(t+=s,8!==s)break}return t}(e);return Math.ceil(t/8)}Ml.Ve=new Ml;class Ll{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.De(n.value),n=t.next();this.Ce()}xe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ne(n.value),n=t.next();this.ke()}Me(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.De(e);else if(e<2048)this.De(960|e>>>6),this.De(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.De(480|e>>>12),this.De(128|63&e>>>6),this.De(128|63&e);else{const e=t.codePointAt(0);this.De(240|e>>>18),this.De(128|63&e>>>12),this.De(128|63&e>>>6),this.De(128|63&e)}}this.Ce()}$e(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ne(e);else if(e<2048)this.Ne(960|e>>>6),this.Ne(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ne(480|e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e);else{const e=t.codePointAt(0);this.Ne(240|e>>>18),this.Ne(128|63&e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e)}}this.ke()}Oe(e){const t=this.Fe(e),n=Rl(t);this.Be(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Le(e){const t=this.Fe(e),n=Rl(t);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(e){this.Be(e.length),this.buffer.set(e,this.position),this.position+=e.length}Qe(){return this.buffer.slice(0,this.position)}Fe(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}De(e){const t=255&e;0===t?(this.Ue(0),this.Ue(255)):255===t?(this.Ue(255),this.Ue(0)):this.Ue(t)}Ne(e){const t=255&e;0===t?(this.Ge(0),this.Ge(255)):255===t?(this.Ge(255),this.Ge(0)):this.Ge(e)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(e){this.Be(1),this.buffer[this.position++]=e}Ge(e){this.Be(1),this.buffer[this.position++]=~e}Be(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Pl{constructor(e){this.je=e}Ae(e){this.je.Se(e)}Ie(e){this.je.Me(e)}pe(e){this.je.Oe(e)}ge(){this.je.qe()}}class Fl{constructor(e){this.je=e}Ae(e){this.je.xe(e)}Ie(e){this.je.$e(e)}pe(e){this.je.Le(e)}ge(){this.je.Ke()}}class Vl{constructor(){this.je=new Ll,this.ze=new Pl(this.je),this.We=new Fl(this.je)}seed(e){this.je.seed(e)}He(e){return 0===e?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class Bl{constructor(e,t,n,s){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=s}Je(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Bl(this.indexId,this.documentKey,this.arrayValue,n)}}function Ul(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=jl(e.arrayValue,t.arrayValue),0!==n?n:(n=jl(e.directionalValue,t.directionalValue),0!==n?n:Vi.comparator(e.documentKey,t.documentKey)))}function jl(e,t){for(let n=0;n<e.length&&n<t.length;++n){const s=e[n]-t[n];if(0!==s)return s}return e.length-t.length}class ql{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ye=e.orderBy,this.Xe=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ze=e:this.Xe.push(e)}}tn(e){gi(e.collectionGroup===this.collectionId);const t=Ui(e);if(void 0!==t&&!this.en(t))return!1;const n=ji(e);let s=new Set,r=0,i=0;for(;r<n.length&&this.en(n[r]);++r)s=s.add(n[r].fieldPath.canonicalString());if(r===n.length)return!0;if(void 0!==this.Ze){if(!s.has(this.Ze.field.canonicalString())){const e=n[r];if(!this.nn(this.Ze,e)||!this.sn(this.Ye[i++],e))return!1}++r}for(;r<n.length;++r){const e=n[r];if(i>=this.Ye.length||!this.sn(this.Ye[i++],e))return!1}return!0}en(e){for(const t of this.Xe)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function zl(e){var t,n;if(gi(e instanceof Va||e instanceof Ba),e instanceof Va){if(e instanceof Za){const s=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>Va.create(e.field,"==",t))))||[];return Ba.create(s,"or")}return e}const s=e.filters.map((e=>zl(e)));return Ba.create(s,e.op)}function Kl(e){if(0===e.getFilters().length)return[];const t=Ql(zl(e));return gi(Hl(t)),$l(t)||Gl(t)?[t]:t.getFilters()}function $l(e){return e instanceof Va}function Gl(e){return e instanceof Ba&&qa(e)}function Hl(e){return $l(e)||Gl(e)||function(e){if(e instanceof Ba&&ja(e)){for(const t of e.getFilters())if(!$l(t)&&!Gl(t))return!1;return!0}return!1}(e)}function Ql(e){if(gi(e instanceof Va||e instanceof Ba),e instanceof Va)return e;if(1===e.filters.length)return Ql(e.filters[0]);const t=e.filters.map((e=>Ql(e)));let n=Ba.create(t,e.op);return n=Yl(n),Hl(n)?n:(gi(n instanceof Ba),gi(Ua(n)),gi(n.filters.length>1),n.filters.reduce(((e,t)=>Wl(e,t))))}function Wl(e,t){let n;return gi(e instanceof Va||e instanceof Ba),gi(t instanceof Va||t instanceof Ba),n=e instanceof Va?t instanceof Va?function(e,t){return Ba.create([e,t],"and")}(e,t):Xl(e,t):t instanceof Va?Xl(t,e):function(e,t){if(gi(e.filters.length>0&&t.filters.length>0),Ua(e)&&Ua(t))return Ga(e,t.getFilters());const n=ja(e)?e:t,s=ja(e)?t:e,r=n.filters.map((e=>Wl(e,s)));return Ba.create(r,"or")}(e,t),Yl(n)}function Xl(e,t){if(Ua(t))return Ga(t,e.getFilters());{const n=t.filters.map((t=>Wl(e,t)));return Ba.create(n,"or")}}function Yl(e){if(gi(e instanceof Va||e instanceof Ba),e instanceof Va)return e;const t=e.getFilters();if(1===t.length)return Yl(t[0]);if(za(e))return e;const n=t.map((e=>Yl(e))),s=[];return n.forEach((t=>{t instanceof Va?s.push(t):t instanceof Ba&&(t.op===e.op?s.push(...t.filters):s.push(t))})),1===s.length?s[0]:Ba.create(s,e.op)}class Jl{constructor(){this.rn=new Zl}addToCollectionParentIndex(e,t){return this.rn.add(t),Xi.resolve()}getCollectionParents(e,t){return Xi.resolve(this.rn.getEntries(t))}addFieldIndex(e,t){return Xi.resolve()}deleteFieldIndex(e,t){return Xi.resolve()}getDocumentsMatchingTarget(e,t){return Xi.resolve(null)}getIndexType(e,t){return Xi.resolve(0)}getFieldIndexes(e,t){return Xi.resolve([])}getNextCollectionGroupToUpdate(e){return Xi.resolve(null)}getMinOffset(e,t){return Xi.resolve($i.min())}getMinOffsetFromCollectionGroup(e,t){return Xi.resolve($i.min())}updateCollectionGroup(e,t,n){return Xi.resolve()}updateIndexEntries(e,t){return Xi.resolve()}}class Zl{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t]||new Ho(Li.comparator),r=!s.has(n);return this.index[t]=s.add(n),r}has(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t];return s&&s.has(n)}getEntries(e){return(this.index[e]||new Ho(Li.comparator)).toArray()}}const eh=new Uint8Array(0);class th{constructor(e,t){this.user=e,this.databaseId=t,this.on=new Zl,this.un=new Ic((e=>rc(e)),((e,t)=>ic(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.on.has(t)){const n=t.lastSegment(),s=t.popLast();e.addOnCommittedListener((()=>{this.on.add(t)}));const r={collectionId:n,parent:ho(s)};return nh(e).put(r)}return Xi.resolve()}getCollectionParents(e,t){const n=[],s=IDBKeyRange.bound([t,""],[Ni(t),""],!1,!0);return nh(e).j(s).next((e=>{for(const s of e){if(s.collectionId!==t)break;n.push(mo(s.parent))}return n}))}addFieldIndex(e,t){const n=rh(e),s=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete s.indexId;const r=n.add(s);if(t.indexState){const n=ih(e);return r.next((e=>{n.put(Dl(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return r.next()}deleteFieldIndex(e,t){const n=rh(e),s=ih(e),r=sh(e);return n.delete(t.indexId).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=sh(e);let s=!0;const r=new Map;return Xi.forEach(this.cn(t),(t=>this.an(e,t).next((e=>{s&&(s=!!e),r.set(t,e)})))).next((()=>{if(s){let e=Oc();const s=[];return Xi.forEach(r,((r,i)=>{var o;ui("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${rc(t)}`);const a=function(e,t){const n=Ui(t);if(void 0===n)return null;for(const t of ac(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,r),c=function(e,t){const n=new Map;for(const s of ji(t))for(const t of ac(e,s.fieldPath))switch(t.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,r),u=function(e,t){const n=[];let s=!0;for(const r of ji(t)){const t=0===r.kind?cc(e,r.fieldPath,e.startAt):uc(e,r.fieldPath,e.startAt);n.push(t.value),s&&(s=t.inclusive)}return new Ma(n,s)}(i,r),l=function(e,t){const n=[];let s=!0;for(const r of ji(t)){const t=0===r.kind?uc(e,r.fieldPath,e.endAt):cc(e,r.fieldPath,e.endAt);n.push(t.value),s&&(s=t.inclusive)}return new Ma(n,s)}(i,r),h=this.hn(r,i,u),d=this.hn(r,i,l),f=this.ln(r,i,c),g=this.fn(r.indexId,a,h,u.inclusive,d,l.inclusive,f);return Xi.forEach(g,(r=>n.H(r,t.limit).next((t=>{t.forEach((t=>{const n=Vi.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),s.push(n))}))}))))})).next((()=>s))}return Xi.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:Kl(Ba.create(e.filters,"and")).map((t=>sc(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}fn(e,t,n,s,r,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,r.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.dn(t[l/c]):eh,h=this.wn(e,a,n[l%c],s),d=this._n(e,a,r[l%c],i),f=o.map((t=>this.wn(e,a,t,!0)));u.push(...this.createRange(h,d,f))}return u}wn(e,t,n,s){const r=new Bl(e,Vi.empty(),t,n);return s?r:r.Je()}_n(e,t,n,s){const r=new Bl(e,Vi.empty(),t,n);return s?r.Je():r}an(e,t){const n=new ql(t),s=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,s).next((e=>{let t=null;for(const s of e)n.tn(s)&&(!t||s.fields.length>t.fields.length)&&(t=s);return t}))}getIndexType(e,t){let n=2;const s=this.cn(t);return Xi.forEach(s,(t=>this.an(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Ho(Fi.comparator),n=!1;for(const s of e.filters)for(const e of s.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&s.length>1&&2===n?1:n))}mn(e,t){const n=new Vl;for(const s of ji(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;const r=n.He(s.kind);Ml.Ve._e(e,r)}return n.Qe()}dn(e){const t=new Vl;return Ml.Ve._e(e,t.He(0)),t.Qe()}gn(e,t){const n=new Vl;return Ml.Ve._e(ya(this.databaseId,t),n.He(function(e){const t=ji(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Qe()}ln(e,t,n){if(null===n)return[];let s=[];s.push(new Vl);let r=0;for(const i of ji(e)){const e=n[r++];for(const n of s)if(this.yn(t,i.fieldPath)&&wa(e))s=this.pn(s,i,e);else{const t=n.He(i.kind);Ml.Ve._e(e,t)}}return this.In(s)}hn(e,t,n){return this.ln(e,t,n.position)}In(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Qe();return t}pn(e,t,n){const s=[...e],r=[];for(const e of n.arrayValue.values||[])for(const n of s){const s=new Vl;s.seed(n.Qe()),Ml.Ve._e(e,s.He(t.kind)),r.push(s)}return r}yn(e,t){return!!e.filters.find((e=>e instanceof Va&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=rh(e),s=ih(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next((e=>{const t=[];return Xi.forEach(e,(e=>s.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new zi(t.sequenceNumber,new $i(wl(t.readTime),new Vi(mo(t.documentKey)),t.largestBatchId)):zi.empty(),s=e.fields.map((([e,t])=>new qi(Fi.fromServerFormat(e),t)));return new Bi(e.indexId,e.collectionGroup,s,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:Ai(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const s=rh(e),r=ih(e);return this.Tn(e).next((e=>s.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>Xi.forEach(t,(t=>r.put(Dl(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return Xi.forEach(t,((t,s)=>{const r=n.get(t.collectionGroup);return(r?Xi.resolve(r):this.getFieldIndexes(e,t.collectionGroup)).next((r=>(n.set(t.collectionGroup,r),Xi.forEach(r,(n=>this.En(e,t,n).next((t=>{const r=this.An(s,n);return t.isEqual(r)?Xi.resolve():this.vn(e,s,n,t,r)})))))))}))}Rn(e,t,n,s){return sh(e).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.gn(n,t.key),documentKey:t.key.path.toArray()})}Pn(e,t,n,s){return sh(e).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.gn(n,t.key),t.key.path.toArray()])}En(e,t,n){const s=sh(e);let r=new Ho(Ul);return s.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,t)])},((e,s)=>{r=r.add(new Bl(n.indexId,t,s.arrayValue,s.directionalValue))})).next((()=>r))}An(e,t){let n=new Ho(Ul);const s=this.mn(t,e);if(null==s)return n;const r=Ui(t);if(null!=r){const i=e.data.field(r.fieldPath);if(wa(i))for(const r of i.arrayValue.values||[])n=n.add(new Bl(t.indexId,e.key,this.dn(r),s))}else n=n.add(new Bl(t.indexId,e.key,eh,s));return n}vn(e,t,n,s,r){ui("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,s,r){const i=e.getIterator(),o=t.getIterator();let a=Wo(i),c=Wo(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const s=n(a,c);s<0?t=!0:s>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(s(c),c=Wo(o)):t?(r(a),a=Wo(i)):(a=Wo(i),c=Wo(o))}}(s,r,Ul,(s=>{i.push(this.Rn(e,t,n,s))}),(s=>{i.push(this.Pn(e,t,n,s))})),Xi.waitFor(i)}Tn(e){let t=1;return ih(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,s)=>{s.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Ul(e,t))).filter(((e,t,n)=>!t||0!==Ul(e,n[t-1])));const s=[];s.push(e);for(const r of n){const n=Ul(r,e),i=Ul(r,t);if(0===n)s[0]=e.Je();else if(n>0&&i<0)s.push(r),s.push(r.Je());else if(i>0)break}s.push(t);const r=[];for(let e=0;e<s.length;e+=2){if(this.bn(s[e],s[e+1]))return[];const t=[s[e].indexId,this.uid,s[e].arrayValue,s[e].directionalValue,eh,[]],n=[s[e+1].indexId,this.uid,s[e+1].arrayValue,s[e+1].directionalValue,eh,[]];r.push(IDBKeyRange.bound(t,n))}return r}bn(e,t){return Ul(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(oh)}getMinOffset(e,t){return Xi.mapArray(this.cn(t),(t=>this.an(e,t).next((e=>e||fi())))).next(oh)}}function nh(e){return Uo(e,"collectionParents")}function sh(e){return Uo(e,"indexEntries")}function rh(e){return Uo(e,"indexConfiguration")}function ih(e){return Uo(e,"indexState")}function oh(e){gi(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){const r=e[s].indexState.offset;Gi(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new $i(t.readTime,t.documentKey,n)}const ah={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ch{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new ch(e,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function uh(e,t,n){const s=e.store("mutations"),r=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=s.X({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{gi(1===a)})));const u=[];for(const e of n.mutations){const s=vo(t,e.key.path,n.batchId);i.push(r.delete(s)),u.push(e.key)}return Xi.waitFor(i).next((()=>u))}function lh(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw fi();t=e.noDocument}return JSON.stringify(t).length}ch.DEFAULT_COLLECTION_PERCENTILE=10,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ch.DEFAULT=new ch(41943040,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ch.DISABLED=new ch(-1,0,0);class hh{constructor(e,t,n,s){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=s,this.Vn={}}static de(e,t,n,s){gi(""!==e.uid);const r=e.isAuthenticated()?e.uid:"";return new hh(r,t,n,s)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return fh(e).X({index:"userMutationsIndex",range:n},((e,n,s)=>{t=!1,s.done()})).next((()=>t))}addMutationBatch(e,t,n,s){const r=gh(e),i=fh(e);return i.add({}).next((o=>{gi("number"==typeof o);const a=new fu(o,t,n,s),c=function(e,t,n){const s=n.baseMutations.map((t=>el(e.fe,t))),r=n.mutations.map((t=>el(e.fe,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.serializer,this.userId,a),u=[];let l=new Ho(((e,t)=>Ai(e.canonicalString(),t.canonicalString())));for(const e of s){const t=vo(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(r.put(t,wo))}return l.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Vn[o]=a.keys()})),Xi.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return fh(e).get(t).next((e=>e?(gi(e.userId===this.userId),bl(this.serializer,e)):null))}Sn(e,t){return this.Vn[t]?Xi.resolve(this.Vn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Vn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return fh(e).X({index:"userMutationsIndex",range:s},((e,t,s)=>{t.userId===this.userId&&(gi(t.batchId>=n),r=bl(this.serializer,t)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return fh(e).X({index:"userMutationsIndex",range:t,reverse:!0},((e,t,s)=>{n=t.batchId,s.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return fh(e).j("userMutationsIndex",t).next((e=>e.map((e=>bl(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=yo(this.userId,t.path),s=IDBKeyRange.lowerBound(n),r=[];return gh(e).X({range:s},((n,s,i)=>{const[o,a,c]=n,u=mo(a);if(o===this.userId&&t.path.isEqual(u))return fh(e).get(c).next((e=>{if(!e)throw fi();gi(e.userId===this.userId),r.push(bl(this.serializer,e))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ho(Ai);const s=[];return t.forEach((t=>{const r=yo(this.userId,t.path),i=IDBKeyRange.lowerBound(r),o=gh(e).X({range:i},((e,s,r)=>{const[i,o,a]=e,c=mo(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):r.done()}));s.push(o)})),Xi.waitFor(s).next((()=>this.Dn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1,r=yo(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Ho(Ai);return gh(e).X({range:i},((e,t,r)=>{const[i,a,c]=e,u=mo(a);i===this.userId&&n.isPrefixOf(u)?u.length===s&&(o=o.add(c)):r.done()})).next((()=>this.Dn(e,o)))}Dn(e,t){const n=[],s=[];return t.forEach((t=>{s.push(fh(e).get(t).next((e=>{if(null===e)throw fi();gi(e.userId===this.userId),n.push(bl(this.serializer,e))})))})),Xi.waitFor(s).next((()=>n))}removeMutationBatch(e,t){return uh(e.ht,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Cn(t.batchId)})),Xi.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Cn(e){delete this.Vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return Xi.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return gh(e).X({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=mo(e[1]);s.push(t)}else n.done()})).next((()=>{gi(0===s.length)}))}))}containsKey(e,t){return dh(e,this.userId,t)}xn(e){return mh(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function dh(e,t,n){const s=yo(t,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return gh(e).X({range:i,Y:!0},((e,n,s)=>{const[i,a,c]=e;i===t&&a===r&&(o=!0),s.done()})).next((()=>o))}function fh(e){return Uo(e,"mutations")}function gh(e){return Uo(e,"documentMutations")}function mh(e){return Uo(e,"mutationQueues")}class ph{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static kn(){return new ph(0)}static Mn(){return new ph(-1)}}class yh{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.$n(e).next((t=>{const n=new ph(t.highestTargetId);return t.highestTargetId=n.next(),this.On(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.$n(e).next((e=>Oi.fromTimestamp(new Mi(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.$n(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.$n(e).next((s=>(s.highestListenSequenceNumber=t,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),t>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=t),this.On(e,s))))}addTargetData(e,t){return this.Fn(e,t).next((()=>this.$n(e).next((n=>(n.targetCount+=1,this.Bn(t,n),this.On(e,n))))))}updateTargetData(e,t){return this.Fn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>vh(e).delete(t.targetId))).next((()=>this.$n(e))).next((t=>(gi(t.targetCount>0),t.targetCount-=1,this.On(e,t))))}removeTargets(e,t,n){let s=0;const r=[];return vh(e).X(((i,o)=>{const a=El(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(e,a)))})).next((()=>Xi.waitFor(r))).next((()=>s))}forEachTarget(e,t){return vh(e).X(((e,n)=>{const s=El(n);t(s)}))}$n(e){return wh(e).get("targetGlobalKey").next((e=>(gi(null!==e),e)))}On(e,t){return wh(e).put("targetGlobalKey",t)}Fn(e,t){return vh(e).put(Il(this.serializer,t))}Bn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.$n(e).next((e=>e.targetCount))}getTargetData(e,t){const n=rc(t),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return vh(e).X({range:s,index:"queryTargetsIndex"},((e,n,s)=>{const i=El(n);ic(t,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(e,t,n){const s=[],r=bh(e);return t.forEach((t=>{const i=ho(t.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(e,n,t))})),Xi.waitFor(s)}removeMatchingKeys(e,t,n){const s=bh(e);return Xi.forEach(t,(t=>{const r=ho(t.path);return Xi.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=bh(e),s=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),s=bh(e);let r=Oc();return s.X({range:n,Y:!0},((e,t,n)=>{const s=mo(e[1]),i=new Vi(s);r=r.add(i)})).next((()=>r))}containsKey(e,t){const n=ho(t.path),s=IDBKeyRange.bound([n],[Ni(n)],!1,!0);let r=0;return bh(e).X({index:"documentTargetsIndex",Y:!0,range:s},(([e,t],n,s)=>{0!==e&&(r++,s.done())})).next((()=>r>0))}le(e,t){return vh(e).get(t).next((e=>e?El(e):null))}}function vh(e){return Uo(e,"targets")}function wh(e){return Uo(e,"targetGlobal")}function bh(e){return Uo(e,"targetDocuments")}function Eh([e,t],[n,s]){const r=Ai(e,n);return 0===r?Ai(t,s):r}class Ih{constructor(e){this.Ln=e,this.buffer=new Ho(Eh),this.qn=0}Un(){return++this.qn}Kn(e){const t=[e,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Eh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Th{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(e){ui("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){to(e)?ui("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await Wi(e)}await this.Qn(3e5)}))}}class _h{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.zn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return Xi.resolve(co.ct);const n=new Ih(t);return this.jn.forEachTarget(e,(e=>n.Kn(e.sequenceNumber))).next((()=>this.jn.Wn(e,(e=>n.Kn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(ui("LruGarbageCollector","Garbage collection skipped; disabled"),Xi.resolve(ah)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(ui("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ah):this.Hn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Hn(e,t){let n,s,r,i,o,a,c;const u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(ui("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),s=this.params.maximumSequenceNumbersToCollect):s=t,i=Date.now(),this.nthSequenceNumber(e,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(e,n,t)))).next((t=>(r=t,a=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),ci()<=T.DEBUG&&ui("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-u}ms\n\tDetermined least recently used ${s} in `+(o-i)+"ms\n"+`\tRemoved ${r} targets in `+(a-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-a)+"ms\n"+`Total Duration: ${c-u}ms`),Xi.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:e}))))}}class Sh{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new _h(e,t)}(this,t)}zn(e){const t=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Jn(e){let t=0;return this.Wn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Wn(e,t){return this.Yn(e,((e,n)=>t(n)))}addReference(e,t,n){return Dh(e,n)}removeReference(e,t,n){return Dh(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Dh(e,t)}Xn(e,t){return function(e,t){let n=!1;return mh(e).Z((s=>dh(e,s,t).next((e=>(e&&(n=!0),Xi.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Yn(e,((i,o)=>{if(o<=t){const t=this.Xn(e,i).next((t=>{if(!t)return r++,n.getEntry(e,i).next((()=>(n.removeEntry(i,Oi.min()),bh(e).delete([0,ho(i.path)]))))}));s.push(t)}})).next((()=>Xi.waitFor(s))).next((()=>n.apply(e))).next((()=>r))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Dh(e,t)}Yn(e,t){const n=bh(e);let s,r=co.ct;return n.X({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(r!==co.ct&&t(new Vi(mo(s)),r),r=o,s=i):r=co.ct})).next((()=>{r!==co.ct&&t(new Vi(mo(s)),r)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Dh(e,t){return bh(e).put(function(e,t){return{targetId:0,path:ho(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class xh{constructor(){this.changes=new Ic((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Na.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?Xi.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Ch{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Mh(e).put(n)}removeEntry(e,t,n){return Mh(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],yl(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Zn(e,n))))}getEntry(e,t){let n=Na.newInvalidDocument(t);return Mh(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Oh(t))},((e,s)=>{n=this.ts(t,s)})).next((()=>n))}es(e,t){let n={size:0,document:Na.newInvalidDocument(t)};return Mh(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Oh(t))},((e,s)=>{n={document:this.ts(t,s),size:lh(s)}})).next((()=>n))}getEntries(e,t){let n=_c();return this.ns(e,t,((e,t)=>{const s=this.ts(e,t);n=n.insert(e,s)})).next((()=>n))}ss(e,t){let n=_c(),s=new Ko(Vi.comparator);return this.ns(e,t,((e,t)=>{const r=this.ts(e,t);n=n.insert(e,r),s=s.insert(e,lh(t))})).next((()=>({documents:n,rs:s})))}ns(e,t,n){if(t.isEmpty())return Xi.resolve();let s=new Ho(Lh);t.forEach((e=>s=s.add(e)));const r=IDBKeyRange.bound(Oh(s.first()),Oh(s.last())),i=s.getIterator();let o=i.getNext();return Mh(e).X({index:"documentKeyIndex",range:r},((e,t,s)=>{const r=Vi.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&Lh(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?s.G(Oh(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,s){const r=t.path,i=[r.popLast().toArray(),r.lastSegment(),yl(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[r.popLast().toArray(),r.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Mh(e).j(IDBKeyRange.bound(i,o,!0)).next((e=>{let n=_c();for(const r of e){const e=this.ts(Vi.fromSegments(r.prefixPath.concat(r.collectionGroup,r.documentId)),r);e.isFoundDocument()&&(wc(t,e)||s.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,s){let r=_c();const i=Rh(t,n),o=Rh(t,$i.max());return Mh(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.ts(Vi.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(e){return new kh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Nh(e).get("remoteDocumentGlobalKey").next((e=>(gi(!!e),e)))}Zn(e,t){return Nh(e).put("remoteDocumentGlobalKey",t)}ts(e,t){if(t){const e=function(e,t){let n;if(t.document)n=function(e,t,n){const s=Qu(e,t.name),r=Ku(t.updateTime),i=t.createTime?Ku(t.createTime):Oi.min(),o=new Aa({mapValue:{fields:t.fields}}),a=Na.newFoundDocument(s,r,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}(e.fe,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Vi.fromSegments(t.noDocument.path),s=wl(t.noDocument.readTime);n=Na.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return fi();{const e=Vi.fromSegments(t.unknownDocument.path),s=wl(t.unknownDocument.version);n=Na.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(function(e){const t=new Mi(e[0],e[1]);return Oi.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(Oi.min()))return e}return Na.newInvalidDocument(e)}}function Ah(e){return new Ch(e)}class kh extends xh{constructor(e,t){super(),this.os=e,this.trackRemovals=t,this.us=new Ic((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,s=new Ho(((e,t)=>Ai(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.us.get(r);if(t.push(this.os.removeEntry(e,r,o.readTime)),i.isValidDocument()){const a=pl(this.os.serializer,i);s=s.add(r.path.popLast());const c=lh(a);n+=c-o.size,t.push(this.os.addEntry(e,r,a))}else if(n-=o.size,this.trackRemovals){const n=pl(this.os.serializer,i.convertToNoDocument(Oi.min()));t.push(this.os.addEntry(e,r,n))}})),s.forEach((n=>{t.push(this.os.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.os.updateMetadata(e,n)),Xi.waitFor(t)}getFromCache(e,t){return this.os.es(e,t).next((e=>(this.us.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.os.ss(e,t).next((({documents:e,rs:t})=>(t.forEach(((t,n)=>{this.us.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Nh(e){return Uo(e,"remoteDocumentGlobal")}function Mh(e){return Uo(e,"remoteDocumentsV14")}function Oh(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Rh(e,t){const n=t.documentKey.path.toArray();return[e,yl(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Lh(e,t){const n=e.path.toArray(),s=t.path.toArray();let r=0;for(let e=0;e<n.length-2&&e<s.length-2;++e)if(r=Ai(n[e],s[e]),r)return r;return r=Ai(n.length,s.length),r||(r=Ai(n[n.length-2],s[s.length-2]),r||Ai(n[n.length-1],s[s.length-1]))}class Ph{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Fh{constructor(e,t,n,s){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=s}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((s=>(n=s,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&su(n.mutation,e,Xo.empty(),Mi.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Oc()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Oc()){const s=Cc();return this.populateOverlays(e,s,t).next((()=>this.computeViews(e,t,s,n).next((e=>{let t=Dc();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Cc();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Oc())))}populateOverlays(e,t,n){const s=[];return n.forEach((e=>{t.has(e)||s.push(e)})),this.documentOverlayCache.getOverlays(e,s).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,s){let r=_c();const i=kc(),o=kc();return t.forEach(((e,t)=>{const o=n.get(t.key);s.has(t.key)&&(void 0===o||o.mutation instanceof au)?r=r.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),su(o.mutation,t,o.mutation.getFieldMask(),Mi.now())):i.set(t.key,Xo.empty())})),this.recalculateAndSaveOverlays(e,r).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new Ph(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=kc();let s=new Ko(((e,t)=>e-t)),r=Oc();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const r of e)r.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||Xo.empty();o=r.applyToLocalView(i,o),n.set(e,o);const a=(s.get(r.batchId)||Oc()).add(e);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,c=s.value,u=Ac();c.forEach((e=>{if(!r.has(e)){const s=tu(t.get(e),n.get(e));null!==s&&u.set(e,s),r=r.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return Xi.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return Vi.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):function(e){return null!==e.collectionGroup}(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,s-r.size):Xi.resolve(Cc());let o=-1,a=r;return i.next((t=>Xi.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(t)?Xi.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,r))).next((()=>this.computeViews(e,a,t,Oc()))).next((e=>({batchId:o,changes:xc(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Vi(t)).next((e=>{let t=Dc();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const s=t.collectionGroup;let r=Dc();return this.indexManager.getCollectionParents(e,s).next((i=>Xi.forEach(i,(i=>{const o=function(e,t){return new lc(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(s));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{r=r.insert(e,t)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(e,t,n){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((r=>(s=r,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s)))).next((e=>{s.forEach(((t,n)=>{const s=n.getKey();null===e.get(s)&&(e=e.insert(s,Na.newInvalidDocument(s)))}));let n=Dc();return e.forEach(((e,r)=>{const i=s.get(e);void 0!==i&&su(i.mutation,r,Xo.empty(),Mi.now()),wc(t,r)&&(n=n.insert(e,r))})),n}))}}class Vh{constructor(e){this.serializer=e,this.cs=new Map,this.hs=new Map}getBundleMetadata(e,t){return Xi.resolve(this.cs.get(t))}saveBundleMetadata(e,t){var n;return this.cs.set(t.id,{id:(n=t).id,version:n.version,createTime:Ku(n.createTime)}),Xi.resolve()}getNamedQuery(e,t){return Xi.resolve(this.hs.get(t))}saveNamedQuery(e,t){return this.hs.set(t.name,function(e){return{name:e.name,query:Tl(e.bundledQuery),readTime:Ku(e.readTime)}}(t)),Xi.resolve()}}class Bh{constructor(){this.overlays=new Ko(Vi.comparator),this.ls=new Map}getOverlay(e,t){return Xi.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Cc();return Xi.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,s)=>{this.we(e,t,s)})),Xi.resolve()}removeOverlaysForBatchId(e,t,n){const s=this.ls.get(n);return void 0!==s&&(s.forEach((e=>this.overlays=this.overlays.remove(e))),this.ls.delete(n)),Xi.resolve()}getOverlaysForCollection(e,t,n){const s=Cc(),r=t.length+1,i=new Vi(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===r&&e.largestBatchId>n&&s.set(e.getKey(),e)}return Xi.resolve(s)}getOverlaysForCollectionGroup(e,t,n,s){let r=new Ko(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=r.get(e.largestBatchId);null===t&&(t=Cc(),r=r.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Cc(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=s)););return Xi.resolve(o)}we(e,t,n){const s=this.overlays.get(n.key);if(null!==s){const e=this.ls.get(s.largestBatchId).delete(n.key);this.ls.set(s.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new mu(t,n));let r=this.ls.get(t);void 0===r&&(r=Oc(),this.ls.set(t,r)),this.ls.set(t,r.add(n.key))}}class Uh{constructor(){this.fs=new Ho(jh.ds),this.ws=new Ho(jh._s)}isEmpty(){return this.fs.isEmpty()}addReference(e,t){const n=new jh(e,t);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.ys(new jh(e,t))}ps(e,t){e.forEach((e=>this.removeReference(e,t)))}Is(e){const t=new Vi(new Li([])),n=new jh(t,e),s=new jh(t,e+1),r=[];return this.ws.forEachInRange([n,s],(e=>{this.ys(e),r.push(e.key)})),r}Ts(){this.fs.forEach((e=>this.ys(e)))}ys(e){this.fs=this.fs.delete(e),this.ws=this.ws.delete(e)}Es(e){const t=new Vi(new Li([])),n=new jh(t,e),s=new jh(t,e+1);let r=Oc();return this.ws.forEachInRange([n,s],(e=>{r=r.add(e.key)})),r}containsKey(e){const t=new jh(e,0),n=this.fs.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class jh{constructor(e,t){this.key=e,this.As=t}static ds(e,t){return Vi.comparator(e.key,t.key)||Ai(e.As,t.As)}static _s(e,t){return Ai(e.As,t.As)||Vi.comparator(e.key,t.key)}}class qh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.vs=1,this.Rs=new Ho(jh.ds)}checkEmpty(e){return Xi.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,s){const r=this.vs;this.vs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new fu(r,t,n,s);this.mutationQueue.push(i);for(const t of s)this.Rs=this.Rs.add(new jh(t.key,r)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return Xi.resolve(i)}lookupMutationBatch(e,t){return Xi.resolve(this.Ps(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=this.bs(n),r=s<0?0:s;return Xi.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Xi.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(e){return Xi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new jh(t,0),s=new jh(t,Number.POSITIVE_INFINITY),r=[];return this.Rs.forEachInRange([n,s],(e=>{const t=this.Ps(e.As);r.push(t)})),Xi.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ho(Ai);return t.forEach((e=>{const t=new jh(e,0),s=new jh(e,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([t,s],(e=>{n=n.add(e.As)}))})),Xi.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1;let r=n;Vi.isDocumentKey(r)||(r=r.child(""));const i=new jh(new Vi(r),0);let o=new Ho(Ai);return this.Rs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===s&&(o=o.add(e.As)),!0)}),i),Xi.resolve(this.Vs(o))}Vs(e){const t=[];return e.forEach((e=>{const n=this.Ps(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){gi(0===this.Ss(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return Xi.forEach(t.mutations,(s=>{const r=new jh(s.key,t.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(e,s.key)})).next((()=>{this.Rs=n}))}Cn(e){}containsKey(e,t){const n=new jh(t,0),s=this.Rs.firstAfterOrEqual(n);return Xi.resolve(t.isEqual(s&&s.key))}performConsistencyCheck(e){return this.mutationQueue.length,Xi.resolve()}Ss(e,t){return this.bs(e)}bs(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Ps(e){const t=this.bs(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class zh{constructor(e){this.Ds=e,this.docs=new Ko(Vi.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,s=this.docs.get(n),r=s?s.size:0,i=this.Ds(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Xi.resolve(n?n.document.mutableCopy():Na.newInvalidDocument(t))}getEntries(e,t){let n=_c();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Na.newInvalidDocument(e))})),Xi.resolve(n)}getDocumentsMatchingQuery(e,t,n,s){let r=_c();const i=t.path,o=new Vi(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||Gi(Ki(o),n)<=0||(s.has(o.key)||wc(t,o))&&(r=r.insert(o.key,o.mutableCopy()))}return Xi.resolve(r)}getAllFromCollectionGroup(e,t,n,s){fi()}Cs(e,t){return Xi.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Kh(this)}getSize(e){return Xi.resolve(this.size)}}class Kh extends xh{constructor(e){super(),this.os=e}applyChanges(e){const t=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?t.push(this.os.addEntry(e,s)):this.os.removeEntry(n)})),Xi.waitFor(t)}getFromCache(e,t){return this.os.getEntry(e,t)}getAllFromCache(e,t){return this.os.getEntries(e,t)}}class $h{constructor(e){this.persistence=e,this.xs=new Ic((e=>rc(e)),ic),this.lastRemoteSnapshotVersion=Oi.min(),this.highestTargetId=0,this.Ns=0,this.ks=new Uh,this.targetCount=0,this.Ms=ph.kn()}forEachTarget(e,t){return this.xs.forEach(((e,n)=>t(n))),Xi.resolve()}getLastRemoteSnapshotVersion(e){return Xi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Xi.resolve(this.Ns)}allocateTargetId(e){return this.highestTargetId=this.Ms.next(),Xi.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Ns&&(this.Ns=t),Xi.resolve()}Fn(e){this.xs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Ms=new ph(t),this.highestTargetId=t),e.sequenceNumber>this.Ns&&(this.Ns=e.sequenceNumber)}addTargetData(e,t){return this.Fn(t),this.targetCount+=1,Xi.resolve()}updateTargetData(e,t){return this.Fn(t),Xi.resolve()}removeTargetData(e,t){return this.xs.delete(t.target),this.ks.Is(t.targetId),this.targetCount-=1,Xi.resolve()}removeTargets(e,t,n){let s=0;const r=[];return this.xs.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.xs.delete(i),r.push(this.removeMatchingKeysForTargetId(e,o.targetId)),s++)})),Xi.waitFor(r).next((()=>s))}getTargetCount(e){return Xi.resolve(this.targetCount)}getTargetData(e,t){const n=this.xs.get(t)||null;return Xi.resolve(n)}addMatchingKeys(e,t,n){return this.ks.gs(t,n),Xi.resolve()}removeMatchingKeys(e,t,n){this.ks.ps(t,n);const s=this.persistence.referenceDelegate,r=[];return s&&t.forEach((t=>{r.push(s.markPotentiallyOrphaned(e,t))})),Xi.waitFor(r)}removeMatchingKeysForTargetId(e,t){return this.ks.Is(t),Xi.resolve()}getMatchingKeysForTargetId(e,t){const n=this.ks.Es(t);return Xi.resolve(n)}containsKey(e,t){return Xi.resolve(this.ks.containsKey(t))}}class Gh{constructor(e,t){this.$s={},this.overlays={},this.Os=new co(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=e(this),this.Bs=new $h(this),this.indexManager=new Jl,this.remoteDocumentCache=function(e){return new zh(e)}((e=>this.referenceDelegate.Ls(e))),this.serializer=new ml(t),this.qs=new Vh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Bh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.$s[e.toKey()];return n||(n=new qh(t,this.referenceDelegate),this.$s[e.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(e,t,n){ui("MemoryPersistence","Starting transaction:",e);const s=new Hh(this.Os.next());return this.referenceDelegate.Us(),n(s).next((e=>this.referenceDelegate.Ks(s).next((()=>e)))).toPromise().then((e=>(s.raiseOnCommittedEvent(),e)))}Gs(e,t){return Xi.or(Object.values(this.$s).map((n=>()=>n.containsKey(e,t))))}}class Hh extends Qi{constructor(e){super(),this.currentSequenceNumber=e}}class Qh{constructor(e){this.persistence=e,this.Qs=new Uh,this.js=null}static zs(e){return new Qh(e)}get Ws(){if(this.js)return this.js;throw fi()}addReference(e,t,n){return this.Qs.addReference(n,t),this.Ws.delete(n.toString()),Xi.resolve()}removeReference(e,t,n){return this.Qs.removeReference(n,t),this.Ws.add(n.toString()),Xi.resolve()}markPotentiallyOrphaned(e,t){return this.Ws.add(t.toString()),Xi.resolve()}removeTarget(e,t){this.Qs.Is(t.targetId).forEach((e=>this.Ws.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ws.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Us(){this.js=new Set}Ks(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Xi.forEach(this.Ws,(n=>{const s=Vi.fromPath(n);return this.Hs(e,s).next((e=>{e||t.removeEntry(s,Oi.min())}))})).next((()=>(this.js=null,t.apply(e))))}updateLimboDocument(e,t){return this.Hs(e,t).next((e=>{e?this.Ws.delete(t.toString()):this.Ws.add(t.toString())}))}Ls(e){return 0}Hs(e,t){return Xi.or([()=>Xi.resolve(this.Qs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gs(e,t)])}}class Wh{constructor(e){this.serializer=e}O(e,t,n,s){const r=new Yi("createOrUpgrade",t);n<1&&s>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",po,{unique:!0}),e.createObjectStore("documentMutations")}(e),Xh(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=Xi.resolve();return n<3&&s>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Xh(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Oi.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").j().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",po,{unique:!0});const s=t.store("mutations"),r=n.map((e=>s.put(e)));return Xi.waitFor(r)}))}(e,r)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&s>=5&&(i=i.next((()=>this.Ys(r)))),n<6&&s>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Xs(r))))),n<7&&s>=7&&(i=i.next((()=>this.Zs(r)))),n<8&&s>=8&&(i=i.next((()=>this.ti(e,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&s>=10&&(i=i.next((()=>this.ei(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&s>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:No});t.createIndex("collectionPathOverlayIndex",Mo,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Oo,{unique:!1})}(e)}))),n<13&&s>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:bo});t.createIndex("documentKeyIndex",Eo),t.createIndex("collectionGroupIndex",Io)}(e))).next((()=>this.ni(e,r))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.si(e,r)))),n<15&&s>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:xo}).createIndex("sequenceNumberIndex",Co,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ao}).createIndex("documentKeyIndex",ko,{unique:!1})}(e)))),i}Xs(e){let t=0;return e.store("remoteDocuments").X(((e,n)=>{t+=lh(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Ys(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.j().next((t=>Xi.forEach(t,(t=>{const s=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",s).next((n=>Xi.forEach(n,(n=>{gi(n.userId===t.userId);const s=bl(this.serializer,n);return uh(e,t.userId,s).next((()=>{}))}))))}))))}Zs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const s=[];return n.X(((n,r)=>{const i=new Li(n),o=function(e){return[0,ho(e)]}(i);s.push(t.get(o).next((n=>n?Xi.resolve():(n=>t.put({targetId:0,path:ho(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>Xi.waitFor(s)))}))}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Do});const n=t.store("collectionParents"),s=new Zl,r=e=>{if(s.add(e)){const t=e.lastSegment(),s=e.popLast();return n.put({collectionId:t,parent:ho(s)})}};return t.store("remoteDocuments").X({Y:!0},((e,t)=>{const n=new Li(e);return r(n.popLast())})).next((()=>t.store("documentMutations").X({Y:!0},(([e,t,n],s)=>{const i=mo(t);return r(i.popLast())}))))}ei(e){const t=e.store("targets");return t.X(((e,n)=>{const s=El(n),r=Il(this.serializer,s);return t.put(r)}))}ni(e,t){const n=t.store("remoteDocuments"),s=[];return n.X(((e,n)=>{const r=t.store("remoteDocumentsV14"),i=(o=n,o.document?new Vi(Li.fromString(o.document.name).popFirst(5)):o.noDocument?Vi.fromSegments(o.noDocument.path):o.unknownDocument?Vi.fromSegments(o.unknownDocument.path):fi()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>Xi.waitFor(s)))}si(e,t){const n=t.store("mutations"),s=Ah(this.serializer),r=new Gh(Qh.zs,this.serializer.fe);return n.j().next((e=>{const n=new Map;return e.forEach((e=>{var t;let s=null!==(t=n.get(e.userId))&&void 0!==t?t:Oc();bl(this.serializer,e).keys().forEach((e=>s=s.add(e))),n.set(e.userId,s)})),Xi.forEach(n,((e,n)=>{const i=new ii(n),o=kl.de(this.serializer,i),a=r.getIndexManager(i),c=hh.de(i,this.serializer,a,r.referenceDelegate);return new Fh(s,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Bo(t,co.ct),e).next()}))}))}}function Xh(e){e.createObjectStore("targetDocuments",{keyPath:_o}).createIndex("documentTargetsIndex",So,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",To,{unique:!0}),e.createObjectStore("targetGlobal")}const Yh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Jh{constructor(e,t,n,s,r,i,o,a,c,u,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=r,this.window=i,this.document=o,this.ri=c,this.oi=u,this.ui=l,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!Jh.D())throw new yi(pi.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Sh(this,s),this.di=t+"main",this.serializer=new ml(a),this.wi=new Ji(this.di,this.ui,new Wh(this.serializer)),this.Bs=new yh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Ah(this.serializer),this.qs=new xl,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===u&&li("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new yi(pi.FAILED_PRECONDITION,Yh);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Bs.getHighestSequenceNumber(e)))})).then((e=>{this.Os=new co(e,this.ri)})).then((()=>{this.Fs=!0})).catch((e=>(this.wi&&this.wi.close(),Promise.reject(e))))}Ii(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.wi.B((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>ed(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Ti(e).next((e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Ei(e))).next((t=>this.isPrimary&&!t?this.Ai(e).next((()=>!1)):!!t&&this.vi(e).next((()=>!0)))))).catch((e=>{if(to(e))return ui("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return ui("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.ii.enqueueRetryable((()=>this.fi(e))),this.isPrimary=e}))}Ti(e){return Zh(e).get("owner").next((e=>Xi.resolve(this.Ri(e))))}Pi(e){return ed(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Uo(e,"clientMetadata");return t.j().next((e=>{const n=this.Si(e,18e5),s=e.filter((e=>-1===n.indexOf(e)));return Xi.forEach(s,(e=>t.delete(e.clientId))).next((()=>s))}))})).catch((()=>[]));if(this._i)for(const t of e)this._i.removeItem(this.Di(t.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.bi())).then((()=>this.pi()))))}Ri(e){return!!e&&e.ownerId===this.clientId}Ei(e){return this.oi?Xi.resolve(!0):Zh(e).get("owner").next((t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)){if(this.Ri(t)&&this.networkEnabled)return!0;if(!this.Ri(t)){if(!t.allowTabSynchronization)throw new yi(pi.FAILED_PRECONDITION,Yh);return!1}}return!(!this.networkEnabled||!this.inForeground)||ed(e).j().next((e=>void 0===this.Si(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,s=this.networkEnabled===e.networkEnabled;if(t||n&&s)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&ui("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new Bo(e,co.ct);return this.Ai(t).next((()=>this.Pi(t)))})),this.wi.close(),this.Mi()}Si(e,t){return e.filter((e=>this.Vi(e.updateTimeMs,t)&&!this.Ci(e.clientId)))}$i(){return this.runTransaction("getActiveClients","readonly",(e=>ed(e).j().next((e=>this.Si(e,18e5).map((e=>e.clientId))))))}get started(){return this.Fs}getMutationQueue(e,t){return hh.de(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new th(e,this.serializer.fe.databaseId)}getDocumentOverlayCache(e){return kl.de(this.serializer,e)}getBundleCache(){return this.qs}runTransaction(e,t,n){ui("IndexedDbPersistence","Starting transaction:",e);const s="readonly"===t?"readonly":"readwrite",r=15===(i=this.ui)?Vo:14===i?Fo:13===i?Po:12===i?Lo:11===i?Ro:void fi();var i;let o;return this.wi.runTransaction(e,s,r,(s=>(o=new Bo(s,this.Os?this.Os.next():co.ct),"readwrite-primary"===t?this.Ti(o).next((e=>!!e||this.Ei(o))).next((t=>{if(!t)throw li(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))),new yi(pi.FAILED_PRECONDITION,Hi);return n(o)})).next((e=>this.vi(o).next((()=>e)))):this.Oi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Oi(e){return Zh(e).get("owner").next((e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.Ri(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new yi(pi.FAILED_PRECONDITION,Yh)}))}vi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Zh(e).put("owner",t)}static D(){return Ji.D()}Ai(e){const t=Zh(e);return t.get("owner").next((e=>this.Ri(e)?(ui("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):Xi.resolve()))}Vi(e,t){const n=Date.now();return!(e<n-t||e>n&&(li(`Detected an update time that is in the future: ${e} > ${n}`),1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;!function(){var e;const t=null===(e=a())||void 0===e?void 0:e.forceEnvironment;if("node"===t)return!0;if("browser"===t)return!1;try{return"[object process]"===Object.prototype.toString.call(n.g.process)}catch(e){return!1}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(e){var t;try{const n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Di(e)));return ui("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return li("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(e){li("Failed to set zombie client id.",e)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(e){}}Di(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Zh(e){return Uo(e,"owner")}function ed(e){return Uo(e,"clientMetadata")}class td{constructor(e,t,n,s){this.targetId=e,this.fromCache=t,this.Fi=n,this.Bi=s}static Li(e,t){let n=Oc(),s=Oc();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:s=s.add(e.doc.key)}return new td(e,t.fromCache,n,s)}}class nd{constructor(){this.qi=!1}initialize(e,t){this.Ui=e,this.indexManager=t,this.qi=!0}getDocumentsMatchingQuery(e,t,n,s){return this.Ki(e,t).next((r=>r||this.Gi(e,t,s,n))).next((n=>n||this.Qi(e,t)))}Ki(e,t){if(dc(t))return Xi.resolve(null);let n=gc(t);return this.indexManager.getIndexType(e,n).next((s=>0===s?null:(null!==t.limit&&1===s&&(t=mc(t,null,"F"),n=gc(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((s=>{const r=Oc(...s);return this.Ui.getDocuments(e,r).next((s=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.ji(t,s);return this.zi(t,i,r,n.readTime)?this.Ki(e,mc(t,null,"F")):this.Wi(e,i,t,n)}))))})))))}Gi(e,t,n,s){return dc(t)||s.isEqual(Oi.min())?this.Qi(e,t):this.Ui.getDocuments(e,n).next((r=>{const i=this.ji(t,r);return this.zi(t,i,n,s)?this.Qi(e,t):(ci()<=T.DEBUG&&ui("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),vc(t)),this.Wi(e,i,t,function(e,t){const n=e.toTimestamp().seconds,s=e.toTimestamp().nanoseconds+1,r=Oi.fromTimestamp(1e9===s?new Mi(n+1,0):new Mi(n,s));return new $i(r,Vi.empty(),t)}(s,-1)))}))}ji(e,t){let n=new Ho(bc(e));return t.forEach(((t,s)=>{wc(e,s)&&(n=n.add(s))})),n}zi(e,t,n,s){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const r="F"===e.limitType?t.last():t.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Qi(e,t){return ci()<=T.DEBUG&&ui("QueryEngine","Using full collection scan to execute query:",vc(t)),this.Ui.getDocumentsMatchingQuery(e,t,$i.min())}Wi(e,t,n,s){return this.Ui.getDocumentsMatchingQuery(e,n,s).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class sd{constructor(e,t,n,s){this.persistence=e,this.Hi=t,this.serializer=s,this.Ji=new Ko(Ai),this.Yi=new Ic((e=>rc(e)),ic),this.Xi=new Map,this.Zi=e.getRemoteDocumentCache(),this.Bs=e.getTargetCache(),this.qs=e.getBundleCache(),this.tr(n)}tr(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Fh(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ji)))}}function rd(e,t,n,s){return new sd(e,t,n,s)}async function id(e,t){const n=mi(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let s;return n.mutationQueue.getAllMutationBatches(e).next((r=>(s=r,n.tr(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const r=[],i=[];let o=Oc();for(const e of s){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({er:e,removedBatchIds:r,addedBatchIds:i})))}))}))}function od(e){const t=mi(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Bs.getLastRemoteSnapshotVersion(e)))}function ad(e,t){const n=mi(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}async function cd(e,t,n){const s=mi(e),r=s.Ji.get(t),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(e=>s.persistence.referenceDelegate.removeTarget(e,r)))}catch(e){if(!to(e))throw e;ui("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}s.Ji=s.Ji.remove(t),s.Yi.delete(r.target)}function ud(e,t,n){const s=mi(e);let r=Oi.min(),i=Oc();return s.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const s=mi(e),r=s.Yi.get(n);return void 0!==r?Xi.resolve(s.Ji.get(r)):s.Bs.getTargetData(t,n)}(s,e,gc(t)).next((t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,s.Bs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>s.Hi.getDocumentsMatchingQuery(e,t,n?r:Oi.min(),n?i:Oc()))).next((e=>(function(e,t,n){let s=e.Xi.get(t)||Oi.min();n.forEach(((e,t)=>{t.readTime.compareTo(s)>0&&(s=t.readTime)})),e.Xi.set(t,s)}(s,function(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}(t),e),{documents:e,ir:i})))))}class ld{constructor(){this.activeTargetIds=Rc}lr(e){this.activeTargetIds=this.activeTargetIds.add(e)}dr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}hr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class hd{constructor(){this.Hr=new ld,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hr.lr(e),this.Jr[e]||"not-current"}updateQueryState(e,t,n){this.Jr[e]=t}removeLocalQueryTarget(e){this.Hr.dr(e)}isLocalQueryTarget(e){return this.Hr.activeTargetIds.has(e)}clearQueryState(e){delete this.Jr[e]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(e){return this.Hr.activeTargetIds.has(e)}start(){return this.Hr=new ld,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class dd{Yr(e){}shutdown(){}}class fd{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(e){this.so.push(e)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){ui("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.so)e(0)}no(){ui("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.so)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let gd=null;function md(){return null===gd?gd=268435456+Math.round(2147483648*Math.random()):gd++,"0x"+gd.toString(16)}const pd={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class yd{constructor(e){this.ro=e.ro,this.oo=e.oo}uo(e){this.co=e}ao(e){this.ho=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.ro(e)}fo(){this.co()}wo(e){this.ho(e)}_o(e){this.lo(e)}}const vd="WebChannelConnection";class wd extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.mo=t+"://"+e.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(e,t,n,s,r){const i=md(),o=this.To(e,t);ui("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={};return this.Eo(a,s,r),this.Ao(e,o,a,n).then((t=>(ui("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw hi("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}vo(e,t,n,s,r,i){return this.Io(e,t,n,s,r)}Eo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+oi,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}To(e,t){const n=pd[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Ao(e,t,n,s){const r=md();return new Promise(((i,o)=>{const a=new ti;a.setWithCredentials(!0),a.listenOnce(Xr.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case Wr.NO_ERROR:const t=a.getResponseJson();ui(vd,`XHR for RPC '${e}' ${r} received:`,JSON.stringify(t)),i(t);break;case Wr.TIMEOUT:ui(vd,`RPC '${e}' ${r} timed out`),o(new yi(pi.DEADLINE_EXCEEDED,"Request time out"));break;case Wr.HTTP_ERROR:const n=a.getStatus();if(ui(vd,`RPC '${e}' ${r} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(pi).indexOf(t)>=0?t:pi.UNKNOWN}(t.status);o(new yi(e,t.message))}else o(new yi(pi.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new yi(pi.UNAVAILABLE,"Connection failed."));break;default:fi()}}finally{ui(vd,`RPC '${e}' ${r} completed.`)}}));const c=JSON.stringify(s);ui(vd,`RPC '${e}' ${r} sending request:`,s),a.send(t,"POST",c,n,15)}))}Ro(e,t,n){const s=md(),r=[this.mo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=Hr(),o=Qr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.xmlHttpFactory=new Zr({})),this.Eo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const u=r.join("");ui(vd,`Creating RPC '${e}' stream ${s}: ${u}`,a);const l=i.createWebChannel(u,a);let h=!1,d=!1;const f=new yd({ro:t=>{d?ui(vd,`Not sending because RPC '${e}' stream ${s} is closed:`,t):(h||(ui(vd,`Opening RPC '${e}' stream ${s} transport.`),l.open(),h=!0),ui(vd,`RPC '${e}' stream ${s} sending:`,t),l.send(t))},oo:()=>l.close()}),g=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return g(l,ei.EventType.OPEN,(()=>{d||ui(vd,`RPC '${e}' stream ${s} transport opened.`)})),g(l,ei.EventType.CLOSE,(()=>{d||(d=!0,ui(vd,`RPC '${e}' stream ${s} transport closed`),f.wo())})),g(l,ei.EventType.ERROR,(t=>{d||(d=!0,hi(vd,`RPC '${e}' stream ${s} transport errored:`,t),f.wo(new yi(pi.UNAVAILABLE,"The operation could not be completed")))})),g(l,ei.EventType.MESSAGE,(t=>{var n;if(!d){const r=t.data[0];gi(!!r);const i=r,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){ui(vd,`RPC '${e}' stream ${s} received error:`,o);const t=o.status;let n=function(e){const t=yu[e];if(void 0!==t)return wu(t)}(t),r=o.message;void 0===n&&(n=pi.INTERNAL,r="Unknown error status: "+t+" with message "+o.message),d=!0,f.wo(new yi(n,r)),l.close()}else ui(vd,`RPC '${e}' stream ${s} received:`,r),f._o(r)}})),g(o,Yr.STAT_EVENT,(t=>{t.stat===Jr.PROXY?ui(vd,`RPC '${e}' stream ${s} detected buffering proxy`):t.stat===Jr.NOPROXY&&ui(vd,`RPC '${e}' stream ${s} detected no buffering proxy`)})),setTimeout((()=>{f.fo()}),0),f}}function bd(){return"undefined"!=typeof document?document:null}function Ed(e){return new Bu(e,!0)}class Id{constructor(e,t,n=1e3,s=1.5,r=6e4){this.ii=e,this.timerId=t,this.Po=n,this.bo=s,this.Vo=r,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(e){this.cancel();const t=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),s=Math.max(0,t-n);s>0&&ui("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.So} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,s,(()=>(this.Co=Date.now(),e()))),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class Td{constructor(e,t,n,s,r,i,o,a){this.ii=e,this.$o=n,this.Oo=s,this.connection=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new Id(e,t)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,(()=>this.zo())))}Wo(e){this.Ho(),this.stream.send(e)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(e,t){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==e?this.qo.reset():t&&t.code===pi.RESOURCE_EXHAUSTED?(li(t.toString()),li("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):t&&t.code===pi.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.ao(t)}Yo(){}auth(){this.state=1;const e=this.Xo(this.Fo),t=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Fo===t&&this.Zo(e,n)}),(t=>{e((()=>{const e=new yi(pi.UNKNOWN,"Fetching auth token failed: "+t.message);return this.tu(e)}))}))}Zo(e,t){const n=this.Xo(this.Fo);this.stream=this.eu(e,t),this.stream.uo((()=>{n((()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,(()=>(this.Ko()&&(this.state=3),Promise.resolve()))),this.listener.uo())))})),this.stream.ao((e=>{n((()=>this.tu(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Go(){this.state=5,this.qo.No((async()=>{this.state=0,this.start()}))}tu(e){return ui("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(e){return t=>{this.ii.enqueueAndForget((()=>this.Fo===e?t():(ui("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class _d extends Td{constructor(e,t,n,s,r,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,s,i),this.serializer=r}eu(e,t){return this.connection.Ro("Listen",e,t)}onMessage(e){this.qo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const s=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:fi()}(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(gi(void 0===t||"string"==typeof t),Jo.fromBase64String(t||"")):(gi(void 0===t||t instanceof Uint8Array),Jo.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?pi.UNKNOWN:wu(e.code);return new yi(t,e.message||"")}(o);n=new Nu(s,r,i,a||null)}else if("documentChange"in t){t.documentChange;const s=t.documentChange;s.document,s.document.name,s.document.updateTime;const r=Qu(e,s.document.name),i=Ku(s.document.updateTime),o=s.document.createTime?Ku(s.document.createTime):Oi.min(),a=new Aa({mapValue:{fields:s.document.fields}}),c=Na.newFoundDocument(r,i,o,a),u=s.targetIds||[],l=s.removedTargetIds||[];n=new Au(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const s=t.documentDelete;s.document;const r=Qu(e,s.document),i=s.readTime?Ku(s.readTime):Oi.min(),o=Na.newNoDocument(r,i),a=s.removedTargetIds||[];n=new Au([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const s=t.documentRemove;s.document;const r=Qu(e,s.document),i=s.removedTargetIds||[];n=new Au([],i,r,null)}else{if(!("filter"in t))return fi();{t.filter;const e=t.filter;e.targetId;const{count:s=0,unchangedNames:r}=e,i=new pu(s,r),o=e.targetId;n=new ku(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return Oi.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?Oi.min():t.readTime?Ku(t.readTime):Oi.min()}(e);return this.listener.nu(t,n)}su(e){const t={};t.database=Yu(this.serializer),t.addTarget=function(e,t){let n;const s=t.target;if(n=oc(s)?{documents:nl(e,s)}:{query:sl(e,s)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=qu(e,t.resumeToken);const s=Uu(e,t.expectedCount);null!==s&&(n.expectedCount=s)}else if(t.snapshotVersion.compareTo(Oi.min())>0){n.readTime=ju(e,t.snapshotVersion.toTimestamp());const s=Uu(e,t.expectedCount);null!==s&&(n.expectedCount=s)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return fi()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.Wo(t)}iu(e){const t={};t.database=Yu(this.serializer),t.removeTarget=e,this.Wo(t)}}class Sd extends Td{constructor(e,t,n,s,r,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,s,i),this.serializer=r,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(e,t){return this.connection.Ro("Write",e,t)}onMessage(e){if(gi(!!e.streamToken),this.lastStreamToken=e.streamToken,this.ru){this.qo.reset();const t=function(e,t){return e&&e.length>0?(gi(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?Ku(e.updateTime):Ku(t);return n.isEqual(Oi.min())&&(n=Ku(t)),new Yc(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=Ku(e.commitTime);return this.listener.cu(n,t)}return gi(!e.writeResults||0===e.writeResults.length),this.ru=!0,this.listener.au()}hu(){const e={};e.database=Yu(this.serializer),this.Wo(e)}uu(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>el(this.serializer,e)))};this.Wo(t)}}class Dd extends class{}{constructor(e,t,n,s){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=s,this.lu=!1}fu(){if(this.lu)throw new yi(pi.FAILED_PRECONDITION,"The client has already been terminated.")}Io(e,t,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.connection.Io(e,t,n,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new yi(pi.UNKNOWN,e.toString())}))}vo(e,t,n,s){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.connection.vo(e,t,n,r,i,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new yi(pi.UNKNOWN,e.toString())}))}terminate(){this.lu=!0}}class xd{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve()))))}Iu(e){"Online"===this.state?this.yu("Unknown"):(this.wu++,this.wu>=1&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.yu("Offline")))}set(e){this.Tu(),this.wu=0,"Online"===e&&(this.mu=!1),this.yu(e)}yu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}pu(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(li(t),this.mu=!1):ui("OnlineStateTracker",t)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class Cd{constructor(e,t,n,s,r){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=r,this.Pu.Yr((e=>{n.enqueueAndForget((async()=>{Fd(this)&&(ui("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=mi(e);t.vu.add(4),await kd(t),t.bu.set("Unknown"),t.vu.delete(4),await Ad(t)}(this))}))})),this.bu=new xd(n,s)}}async function Ad(e){if(Fd(e))for(const t of e.Ru)await t(!0)}async function kd(e){for(const t of e.Ru)await t(!1)}function Nd(e,t){const n=mi(e);n.Au.has(t.targetId)||(n.Au.set(t.targetId,t),Pd(n)?Ld(n):ef(n).Ko()&&Od(n,t))}function Md(e,t){const n=mi(e),s=ef(n);n.Au.delete(t),s.Ko()&&Rd(n,t),0===n.Au.size&&(s.Ko()?s.jo():Fd(n)&&n.bu.set("Unknown"))}function Od(e,t){if(e.Vu.qt(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Oi.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ef(e).su(t)}function Rd(e,t){e.Vu.qt(t),ef(e).iu(t)}function Ld(e){e.Vu=new Ou({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),le:t=>e.Au.get(t)||null,ue:()=>e.datastore.serializer.databaseId}),ef(e).start(),e.bu.gu()}function Pd(e){return Fd(e)&&!ef(e).Uo()&&e.Au.size>0}function Fd(e){return 0===mi(e).vu.size}function Vd(e){e.Vu=void 0}async function Bd(e){e.Au.forEach(((t,n)=>{Od(e,t)}))}async function Ud(e,t){Vd(e),Pd(e)?(e.bu.Iu(t),Ld(e)):e.bu.set("Unknown")}async function jd(e,t,n){if(e.bu.set("Online"),t instanceof Nu&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const s of t.targetIds)e.Au.has(s)&&(await e.remoteSyncer.rejectListen(s,n),e.Au.delete(s),e.Vu.removeTarget(s))}(e,t)}catch(n){ui("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await qd(e,n)}else if(t instanceof Au?e.Vu.Ht(t):t instanceof ku?e.Vu.ne(t):e.Vu.Xt(t),!n.isEqual(Oi.min()))try{const t=await od(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Vu.ce(t);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=e.Au.get(s);r&&e.Au.set(s,r.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const s=e.Au.get(t);if(!s)return;e.Au.set(t,s.withResumeToken(Jo.EMPTY_BYTE_STRING,s.snapshotVersion)),Rd(e,t);const r=new gl(s.target,t,n,s.sequenceNumber);Od(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){ui("RemoteStore","Failed to raise snapshot:",t),await qd(e,t)}}async function qd(e,t,n){if(!to(t))throw t;e.vu.add(1),await kd(e),e.bu.set("Offline"),n||(n=()=>od(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{ui("RemoteStore","Retrying IndexedDB access"),await n(),e.vu.delete(1),await Ad(e)}))}function zd(e,t){return t().catch((n=>qd(e,n,t)))}async function Kd(e){const t=mi(e),n=tf(t);let s=t.Eu.length>0?t.Eu[t.Eu.length-1].batchId:-1;for(;$d(t);)try{const e=await ad(t.localStore,s);if(null===e){0===t.Eu.length&&n.jo();break}s=e.batchId,Gd(t,e)}catch(e){await qd(t,e)}Hd(t)&&Qd(t)}function $d(e){return Fd(e)&&e.Eu.length<10}function Gd(e,t){e.Eu.push(t);const n=tf(e);n.Ko()&&n.ou&&n.uu(t.mutations)}function Hd(e){return Fd(e)&&!tf(e).Uo()&&e.Eu.length>0}function Qd(e){tf(e).start()}async function Wd(e){tf(e).hu()}async function Xd(e){const t=tf(e);for(const n of e.Eu)t.uu(n.mutations)}async function Yd(e,t,n){const s=e.Eu.shift(),r=gu.from(s,t,n);await zd(e,(()=>e.remoteSyncer.applySuccessfulWrite(r))),await Kd(e)}async function Jd(e,t){t&&tf(e).ou&&await async function(e,t){if(function(e){switch(e){default:return fi();case pi.CANCELLED:case pi.UNKNOWN:case pi.DEADLINE_EXCEEDED:case pi.RESOURCE_EXHAUSTED:case pi.INTERNAL:case pi.UNAVAILABLE:case pi.UNAUTHENTICATED:return!1;case pi.INVALID_ARGUMENT:case pi.NOT_FOUND:case pi.ALREADY_EXISTS:case pi.PERMISSION_DENIED:case pi.FAILED_PRECONDITION:case pi.ABORTED:case pi.OUT_OF_RANGE:case pi.UNIMPLEMENTED:case pi.DATA_LOSS:return!0}}(n=t.code)&&n!==pi.ABORTED){const n=e.Eu.shift();tf(e).Qo(),await zd(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Kd(e)}var n}(e,t),Hd(e)&&Qd(e)}async function Zd(e,t){const n=mi(e);n.asyncQueue.verifyOperationInProgress(),ui("RemoteStore","RemoteStore received new credentials");const s=Fd(n);n.vu.add(3),await kd(n),s&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.vu.delete(3),await Ad(n)}function ef(e){return e.Su||(e.Su=function(e,t,n){const s=mi(e);return s.fu(),new _d(t,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(e.datastore,e.asyncQueue,{uo:Bd.bind(null,e),ao:Ud.bind(null,e),nu:jd.bind(null,e)}),e.Ru.push((async t=>{t?(e.Su.Qo(),Pd(e)?Ld(e):e.bu.set("Unknown")):(await e.Su.stop(),Vd(e))}))),e.Su}function tf(e){return e.Du||(e.Du=function(e,t,n){const s=mi(e);return s.fu(),new Sd(t,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(e.datastore,e.asyncQueue,{uo:Wd.bind(null,e),ao:Jd.bind(null,e),au:Xd.bind(null,e),cu:Yd.bind(null,e)}),e.Ru.push((async t=>{t?(e.Du.Qo(),await Kd(e)):(await e.Du.stop(),e.Eu.length>0&&(ui("RemoteStore",`Stopping write stream with ${e.Eu.length} pending writes`),e.Eu=[]))}))),e.Du}class nf{constructor(e,t,n,s,r){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new vi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,s,r){const i=Date.now()+n,o=new nf(e,t,i,s,r);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new yi(pi.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function sf(e,t){if(li("AsyncQueue",`${t}: ${e}`),to(e))return new yi(pi.UNAVAILABLE,`${t}: ${e}`);throw e}class rf{constructor(e){this.comparator=e?(t,n)=>e(t,n)||Vi.comparator(t.key,n.key):(e,t)=>Vi.comparator(e.key,t.key),this.keyedMap=Dc(),this.sortedSet=new Ko(this.comparator)}static emptySet(e){return new rf(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof rf))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(!e.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new rf;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class of{constructor(){this.Cu=new Ko(Vi.comparator)}track(e){const t=e.doc.key,n=this.Cu.get(t);n?0!==e.type&&3===n.type?this.Cu=this.Cu.insert(t,e):3===e.type&&1!==n.type?this.Cu=this.Cu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Cu=this.Cu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Cu=this.Cu.remove(t):1===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):fi():this.Cu=this.Cu.insert(t,e)}xu(){const e=[];return this.Cu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class af{constructor(e,t,n,s,r,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,s,r){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new af(e,t,rf.emptySet(t),i,n,s,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&pc(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class cf{constructor(){this.Nu=void 0,this.listeners=[]}}class uf{constructor(){this.queries=new Ic((e=>yc(e)),pc),this.onlineState="Unknown",this.ku=new Set}}async function lf(e,t){const n=mi(e),s=t.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new cf),r)try{i.Nu=await n.onListen(s)}catch(e){const n=sf(e,`Initialization of query '${vc(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.listeners.push(t),t.Mu(n.onlineState),i.Nu&&t.$u(i.Nu)&&gf(n)}async function hf(e,t){const n=mi(e),s=t.query;let r=!1;const i=n.queries.get(s);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function df(e,t){const n=mi(e);let s=!1;for(const e of t){const t=e.query,r=n.queries.get(t);if(r){for(const t of r.listeners)t.$u(e)&&(s=!0);r.Nu=e}}s&&gf(n)}function ff(e,t,n){const s=mi(e),r=s.queries.get(t);if(r)for(const e of r.listeners)e.onError(n);s.queries.delete(t)}function gf(e){e.ku.forEach((e=>{e.next()}))}class mf{constructor(e,t,n){this.query=e,this.Ou=t,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new af(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Fu?this.Lu(e)&&(this.Ou.next(e),t=!0):this.qu(e,this.onlineState)&&(this.Uu(e),t=!0),this.Bu=e,t}onError(e){this.Ou.error(e)}Mu(e){this.onlineState=e;let t=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,e)&&(this.Uu(this.Bu),t=!0),t}qu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Ku||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Lu(e){if(e.docChanges.length>0)return!0;const t=this.Bu&&this.Bu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Uu(e){e=af.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Fu=!0,this.Ou.next(e)}}class pf{constructor(e){this.key=e}}class yf{constructor(e){this.key=e}}class vf{constructor(e,t){this.query=e,this.Yu=t,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=Oc(),this.mutatedKeys=Oc(),this.tc=bc(e),this.ec=new rf(this.tc)}get nc(){return this.Yu}sc(e,t){const n=t?t.ic:new of,s=t?t.ec:this.ec;let r=t?t.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,c="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(e.inorderTraversal(((e,t)=>{const u=s.get(e),l=wc(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.rc(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.tc(l,a)>0||c&&this.tc(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),r=d?r.add(e):r.delete(e)):(i=i.delete(e),r=r.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),r=r.delete(e.key),n.track({type:1,doc:e})}return{ec:i,ic:n,zi:o,mutatedKeys:r}}rc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const s=this.ec;this.ec=e.ec,this.mutatedKeys=e.mutatedKeys;const r=e.ic.xu();r.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return fi()}};return n(e)-n(t)}(e.type,t.type)||this.tc(e.doc,t.doc))),this.oc(n);const i=t?this.uc():[],o=0===this.Zu.size&&this.current?1:0,a=o!==this.Xu;return this.Xu=o,0!==r.length||a?{snapshot:new af(this.query,e.ec,s,r,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),cc:i}:{cc:i}}Mu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ec:this.ec,ic:new of,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(e){return!this.Yu.has(e)&&!!this.ec.has(e)&&!this.ec.get(e).hasLocalMutations}oc(e){e&&(e.addedDocuments.forEach((e=>this.Yu=this.Yu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Yu=this.Yu.delete(e))),this.current=e.current)}uc(){if(!this.current)return[];const e=this.Zu;this.Zu=Oc(),this.ec.forEach((e=>{this.ac(e.key)&&(this.Zu=this.Zu.add(e.key))}));const t=[];return e.forEach((e=>{this.Zu.has(e)||t.push(new yf(e))})),this.Zu.forEach((n=>{e.has(n)||t.push(new pf(n))})),t}hc(e){this.Yu=e.ir,this.Zu=Oc();const t=this.sc(e.documents);return this.applyChanges(t,!0)}lc(){return af.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class wf{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class bf{constructor(e){this.key=e,this.fc=!1}}class Ef{constructor(e,t,n,s,r,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.dc={},this.wc=new Ic((e=>yc(e)),pc),this._c=new Map,this.mc=new Set,this.gc=new Ko(Vi.comparator),this.yc=new Map,this.Ic=new Uh,this.Tc={},this.Ec=new Map,this.Ac=ph.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function If(e,t){const n=function(e){const t=mi(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=_f.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Vf.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Df.bind(null,t),t.dc.nu=df.bind(null,t.eventManager),t.dc.Pc=ff.bind(null,t.eventManager),t}(e);let s,r;const i=n.wc.get(t);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.lc();else{const e=await function(e,t){const n=mi(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let s;return n.Bs.getTargetData(e,t).next((r=>r?(s=r,Xi.resolve(s)):n.Bs.allocateTargetId(e).next((r=>(s=new gl(t,r,"TargetPurposeListen",e.currentSequenceNumber),n.Bs.addTargetData(e,s).next((()=>s)))))))})).then((e=>{const s=n.Ji.get(e.targetId);return(null===s||e.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ji=n.Ji.insert(e.targetId,e),n.Yi.set(t,e.targetId)),e}))}(n.localStore,gc(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);s=e.targetId,r=await async function(e,t,n,s,r){e.Rc=(t,n,s)=>async function(e,t,n,s){let r=t.view.sc(n);r.zi&&(r=await ud(e.localStore,t.query,!1).then((({documents:e})=>t.view.sc(e,r))));const i=s&&s.targetChanges.get(t.targetId),o=t.view.applyChanges(r,e.isPrimaryClient,i);return Of(e,t.targetId,o.cc),o.snapshot}(e,t,n,s);const i=await ud(e.localStore,t,!0),o=new vf(t,i.ir),a=o.sc(i.documents),c=Cu.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==e.onlineState,r),u=o.applyChanges(a,e.isPrimaryClient,c);Of(e,n,u.cc);const l=new wf(t,n,o);return e.wc.set(t,l),e._c.has(n)?e._c.get(n).push(t):e._c.set(n,[t]),u.snapshot}(n,t,s,"current"===i,e.resumeToken),n.isPrimaryClient&&Nd(n.remoteStore,e)}return r}async function Tf(e,t){const n=mi(e),s=n.wc.get(t),r=n._c.get(s.targetId);if(r.length>1)return n._c.set(s.targetId,r.filter((e=>!pc(e,t)))),void n.wc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await cd(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Md(n.remoteStore,s.targetId),Nf(n,s.targetId)})).catch(Wi)):(Nf(n,s.targetId),await cd(n.localStore,s.targetId,!0))}async function _f(e,t){const n=mi(e);try{const e=await function(e,t){const n=mi(e),s=t.snapshotVersion;let r=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Zi.newChangeBuffer({trackRemovals:!0});r=n.Ji;const o=[];t.targetChanges.forEach(((i,a)=>{const c=r.get(a);if(!c)return;o.push(n.Bs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Bs.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(Jo.EMPTY_BYTE_STRING,Oi.min()).withLastLimboFreeSnapshotVersion(Oi.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,s)),r=r.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Bs.updateTargetData(e,u))}));let a=_c(),c=Oc();if(t.documentUpdates.forEach((s=>{t.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,s))})),o.push(function(e,t,n){let s=Oc(),r=Oc();return n.forEach((e=>s=s.add(e))),t.getEntries(e,s).next((e=>{let s=_c();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(Oi.min())?(t.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),s=s.insert(n,i)):ui("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{nr:s,sr:r}}))}(e,i,t.documentUpdates).next((e=>{a=e.nr,c=e.sr}))),!s.isEqual(Oi.min())){const t=n.Bs.getLastRemoteSnapshotVersion(e).next((t=>n.Bs.setTargetsMetadata(e,e.currentSequenceNumber,s)));o.push(t)}return Xi.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.Ji=r,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const s=n.yc.get(t);s&&(gi(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?s.fc=!0:e.modifiedDocuments.size>0?gi(s.fc):e.removedDocuments.size>0&&(gi(s.fc),s.fc=!1))})),await Pf(n,e,t)}catch(e){await Wi(e)}}function Sf(e,t,n){const s=mi(e);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const e=[];s.wc.forEach(((n,s)=>{const r=s.view.Mu(t);r.snapshot&&e.push(r.snapshot)})),function(e,t){const n=mi(e);n.onlineState=t;let s=!1;n.queries.forEach(((e,n)=>{for(const e of n.listeners)e.Mu(t)&&(s=!0)})),s&&gf(n)}(s.eventManager,t),e.length&&s.dc.nu(e),s.onlineState=t,s.isPrimaryClient&&s.sharedClientState.setOnlineState(t)}}async function Df(e,t,n){const s=mi(e);s.sharedClientState.updateQueryState(t,"rejected",n);const r=s.yc.get(t),i=r&&r.key;if(i){let e=new Ko(Vi.comparator);e=e.insert(i,Na.newNoDocument(i,Oi.min()));const n=Oc().add(i),r=new xu(Oi.min(),new Map,new Ko(Ai),e,n);await _f(s,r),s.gc=s.gc.remove(i),s.yc.delete(t),Lf(s)}else await cd(s.localStore,t,!1).then((()=>Nf(s,t,n))).catch(Wi)}async function xf(e,t){const n=mi(e),s=t.batch.batchId;try{const e=await function(e,t){const n=mi(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const s=t.batch.keys(),r=n.Zi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,s){const r=n.batch,i=r.keys();let o=Xi.resolve();return i.forEach((e=>{o=o.next((()=>s.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);gi(null!==i),t.version.compareTo(i)<0&&(r.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),s.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,r)))}(n,e,t,r).next((()=>r.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Oc();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(n.localStore,t);kf(n,s,null),Af(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Pf(n,e)}catch(e){await Wi(e)}}async function Cf(e,t,n){const s=mi(e);try{const e=await function(e,t){const n=mi(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let s;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(gi(null!==t),s=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,s))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(s.localStore,t);kf(s,t,n),Af(s,t),s.sharedClientState.updateMutationState(t,"rejected",n),await Pf(s,e)}catch(n){await Wi(n)}}function Af(e,t){(e.Ec.get(t)||[]).forEach((e=>{e.resolve()})),e.Ec.delete(t)}function kf(e,t,n){const s=mi(e);let r=s.Tc[s.currentUser.toKey()];if(r){const e=r.get(t);e&&(n?e.reject(n):e.resolve(),r=r.remove(t)),s.Tc[s.currentUser.toKey()]=r}}function Nf(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const s of e._c.get(t))e.wc.delete(s),n&&e.dc.Pc(s,n);e._c.delete(t),e.isPrimaryClient&&e.Ic.Is(t).forEach((t=>{e.Ic.containsKey(t)||Mf(e,t)}))}function Mf(e,t){e.mc.delete(t.path.canonicalString());const n=e.gc.get(t);null!==n&&(Md(e.remoteStore,n),e.gc=e.gc.remove(t),e.yc.delete(n),Lf(e))}function Of(e,t,n){for(const s of n)s instanceof pf?(e.Ic.addReference(s.key,t),Rf(e,s)):s instanceof yf?(ui("SyncEngine","Document no longer in limbo: "+s.key),e.Ic.removeReference(s.key,t),e.Ic.containsKey(s.key)||Mf(e,s.key)):fi()}function Rf(e,t){const n=t.key,s=n.path.canonicalString();e.gc.get(n)||e.mc.has(s)||(ui("SyncEngine","New document in limbo: "+n),e.mc.add(s),Lf(e))}function Lf(e){for(;e.mc.size>0&&e.gc.size<e.maxConcurrentLimboResolutions;){const t=e.mc.values().next().value;e.mc.delete(t);const n=new Vi(Li.fromString(t)),s=e.Ac.next();e.yc.set(s,new bf(n)),e.gc=e.gc.insert(n,s),Nd(e.remoteStore,new gl(gc(hc(n.path)),s,"TargetPurposeLimboResolution",co.ct))}}async function Pf(e,t,n){const s=mi(e),r=[],i=[],o=[];s.wc.isEmpty()||(s.wc.forEach(((e,a)=>{o.push(s.Rc(a,t,n).then((e=>{if((e||n)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){r.push(e);const t=td.Li(a.targetId,e);i.push(t)}})))})),await Promise.all(o),s.dc.nu(r),await async function(e,t){const n=mi(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>Xi.forEach(t,(t=>Xi.forEach(t.Fi,(s=>n.persistence.referenceDelegate.addReference(e,t.targetId,s))).next((()=>Xi.forEach(t.Bi,(s=>n.persistence.referenceDelegate.removeReference(e,t.targetId,s)))))))))}catch(e){if(!to(e))throw e;ui("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.Ji.get(t),s=e.snapshotVersion,r=e.withLastLimboFreeSnapshotVersion(s);n.Ji=n.Ji.insert(t,r)}}}(s.localStore,i))}async function Ff(e,t){const n=mi(e);if(!n.currentUser.isEqual(t)){ui("SyncEngine","User change. New user:",t.toKey());const e=await id(n.localStore,t);n.currentUser=t,function(e){e.Ec.forEach((e=>{e.forEach((e=>{e.reject(new yi(pi.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Ec.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Pf(n,e.er)}}function Vf(e,t){const n=mi(e),s=n.yc.get(t);if(s&&s.fc)return Oc().add(s.key);{let e=Oc();const s=n._c.get(t);if(!s)return e;for(const t of s){const s=n.wc.get(t);e=e.unionWith(s.view.nc)}return e}}function Bf(e){const t=mi(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=xf.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Cf.bind(null,t),t}class Uf{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Ed(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return rd(this.persistence,new nd,e.initialUser,this.serializer)}createPersistence(e){return new Gh(Qh.zs,this.serializer)}createSharedClientState(e){return new hd}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class jf extends Uf{constructor(e,t,n){super(),this.Vc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Vc.initialize(this,e),await Bf(this.Vc.syncEngine),await Kd(this.Vc.remoteStore),await this.persistence.Ii((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return rd(this.persistence,new nd,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Th(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new ao(t,this.persistence);return new oo(e.asyncQueue,n)}createPersistence(e){const t=function(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ch.withCacheSize(this.cacheSizeBytes):ch.DEFAULT;return new Jh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,"undefined"!=typeof window?window:null,bd(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new hd}}class qf{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Sf(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Ff.bind(null,this.syncEngine),await async function(e,t){const n=mi(e);t?(n.vu.delete(2),await Ad(n)):t||(n.vu.add(2),await kd(n),n.bu.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new uf}createDatastore(e){const t=Ed(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new wd(s));var s;return function(e,t,n,s){return new Dd(e,t,n,s)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,s=e.asyncQueue,r=e=>Sf(this.syncEngine,e,0),i=fd.D()?new fd:new dd,new Cd(t,n,s,r,i);var t,n,s,r,i}createSyncEngine(e,t){return function(e,t,n,s,r,i,o){const a=new Ef(e,t,n,s,r,i);return o&&(a.vc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=mi(e);ui("RemoteStore","RemoteStore shutting down."),t.vu.add(5),await kd(t),t.Pu.shutdown(),t.bu.set("Unknown")}(this.remoteStore)}}class zf{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Sc(this.observer.next,e)}error(e){this.observer.error?this.Sc(this.observer.error,e):li("Uncaught Error in snapshot listener:",e.toString())}Dc(){this.muted=!0}Sc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Kf{constructor(e,t,n,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=s,this.user=ii.UNAUTHENTICATED,this.clientId=Ci.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{ui("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(ui("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new yi(pi.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new vi;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=sf(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function $f(e,t){e.asyncQueue.verifyOperationInProgress(),ui("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let s=n.initialUser;e.setCredentialChangeListener((async e=>{s.isEqual(e)||(await id(t.localStore,e),s=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Gf(e,t){e.asyncQueue.verifyOperationInProgress();const n=await async function(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){ui("FirestoreClient","Using user provided OfflineComponentProvider");try{await $f(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!Hf(n))throw n;hi("Error using user provided cache. Falling back to memory cache: "+n),await $f(e,new Uf)}}else ui("FirestoreClient","Using default OfflineComponentProvider"),await $f(e,new Uf);return e._offlineComponents}(e);ui("FirestoreClient","Initializing OnlineComponentProvider");const s=await e.getConfiguration();await t.initialize(n,s),e.setCredentialChangeListener((e=>Zd(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Zd(t.remoteStore,n))),e._onlineComponents=t}function Hf(e){return"FirebaseError"===e.name?e.code===pi.FAILED_PRECONDITION||e.code===pi.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Qf(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(ui("FirestoreClient","Using user provided OnlineComponentProvider"),await Gf(e,e._uninitializedComponentsProvider._online)):(ui("FirestoreClient","Using default OnlineComponentProvider"),await Gf(e,new qf))),e._onlineComponents}async function Wf(e){const t=await Qf(e),n=t.eventManager;return n.onListen=If.bind(null,t.syncEngine),n.onUnlisten=Tf.bind(null,t.syncEngine),n}function Xf(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Yf=new Map;function Jf(e,t,n){if(!n)throw new yi(pi.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Zf(e){if(!Vi.isDocumentKey(e))throw new yi(pi.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function eg(e){if(Vi.isDocumentKey(e))throw new yi(pi.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function tg(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":fi()}function ng(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new yi(pi.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=tg(e);throw new yi(pi.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}class sg{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new yi(pi.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new yi(pi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,s){if(!0===t&&!0===s)throw new yi(pi.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")})(0,e.experimentalForceLongPolling,0,e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Xf(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class rg{constructor(e,t,n,s){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new sg({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new yi(pi.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new yi(pi.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new sg(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new bi;switch(e.type){case"firstParty":return new _i(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new yi(pi.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Yf.get(e);t&&(ui("ComponentProvider","Removing Datastore"),Yf.delete(e),t.terminate())}(this),Promise.resolve()}}class ig{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ag(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new ig(this.firestore,e,this._key)}}class og{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new og(this.firestore,e,this._query)}}class ag extends og{constructor(e,t,n){super(e,t,hc(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new ig(this.firestore,null,new Vi(e))}withConverter(e){return new ag(this.firestore,e,this._path)}}function cg(e,t,...n){if(e=y(e),Jf("collection","path",t),e instanceof rg){const s=Li.fromString(t,...n);return eg(s),new ag(e,null,s)}{if(!(e instanceof ig||e instanceof ag))throw new yi(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(Li.fromString(t,...n));return eg(s),new ag(e.firestore,null,s)}}function ug(e,t,...n){if(e=y(e),1===arguments.length&&(t=Ci.A()),Jf("doc","path",t),e instanceof rg){const s=Li.fromString(t,...n);return Zf(s),new ig(e,null,new Vi(s))}{if(!(e instanceof ig||e instanceof ag))throw new yi(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(Li.fromString(t,...n));return Zf(s),new ig(e.firestore,e instanceof ag?e.converter:null,new Vi(s))}}class lg{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new Id(this,"async_queue_retry"),this.Xc=()=>{const e=bd();e&&ui("AsyncQueue","Visibility state changed to "+e.visibilityState),this.qo.Mo()};const e=bd();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Zc(),this.ta(e)}enterRestrictedMode(e){if(!this.jc){this.jc=!0,this.Jc=e||!1;const t=bd();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xc)}}enqueue(e){if(this.Zc(),this.jc)return new Promise((()=>{}));const t=new vi;return this.ta((()=>this.jc&&this.Jc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Qc.push(e),this.ea())))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(e){if(!to(e))throw e;ui("AsyncQueue","Operation failed with retryable error: "+e)}this.Qc.length>0&&this.qo.No((()=>this.ea()))}}ta(e){const t=this.Gc.then((()=>(this.Hc=!0,e().catch((e=>{this.Wc=e,this.Hc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw li("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Hc=!1,e))))));return this.Gc=t,t}enqueueAfterDelay(e,t,n){this.Zc(),this.Yc.indexOf(e)>-1&&(t=0);const s=nf.createAndSchedule(this,e,t,n,(e=>this.na(e)));return this.zc.push(s),s}Zc(){this.Wc&&fi()}verifyOperationInProgress(){}async sa(){let e;do{e=this.Gc,await e}while(e!==this.Gc)}ia(e){for(const t of this.zc)if(t.timerId===e)return!0;return!1}ra(e){return this.sa().then((()=>{this.zc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.zc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.sa()}))}oa(e){this.Yc.push(e)}na(e){const t=this.zc.indexOf(e);this.zc.splice(t,1)}}function hg(e){return function(e){if("object"!=typeof e||null===e)return!1;const t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return!0;return!1}(e)}class dg extends rg{constructor(e,t,n,s){super(e,t,n,s),this.type="firestore",this._queue=new lg,this._persistenceKey=(null==s?void 0:s.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||gg(this),this._firestoreClient.terminate()}}function fg(e){return e._firestoreClient||gg(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function gg(e){var t,n,s;const r=e._freezeSettings(),i=function(e,t,n,s){return new oa(e,t,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,Xf(s.experimentalLongPollingOptions),s.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,r);e._firestoreClient=new Kf(e._authCredentials,e._appCheckCredentials,e._queue,i),(null===(n=r.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(s=r.cache)||void 0===s?void 0:s._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:r.cache.kind,_offline:r.cache._offlineComponentProvider,_online:r.cache._onlineComponentProvider})}class mg{constructor(e){this._byteString=e}static fromBase64String(e){try{return new mg(Jo.fromBase64String(e))}catch(e){throw new yi(pi.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new mg(Jo.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class pg{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new yi(pi.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Fi(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class yg{constructor(e){this._methodName=e}}class vg{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new yi(pi.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new yi(pi.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Ai(this._lat,e._lat)||Ai(this._long,e._long)}}const wg=/^__.*__$/;class bg{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new au(e,this.data,this.fieldMask,t,this.fieldTransforms):new ou(e,this.data,t,this.fieldTransforms)}}function Eg(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw fi()}}class Ig{constructor(e,t,n,s,r,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=s,void 0===r&&this.ua(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(e){return new Ig(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.aa({path:n,la:!1});return s.fa(e),s}da(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.aa({path:n,la:!1});return s.ua(),s}wa(e){return this.aa({path:void 0,la:!0})}_a(e){return Og(e,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}ua(){if(this.path)for(let e=0;e<this.path.length;e++)this.fa(this.path.get(e))}fa(e){if(0===e.length)throw this._a("Document fields must not be empty");if(Eg(this.ca)&&wg.test(e))throw this._a('Document fields cannot begin and end with "__"')}}class Tg{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Ed(e)}ya(e,t,n,s=!1){return new Ig({ca:e,methodName:t,ga:n,path:Fi.emptyPath(),la:!1,ma:s},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function _g(e){const t=e._freezeSettings(),n=Ed(e._databaseId);return new Tg(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Sg(e,t,n,s,r,i={}){const o=e.ya(i.merge||i.mergeFields?2:0,t,n,r);Ag("Data must be an object, but it was:",o,s);const a=xg(s,o);let c,u;if(i.merge)c=new Xo(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const s of i.mergeFields){const r=kg(t,s,n);if(!o.contains(r))throw new yi(pi.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Rg(e,r)||e.push(r)}c=new Xo(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new bg(new Aa(a),c,u)}function Dg(e,t){if(Cg(e=y(e)))return Ag("Unsupported field value:",t,e),xg(e,t);if(e instanceof yg)return function(e,t){if(!Eg(t.ca))throw t._a(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t._a(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.la&&4!==t.ca)throw t._a("Nested arrays are not supported");return function(e,t){const n=[];let s=0;for(const r of e){let e=Dg(r,t.wa(s));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),s++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=y(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Fc(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=Mi.fromDate(e);return{timestampValue:ju(t.serializer,n)}}if(e instanceof Mi){const n=new Mi(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ju(t.serializer,n)}}if(e instanceof vg)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof mg)return{bytesValue:qu(t.serializer,e._byteString)};if(e instanceof ig){const n=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(n))throw t._a(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:$u(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t._a(`Unsupported field value: ${tg(e)}`)}(e,t)}function xg(e,t){const n={};return zo(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):qo(e,((e,s)=>{const r=Dg(s,t.ha(e));null!=r&&(n[e]=r)})),{mapValue:{fields:n}}}function Cg(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Mi||e instanceof vg||e instanceof mg||e instanceof ig||e instanceof yg)}function Ag(e,t,n){if(!Cg(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const s=tg(n);throw"an object"===s?t._a(e+" a custom object"):t._a(e+" "+s)}}function kg(e,t,n){if((t=y(t))instanceof pg)return t._internalPath;if("string"==typeof t)return Mg(e,t);throw Og("Field path arguments must be of type string or ",e,!1,void 0,n)}const Ng=new RegExp("[~\\*/\\[\\]]");function Mg(e,t,n){if(t.search(Ng)>=0)throw Og(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new pg(...t.split("."))._internalPath}catch(s){throw Og(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Og(e,t,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${s}`),o&&(c+=` in document ${r}`),c+=")"),new yi(pi.INVALID_ARGUMENT,a+e+c)}function Rg(e,t){return e.some((e=>e.isEqual(t)))}class Lg{constructor(e,t,n,s,r){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new ig(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Pg(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Fg("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Pg extends Lg{data(){return super.data()}}function Fg(e,t){return"string"==typeof t?Mg(e,t):t instanceof pg?t._internalPath:t._delegate._internalPath}function Vg(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new yi(pi.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bg{convertValue(e,t="none"){switch(la(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ta(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(na(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw fi()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return qo(e,((e,s)=>{n[e]=this.convertValue(s,t)})),n}convertGeoPoint(e){return new vg(ta(e.latitude),ta(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=ra(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(ia(e));default:return null}}convertTimestamp(e){const t=ea(e);return new Mi(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Li.fromString(e);gi(fl(n));const s=new aa(n.get(1),n.get(3)),r=new Vi(n.popFirst(5));return s.isEqual(t)||li(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),r}}function Ug(e,t,n){let s;return s=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,s}class jg{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class qg extends Lg{constructor(e,t,n,s,r,i){super(e,t,n,s,i),this._firestore=e,this._firestoreImpl=e,this.metadata=r}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new zg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Fg("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class zg extends qg{data(e={}){return super.data(e)}}class Kg{constructor(e,t,n,s){this._firestore=e,this._userDataWriter=t,this._snapshot=s,this.metadata=new jg(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new zg(this._firestore,this._userDataWriter,n.key,n,new jg(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new yi(pi.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const s=new zg(e._firestore,e._userDataWriter,n.doc.key,n.doc,new jg(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:s,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const s=new zg(e._firestore,e._userDataWriter,t.doc.key,t.doc,new jg(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let r=-1,i=-1;return 0!==t.type&&(r=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:$g(t.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function $g(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return fi()}}class Gg extends Bg{constructor(e){super(),this.firestore=e}convertBytes(e){return new mg(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ig(this.firestore,null,t)}}function Hg(e){e=ng(e,og);const t=ng(e.firestore,dg),n=fg(t),s=new Gg(t);return Vg(e._query),function(e,t,n={}){const s=new vi;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,r){const i=new zf({next:n=>{t.enqueueAndForget((()=>hf(e,o))),n.fromCache&&"server"===s.source?r.reject(new yi(pi.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:e=>r.reject(e)}),o=new mf(n,i,{includeMetadataChanges:!0,Ku:!0});return lf(e,o)}(await Wf(e),e.asyncQueue,t,n,s))),s.promise}(n,e._query).then((n=>new Kg(t,s,e,n)))}function Qg(e,t,n){e=ng(e,ig);const s=ng(e.firestore,dg),r=Ug(e.converter,t,n);return Jg(s,[Sg(_g(s),"setDoc",e._key,r,null!==e.converter,n).toMutation(e._key,Jc.none())])}function Wg(e){return Jg(ng(e.firestore,dg),[new hu(e._key,Jc.none())])}function Xg(e,t){const n=ng(e.firestore,dg),s=ug(e),r=Ug(e.converter,t);return Jg(n,[Sg(_g(e.firestore),"addDoc",s._key,r,null!==e.converter,{}).toMutation(s._key,Jc.exists(!1))]).then((()=>s))}function Yg(e,...t){var n,s,r;e=y(e);let i={includeMetadataChanges:!1},o=0;"object"!=typeof t[o]||hg(t[o])||(i=t[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if(hg(t[o])){const e=t[o];t[o]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[o+1]=null===(s=e.error)||void 0===s?void 0:s.bind(e),t[o+2]=null===(r=e.complete)||void 0===r?void 0:r.bind(e)}let c,u,l;if(e instanceof ig)u=ng(e.firestore,dg),l=hc(e._key.path),c={next:n=>{t[o]&&t[o](function(e,t,n){const s=n.docs.get(t._key),r=new Gg(e);return new qg(e,r,t._key,s,new jg(n.hasPendingWrites,n.fromCache),t.converter)}(u,e,n))},error:t[o+1],complete:t[o+2]};else{const n=ng(e,og);u=ng(n.firestore,dg),l=n._query;const s=new Gg(u);c={next:e=>{t[o]&&t[o](new Kg(u,s,n,e))},error:t[o+1],complete:t[o+2]},Vg(e._query)}return function(e,t,n,s){const r=new zf(s),i=new mf(t,r,n);return e.asyncQueue.enqueueAndForget((async()=>lf(await Wf(e),i))),()=>{r.Dc(),e.asyncQueue.enqueueAndForget((async()=>hf(await Wf(e),i)))}}(fg(u),l,a,c)}function Jg(e,t){return function(e,t){const n=new vi;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const s=Bf(e);try{const e=await function(e,t){const n=mi(e),s=Mi.now(),r=t.reduce(((e,t)=>e.add(t.key)),Oc());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=_c(),c=Oc();return n.Zi.getEntries(e,r).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((r=>{i=r;const o=[];for(const e of t){const t=ru(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new au(e.key,t,ka(t.value.mapValue),Jc.exists(!0)))}return n.mutationQueue.addMutationBatch(e,s,o,t)})).next((t=>{o=t;const s=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:xc(i)})))}(s.localStore,t);s.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let s=e.Tc[e.currentUser.toKey()];s||(s=new Ko(Ai)),s=s.insert(t,n),e.Tc[e.currentUser.toKey()]=s}(s,e.batchId,n),await Pf(s,e.changes),await Kd(s.remoteStore)}catch(e){const t=sf(e,"Failed to persist write");n.reject(t)}}(await function(e){return Qf(e).then((e=>e.syncEngine))}(e),t,n))),n.promise}(fg(e),t)}!function(e,t=!0){oi="9.23.0",_e(new v("firestore",((e,{instanceIdentifier:n,options:s})=>{const r=e.getProvider("app").getImmediate(),i=new dg(new Ii(e.getProvider("auth-internal")),new Di(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new yi(pi.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new aa(e.options.projectId,t)}(r,n),r);return s=Object.assign({useFetchStreams:t},s),i._setSettings(s),i}),"PUBLIC").setMultipleInstances(!0)),Ce(ri,"3.13.0",e),Ce(ri,"3.13.0","esm2017")}();const Zg=function(e){const t="string"==typeof e?e:"(default)",n=function(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}("object"==typeof e?e:function(e=we){const t=Ee.get(e);if(!t&&e===we&&c())return xe();if(!t)throw Se.create("no-app",{appName:e});return t}(),"firestore").getImmediate({identifier:t});if(!n._initialized){const e=(e=>{const t=(e=>{var t,n;return null===(n=null===(t=a())||void 0===t?void 0:t.emulatorHosts)||void 0===n?void 0:n[e]})(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const s=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),s]:[t.substring(0,n),s]})("firestore");e&&function(e,t,n,s={}){var r;const i=(e=ng(e,rg))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&hi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),s.mockUserToken){let t,n;if("string"==typeof s.mockUserToken)t=s.mockUserToken,n=ii.MOCK_USER;else{t=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=t||"demo-project",s=e.iat||0,r=e.sub||e.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:s,exp:s+3600,auth_time:s,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e);return[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(s.mockUserToken,null===(r=e._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new yi(pi.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new ii(i)}e._authCredentials=new Ei(new wi(t,n))}}(n,...e)}return n}(xe({apiKey:"AIzaSyCg7xzeSJO7BtZgmetFzLHfRruhcDDISBI",authDomain:"budget-calculator-13b20.firebaseapp.com",projectId:"budget-calculator-13b20",storageBucket:"budget-calculator-13b20.firebasestorage.app",messagingSenderId:"913412660495",appId:"1:913412660495:web:cde3287ddd79827db0327a",measurementId:"G-Z2MR16FYB4"}));(function(e){!function(e){if(e._initialized||e._terminated)throw new yi(pi.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}(e=ng(e,dg));const t=fg(e);if(t._uninitializedComponentsProvider)throw new yi(pi.FAILED_PRECONDITION,"SDK cache is already specified.");hi("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),s=new qf;return function(e,t,n){const s=new vi;return e.asyncQueue.enqueue((async()=>{try{await $f(e,n),await Gf(e,t),s.resolve()}catch(e){const t=e;if(!Hf(t))throw t;hi("Error enabling indexeddb cache. Falling back to memory cache: "+t),s.reject(t)}})).then((()=>s.promise))}(t,s,new jf(s,n.cacheSizeBytes,void 0))})(Zg).catch((e=>{"failed-precondition"===e.code?console.error("Persistence failed (multiple tabs open):",e):"unimplemented"===e.code&&console.error("Persistence is not available:",e)}))},212:(e,t,n)=>{function s(){this.expenses=[],this.monthlyGoals={}}n.d(t,{A:()=>r}),s.prototype.addExpense=function(e,t,n,s,r,i=!1){this.expenses.push({person:e.toUpperCase(),description:t,category:n,amount:parseFloat(s),date:r,pending:i})},s.prototype.setMonthlyGoal=function(e,t){this.monthlyGoals[e.toUpperCase()]=parseFloat(t)},s.prototype.calculateTotal=function(){return this.expenses.reduce(((e,t)=>e+t.amount),0)},s.prototype.getExpenses=function(){return this.expenses},s.prototype.clearExpenses=function(){this.expenses=[]},s.prototype.calculateMonthlyTotals=function(e,t){const n={},s=new Date(t,e-1,1),r=new Date(t,e,0);return this.expenses.forEach((e=>{const t=new Date(e.date+"T00:00");t>=s&&t<=r&&(n[e.person]=(n[e.person]||0)+e.amount)})),n};const r=s}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={},_budgetCalculator_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(212),_firebase_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(94);document.addEventListener("DOMContentLoaded",(()=>{const expenseForm=document.getElementById("expense-form"),expenseList=document.getElementById("expense-list"),totalDisplay=document.getElementById("total-display"),individualTotalsContainer=document.getElementById("Year-to-Date-Total"),calculator=new _budgetCalculator_js__WEBPACK_IMPORTED_MODULE_0__.A;async function loadExpenses(){try{(await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.GG)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"))).forEach((e=>{const t=e.data();calculator.addExpense(t.person,t.name,t.category,t.amount,t.date)})),updateExpenseList(),updateTotal(),updateIndividualTotals(),updateMonthlyTotals()}catch(e){console.error("Error loading expenses:",e)}}async function loadMonthlyGoals(){try{(await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.GG)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"monthlyGoals"))).forEach((e=>{const t=e.data();calculator.monthlyGoals[t.person]=parseFloat(t.goal)})),updateMonthlyTotals()}catch(e){console.error("Error loading monthly goals:",e)}}function updateExpenseList(){const e=calculator.getExpenses();expenseList.innerHTML="",e.forEach((e=>{const t=document.createElement("li");let n=e.description?` (${e.description})`:"";t.textContent=`${e.person} spent $${e.amount.toFixed(2)} on ${e.category}${n} on ${e.date}`,t.textContent+=e.pending?" - Pending":"",t.style.color=e.pending?"orange":"green",expenseList.appendChild(t)}))}function updateTotal(){const e=calculator.calculateTotal();totalDisplay.textContent=`HouseHold Total: $${e.toFixed(2)}`}function updateIndividualTotals(){const e=calculator.getExpenses(),t={};e.forEach((e=>{t[e.person]=(t[e.person]||0)+e.amount})),individualTotalsContainer.innerHTML="<h3>Year to Date Individual Totals:</h3>",Object.entries(t).forEach((([e,t])=>{const n=document.createElement("p");n.textContent=`${e}: $${t.toFixed(2)}`,individualTotalsContainer.appendChild(n)}))}function updateMonthlyTotals(){const e=new Date,t=e.getMonth()+1,n=e.getFullYear(),s=new Date(n,t-1,1),r=new Date(n,t,0),i={year:"numeric",month:"2-digit",day:"2-digit"},o=s.toLocaleDateString(void 0,i),a=r.toLocaleDateString(void 0,i),c=calculator.calculateMonthlyTotals(t,n),u=document.getElementById("monthly-totals");u.innerHTML=`<h3>Monthly Totals (from ${o} to ${a}):</h3>`,Object.entries(c).forEach((([e,t])=>{const n=calculator.monthlyGoals[e]||0;let s=`${e}: $${t.toFixed(2)}`;n&&(s+=` (Goal: $${n.toFixed(2)})`,t>=n&&(s+=" - Warning: Exceeds monthly goal!"));const r=document.createElement("p");r.textContent=s,u.appendChild(r)}))}loadExpenses(),loadMonthlyGoals(),expenseForm.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(expenseForm),n=t.get("person"),s=t.get("name"),r=t.get("category"),i=parseFloat(t.get("amount")),o=t.get("expense-date")||(new Date).toISOString().slice(0,10);if(!n||!r||isNaN(i)||!o)return void console.error("Invalid input:",{person:n,name:s,category:r,amount:i,expenseDate:o});const a={person:n.toUpperCase(),name:s,category:r,amount:i,date:o};calculator.addExpense(a.person,a.name,a.category,a.amount,a.date,!0),updateExpenseList(),updateTotal(),updateIndividualTotals(),updateMonthlyTotals(),expenseForm.reset(),(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.gS)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"),{person:n,name:s,category:r,amount:i,date:o,timestamp:new Date}).then((e=>{console.log("Expense added to Firebase",e.id)})).catch((e=>{console.error("Error adding expense to Firebase:",e)}))}));const amountInput=document.getElementById("amount"),calcModal=document.getElementById("calc-modal"),calcDisplay=document.getElementById("calc-display"),calcButtons=document.querySelectorAll(".calc-buttons button"),calcClear=document.getElementById("calc-clear"),calcEquals=document.getElementById("calc-equals"),calcDelete=document.getElementById("calc-delete");amountInput.addEventListener("click",(e=>{e.stopPropagation(),calcModal.style.display="block",calcDisplay.textContent=""})),document.addEventListener("click",(e=>{e.target===amountInput||calcModal.contains(e.target)||(calcModal.style.display="none")})),calcButtons.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-value");t&&(calcDisplay.textContent+=t)}))})),calcClear.addEventListener("click",(()=>{calcDisplay.textContent=""})),calcEquals.addEventListener("click",(()=>{try{const result=eval(calcDisplay.textContent);amountInput.value=result,calcModal.style.display="none"}catch(e){calcDisplay.textContent="Error"}})),calcDelete.addEventListener("click",(()=>{calcDisplay.textContent=calcDisplay.textContent.slice(0,-1)}));const monthlyGoalForm=document.getElementById("monthly-goal-form");async function deleteExpense(e){try{await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.kd)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.H9)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses",e)),console.log(`Deleted expense doc: ${e}`)}catch(e){console.error(`Error deleting expense: ${e}`)}}function updateExpenseListFromSnapshot(e){expenseList.innerHTML="",e.forEach((e=>{const t=e.data(),n=e.id,s=e.metadata.hasPendingWrites,r=document.createElement("li");r.textContent=`${t.person} spent $${t.amount.toFixed(2)} on ${t.category} on ${t.date}`,r.textContent+=s?" - Pending":" - Added Successfully",r.style.color=s?"orange":"green";const i=document.createElement("button");i.textContent="Delete",i.addEventListener("click",(()=>{deleteExpense(n)})),r.appendChild(i),expenseList.appendChild(r)}))}monthlyGoalForm.addEventListener("submit",(async e=>{e.preventDefault();const t=e.target.elements["goal-person"].value,n=parseFloat(e.target.elements["goal-amount"].value);if(t&&!isNaN(n))try{const e=(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.H9)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"monthlyGoals",t.toUpperCase());await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.BN)(e,{person:t.toUpperCase(),goal:n}),calculator.setMonthlyGoal(t,n),updateMonthlyTotals()}catch(e){console.error("Error setting monthly goal:",e)}monthlyGoalForm.reset()})),(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.aQ)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"),{includeMetadataChanges:!0},(e=>{console.log("Snapshot fired, number of documents:",e.docs.length),updateExpenseListFromSnapshot(e)}))}))})();