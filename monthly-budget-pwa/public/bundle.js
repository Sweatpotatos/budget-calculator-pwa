/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={94:(t,e,n)=>{n.d(e,{gS:()=>Gg,rJ:()=>ag,db:()=>Qg,H9:()=>cg,GG:()=>Kg,BN:()=>$g});const s=function(t){const e=[];let n=0;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);r<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(r=65536+((1023&r)<<10)+(1023&t.charCodeAt(++s)),e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128)}return e},r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let e=0;e<t.length;e+=3){const r=t[e],i=e+1<t.length,o=i?t[e+1]:0,a=e+2<t.length,c=a?t[e+2]:0,u=r>>2,l=(3&r)<<4|o>>4;let h=(15&o)<<2|c>>6,d=63&c;a||(d=64,i||(h=64)),s.push(n[u],n[l],n[h],n[d])}return s.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(s(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,s=0;for(;n<t.length;){const r=t[n++];if(r<128)e[s++]=String.fromCharCode(r);else if(r>191&&r<224){const i=t[n++];e[s++]=String.fromCharCode((31&r)<<6|63&i)}else if(r>239&&r<365){const i=((7&r)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536;e[s++]=String.fromCharCode(55296+(i>>10)),e[s++]=String.fromCharCode(56320+(1023&i))}else{const i=t[n++],o=t[n++];e[s++]=String.fromCharCode((15&r)<<12|(63&i)<<6|63&o)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let e=0;e<t.length;){const r=n[t.charAt(e++)],o=e<t.length?n[t.charAt(e)]:0;++e;const a=e<t.length?n[t.charAt(e)]:64;++e;const c=e<t.length?n[t.charAt(e)]:64;if(++e,null==r||null==o||null==a||null==c)throw new i;const u=r<<2|o>>4;if(s.push(u),64!==a){const t=o<<4&240|a>>2;if(s.push(t),64!==c){const t=a<<6&192|c;s.push(t)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}};class i extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(t){return function(t){const e=s(t);return r.encodeByteArray(e,!0)}(t).replace(/\./g,"")},a=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const t=process.env.__FIREBASE_DEFAULTS__;return t?JSON.parse(t):void 0})()||(()=>{if("undefined"==typeof document)return;let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(t){return}const e=t&&function(t){try{return r.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null}(t[1]);return e&&JSON.parse(e)})()}catch(t){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${t}`)}},c=()=>{var t;return null===(t=a())||void 0===t?void 0:t.config};class u{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}wrapCallback(t){return(e,n)=>{e?this.reject(e):this.resolve(n),"function"==typeof t&&(this.promise.catch((()=>{})),1===t.length?t(e):t(e,n))}}}function l(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){try{return"object"==typeof indexedDB}catch(t){return!1}}class d extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){const n=e[0]||{},s=`${this.service}/${t}`,r=this.errors[t],i=r?function(t,e){return t.replace(g,((t,n)=>{const s=e[n];return null!=s?String(s):`<${n}?>`}))}(r,n):"Error",o=`${this.serviceName}: ${i} (${s}).`;return new d(s,o,n)}}const g=/\{\$([^}]+)}/g;function m(t,e){if(t===e)return!0;const n=Object.keys(t),s=Object.keys(e);for(const r of n){if(!s.includes(r))return!1;const n=t[r],i=e[r];if(p(n)&&p(i)){if(!m(n,i))return!1}else if(n!==i)return!1}for(const t of s)if(!n.includes(t))return!1;return!0}function p(t){return null!==t&&"object"==typeof t}function y(t){return t&&t._delegate?t._delegate:t}class v{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}const w="[DEFAULT]";class b{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const t=new u;if(this.instancesDeferred.set(e,t),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&t.resolve(n)}catch(t){}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const n=this.normalizeInstanceIdentifier(null==t?void 0:t.identifier),s=null!==(e=null==t?void 0:t.optional)&&void 0!==e&&e;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(s)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(t){if(s)return null;throw t}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,this.shouldAutoInitialize()){if(function(t){return"EAGER"===t.instantiationMode}(t))try{this.getOrInitializeService({instanceIdentifier:w})}catch(t){}for(const[t,e]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(t);try{const t=this.getOrInitializeService({instanceIdentifier:n});e.resolve(t)}catch(t){}}}}clearInstance(t=w){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter((t=>"INTERNAL"in t)).map((t=>t.INTERNAL.delete())),...t.filter((t=>"_delete"in t)).map((t=>t._delete()))])}isComponentSet(){return null!=this.component}isInitialized(t=w){return this.instances.has(t)}getOptions(t=w){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,n=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const s=this.getOrInitializeService({instanceIdentifier:n,options:e});for(const[t,e]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(t)&&e.resolve(s);return s}onInit(t,e){var n;const s=this.normalizeInstanceIdentifier(e),r=null!==(n=this.onInitCallbacks.get(s))&&void 0!==n?n:new Set;r.add(t),this.onInitCallbacks.set(s,r);const i=this.instances.get(s);return i&&t(i,s),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const n=this.onInitCallbacks.get(e);if(n)for(const s of n)try{s(t,e)}catch(t){}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let n=this.instances.get(t);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(s=t,s===w?void 0:s),options:e}),this.instances.set(t,n),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(n,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,n)}catch(t){}var s;return n||null}normalizeInstanceIdentifier(t=w){return this.component?this.component.multipleInstances?t:w:t}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class E{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new b(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}const I=[];var T;!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(T||(T={}));const S={debug:T.DEBUG,verbose:T.VERBOSE,info:T.INFO,warn:T.WARN,error:T.ERROR,silent:T.SILENT},_=T.INFO,D={[T.DEBUG]:"log",[T.VERBOSE]:"log",[T.INFO]:"info",[T.WARN]:"warn",[T.ERROR]:"error"},x=(t,e,...n)=>{if(e<t.logLevel)return;const s=(new Date).toISOString(),r=D[e];if(!r)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[r](`[${s}]  ${t.name}:`,...n)};class C{constructor(t){this.name=t,this._logLevel=_,this._logHandler=x,this._userLogHandler=null,I.push(this)}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in T))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?S[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,T.DEBUG,...t),this._logHandler(this,T.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,T.VERBOSE,...t),this._logHandler(this,T.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,T.INFO,...t),this._logHandler(this,T.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,T.WARN,...t),this._logHandler(this,T.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,T.ERROR,...t),this._logHandler(this,T.ERROR,...t)}}let A,k;const N=new WeakMap,M=new WeakMap,O=new WeakMap,R=new WeakMap,L=new WeakMap;let P={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return M.get(t);if("objectStoreNames"===e)return t.objectStoreNames||O.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return V(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function F(t){return"function"==typeof t?(e=t)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(B(this),t),V(N.get(this))}:function(...t){return V(e.apply(B(this),t))}:function(t,...n){const s=e.call(B(this),t,...n);return O.set(s,t.sort?t.sort():[t]),V(s)}:(t instanceof IDBTransaction&&function(t){if(M.has(t))return;const e=new Promise(((e,n)=>{const s=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",i),t.removeEventListener("abort",i)},r=()=>{e(),s()},i=()=>{n(t.error||new DOMException("AbortError","AbortError")),s()};t.addEventListener("complete",r),t.addEventListener("error",i),t.addEventListener("abort",i)}));M.set(t,e)}(t),n=t,(A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>n instanceof t))?new Proxy(t,P):t);var e,n}function V(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,n)=>{const s=()=>{t.removeEventListener("success",r),t.removeEventListener("error",i)},r=()=>{e(V(t.result)),s()},i=()=>{n(t.error),s()};t.addEventListener("success",r),t.addEventListener("error",i)}));return e.then((e=>{e instanceof IDBCursor&&N.set(e,t)})).catch((()=>{})),L.set(e,t),e}(t);if(R.has(t))return R.get(t);const e=F(t);return e!==t&&(R.set(t,e),L.set(e,t)),e}const B=t=>L.get(t),U=["get","getKey","getAll","getAllKeys","count"],j=["put","add","delete","clear"],q=new Map;function z(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(q.get(e))return q.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,r=j.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!r&&!U.includes(n))return;const i=async function(t,...e){const i=this.transaction(t,r?"readwrite":"readonly");let o=i.store;return s&&(o=o.index(e.shift())),(await Promise.all([o[n](...e),r&&i.done]))[0]};return q.set(e,i),i}var K;K=P,P={...K,get:(t,e,n)=>z(t,e)||K.get(t,e,n),has:(t,e)=>!!z(t,e)||K.has(t,e)};class ${constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map((t=>{if(function(t){const e=t.getComponent();return"VERSION"===(null==e?void 0:e.type)}(t)){const e=t.getImmediate();return`${e.library}/${e.version}`}return null})).filter((t=>t)).join(" ")}}const G="@firebase/app",H="0.9.13",Q=new C("@firebase/app"),W="@firebase/app-compat",X="@firebase/analytics-compat",Y="@firebase/analytics",J="@firebase/app-check-compat",Z="@firebase/app-check",tt="@firebase/auth",et="@firebase/auth-compat",nt="@firebase/database",st="@firebase/database-compat",rt="@firebase/functions",it="@firebase/functions-compat",ot="@firebase/installations",at="@firebase/installations-compat",ct="@firebase/messaging",ut="@firebase/messaging-compat",lt="@firebase/performance",ht="@firebase/performance-compat",dt="@firebase/remote-config",ft="@firebase/remote-config-compat",gt="@firebase/storage",mt="@firebase/storage-compat",pt="@firebase/firestore",yt="@firebase/firestore-compat",vt="firebase",wt="[DEFAULT]",bt={[G]:"fire-core",[W]:"fire-core-compat",[Y]:"fire-analytics",[X]:"fire-analytics-compat",[Z]:"fire-app-check",[J]:"fire-app-check-compat",[tt]:"fire-auth",[et]:"fire-auth-compat",[nt]:"fire-rtdb",[st]:"fire-rtdb-compat",[rt]:"fire-fn",[it]:"fire-fn-compat",[ot]:"fire-iid",[at]:"fire-iid-compat",[ct]:"fire-fcm",[ut]:"fire-fcm-compat",[lt]:"fire-perf",[ht]:"fire-perf-compat",[dt]:"fire-rc",[ft]:"fire-rc-compat",[gt]:"fire-gcs",[mt]:"fire-gcs-compat",[pt]:"fire-fst",[yt]:"fire-fst-compat","fire-js":"fire-js",[vt]:"fire-js-all"},Et=new Map,It=new Map;function Tt(t,e){try{t.container.addComponent(e)}catch(n){Q.debug(`Component ${e.name} failed to register with FirebaseApp ${t.name}`,n)}}function St(t){const e=t.name;if(It.has(e))return Q.debug(`There were multiple attempts to register component ${e}.`),!1;It.set(e,t);for(const e of Et.values())Tt(e,t);return!0}const _t=new f("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class Dt{constructor(t,e,n){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new v("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw _t.create("app-deleted",{appName:this._name})}}function xt(t,e={}){let n=t;"object"!=typeof e&&(e={name:e});const s=Object.assign({name:wt,automaticDataCollectionEnabled:!1},e),r=s.name;if("string"!=typeof r||!r)throw _t.create("bad-app-name",{appName:String(r)});if(n||(n=c()),!n)throw _t.create("no-options");const i=Et.get(r);if(i){if(m(n,i.options)&&m(s,i.config))return i;throw _t.create("duplicate-app",{appName:r})}const o=new E(r);for(const t of It.values())o.addComponent(t);const a=new Dt(n,s,o);return Et.set(r,a),a}function Ct(t,e,n){var s;let r=null!==(s=bt[t])&&void 0!==s?s:t;n&&(r+=`-${n}`);const i=r.match(/\s|\//),o=e.match(/\s|\//);if(i||o){const t=[`Unable to register library "${r}" with version "${e}":`];return i&&t.push(`library name "${r}" contains illegal characters (whitespace or "/")`),i&&o&&t.push("and"),o&&t.push(`version name "${e}" contains illegal characters (whitespace or "/")`),void Q.warn(t.join(" "))}St(new v(`${r}-version`,(()=>({library:r,version:e})),"VERSION"))}const At="firebase-heartbeat-store";let kt=null;function Nt(){return kt||(kt=function(t,e,{blocked:n,upgrade:s,blocking:r,terminated:i}={}){const o=indexedDB.open(t,e),a=V(o);return s&&o.addEventListener("upgradeneeded",(t=>{s(V(o.result),t.oldVersion,t.newVersion,V(o.transaction),t)})),n&&o.addEventListener("blocked",(t=>n(t.oldVersion,t.newVersion,t))),a.then((t=>{i&&t.addEventListener("close",(()=>i())),r&&t.addEventListener("versionchange",(t=>r(t.oldVersion,t.newVersion,t)))})).catch((()=>{})),a}("firebase-heartbeat-database",1,{upgrade:(t,e)=>{0===e&&t.createObjectStore(At)}}).catch((t=>{throw _t.create("idb-open",{originalErrorMessage:t.message})}))),kt}async function Mt(t,e){try{const n=(await Nt()).transaction(At,"readwrite"),s=n.objectStore(At);await s.put(e,Ot(t)),await n.done}catch(t){if(t instanceof d)Q.warn(t.message);else{const e=_t.create("idb-set",{originalErrorMessage:null==t?void 0:t.message});Q.warn(e.message)}}}function Ot(t){return`${t.name}!${t.options.appId}`}class Rt{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new Pt(e),this._heartbeatsCachePromise=this._storage.read().then((t=>(this._heartbeatsCache=t,t)))}async triggerHeartbeat(){const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),e=Lt();if(null===this._heartbeatsCache&&(this._heartbeatsCache=await this._heartbeatsCachePromise),this._heartbeatsCache.lastSentHeartbeatDate!==e&&!this._heartbeatsCache.heartbeats.some((t=>t.date===e)))return this._heartbeatsCache.heartbeats.push({date:e,agent:t}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((t=>{const e=new Date(t.date).valueOf();return Date.now()-e<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null===this._heartbeatsCache||0===this._heartbeatsCache.heartbeats.length)return"";const t=Lt(),{heartbeatsToSend:e,unsentEntries:n}=function(t,e=1024){const n=[];let s=t.slice();for(const r of t){const t=n.find((t=>t.agent===r.agent));if(t){if(t.dates.push(r.date),Ft(n)>e){t.dates.pop();break}}else if(n.push({agent:r.agent,dates:[r.date]}),Ft(n)>e){n.pop();break}s=s.slice(1)}return{heartbeatsToSend:n,unsentEntries:s}}(this._heartbeatsCache.heartbeats),s=o(JSON.stringify({version:2,heartbeats:e}));return this._heartbeatsCache.lastSentHeartbeatDate=t,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),s}}function Lt(){return(new Date).toISOString().substring(0,10)}class Pt{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!h()&&new Promise(((t,e)=>{try{let n=!0;const s="validate-browser-context-for-indexeddb-analytics-module",r=self.indexedDB.open(s);r.onsuccess=()=>{r.result.close(),n||self.indexedDB.deleteDatabase(s),t(!0)},r.onupgradeneeded=()=>{n=!1},r.onerror=()=>{var t;e((null===(t=r.error)||void 0===t?void 0:t.message)||"")}}catch(t){e(t)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const t=await async function(t){try{const e=await Nt();return await e.transaction(At).objectStore(At).get(Ot(t))}catch(t){if(t instanceof d)Q.warn(t.message);else{const e=_t.create("idb-get",{originalErrorMessage:null==t?void 0:t.message});Q.warn(e.message)}}}(this.app);return t||{heartbeats:[]}}return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return Mt(this.app,{lastSentHeartbeatDate:null!==(e=t.lastSentHeartbeatDate)&&void 0!==e?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return Mt(this.app,{lastSentHeartbeatDate:null!==(e=t.lastSentHeartbeatDate)&&void 0!==e?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}}}function Ft(t){return o(JSON.stringify({version:2,heartbeats:t})).length}St(new v("platform-logger",(t=>new $(t)),"PRIVATE")),St(new v("heartbeat",(t=>new Rt(t)),"PRIVATE")),Ct(G,H,""),Ct(G,H,"esm2017"),Ct("fire-js",""),Ct("firebase","9.23.0","app");var Vt,Bt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Ut={},jt=jt||{},qt=Bt||self;function zt(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function Kt(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var $t="closure_uid_"+(1e9*Math.random()>>>0),Gt=0;function Ht(t,e,n){return t.call.apply(t.bind,arguments)}function Qt(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function Wt(t,e,n){return(Wt=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Ht:Qt).apply(null,arguments)}function Xt(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function Yt(t,e){function n(){}n.prototype=e.prototype,t.$=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.ac=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function Jt(){this.s=this.s,this.o=this.o}Jt.prototype.s=!1,Jt.prototype.sa=function(){var t;!this.s&&(this.s=!0,this.N(),0)&&(t=this,Object.prototype.hasOwnProperty.call(t,$t)&&t[$t]||(t[$t]=++Gt))},Jt.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Zt=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function te(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function ee(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(zt(n)){const e=t.length||0,s=n.length||0;t.length=e+s;for(let r=0;r<s;r++)t[e+r]=n[r]}else t.push(n)}}function ne(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}ne.prototype.h=function(){this.defaultPrevented=!0};var se=function(){if(!qt.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{qt.addEventListener("test",(()=>{}),e),qt.removeEventListener("test",(()=>{}),e)}catch(t){}return t}();function re(t){return/^[\s\xa0]*$/.test(t)}function ie(){var t=qt.navigator;return t&&(t=t.userAgent)?t:""}function oe(t){return-1!=ie().indexOf(t)}function ae(t){return ae[" "](t),t}ae[" "]=function(){};var ce,ue,le,he=oe("Opera"),de=oe("Trident")||oe("MSIE"),fe=oe("Edge"),ge=fe||de,me=oe("Gecko")&&!(-1!=ie().toLowerCase().indexOf("webkit")&&!oe("Edge"))&&!(oe("Trident")||oe("MSIE"))&&!oe("Edge"),pe=-1!=ie().toLowerCase().indexOf("webkit")&&!oe("Edge");function ye(){var t=qt.document;return t?t.documentMode:void 0}t:{var ve="",we=(ue=ie(),me?/rv:([^\);]+)(\)|;)/.exec(ue):fe?/Edge\/([\d\.]+)/.exec(ue):de?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ue):pe?/WebKit\/(\S+)/.exec(ue):he?/(?:Version)[ \/]?(\S+)/.exec(ue):void 0);if(we&&(ve=we?we[1]:""),de){var be=ye();if(null!=be&&be>parseFloat(ve)){ce=String(be);break t}}ce=ve}qt.document&&de?le=ye()||parseInt(ce,10)||void 0:le=void 0;var Ee=le;function Ie(t,e){if(ne.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(me){t:{try{ae(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:Te[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&Ie.$.h.call(this)}}Yt(Ie,ne);var Te={2:"touch",3:"pen",4:"mouse"};Ie.prototype.h=function(){Ie.$.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var Se="closure_listenable_"+(1e6*Math.random()|0),_e=0;function De(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.la=r,this.key=++_e,this.fa=this.ia=!1}function xe(t){t.fa=!0,t.listener=null,t.proxy=null,t.src=null,t.la=null}function Ce(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function Ae(t){const e={};for(const n in t)e[n]=t[n];return e}const ke="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Ne(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<ke.length;e++)n=ke[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function Me(t){this.src=t,this.g={},this.h=0}function Oe(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=Zt(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(xe(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function Re(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.fa&&i.listener==e&&i.capture==!!n&&i.la==s)return r}return-1}Me.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=Re(t,e,s,r);return-1<o?(e=t[o],n||(e.ia=!1)):((e=new De(e,this.src,i,!!s,r)).ia=n,t.push(e)),e};var Le="closure_lm_"+(1e6*Math.random()|0),Pe={};function Fe(t,e,n,s,r){if(s&&s.once)return Be(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)Fe(t,e[i],n,s,r);return null}return n=Ge(n),t&&t[Se]?t.O(e,n,Kt(s)?!!s.capture:!!s,r):Ve(t,e,n,!1,s,r)}function Ve(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=Kt(r)?!!r.capture:!!r,a=Ke(t);if(a||(t[Le]=a=new Me(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){const t=ze;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)se||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(qe(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function Be(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)Be(t,e[i],n,s,r);return null}return n=Ge(n),t&&t[Se]?t.P(e,n,Kt(s)?!!s.capture:!!s,r):Ve(t,e,n,!0,s,r)}function Ue(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)Ue(t,e[i],n,s,r);else s=Kt(s)?!!s.capture:!!s,n=Ge(n),t&&t[Se]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=Re(i=t.g[e],n,s,r))&&(xe(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=Ke(t))&&(e=t.g[e.toString()],t=-1,e&&(t=Re(e,n,s,r)),(n=-1<t?e[t]:null)&&je(n))}function je(t){if("number"!=typeof t&&t&&!t.fa){var e=t.src;if(e&&e[Se])Oe(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(qe(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Ke(e))?(Oe(n,t),0==n.h&&(n.src=null,e[Le]=null)):xe(t)}}}function qe(t){return t in Pe?Pe[t]:Pe[t]="on"+t}function ze(t,e){if(t.fa)t=!0;else{e=new Ie(e,this);var n=t.listener,s=t.la||t.src;t.ia&&je(t),t=n.call(s,e)}return t}function Ke(t){return(t=t[Le])instanceof Me?t:null}var $e="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ge(t){return"function"==typeof t?t:(t[$e]||(t[$e]=function(e){return t.handleEvent(e)}),t[$e])}function He(){Jt.call(this),this.i=new Me(this),this.S=this,this.J=null}function Qe(t,e){var n,s=t.J;if(s)for(n=[];s;s=s.J)n.push(s);if(t=t.S,s=e.type||e,"string"==typeof e)e=new ne(e,t);else if(e instanceof ne)e.target=e.target||t;else{var r=e;Ne(e=new ne(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=We(o,s,!0,e)&&r}if(r=We(o=e.g=t,s,!0,e)&&r,r=We(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=We(o=e.g=n[i],s,!1,e)&&r}function We(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.fa&&o.capture==n){var a=o.listener,c=o.la||o.src;o.ia&&Oe(t.i,o),r=!1!==a.call(c,s)&&r}}return r&&!s.defaultPrevented}Yt(He,Jt),He.prototype[Se]=!0,He.prototype.removeEventListener=function(t,e,n,s){Ue(this,t,e,n,s)},He.prototype.N=function(){if(He.$.N.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)xe(n[s]);delete e.g[t],e.h--}}this.J=null},He.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},He.prototype.P=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var Xe=qt.JSON.stringify;function Ye(){var t=rn;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Je=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Ze),(t=>t.reset()));class Ze{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function tn(t){var e=1;t=t.split(":");const n=[];for(;0<e&&t.length;)n.push(t.shift()),e--;return t.length&&n.push(t.join(":")),n}function en(t){qt.setTimeout((()=>{throw t}),0)}let nn,sn=!1,rn=new class{constructor(){this.h=this.g=null}add(t,e){const n=Je.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}},on=()=>{const t=qt.Promise.resolve(void 0);nn=()=>{t.then(an)}};var an=()=>{for(var t;t=Ye();){try{t.h.call(t.g)}catch(t){en(t)}var e=Je;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}sn=!1};function cn(t,e){He.call(this),this.h=t||1,this.g=e||qt,this.j=Wt(this.qb,this),this.l=Date.now()}function un(t){t.ga=!1,t.T&&(t.g.clearTimeout(t.T),t.T=null)}function ln(t,e,n){if("function"==typeof t)n&&(t=Wt(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=Wt(t.handleEvent,t)}return 2147483647<Number(e)?-1:qt.setTimeout(t,e||0)}function hn(t){t.g=ln((()=>{t.g=null,t.i&&(t.i=!1,hn(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}Yt(cn,He),(Vt=cn.prototype).ga=!1,Vt.T=null,Vt.qb=function(){if(this.ga){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-t):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Qe(this,"tick"),this.ga&&(un(this),this.start()))}},Vt.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},Vt.N=function(){cn.$.N.call(this),un(this),delete this.g};class dn extends Jt{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:hn(this)}N(){super.N(),this.g&&(qt.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function fn(t){Jt.call(this),this.h=t,this.g={}}Yt(fn,Jt);var gn=[];function mn(t,e,n,s){Array.isArray(n)||(n&&(gn[0]=n.toString()),n=gn);for(var r=0;r<n.length;r++){var i=Fe(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function pn(t){Ce(t.g,(function(t,e){this.g.hasOwnProperty(e)&&je(t)}),t),t.g={}}function yn(){this.g=!0}function vn(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return Xe(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}fn.prototype.N=function(){fn.$.N.call(this),pn(this)},fn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},yn.prototype.Ea=function(){this.g=!1},yn.prototype.info=function(){};var wn={},bn=null;function En(){return bn=bn||new He}function In(t){ne.call(this,wn.Ta,t)}function Tn(t){const e=En();Qe(e,new In(e))}function Sn(t,e){ne.call(this,wn.STAT_EVENT,t),this.stat=e}function _n(t){const e=En();Qe(e,new Sn(e,t))}function Dn(t,e){ne.call(this,wn.Ua,t),this.size=e}function xn(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return qt.setTimeout((function(){t()}),e)}wn.Ta="serverreachability",Yt(In,ne),wn.STAT_EVENT="statevent",Yt(Sn,ne),wn.Ua="timingevent",Yt(Dn,ne);var Cn={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},An={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function kn(){}function Nn(t){return t.h||(t.h=t.i())}function Mn(){}kn.prototype.h=null;var On,Rn={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function Ln(){ne.call(this,"d")}function Pn(){ne.call(this,"c")}function Fn(){}function Vn(t,e,n,s){this.l=t,this.j=e,this.m=n,this.W=s||1,this.U=new fn(this),this.P=Un,t=ge?125:void 0,this.V=new cn(t),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Bn}function Bn(){this.i=null,this.g="",this.h=!1}Yt(Ln,ne),Yt(Pn,ne),Yt(Fn,kn),Fn.prototype.g=function(){return new XMLHttpRequest},Fn.prototype.i=function(){return{}},On=new Fn;var Un=45e3,jn={},qn={};function zn(t,e,n){t.L=1,t.v=cs(ss(e)),t.s=n,t.S=!0,Kn(t,null)}function Kn(t,e){t.G=Date.now(),Qn(t),t.A=ss(t.v);var n=t.A,s=t.W;Array.isArray(s)||(s=[String(s)]),Es(n.i,"t",s),t.C=0,n=t.l.J,t.h=new Bn,t.g=Er(t.l,n?e:null,!t.s),0<t.O&&(t.M=new dn(Wt(t.Pa,t,t.g),t.O)),mn(t.U,t.g,"readystatechange",t.nb),e=t.I?Ae(t.I):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ha(t.A,t.u,t.s,e)):(t.u="GET",t.g.ha(t.A,t.u,null,e)),Tn(),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+u+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.W,t.s)}function $n(t){return!!t.g&&"GET"==t.u&&2!=t.L&&t.l.Ha}function Gn(t,e,n){let s,r=!0;for(;!t.J&&t.C<n.length;){if(s=Hn(t,n),s==qn){4==e&&(t.o=4,_n(14),r=!1),vn(t.j,t.m,null,"[Incomplete Response]");break}if(s==jn){t.o=4,_n(15),vn(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}vn(t.j,t.m,s,null),Zn(t,s)}$n(t)&&s!=qn&&s!=jn&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,_n(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.ba&&(t.ba=!0,(e=t.l).g==t&&e.ca&&!e.M&&(e.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),fr(e),e.M=!0,_n(11))):(vn(t.j,t.m,n,"[Invalid Chunked Response]"),Jn(t),Yn(t))}function Hn(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?qn:(n=Number(e.substring(n,s)),isNaN(n)?jn:(s+=1)+n>e.length?qn:(e=e.slice(s,s+n),t.C=s+n,e))}function Qn(t){t.Y=Date.now()+t.P,Wn(t,t.P)}function Wn(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=xn(Wt(t.lb,t),e)}function Xn(t){t.B&&(qt.clearTimeout(t.B),t.B=null)}function Yn(t){0==t.l.H||t.J||pr(t.l,t)}function Jn(t){Xn(t);var e=t.M;e&&"function"==typeof e.sa&&e.sa(),t.M=null,un(t.V),pn(t.U),t.g&&(e=t.g,t.g=null,e.abort(),e.sa())}function Zn(t,e){try{var n=t.l;if(0!=n.H&&(n.g==t||Cs(n.i,t)))if(!t.K&&Cs(n.i,t)&&3==n.H){try{var s=n.Ja.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.G+3e3<t.G))break t;mr(n),ir(n)}dr(n),_n(18)}}else n.Fa=r[1],0<n.Fa-n.V&&37500>r[2]&&n.G&&0==n.A&&!n.v&&(n.v=xn(Wt(n.ib,n),6e3));if(1>=xs(n.i)&&n.oa){try{n.oa()}catch(t){}n.oa=void 0}}else vr(n,11)}else if((t.K||n.g==t)&&mr(n),!re(e))for(r=n.Ja.g.parse(e),e=0;e<r.length;e++){let u=r[e];if(n.V=u[0],u=u[1],2==n.H)if("c"==u[0]){n.K=u[1],n.pa=u[2];const e=u[3];null!=e&&(n.ra=e,n.l.info("VER="+n.ra));const r=u[4];null!=r&&(n.Ga=r,n.l.info("SVER="+n.Ga));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(s=1.5*l,n.L=s,n.l.info("backChannelRequestTimeoutMs_="+s)),s=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(As(i,i.h),i.h=null))}if(s.F){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.Da=t,as(s.I,s.F,t))}}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-t.G,n.l.info("Handshake RTT: "+n.S+"ms"));var o=t;if((s=n).wa=br(s,s.J?s.pa:null,s.Y),o.K){ks(s.i,o);var a=o,c=s.L;c&&a.setTimeout(c),a.B&&(Xn(a),Qn(a)),s.g=o}else hr(s);0<n.j.length&&ar(n)}else"stop"!=u[0]&&"close"!=u[0]||vr(n,7);else 3==n.H&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?vr(n,7):rr(n):"noop"!=u[0]&&n.h&&n.h.Aa(u),n.A=0)}Tn()}catch(t){}}function ts(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(zt(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.ta&&"function"==typeof t.ta)return t.ta();if(!t.Z||"function"!=typeof t.Z){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(zt(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const s in t)e[n++]=s;return e}}}(t),s=function(t){if(t.Z&&"function"==typeof t.Z)return t.Z();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(zt(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length,i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}(Vt=Vn.prototype).setTimeout=function(t){this.P=t},Vt.nb=function(t){t=t.target;const e=this.M;e&&3==Js(t)?e.l():this.Pa(t)},Vt.Pa=function(t){try{if(t==this.g)t:{const l=Js(this.g);var e=this.g.Ia();if(this.g.da(),!(3>l)&&(3!=l||ge||this.g&&(this.h.h||this.g.ja()||Zs(this.g)))){this.J||4!=l||7==e||Tn(),Xn(this);var n=this.g.da();this.ca=n;e:if($n(this)){var s=Zs(this.g);t="";var r=s.length,i=4==Js(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Jn(this),Yn(this);var o="";break e}this.h.i=new qt.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.W,l,n),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!re(a)){var u=a;break e}}u=null}if(!(n=u)){this.i=!1,this.o=3,_n(12),Jn(this),Yn(this);break t}vn(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Zn(this,n)}this.S?(Gn(this,l,o),ge&&this.i&&3==l&&(mn(this.U,this.V,"tick",this.mb),this.V.start())):(vn(this.j,this.m,o,null),Zn(this,o)),4==l&&Jn(this),this.i&&!this.J&&(4==l?pr(this.l,this):(this.i=!1,Qn(this)))}else(function(t){const e={};t=(t.g&&2<=Js(t)&&t.g.getAllResponseHeaders()||"").split("\r\n");for(let s=0;s<t.length;s++){if(re(t[s]))continue;var n=tn(t[s]);const r=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const i=e[r]||[];e[r]=i,i.push(n)}!function(t,e){for(const n in t)e.call(void 0,t[n],n,t)}(e,(function(t){return t.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.o=3,_n(12)):(this.o=0,_n(13)),Jn(this),Yn(this)}}}catch(t){}},Vt.mb=function(){if(this.g){var t=Js(this.g),e=this.g.ja();this.C<e.length&&(Xn(this),Gn(this,t,e),this.i&&4!=t&&Qn(this))}},Vt.cancel=function(){this.J=!0,Jn(this)},Vt.lb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.L&&(Tn(),_n(17)),Jn(this),this.o=2,Yn(this)):Wn(this,this.Y-t)};var es=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ns(t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof ns){this.h=t.h,rs(this,t.j),this.s=t.s,this.g=t.g,is(this,t.m),this.l=t.l;var e=t.i,n=new ys;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),os(this,n),this.o=t.o}else t&&(e=String(t).match(es))?(this.h=!1,rs(this,e[1]||"",!0),this.s=us(e[2]||""),this.g=us(e[3]||"",!0),is(this,e[4]),this.l=us(e[5]||"",!0),os(this,e[6]||"",!0),this.o=us(e[7]||"")):(this.h=!1,this.i=new ys(null,this.h))}function ss(t){return new ns(t)}function rs(t,e,n){t.j=n?us(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function is(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function os(t,e,n){e instanceof ys?(t.i=e,function(t,e){e&&!t.j&&(vs(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(ws(this,e),Es(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=ls(e,ms)),t.i=new ys(e,t.h))}function as(t,e,n){t.i.set(e,n)}function cs(t){return as(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function us(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function ls(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,hs),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function hs(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ns.prototype.toString=function(){var t=[],e=this.j;e&&t.push(ls(e,ds,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(ls(e,ds,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(ls(n,"/"==n.charAt(0)?gs:fs,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",ls(n,ps)),t.join("")};var ds=/[#\/\?@]/g,fs=/[#\?:]/g,gs=/[#\?]/g,ms=/[#\?@]/g,ps=/#/g;function ys(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function vs(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function ws(t,e){vs(t),e=Is(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function bs(t,e){return vs(t),e=Is(t,e),t.g.has(e)}function Es(t,e,n){ws(t,e),0<n.length&&(t.i=null,t.g.set(Is(t,e),te(n)),t.h+=n.length)}function Is(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(Vt=ys.prototype).add=function(t,e){vs(this),this.i=null,t=Is(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},Vt.forEach=function(t,e){vs(this),this.g.forEach((function(n,s){n.forEach((function(n){t.call(e,n,s,this)}),this)}),this)},Vt.ta=function(){vs(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let s=0;s<e.length;s++){const r=t[s];for(let t=0;t<r.length;t++)n.push(e[s])}return n},Vt.Z=function(t){vs(this);let e=[];if("string"==typeof t)bs(this,t)&&(e=e.concat(this.g.get(Is(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},Vt.set=function(t,e){return vs(this),this.i=null,bs(this,t=Is(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},Vt.get=function(t,e){return t&&0<(t=this.Z(t)).length?String(t[0]):e},Vt.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var s=e[n];const i=encodeURIComponent(String(s)),o=this.Z(s);for(s=0;s<o.length;s++){var r=i;""!==o[s]&&(r+="="+encodeURIComponent(String(o[s]))),t.push(r)}}return this.i=t.join("&")};var Ts=class{constructor(t,e){this.g=t,this.map=e}};function Ss(t){this.l=t||_s,t=qt.PerformanceNavigationTiming?0<(t=qt.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(qt.g&&qt.g.Ka&&qt.g.Ka()&&qt.g.Ka().ec),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var _s=10;function Ds(t){return!!t.h||!!t.g&&t.g.size>=t.j}function xs(t){return t.h?1:t.g?t.g.size:0}function Cs(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function As(t,e){t.g?t.g.add(e):t.h=e}function ks(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function Ns(t){if(null!=t.h)return t.i.concat(t.h.F);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}return te(t.i)}Ss.prototype.cancel=function(){if(this.i=Ns(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}};var Ms=class{stringify(t){return qt.JSON.stringify(t,void 0)}parse(t){return qt.JSON.parse(t,void 0)}};function Os(){this.g=new Ms}function Rs(t,e,n){const s=n||"";try{ts(t,(function(t,n){let r=t;Kt(t)&&(r=Xe(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function Ls(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function Ps(t){this.l=t.fc||null,this.j=t.ob||!1}function Fs(t,e){He.call(this),this.F=t,this.u=e,this.m=void 0,this.readyState=Vs,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Yt(Ps,kn),Ps.prototype.g=function(){return new Fs(this.l,this.j)},Ps.prototype.i=function(t){return function(){return t}}({}),Yt(Fs,He);var Vs=0;function Bs(t){t.j.read().then(t.Xa.bind(t)).catch(t.ka.bind(t))}function Us(t){t.readyState=4,t.l=null,t.j=null,t.A=null,js(t)}function js(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(Vt=Fs.prototype).open=function(t,e){if(this.readyState!=Vs)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,js(this)},Vt.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.F||qt).fetch(new Request(this.B,e)).then(this.$a.bind(this),this.ka.bind(this))},Vt.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Us(this)),this.readyState=Vs},Vt.$a=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,js(this)),this.g&&(this.readyState=3,js(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==qt.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Bs(this)}else t.text().then(this.Za.bind(this),this.ka.bind(this))},Vt.Xa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Us(this):js(this),3==this.readyState&&Bs(this)}},Vt.Za=function(t){this.g&&(this.response=this.responseText=t,Us(this))},Vt.Ya=function(t){this.g&&(this.response=t,Us(this))},Vt.ka=function(){this.g&&Us(this)},Vt.setRequestHeader=function(t,e){this.v.append(t,e)},Vt.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},Vt.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(Fs.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var qs=qt.JSON.parse;function zs(t){He.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Ks,this.L=this.M=!1}Yt(zs,He);var Ks="",$s=/^https?$/i,Gs=["POST","PUT"];function Hs(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Qs(t),Xs(t)}function Qs(t){t.F||(t.F=!0,Qe(t,"complete"),Qe(t,"error"))}function Ws(t){if(t.h&&void 0!==jt&&(!t.C[1]||4!=Js(t)||2!=t.da()))if(t.v&&4==Js(t))ln(t.La,0,t);else if(Qe(t,"readystatechange"),4==Js(t)){t.h=!1;try{const o=t.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===o){var r=String(t.I).match(es)[1]||null;!r&&qt.self&&qt.self.location&&(r=qt.self.location.protocol.slice(0,-1)),s=!$s.test(r?r.toLowerCase():"")}n=s}if(n)Qe(t,"complete"),Qe(t,"success");else{t.m=6;try{var i=2<Js(t)?t.g.statusText:""}catch(t){i=""}t.j=i+" ["+t.da()+"]",Qs(t)}}finally{Xs(t)}}}function Xs(t,e){if(t.g){Ys(t);const n=t.g,s=t.C[0]?()=>{}:null;t.g=null,t.C=null,e||Qe(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Ys(t){t.g&&t.L&&(t.g.ontimeout=null),t.A&&(qt.clearTimeout(t.A),t.A=null)}function Js(t){return t.g?t.g.readyState:0}function Zs(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.K){case Ks:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function tr(t){let e="";return Ce(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function er(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=tr(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):as(t,e,n))}function nr(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function sr(t){this.Ga=0,this.j=[],this.l=new yn,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=nr("failFast",!1,t),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=nr("baseRetryDelayMs",5e3,t),this.hb=nr("retryDelaySeedMs",1e4,t),this.eb=nr("forwardChannelMaxRetries",2,t),this.xa=nr("forwardChannelRequestTimeoutMs",2e4,t),this.va=t&&t.xmlHttpFactory||void 0,this.Ha=t&&t.dc||!1,this.L=void 0,this.J=t&&t.supportsCrossDomainXhr||!1,this.K="",this.i=new Ss(t&&t.concurrentRequestLimit),this.Ja=new Os,this.P=t&&t.fastHandshake||!1,this.O=t&&t.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=t&&t.bc||!1,t&&t.Ea&&this.l.Ea(),t&&t.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&t&&t.detectBufferingProxy||!1,this.qa=void 0,t&&t.longPollingTimeout&&0<t.longPollingTimeout&&(this.qa=t.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function rr(t){if(or(t),3==t.H){var e=t.W++,n=ss(t.I);if(as(n,"SID",t.K),as(n,"RID",e),as(n,"TYPE","terminate"),ur(t,n),(e=new Vn(t,t.l,e)).L=2,e.v=cs(ss(n)),n=!1,qt.navigator&&qt.navigator.sendBeacon)try{n=qt.navigator.sendBeacon(e.v.toString(),"")}catch(t){}!n&&qt.Image&&((new Image).src=e.v,n=!0),n||(e.g=Er(e.l,null),e.g.ha(e.v)),e.G=Date.now(),Qn(e)}wr(t)}function ir(t){t.g&&(fr(t),t.g.cancel(),t.g=null)}function or(t){ir(t),t.u&&(qt.clearTimeout(t.u),t.u=null),mr(t),t.i.cancel(),t.m&&("number"==typeof t.m&&qt.clearTimeout(t.m),t.m=null)}function ar(t){if(!Ds(t.i)&&!t.m){t.m=!0;var e=t.Na;nn||on(),sn||(nn(),sn=!0),rn.add(e,t),t.C=0}}function cr(t,e){var n;n=e?e.m:t.W++;const s=ss(t.I);as(s,"SID",t.K),as(s,"RID",n),as(s,"AID",t.V),ur(t,s),t.o&&t.s&&er(s,t.o,t.s),n=new Vn(t,t.l,n,t.C+1),null===t.o&&(n.I=t.s),e&&(t.j=e.F.concat(t.j)),e=lr(t,n,1e3),n.setTimeout(Math.round(.5*t.xa)+Math.round(.5*t.xa*Math.random())),As(t.i,n),zn(n,s,e)}function ur(t,e){t.na&&Ce(t.na,(function(t,n){as(e,n,t)})),t.h&&ts({},(function(t,n){as(e,n,t)}))}function lr(t,e,n){n=Math.min(t.j.length,n);var s=t.h?Wt(t.h.Va,t.h,t):null;t:{var r=t.j;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].g,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].g;const a=r[o].map;if(n-=e,0>n)e=Math.max(0,r[o].g-100),i=!1;else try{Rs(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.j.splice(0,n),e.F=t,s}function hr(t){if(!t.g&&!t.u){t.ba=1;var e=t.Ma;nn||on(),sn||(nn(),sn=!0),rn.add(e,t),t.A=0}}function dr(t){return!(t.g||t.u||3<=t.A||(t.ba++,t.u=xn(Wt(t.Ma,t),yr(t,t.A)),t.A++,0))}function fr(t){null!=t.B&&(qt.clearTimeout(t.B),t.B=null)}function gr(t){t.g=new Vn(t,t.l,"rpc",t.ba),null===t.o&&(t.g.I=t.s),t.g.O=0;var e=ss(t.wa);as(e,"RID","rpc"),as(e,"SID",t.K),as(e,"AID",t.V),as(e,"CI",t.G?"0":"1"),!t.G&&t.qa&&as(e,"TO",t.qa),as(e,"TYPE","xmlhttp"),ur(t,e),t.o&&t.s&&er(e,t.o,t.s),t.L&&t.g.setTimeout(t.L);var n=t.g;t=t.pa,n.L=1,n.v=cs(ss(e)),n.s=null,n.S=!0,Kn(n,t)}function mr(t){null!=t.v&&(qt.clearTimeout(t.v),t.v=null)}function pr(t,e){var n=null;if(t.g==e){mr(t),fr(t),t.g=null;var s=2}else{if(!Cs(t.i,e))return;n=e.F,ks(t.i,e),s=1}if(0!=t.H)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.G;var r=t.C;Qe(s=En(),new Dn(s,n)),ar(t)}else hr(t);else if(3==(r=e.o)||0==r&&0<e.ca||!(1==s&&function(t,e){return!(xs(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.j=e.F.concat(t.j),0):1==t.H||2==t.H||t.C>=(t.cb?0:t.eb)||(t.m=xn(Wt(t.Na,t,e),yr(t,t.C)),t.C++,0)))}(t,e)||2==s&&dr(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:vr(t,5);break;case 4:vr(t,10);break;case 3:vr(t,6);break;default:vr(t,2)}}function yr(t,e){let n=t.ab+Math.floor(Math.random()*t.hb);return t.isActive()||(n*=2),n*e}function vr(t,e){if(t.l.info("Error code "+e),2==e){var n=null;t.h&&(n=null);var s=Wt(t.pb,t);n||(n=new ns("//www.google.com/images/cleardot.gif"),qt.location&&"http"==qt.location.protocol||rs(n,"https"),cs(n)),function(t,e){const n=new yn;if(qt.Image){const s=new Image;s.onload=Xt(Ls,n,s,"TestLoadImage: loaded",!0,e),s.onerror=Xt(Ls,n,s,"TestLoadImage: error",!1,e),s.onabort=Xt(Ls,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=Xt(Ls,n,s,"TestLoadImage: timeout",!1,e),qt.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else _n(2);t.H=0,t.h&&t.h.za(e),wr(t),or(t)}function wr(t){if(t.H=0,t.ma=[],t.h){const e=Ns(t.i);0==e.length&&0==t.j.length||(ee(t.ma,e),ee(t.ma,t.j),t.i.i.length=0,te(t.j),t.j.length=0),t.h.ya()}}function br(t,e,n){var s=n instanceof ns?ss(n):new ns(n);if(""!=s.g)e&&(s.g=e+"."+s.g),is(s,s.m);else{var r=qt.location;s=r.protocol,e=e?e+"."+r.hostname:r.hostname,r=+r.port;var i=new ns(null);s&&rs(i,s),e&&(i.g=e),r&&is(i,r),n&&(i.l=n),s=i}return n=t.F,e=t.Da,n&&e&&as(s,n,e),as(s,"VER",t.ra),ur(t,s),s}function Er(t,e,n){if(e&&!t.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ha&&!t.va?new zs(new Ps({ob:!0})):new zs(t.va)).Oa(t.J),e}function Ir(){}function Tr(){if(de&&!(10<=Number(Ee)))throw Error("Environmental error: no available transport.")}function Sr(t,e){He.call(this),this.g=new sr(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.Ca&&(t?t["X-WebChannel-Client-Profile"]=e.Ca:t={"X-WebChannel-Client-Profile":e.Ca}),this.g.U=t,(t=e&&e.cc)&&!re(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!re(e)&&(this.g.F=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new xr(this)}function _r(t){Ln.call(this),t.__headers__&&(this.headers=t.__headers__,this.statusCode=t.__status__,delete t.__headers__,delete t.__status__);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Dr(){Pn.call(this),this.status=1}function xr(t){this.g=t}function Cr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Ar(t,e,n){n||(n=0);var s=Array(16);if("string"==typeof e)for(var r=0;16>r;++r)s[r]=e.charCodeAt(n++)|e.charCodeAt(n++)<<8|e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<24;else for(r=0;16>r;++r)s[r]=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24;e=t.g[0],n=t.g[1],r=t.g[2];var i=t.g[3],o=e+(i^n&(r^i))+s[0]+3614090360&4294967295;o=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=(n=(r=(i=(e=n+(o<<7&4294967295|o>>>25))+((o=i+(r^e&(n^r))+s[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(e^n))+s[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^r&(i^e))+s[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(r^i))+s[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^e&(n^r))+s[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(e^n))+s[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^r&(i^e))+s[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(r^i))+s[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^e&(n^r))+s[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(e^n))+s[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^r&(i^e))+s[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(r^i))+s[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(r^e&(n^r))+s[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=r+(n^i&(e^n))+s[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^r&(i^e))+s[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(r^i&(n^r))+s[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(e^n))+s[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=r+(e^n&(i^e))+s[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(r^i))+s[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(r^i&(n^r))+s[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(e^n))+s[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=r+(e^n&(i^e))+s[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(r^i))+s[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(r^i&(n^r))+s[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(e^n))+s[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=r+(e^n&(i^e))+s[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(r^i))+s[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(r^i&(n^r))+s[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^r&(e^n))+s[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=r+(e^n&(i^e))+s[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(r^i))+s[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(n^r^i)+s[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^r)+s[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^e^n)+s[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^e)+s[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^r^i)+s[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^r)+s[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^e^n)+s[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^e)+s[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^r^i)+s[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^r)+s[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^e^n)+s[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^e)+s[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^r^i)+s[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^r)+s[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=r+(i^e^n)+s[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(r^i^e)+s[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(r^(n|~i))+s[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~r))+s[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=r+(e^(i|~n))+s[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~e))+s[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(r^(n|~i))+s[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~r))+s[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=r+(e^(i|~n))+s[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~e))+s[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(r^(n|~i))+s[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~r))+s[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=r+(e^(i|~n))+s[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(r|~e))+s[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(e=n+((o=e+(r^(n|~i))+s[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~r))+s[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((r=i+((o=r+(e^(i|~n))+s[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+s[9]+3951481745&4294967295,t.g[0]=t.g[0]+e&4294967295,t.g[1]=t.g[1]+(r+(o<<21&4294967295|o>>>11))&4294967295,t.g[2]=t.g[2]+r&4294967295,t.g[3]=t.g[3]+i&4294967295}function kr(t,e){this.h=e;for(var n=[],s=!0,r=t.length-1;0<=r;r--){var i=0|t[r];s&&i==e||(n[r]=i,s=!1)}this.g=n}(Vt=zs.prototype).Oa=function(t){this.M=t},Vt.ha=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+t);e=e?e.toUpperCase():"GET",this.I=t,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():On.g(),this.C=this.u?Nn(this.u):Nn(On),this.g.onreadystatechange=Wt(this.La,this);try{this.G=!0,this.g.open(e,String(t),!0),this.G=!1}catch(t){return void Hs(this,t)}if(t=n||"",n=new Map(this.headers),s)if(Object.getPrototypeOf(s)===Object.prototype)for(var r in s)n.set(r,s[r]);else{if("function"!=typeof s.keys||"function"!=typeof s.get)throw Error("Unknown input type for opt_headers: "+String(s));for(const t of s.keys())n.set(t,s.get(t))}s=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),r=qt.FormData&&t instanceof qt.FormData,!(0<=Zt(Gs,e))||s||r||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Ys(this),0<this.B&&((this.L=function(t){return de&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=Wt(this.ua,this)):this.A=ln(this.ua,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){Hs(this,t)}},Vt.ua=function(){void 0!==jt&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Qe(this,"timeout"),this.abort(8))},Vt.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Qe(this,"complete"),Qe(this,"abort"),Xs(this))},Vt.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Xs(this,!0)),zs.$.N.call(this)},Vt.La=function(){this.s||(this.G||this.v||this.l?Ws(this):this.kb())},Vt.kb=function(){Ws(this)},Vt.isActive=function(){return!!this.g},Vt.da=function(){try{return 2<Js(this)?this.g.status:-1}catch(t){return-1}},Vt.ja=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},Vt.Wa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),qs(e)}},Vt.Ia=function(){return this.m},Vt.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(Vt=sr.prototype).ra=8,Vt.H=1,Vt.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const r=new Vn(this,this.l,t);let i=this.s;if(this.U&&(i?(i=Ae(i),Ne(i,this.U)):i=this.U),null!==this.o||this.O||(r.I=i,i=null),this.P)t:{for(var e=0,n=0;n<this.j.length;n++){var s=this.j[n];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.j.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=lr(this,r,e),as(n=ss(this.I),"RID",t),as(n,"CVER",22),this.F&&as(n,"X-HTTP-Session-Id",this.F),ur(this,n),i&&(this.O?e="headers="+encodeURIComponent(String(tr(i)))+"&"+e:this.o&&er(n,this.o,i)),As(this.i,r),this.bb&&as(n,"TYPE","init"),this.P?(as(n,"$req",e),as(n,"SID","null"),r.aa=!0,zn(r,n,null)):zn(r,n,e),this.H=2}}else 3==this.H&&(t?cr(this,t):0==this.j.length||Ds(this.i)||cr(this))},Vt.Ma=function(){if(this.u=null,gr(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var t=2*this.S;this.l.info("BP detection timer enabled: "+t),this.B=xn(Wt(this.jb,this),t)}},Vt.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,_n(10),ir(this),gr(this))},Vt.ib=function(){null!=this.v&&(this.v=null,ir(this),dr(this),_n(19))},Vt.pb=function(t){t?(this.l.info("Successfully pinged google.com"),_n(2)):(this.l.info("Failed to ping google.com"),_n(1))},Vt.isActive=function(){return!!this.h&&this.h.isActive(this)},(Vt=Ir.prototype).Ba=function(){},Vt.Aa=function(){},Vt.za=function(){},Vt.ya=function(){},Vt.isActive=function(){return!0},Vt.Va=function(){},Tr.prototype.g=function(t,e){return new Sr(t,e)},Yt(Sr,He),Sr.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var t=this.g,e=this.l,n=this.h||void 0;_n(0),t.Y=e,t.na=n||{},t.G=t.aa,t.I=br(t,null,t.Y),ar(t)},Sr.prototype.close=function(){rr(this.g)},Sr.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=Xe(t),t=n);e.j.push(new Ts(e.fb++,t)),3==e.H&&ar(e)},Sr.prototype.N=function(){this.g.h=null,delete this.j,rr(this.g),delete this.g,Sr.$.N.call(this)},Yt(_r,Ln),Yt(Dr,Pn),Yt(xr,Ir),xr.prototype.Ba=function(){Qe(this.g,"a")},xr.prototype.Aa=function(t){Qe(this.g,new _r(t))},xr.prototype.za=function(t){Qe(this.g,new Dr)},xr.prototype.ya=function(){Qe(this.g,"b")},Yt(Cr,(function(){this.blockSize=-1})),Cr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Cr.prototype.j=function(t,e){void 0===e&&(e=t.length);for(var n=e-this.blockSize,s=this.m,r=this.h,i=0;i<e;){if(0==r)for(;i<=n;)Ar(this,t,i),i+=this.blockSize;if("string"==typeof t){for(;i<e;)if(s[r++]=t.charCodeAt(i++),r==this.blockSize){Ar(this,s),r=0;break}}else for(;i<e;)if(s[r++]=t[i++],r==this.blockSize){Ar(this,s),r=0;break}}this.h=r,this.i+=e},Cr.prototype.l=function(){var t=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);t[0]=128;for(var e=1;e<t.length-8;++e)t[e]=0;var n=8*this.i;for(e=t.length-8;e<t.length;++e)t[e]=255&n,n/=256;for(this.j(t),t=Array(16),e=n=0;4>e;++e)for(var s=0;32>s;s+=8)t[n++]=this.g[e]>>>s&255;return t};var Nr={};function Mr(t){return-128<=t&&128>t?function(t){var e=Nr;return Object.prototype.hasOwnProperty.call(e,t)?e[t]:e[t]=function(t){return new kr([0|t],0>t?-1:0)}(t)}(t):new kr([0|t],0>t?-1:0)}function Or(t){if(isNaN(t)||!isFinite(t))return Lr;if(0>t)return Ur(Or(-t));for(var e=[],n=1,s=0;t>=n;s++)e[s]=t/n|0,n*=Rr;return new kr(e,0)}var Rr=4294967296,Lr=Mr(0),Pr=Mr(1),Fr=Mr(16777216);function Vr(t){if(0!=t.h)return!1;for(var e=0;e<t.g.length;e++)if(0!=t.g[e])return!1;return!0}function Br(t){return-1==t.h}function Ur(t){for(var e=t.g.length,n=[],s=0;s<e;s++)n[s]=~t.g[s];return new kr(n,~t.h).add(Pr)}function jr(t,e){return t.add(Ur(e))}function qr(t,e){for(;(65535&t[e])!=t[e];)t[e+1]+=t[e]>>>16,t[e]&=65535,e++}function zr(t,e){this.g=t,this.h=e}function Kr(t,e){if(Vr(e))throw Error("division by zero");if(Vr(t))return new zr(Lr,Lr);if(Br(t))return e=Kr(Ur(t),e),new zr(Ur(e.g),Ur(e.h));if(Br(e))return e=Kr(t,Ur(e)),new zr(Ur(e.g),e.h);if(30<t.g.length){if(Br(t)||Br(e))throw Error("slowDivide_ only works with positive integers.");for(var n=Pr,s=e;0>=s.X(t);)n=$r(n),s=$r(s);var r=Gr(n,1),i=Gr(s,1);for(s=Gr(s,2),n=Gr(n,2);!Vr(s);){var o=i.add(s);0>=o.X(t)&&(r=r.add(n),i=o),s=Gr(s,1),n=Gr(n,1)}return e=jr(t,r.R(e)),new zr(r,e)}for(r=Lr;0<=t.X(e);){for(n=Math.max(1,Math.floor(t.ea()/e.ea())),s=48>=(s=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,s-48),o=(i=Or(n)).R(e);Br(o)||0<o.X(t);)o=(i=Or(n-=s)).R(e);Vr(i)&&(i=Pr),r=r.add(i),t=jr(t,o)}return new zr(r,t)}function $r(t){for(var e=t.g.length+1,n=[],s=0;s<e;s++)n[s]=t.D(s)<<1|t.D(s-1)>>>31;return new kr(n,t.h)}function Gr(t,e){var n=e>>5;e%=32;for(var s=t.g.length-n,r=[],i=0;i<s;i++)r[i]=0<e?t.D(i+n)>>>e|t.D(i+n+1)<<32-e:t.D(i+n);return new kr(r,t.h)}(Vt=kr.prototype).ea=function(){if(Br(this))return-Ur(this).ea();for(var t=0,e=1,n=0;n<this.g.length;n++){var s=this.D(n);t+=(0<=s?s:Rr+s)*e,e*=Rr}return t},Vt.toString=function(t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);if(Vr(this))return"0";if(Br(this))return"-"+Ur(this).toString(t);for(var e=Or(Math.pow(t,6)),n=this,s="";;){var r=Kr(n,e).g,i=((0<(n=jr(n,r.R(e))).g.length?n.g[0]:n.h)>>>0).toString(t);if(Vr(n=r))return i+s;for(;6>i.length;)i="0"+i;s=i+s}},Vt.D=function(t){return 0>t?0:t<this.g.length?this.g[t]:this.h},Vt.X=function(t){return Br(t=jr(this,t))?-1:Vr(t)?0:1},Vt.abs=function(){return Br(this)?Ur(this):this},Vt.add=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],s=0,r=0;r<=e;r++){var i=s+(65535&this.D(r))+(65535&t.D(r)),o=(i>>>16)+(this.D(r)>>>16)+(t.D(r)>>>16);s=o>>>16,i&=65535,o&=65535,n[r]=o<<16|i}return new kr(n,-2147483648&n[n.length-1]?-1:0)},Vt.R=function(t){if(Vr(this)||Vr(t))return Lr;if(Br(this))return Br(t)?Ur(this).R(Ur(t)):Ur(Ur(this).R(t));if(Br(t))return Ur(this.R(Ur(t)));if(0>this.X(Fr)&&0>t.X(Fr))return Or(this.ea()*t.ea());for(var e=this.g.length+t.g.length,n=[],s=0;s<2*e;s++)n[s]=0;for(s=0;s<this.g.length;s++)for(var r=0;r<t.g.length;r++){var i=this.D(s)>>>16,o=65535&this.D(s),a=t.D(r)>>>16,c=65535&t.D(r);n[2*s+2*r]+=o*c,qr(n,2*s+2*r),n[2*s+2*r+1]+=i*c,qr(n,2*s+2*r+1),n[2*s+2*r+1]+=o*a,qr(n,2*s+2*r+1),n[2*s+2*r+2]+=i*a,qr(n,2*s+2*r+2)}for(s=0;s<e;s++)n[s]=n[2*s+1]<<16|n[2*s];for(s=e;s<2*e;s++)n[s]=0;return new kr(n,0)},Vt.gb=function(t){return Kr(this,t).h},Vt.and=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],s=0;s<e;s++)n[s]=this.D(s)&t.D(s);return new kr(n,this.h&t.h)},Vt.or=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],s=0;s<e;s++)n[s]=this.D(s)|t.D(s);return new kr(n,this.h|t.h)},Vt.xor=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],s=0;s<e;s++)n[s]=this.D(s)^t.D(s);return new kr(n,this.h^t.h)},Tr.prototype.createWebChannel=Tr.prototype.g,Sr.prototype.send=Sr.prototype.u,Sr.prototype.open=Sr.prototype.m,Sr.prototype.close=Sr.prototype.close,Cn.NO_ERROR=0,Cn.TIMEOUT=8,Cn.HTTP_ERROR=6,An.COMPLETE="complete",Mn.EventType=Rn,Rn.OPEN="a",Rn.CLOSE="b",Rn.ERROR="c",Rn.MESSAGE="d",He.prototype.listen=He.prototype.O,zs.prototype.listenOnce=zs.prototype.P,zs.prototype.getLastError=zs.prototype.Sa,zs.prototype.getLastErrorCode=zs.prototype.Ia,zs.prototype.getStatus=zs.prototype.da,zs.prototype.getResponseJson=zs.prototype.Wa,zs.prototype.getResponseText=zs.prototype.ja,zs.prototype.send=zs.prototype.ha,zs.prototype.setWithCredentials=zs.prototype.Oa,Cr.prototype.digest=Cr.prototype.l,Cr.prototype.reset=Cr.prototype.reset,Cr.prototype.update=Cr.prototype.j,kr.prototype.add=kr.prototype.add,kr.prototype.multiply=kr.prototype.R,kr.prototype.modulo=kr.prototype.gb,kr.prototype.compare=kr.prototype.X,kr.prototype.toNumber=kr.prototype.ea,kr.prototype.toString=kr.prototype.toString,kr.prototype.getBits=kr.prototype.D,kr.fromNumber=Or,kr.fromString=function t(e,n){if(0==e.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==e.charAt(0))return Ur(t(e.substring(1),n));if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character');for(var s=Or(Math.pow(n,8)),r=Lr,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),a=parseInt(e.substring(i,i+o),n);8>o?(o=Or(Math.pow(n,o)),r=r.R(o).add(Or(a))):r=(r=r.R(s)).add(Or(a))}return r};var Hr=Ut.createWebChannelTransport=function(){return new Tr},Qr=Ut.getStatEventTarget=function(){return En()},Wr=Ut.ErrorCode=Cn,Xr=Ut.EventType=An,Yr=Ut.Event=wn,Jr=Ut.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},Zr=Ut.FetchXmlHttpFactory=Ps,ti=Ut.WebChannel=Mn,ei=Ut.XhrIo=zs,ni=Ut.Md5=Cr,si=Ut.Integer=kr;const ri="@firebase/firestore";class ii{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}ii.UNAUTHENTICATED=new ii(null),ii.GOOGLE_CREDENTIALS=new ii("google-credentials-uid"),ii.FIRST_PARTY=new ii("first-party-uid"),ii.MOCK_USER=new ii("mock-user");let oi="9.23.0";const ai=new C("@firebase/firestore");function ci(){return ai.logLevel}function ui(t,...e){if(ai.logLevel<=T.DEBUG){const n=e.map(di);ai.debug(`Firestore (${oi}): ${t}`,...n)}}function li(t,...e){if(ai.logLevel<=T.ERROR){const n=e.map(di);ai.error(`Firestore (${oi}): ${t}`,...n)}}function hi(t,...e){if(ai.logLevel<=T.WARN){const n=e.map(di);ai.warn(`Firestore (${oi}): ${t}`,...n)}}function di(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function fi(t="Unexpected state"){const e=`FIRESTORE (${oi}) INTERNAL ASSERTION FAILED: `+t;throw li(e),new Error(e)}function gi(t,e){t||fi()}function mi(t,e){return t}const pi={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class yi extends d{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class vi{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class wi{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class bi{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(ii.UNAUTHENTICATED)))}shutdown(){}}class Ei{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Ii{constructor(t){this.t=t,this.currentUser=ii.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new vi;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new vi,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{ui("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(ui("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new vi)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(ui("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(gi("string"==typeof e.accessToken),new wi(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return gi(null===t||"string"==typeof t),new ii(t)}}class Ti{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=ii.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const t=this.p();return t&&this.g.set("Authorization",t),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class Si{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Ti(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(ii.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class _i{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Di{constructor(t){this.I=t,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(t,e){const n=t=>{null!=t.error&&ui("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.T;return this.T=t.token,ui("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{ui("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.I.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.I.getImmediate({optional:!0});t?s(t):ui("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(gi("string"==typeof t.token),this.T=t.token,new _i(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function xi(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class Ci{static A(){const t=62*Math.floor(256/62);let e="";for(;e.length<20;){const n=xi(40);for(let s=0;s<n.length;++s)e.length<20&&n[s]<t&&(e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[s]%62))}return e}}function Ai(t,e){return t<e?-1:t>e?1:0}function ki(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function Ni(t){return t+"\0"}class Mi{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new yi(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new yi(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new yi(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new yi(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Mi.fromMillis(Date.now())}static fromDate(t){return Mi.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Mi(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Ai(this.nanoseconds,t.nanoseconds):Ai(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Oi{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Oi(t)}static min(){return new Oi(new Mi(0,0))}static max(){return new Oi(new Mi(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Ri{constructor(t,e,n){void 0===e?e=0:e>t.length&&fi(),void 0===n?n=t.length-e:n>t.length-e&&fi(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Ri.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Ri?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Li extends Ri{construct(t,e,n){return new Li(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new yi(pi.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new Li(e)}static emptyPath(){return new Li([])}}const Pi=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Fi extends Ri{construct(t,e,n){return new Fi(t,e,n)}static isValidIdentifier(t){return Pi.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Fi.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Fi(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new yi(pi.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new yi(pi.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new yi(pi.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new yi(pi.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Fi(e)}static emptyPath(){return new Fi([])}}class Vi{constructor(t){this.path=t}static fromPath(t){return new Vi(Li.fromString(t))}static fromName(t){return new Vi(Li.fromString(t).popFirst(5))}static empty(){return new Vi(Li.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===Li.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Li.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new Vi(new Li(t.slice()))}}class Bi{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function Ui(t){return t.fields.find((t=>2===t.kind))}function ji(t){return t.fields.filter((t=>2!==t.kind))}Bi.UNKNOWN_ID=-1;class qi{constructor(t,e){this.fieldPath=t,this.kind=e}}class zi{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new zi(0,$i.min())}}function Ki(t){return new $i(t.readTime,t.key,-1)}class $i{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new $i(Oi.min(),Vi.empty(),-1)}static max(){return new $i(Oi.max(),Vi.empty(),-1)}}function Gi(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=Vi.comparator(t.documentKey,e.documentKey),0!==n?n:Ai(t.largestBatchId,e.largestBatchId))}const Hi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Qi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Wi(t){if(t.code!==pi.FAILED_PRECONDITION||t.message!==Hi)throw t;ui("LocalStore","Unexpectedly lost primary lease")}class Xi{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&fi(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Xi(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Xi?e:Xi.resolve(e)}catch(t){return Xi.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Xi.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Xi.reject(e)}static resolve(t){return new Xi(((e,n)=>{e(t)}))}static reject(t){return new Xi(((e,n)=>{n(t)}))}static waitFor(t){return new Xi(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=Xi.resolve(!1);for(const n of t)e=e.next((t=>t?Xi.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}static mapArray(t,e){return new Xi(((n,s)=>{const r=t.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const c=a;e(t[c]).next((t=>{i[c]=t,++o,o===r&&n(i)}),(t=>s(t)))}}))}static doWhile(t,e){return new Xi(((n,s)=>{const r=()=>{!0===t()?e().next((()=>{r()}),s):n()};r()}))}}class Yi{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.v=new vi,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{e.error?this.v.reject(new to(t,e.error)):this.v.resolve()},this.transaction.onerror=e=>{const n=io(e.target.error);this.v.reject(new to(t,n))}}static open(t,e,n,s){try{return new Yi(e,t.transaction(s,n))}catch(t){throw new to(e,t)}}get R(){return this.v.promise}abort(t){t&&this.v.reject(t),this.aborted||(ui("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new no(e)}}class Ji{constructor(t,e,n){this.name=t,this.version=e,this.V=n,12.2===Ji.S(l())&&li("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return ui("SimpleDb","Removing database:",t),so(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!h())return!1;if(Ji.C())return!0;const t=l(),e=Ji.S(t),n=0<e&&e<10,s=Ji.N(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static C(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.k)}static M(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(t){return this.db||(ui("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new to(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new yi(pi.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new yi(pi.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new to(t,s))},s.onupgradeneeded=t=>{ui("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.V.O(e,s.transaction,t.oldVersion,this.version).next((()=>{ui("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=t=>this.F(t)),this.db}B(t){this.F=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.$(t);const e=Yi.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.P(),t))).catch((t=>(e.abort(t),Xi.reject(t)))).toPromise();return i.catch((()=>{})),await e.R,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(ui("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Zi{constructor(t){this.L=t,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(t){this.L=t}done(){this.q=!0}G(t){this.U=t}delete(){return so(this.L.delete())}}class to extends yi{constructor(t,e){super(pi.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function eo(t){return"IndexedDbTransactionError"===t.name}class no{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(ui("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(ui("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),so(n)}add(t){return ui("SimpleDb","ADD",this.store.name,t,t),so(this.store.add(t))}get(t){return so(this.store.get(t)).next((e=>(void 0===e&&(e=null),ui("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return ui("SimpleDb","DELETE",this.store.name,t),so(this.store.delete(t))}count(){return ui("SimpleDb","COUNT",this.store.name),so(this.store.count())}j(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.W(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new Xi(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}H(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new Xi(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}J(t,e){ui("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.Y=!1;const s=this.cursor(n);return this.W(s,((t,e,n)=>n.delete()))}X(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.W(s,e)}Z(t){const e=this.cursor({});return new Xi(((n,s)=>{e.onerror=t=>{const e=io(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}W(t,e){const n=[];return new Xi(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new Zi(r),o=e(r.primaryKey,r.value,i);if(o instanceof Xi){const t=o.catch((t=>(i.done(),Xi.reject(t))));n.push(t)}i.isDone?s():null===i.K?r.continue():r.continue(i.K)}})).next((()=>Xi.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Y?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function so(t){return new Xi(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=io(t.target.error);n(e)}}))}let ro=!1;function io(t){const e=Ji.S(l());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new yi("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ro||(ro=!0,setTimeout((()=>{throw t}),0)),t}}return t}class oo{constructor(t,e){this.asyncQueue=t,this.tt=e,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(t){ui("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{ui("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(t){eo(t)?ui("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await Wi(t)}await this.et(6e4)}))}}class ao{constructor(t,e){this.localStore=t,this.persistence=e}async nt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.st(e,t)))}st(t,e){const n=new Set;let s=e,r=!0;return Xi.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return ui("IndexBackiller",`Processing collection: ${e}`),this.it(t,e,s).next((t=>{s-=t,n.add(e)}));r=!1})))).next((()=>e-s))}it(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((s=>this.localStore.localDocuments.getNextDocuments(t,e,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(t,r).next((()=>this.rt(s,n))).next((n=>(ui("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>r.size))}))))}rt(t,e){let n=t;return e.changes.forEach(((t,e)=>{const s=Ki(e);Gi(s,n)>0&&(n=s)})),new $i(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class co{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.ot(t),this.ut=t=>e.writeSequenceNumber(t))}ot(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ut&&this.ut(t),t}}function uo(t){return null==t}function lo(t){return 0===t&&1/t==-1/0}function ho(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=go(e)),e=fo(t.get(n),e);return go(e)}function fo(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function go(t){return t+""}function mo(t){const e=t.length;if(gi(e>=2),2===e)return gi(""===t.charAt(0)&&""===t.charAt(1)),Li.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&fi(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:fi()}i=e+2}return new Li(s)}co.ct=-1;const po=["userId","batchId"];function yo(t,e){return[t,ho(e)]}function vo(t,e,n){return[t,ho(e),n]}const wo={},bo=["prefixPath","collectionGroup","readTime","documentId"],Eo=["prefixPath","collectionGroup","documentId"],Io=["collectionGroup","readTime","prefixPath","documentId"],To=["canonicalId","targetId"],So=["targetId","path"],_o=["path","targetId"],Do=["collectionId","parent"],xo=["indexId","uid"],Co=["uid","sequenceNumber"],Ao=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ko=["indexId","uid","orderedDocumentKey"],No=["userId","collectionPath","documentId"],Mo=["userId","collectionPath","largestBatchId"],Oo=["userId","collectionGroup","largestBatchId"],Ro=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Lo=[...Ro,"documentOverlays"],Po=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Fo=Po,Vo=[...Fo,"indexConfiguration","indexState","indexEntries"];class Bo extends Qi{constructor(t,e){super(),this.ht=t,this.currentSequenceNumber=e}}function Uo(t,e){const n=mi(t);return Ji.M(n.ht,e)}function jo(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function qo(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function zo(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class Ko{constructor(t,e){this.comparator=t,this.root=e||Go.EMPTY}insert(t,e){return new Ko(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Go.BLACK,null,null))}remove(t){return new Ko(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Go.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new $o(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new $o(this.root,t,this.comparator,!1)}getReverseIterator(){return new $o(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new $o(this.root,t,this.comparator,!0)}}class $o{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Go{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:Go.RED,this.left=null!=s?s:Go.EMPTY,this.right=null!=r?r:Go.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new Go(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return Go.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return Go.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Go.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Go.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw fi();if(this.right.isRed())throw fi();const t=this.left.check();if(t!==this.right.check())throw fi();return t+(this.isRed()?0:1)}}Go.EMPTY=null,Go.RED=!0,Go.BLACK=!1,Go.EMPTY=new class{constructor(){this.size=0}get key(){throw fi()}get value(){throw fi()}get color(){throw fi()}get left(){throw fi()}get right(){throw fi()}copy(t,e,n,s,r){return this}insert(t,e,n){return new Go(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ho{constructor(t){this.comparator=t,this.data=new Ko(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Qo(this.data.getIterator())}getIteratorFrom(t){return new Qo(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Ho))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Ho(this.comparator);return e.data=t,e}}class Qo{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Wo(t){return t.hasNext()?t.getNext():void 0}class Xo{constructor(t){this.fields=t,t.sort(Fi.comparator)}static empty(){return new Xo([])}unionWith(t){let e=new Ho(Fi.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Xo(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return ki(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class Yo extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Jo{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new Yo("Invalid base64 string: "+t):t}}(t);return new Jo(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Jo(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Ai(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Jo.EMPTY_BYTE_STRING=new Jo("");const Zo=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ta(t){if(gi(!!t),"string"==typeof t){let e=0;const n=Zo.exec(t);if(gi(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:ea(t.seconds),nanos:ea(t.nanos)}}function ea(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function na(t){return"string"==typeof t?Jo.fromBase64String(t):Jo.fromUint8Array(t)}function sa(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ra(t){const e=t.mapValue.fields.__previous_value__;return sa(e)?ra(e):e}function ia(t){const e=ta(t.mapValue.fields.__local_write_time__.timestampValue);return new Mi(e.seconds,e.nanos)}class oa{constructor(t,e,n,s,r,i,o,a,c){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class aa{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new aa("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof aa&&t.projectId===this.projectId&&t.database===this.database}}const ca={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ua={nullValue:"NULL_VALUE"};function la(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?sa(t)?4:Sa(t)?9007199254740991:10:fi()}function ha(t,e){if(t===e)return!0;const n=la(t);if(n!==la(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return ia(t).isEqual(ia(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=ta(t.timestampValue),s=ta(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return na(t.bytesValue).isEqual(na(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return ea(t.geoPointValue.latitude)===ea(e.geoPointValue.latitude)&&ea(t.geoPointValue.longitude)===ea(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return ea(t.integerValue)===ea(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=ea(t.doubleValue),s=ea(e.doubleValue);return n===s?lo(n)===lo(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return ki(t.arrayValue.values||[],e.arrayValue.values||[],ha);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(jo(n)!==jo(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!ha(n[t],s[t])))return!1;return!0}(t,e);default:return fi()}}function da(t,e){return void 0!==(t.values||[]).find((t=>ha(t,e)))}function fa(t,e){if(t===e)return 0;const n=la(t),s=la(e);if(n!==s)return Ai(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return Ai(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=ea(t.integerValue||t.doubleValue),s=ea(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return ga(t.timestampValue,e.timestampValue);case 4:return ga(ia(t),ia(e));case 5:return Ai(t.stringValue,e.stringValue);case 6:return function(t,e){const n=na(t),s=na(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=Ai(n[t],s[t]);if(0!==e)return e}return Ai(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=Ai(ea(t.latitude),ea(e.latitude));return 0!==n?n:Ai(ea(t.longitude),ea(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=fa(n[t],s[t]);if(e)return e}return Ai(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===ca.mapValue&&e===ca.mapValue)return 0;if(t===ca.mapValue)return 1;if(e===ca.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=Ai(s[t],i[t]);if(0!==e)return e;const o=fa(n[s[t]],r[i[t]]);if(0!==o)return o}return Ai(s.length,i.length)}(t.mapValue,e.mapValue);default:throw fi()}}function ga(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Ai(t,e);const n=ta(t),s=ta(e),r=Ai(n.seconds,s.seconds);return 0!==r?r:Ai(n.nanos,s.nanos)}function ma(t){return pa(t)}function pa(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=ta(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?na(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,Vi.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=pa(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${pa(t.fields[r])}`;return n+"}"}(t.mapValue):fi();var e,n}function ya(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function va(t){return!!t&&"integerValue"in t}function wa(t){return!!t&&"arrayValue"in t}function ba(t){return!!t&&"nullValue"in t}function Ea(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Ia(t){return!!t&&"mapValue"in t}function Ta(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return qo(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Ta(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Ta(t.arrayValue.values[n]);return e}return Object.assign({},t)}function Sa(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function _a(t){return"nullValue"in t?ua:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?ya(aa.empty(),Vi.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:fi()}function Da(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?ya(aa.empty(),Vi.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?ca:fi()}function xa(t,e){const n=fa(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function Ca(t,e){const n=fa(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class Aa{constructor(t){this.value=t}static empty(){return new Aa({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Ia(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Ta(e)}setAll(t){let e=Fi.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=Ta(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());Ia(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ha(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Ia(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){qo(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Aa(Ta(this.value))}}function ka(t){const e=[];return qo(t.fields,((t,n)=>{const s=new Fi([t]);if(Ia(n)){const t=ka(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new Xo(e)}class Na{constructor(t,e,n,s,r,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.createTime=r,this.data=i,this.documentState=o}static newInvalidDocument(t){return new Na(t,0,Oi.min(),Oi.min(),Oi.min(),Aa.empty(),0)}static newFoundDocument(t,e,n,s){return new Na(t,1,e,Oi.min(),n,s,0)}static newNoDocument(t,e){return new Na(t,2,e,Oi.min(),Oi.min(),Aa.empty(),0)}static newUnknownDocument(t,e){return new Na(t,3,e,Oi.min(),Oi.min(),Aa.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(Oi.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Aa.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Aa.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Oi.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Na&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Na(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ma{constructor(t,e){this.position=t,this.inclusive=e}}function Oa(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?Vi.comparator(Vi.fromName(o.referenceValue),n.key):fa(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Ra(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!ha(t.position[n],e.position[n]))return!1;return!0}class La{constructor(t,e="asc"){this.field=t,this.dir=e}}function Pa(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class Fa{}class Va extends Fa{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new Qa(t,e,n):"array-contains"===e?new Ja(t,n):"in"===e?new Za(t,n):"not-in"===e?new tc(t,n):"array-contains-any"===e?new ec(t,n):new Va(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Wa(t,n):new Xa(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(fa(e,this.value)):null!==e&&la(this.value)===la(e)&&this.matchesComparison(fa(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return fi()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Ba extends Fa{constructor(t,e){super(),this.filters=t,this.op=e,this.lt=null}static create(t,e){return new Ba(t,e)}matches(t){return Ua(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const t=this.ft((t=>t.isInequality()));return null!==t?t.field:null}ft(t){for(const e of this.getFlattenedFilters())if(t(e))return e;return null}}function Ua(t){return"and"===t.op}function ja(t){return"or"===t.op}function qa(t){return za(t)&&Ua(t)}function za(t){for(const e of t.filters)if(e instanceof Ba)return!1;return!0}function Ka(t){if(t instanceof Va)return t.field.canonicalString()+t.op.toString()+ma(t.value);if(qa(t))return t.filters.map((t=>Ka(t))).join(",");{const e=t.filters.map((t=>Ka(t))).join(",");return`${t.op}(${e})`}}function $a(t,e){return t instanceof Va?function(t,e){return e instanceof Va&&t.op===e.op&&t.field.isEqual(e.field)&&ha(t.value,e.value)}(t,e):t instanceof Ba?function(t,e){return e instanceof Ba&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,s)=>t&&$a(n,e.filters[s])),!0)}(t,e):void fi()}function Ga(t,e){const n=t.filters.concat(e);return Ba.create(n,t.op)}function Ha(t){return t instanceof Va?function(t){return`${t.field.canonicalString()} ${t.op} ${ma(t.value)}`}(t):t instanceof Ba?function(t){return t.op.toString()+" {"+t.getFilters().map(Ha).join(" ,")+"}"}(t):"Filter"}class Qa extends Va{constructor(t,e,n){super(t,e,n),this.key=Vi.fromName(n.referenceValue)}matches(t){const e=Vi.comparator(t.key,this.key);return this.matchesComparison(e)}}class Wa extends Va{constructor(t,e){super(t,"in",e),this.keys=Ya(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Xa extends Va{constructor(t,e){super(t,"not-in",e),this.keys=Ya(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Ya(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>Vi.fromName(t.referenceValue)))}class Ja extends Va{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return wa(e)&&da(e.arrayValue,this.value)}}class Za extends Va{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&da(this.value.arrayValue,e)}}class tc extends Va{constructor(t,e){super(t,"not-in",e)}matches(t){if(da(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!da(this.value.arrayValue,e)}}class ec extends Va{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!wa(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>da(this.value.arrayValue,t)))}}class nc{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.dt=null}}function sc(t,e=null,n=[],s=[],r=null,i=null,o=null){return new nc(t,e,n,s,r,i,o)}function rc(t){const e=mi(t);if(null===e.dt){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>Ka(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),uo(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>ma(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>ma(t))).join(",")),e.dt=t}return e.dt}function ic(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Pa(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!$a(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Ra(t.startAt,e.startAt)&&Ra(t.endAt,e.endAt)}function oc(t){return Vi.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function ac(t,e){return t.filters.filter((t=>t instanceof Va&&t.field.isEqual(e)))}function cc(t,e,n){let s=ua,r=!0;for(const n of ac(t,e)){let t=ua,e=!0;switch(n.op){case"<":case"<=":t=_a(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=ua}xa({value:s,inclusive:r},{value:t,inclusive:e})<0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];xa({value:s,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}function uc(t,e,n){let s=ca,r=!0;for(const n of ac(t,e)){let t=ca,e=!0;switch(n.op){case">=":case">":t=Da(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=ca}Ca({value:s,inclusive:r},{value:t,inclusive:e})>0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Ca({value:s,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}class lc{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.wt=null,this._t=null,this.startAt,this.endAt}}function hc(t){return new lc(t)}function dc(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function fc(t){const e=mi(t);if(null===e.wt){e.wt=[];const t=function(t){for(const e of t.filters){const t=e.getFirstInequalityField();if(null!==t)return t}return null}(e),n=function(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}(e);if(null!==t&&null===n)t.isKeyField()||e.wt.push(new La(t)),e.wt.push(new La(Fi.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.wt.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.wt.push(new La(Fi.keyField(),t))}}}return e.wt}function gc(t){const e=mi(t);if(!e._t)if("F"===e.limitType)e._t=sc(e.path,e.collectionGroup,fc(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of fc(e)){const e="desc"===n.dir?"asc":"desc";t.push(new La(n.field,e))}const n=e.endAt?new Ma(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new Ma(e.startAt.position,e.startAt.inclusive):null;e._t=sc(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e._t}function mc(t,e,n){return new lc(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function pc(t,e){return ic(gc(t),gc(e))&&t.limitType===e.limitType}function yc(t){return`${rc(gc(t))}|lt:${t.limitType}`}function vc(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>Ha(t))).join(", ")}]`),uo(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>ma(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>ma(t))).join(",")),`Target(${e})`}(gc(t))}; limitType=${t.limitType})`}function wc(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):Vi.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of fc(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=Oa(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,fc(t),e)||t.endAt&&!function(t,e,n){const s=Oa(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,fc(t),e))}(t,e)}function bc(t){return(e,n)=>{let s=!1;for(const r of fc(t)){const t=Ec(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function Ec(t,e,n){const s=t.field.isKeyField()?Vi.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?fa(s,r):fi()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return fi()}}class Ic{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){qo(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return zo(this.inner)}size(){return this.innerSize}}const Tc=new Ko(Vi.comparator);function Sc(){return Tc}const _c=new Ko(Vi.comparator);function Dc(...t){let e=_c;for(const n of t)e=e.insert(n.key,n);return e}function xc(t){let e=_c;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function Cc(){return kc()}function Ac(){return kc()}function kc(){return new Ic((t=>t.toString()),((t,e)=>t.isEqual(e)))}const Nc=new Ko(Vi.comparator),Mc=new Ho(Vi.comparator);function Oc(...t){let e=Mc;for(const n of t)e=e.add(n);return e}const Rc=new Ho(Ai);function Lc(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:lo(e)?"-0":e}}function Pc(t){return{integerValue:""+t}}function Fc(t,e){return function(t){return"number"==typeof t&&Number.isInteger(t)&&!lo(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}(e)?Pc(e):Lc(t,e)}class Vc{constructor(){this._=void 0}}function Bc(t,e,n){return t instanceof qc?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&sa(e)&&(e=ra(e)),e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof zc?Kc(t,e):t instanceof $c?Gc(t,e):function(t,e){const n=jc(t,e),s=Qc(n)+Qc(t.gt);return va(n)&&va(t.gt)?Pc(s):Lc(t.serializer,s)}(t,e)}function Uc(t,e,n){return t instanceof zc?Kc(t,e):t instanceof $c?Gc(t,e):n}function jc(t,e){return t instanceof Hc?va(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class qc extends Vc{}class zc extends Vc{constructor(t){super(),this.elements=t}}function Kc(t,e){const n=Wc(e);for(const e of t.elements)n.some((t=>ha(t,e)))||n.push(e);return{arrayValue:{values:n}}}class $c extends Vc{constructor(t){super(),this.elements=t}}function Gc(t,e){let n=Wc(e);for(const e of t.elements)n=n.filter((t=>!ha(t,e)));return{arrayValue:{values:n}}}class Hc extends Vc{constructor(t,e){super(),this.serializer=t,this.gt=e}}function Qc(t){return ea(t.integerValue||t.doubleValue)}function Wc(t){return wa(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Xc{constructor(t,e){this.field=t,this.transform=e}}class Yc{constructor(t,e){this.version=t,this.transformResults=e}}class Jc{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Jc}static exists(t){return new Jc(void 0,t)}static updateTime(t){return new Jc(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Zc(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class tu{}function eu(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new hu(t.key,Jc.none()):new ou(t.key,t.data,Jc.none());{const n=t.data,s=Aa.empty();let r=new Ho(Fi.comparator);for(let t of e.fields)if(!r.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?s.delete(t):s.set(t,e),r=r.add(t)}return new au(t.key,s,new Xo(r.toArray()),Jc.none())}}function nu(t,e,n){t instanceof ou?function(t,e,n){const s=t.value.clone(),r=uu(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof au?function(t,e,n){if(!Zc(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=uu(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(cu(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function su(t,e,n,s){return t instanceof ou?function(t,e,n,s){if(!Zc(t.precondition,e))return n;const r=t.value.clone(),i=lu(t.fieldTransforms,s,e);return r.setAll(i),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null}(t,e,n,s):t instanceof au?function(t,e,n,s){if(!Zc(t.precondition,e))return n;const r=lu(t.fieldTransforms,s,e),i=e.data;return i.setAll(cu(t)),i.setAll(r),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,s):function(t,e,n){return Zc(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function ru(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=jc(s.transform,t||null);null!=r&&(null===n&&(n=Aa.empty()),n.set(s.field,r))}return n||null}function iu(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&ki(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof zc&&e instanceof zc||t instanceof $c&&e instanceof $c?ki(t.elements,e.elements,ha):t instanceof Hc&&e instanceof Hc?ha(t.gt,e.gt):t instanceof qc&&e instanceof qc}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class ou extends tu{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class au extends tu{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function cu(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function uu(t,e,n){const s=new Map;gi(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,Uc(o,a,n[r]))}return s}function lu(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Bc(t,i,e))}return s}class hu extends tu{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class du extends tu{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class fu{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&nu(s,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=su(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=su(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=Ac();return this.mutations.forEach((s=>{const r=t.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=e.has(s.key)?null:o;const a=eu(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(Oi.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),Oc())}isEqual(t){return this.batchId===t.batchId&&ki(this.mutations,t.mutations,((t,e)=>iu(t,e)))&&ki(this.baseMutations,t.baseMutations,((t,e)=>iu(t,e)))}}class gu{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){gi(t.mutations.length===n.length);let s=Nc;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new gu(t,e,n,s)}}class mu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class pu{constructor(t,e){this.count=t,this.unchangedNames=e}}var yu,vu;function wu(t){if(void 0===t)return li("GRPC error has no .code"),pi.UNKNOWN;switch(t){case yu.OK:return pi.OK;case yu.CANCELLED:return pi.CANCELLED;case yu.UNKNOWN:return pi.UNKNOWN;case yu.DEADLINE_EXCEEDED:return pi.DEADLINE_EXCEEDED;case yu.RESOURCE_EXHAUSTED:return pi.RESOURCE_EXHAUSTED;case yu.INTERNAL:return pi.INTERNAL;case yu.UNAVAILABLE:return pi.UNAVAILABLE;case yu.UNAUTHENTICATED:return pi.UNAUTHENTICATED;case yu.INVALID_ARGUMENT:return pi.INVALID_ARGUMENT;case yu.NOT_FOUND:return pi.NOT_FOUND;case yu.ALREADY_EXISTS:return pi.ALREADY_EXISTS;case yu.PERMISSION_DENIED:return pi.PERMISSION_DENIED;case yu.FAILED_PRECONDITION:return pi.FAILED_PRECONDITION;case yu.ABORTED:return pi.ABORTED;case yu.OUT_OF_RANGE:return pi.OUT_OF_RANGE;case yu.UNIMPLEMENTED:return pi.UNIMPLEMENTED;case yu.DATA_LOSS:return pi.DATA_LOSS;default:return fi()}}(vu=yu||(yu={}))[vu.OK=0]="OK",vu[vu.CANCELLED=1]="CANCELLED",vu[vu.UNKNOWN=2]="UNKNOWN",vu[vu.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",vu[vu.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",vu[vu.NOT_FOUND=5]="NOT_FOUND",vu[vu.ALREADY_EXISTS=6]="ALREADY_EXISTS",vu[vu.PERMISSION_DENIED=7]="PERMISSION_DENIED",vu[vu.UNAUTHENTICATED=16]="UNAUTHENTICATED",vu[vu.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",vu[vu.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",vu[vu.ABORTED=10]="ABORTED",vu[vu.OUT_OF_RANGE=11]="OUT_OF_RANGE",vu[vu.UNIMPLEMENTED=12]="UNIMPLEMENTED",vu[vu.INTERNAL=13]="INTERNAL",vu[vu.UNAVAILABLE=14]="UNAVAILABLE",vu[vu.DATA_LOSS=15]="DATA_LOSS";class bu{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Eu}static getOrCreateInstance(){return null===Eu&&(Eu=new bu),Eu}onExistenceFilterMismatch(t){const e=Symbol();return this.onExistenceFilterMismatchCallbacks.set(e,t),()=>this.onExistenceFilterMismatchCallbacks.delete(e)}notifyOnExistenceFilterMismatch(t){this.onExistenceFilterMismatchCallbacks.forEach((e=>e(t)))}}let Eu=null;const Iu=new si([4294967295,4294967295],0);function Tu(t){const e=(new TextEncoder).encode(t),n=new ni;return n.update(e),new Uint8Array(n.digest())}function Su(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),s=e.getUint32(4,!0),r=e.getUint32(8,!0),i=e.getUint32(12,!0);return[new si([n,s],0),new si([r,i],0)]}class _u{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new Du(`Invalid padding: ${e}`);if(n<0)throw new Du(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new Du(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new Du(`Invalid padding when bitmap length is 0: ${e}`);this.It=8*t.length-e,this.Tt=si.fromNumber(this.It)}Et(t,e,n){let s=t.add(e.multiply(si.fromNumber(n)));return 1===s.compare(Iu)&&(s=new si([s.getBits(0),s.getBits(1)],0)),s.modulo(this.Tt).toNumber()}At(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}vt(t){if(0===this.It)return!1;const e=Tu(t),[n,s]=Su(e);for(let t=0;t<this.hashCount;t++){const e=this.Et(n,s,t);if(!this.At(e))return!1}return!0}static create(t,e,n){const s=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),i=new _u(r,s,e);return n.forEach((t=>i.insert(t))),i}insert(t){if(0===this.It)return;const e=Tu(t),[n,s]=Su(e);for(let t=0;t<this.hashCount;t++){const e=this.Et(n,s,t);this.Rt(e)}}Rt(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class Du extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class xu{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const s=new Map;return s.set(t,Cu.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new xu(Oi.min(),s,new Ko(Ai),Sc(),Oc())}}class Cu{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new Cu(n,e,Oc(),Oc(),Oc())}}class Au{constructor(t,e,n,s){this.Pt=t,this.removedTargetIds=e,this.key=n,this.bt=s}}class ku{constructor(t,e){this.targetId=t,this.Vt=e}}class Nu{constructor(t,e,n=Jo.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class Mu{constructor(){this.St=0,this.Dt=Lu(),this.Ct=Jo.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(t){t.approximateByteSize()>0&&(this.Nt=!0,this.Ct=t)}Ot(){let t=Oc(),e=Oc(),n=Oc();return this.Dt.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:fi()}})),new Cu(this.Ct,this.xt,t,e,n)}Ft(){this.Nt=!1,this.Dt=Lu()}Bt(t,e){this.Nt=!0,this.Dt=this.Dt.insert(t,e)}Lt(t){this.Nt=!0,this.Dt=this.Dt.remove(t)}qt(){this.St+=1}Ut(){this.St-=1}Kt(){this.Nt=!0,this.xt=!0}}class Ou{constructor(t){this.Gt=t,this.Qt=new Map,this.jt=Sc(),this.zt=Ru(),this.Wt=new Ko(Ai)}Ht(t){for(const e of t.Pt)t.bt&&t.bt.isFoundDocument()?this.Jt(e,t.bt):this.Yt(e,t.key,t.bt);for(const e of t.removedTargetIds)this.Yt(e,t.key,t.bt)}Xt(t){this.forEachTarget(t,(e=>{const n=this.Zt(e);switch(t.state){case 0:this.te(e)&&n.$t(t.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(t.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(e);break;case 3:this.te(e)&&(n.Kt(),n.$t(t.resumeToken));break;case 4:this.te(e)&&(this.ee(e),n.$t(t.resumeToken));break;default:fi()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Qt.forEach(((t,n)=>{this.te(n)&&e(n)}))}ne(t){var e;const n=t.targetId,s=t.Vt.count,r=this.se(n);if(r){const i=r.target;if(oc(i))if(0===s){const t=new Vi(i.path);this.Yt(n,t,Na.newNoDocument(t,Oi.min()))}else gi(1===s);else{const r=this.ie(n);if(r!==s){const s=this.re(t,r);if(0!==s){this.ee(n);const t=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(n,t)}null===(e=bu.instance)||void 0===e||e.notifyOnExistenceFilterMismatch(function(t,e,n){var s,r,i,o,a,c;const u={localCacheCount:e,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(u.bloomFilter={applied:0===t,hashCount:null!==(s=null==l?void 0:l.hashCount)&&void 0!==s?s:0,bitmapLength:null!==(o=null===(i=null===(r=null==l?void 0:l.bits)||void 0===r?void 0:r.bitmap)||void 0===i?void 0:i.length)&&void 0!==o?o:0,padding:null!==(c=null===(a=null==l?void 0:l.bits)||void 0===a?void 0:a.padding)&&void 0!==c?c:0}),u}(s,r,t.Vt))}}}}re(t,e){const{unchangedNames:n,count:s}=t.Vt;if(!n||!n.bits)return 1;const{bits:{bitmap:r="",padding:i=0},hashCount:o=0}=n;let a,c;try{a=na(r).toUint8Array()}catch(t){if(t instanceof Yo)return hi("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw t}try{c=new _u(a,i,o)}catch(t){return hi(t instanceof Du?"BloomFilter error: ":"Applying bloom filter failed: ",t),1}return 0===c.It?1:s!==e-this.oe(t.targetId,c)?2:0}oe(t,e){const n=this.Gt.getRemoteKeysForTarget(t);let s=0;return n.forEach((n=>{const r=this.Gt.ue(),i=`projects/${r.projectId}/databases/${r.database}/documents/${n.path.canonicalString()}`;e.vt(i)||(this.Yt(t,n,null),s++)})),s}ce(t){const e=new Map;this.Qt.forEach(((n,s)=>{const r=this.se(s);if(r){if(n.current&&oc(r.target)){const e=new Vi(r.target.path);null!==this.jt.get(e)||this.ae(s,e)||this.Yt(s,e,Na.newNoDocument(e,t))}n.Mt&&(e.set(s,n.Ot()),n.Ft())}}));let n=Oc();this.zt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.se(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.jt.forEach(((e,n)=>n.setReadTime(t)));const s=new xu(t,e,this.Wt,this.jt,n);return this.jt=Sc(),this.zt=Ru(),this.Wt=new Ko(Ai),s}Jt(t,e){if(!this.te(t))return;const n=this.ae(t,e.key)?2:0;this.Zt(t).Bt(e.key,n),this.jt=this.jt.insert(e.key,e),this.zt=this.zt.insert(e.key,this.he(e.key).add(t))}Yt(t,e,n){if(!this.te(t))return;const s=this.Zt(t);this.ae(t,e)?s.Bt(e,1):s.Lt(e),this.zt=this.zt.insert(e,this.he(e).delete(t)),n&&(this.jt=this.jt.insert(e,n))}removeTarget(t){this.Qt.delete(t)}ie(t){const e=this.Zt(t).Ot();return this.Gt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}qt(t){this.Zt(t).qt()}Zt(t){let e=this.Qt.get(t);return e||(e=new Mu,this.Qt.set(t,e)),e}he(t){let e=this.zt.get(t);return e||(e=new Ho(Ai),this.zt=this.zt.insert(t,e)),e}te(t){const e=null!==this.se(t);return e||ui("WatchChangeAggregator","Detected inactive target",t),e}se(t){const e=this.Qt.get(t);return e&&e.kt?null:this.Gt.le(t)}ee(t){this.Qt.set(t,new Mu),this.Gt.getRemoteKeysForTarget(t).forEach((e=>{this.Yt(t,e,null)}))}ae(t,e){return this.Gt.getRemoteKeysForTarget(t).has(e)}}function Ru(){return new Ko(Vi.comparator)}function Lu(){return new Ko(Vi.comparator)}const Pu={asc:"ASCENDING",desc:"DESCENDING"},Fu={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Vu={and:"AND",or:"OR"};class Bu{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Uu(t,e){return t.useProto3Json||uo(e)?e:{value:e}}function ju(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function qu(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function zu(t,e){return ju(t,e.toTimestamp())}function Ku(t){return gi(!!t),Oi.fromTimestamp(function(t){const e=ta(t);return new Mi(e.seconds,e.nanos)}(t))}function $u(t,e){return function(t){return new Li(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Gu(t){const e=Li.fromString(t);return gi(fl(e)),e}function Hu(t,e){return $u(t.databaseId,e.path)}function Qu(t,e){const n=Gu(e);if(n.get(1)!==t.databaseId.projectId)throw new yi(pi.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new yi(pi.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new Vi(Ju(n))}function Wu(t,e){return $u(t.databaseId,e)}function Xu(t){const e=Gu(t);return 4===e.length?Li.emptyPath():Ju(e)}function Yu(t){return new Li(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Ju(t){return gi(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Zu(t,e,n){return{name:Hu(t,e),fields:n.value.mapValue.fields}}function tl(t,e){let n;if(e instanceof ou)n={update:Zu(t,e.key,e.value)};else if(e instanceof hu)n={delete:Hu(t,e.key)};else if(e instanceof au)n={update:Zu(t,e.key,e.data),updateMask:dl(e.fieldMask)};else{if(!(e instanceof du))return fi();n={verify:Hu(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof qc)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof zc)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof $c)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Hc)return{fieldPath:e.field.canonicalString(),increment:n.gt};throw fi()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:zu(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:fi()}(t,e.precondition)),n}function el(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Jc.updateTime(Ku(t.updateTime)):void 0!==t.exists?Jc.exists(t.exists):Jc.none()}(e.currentDocument):Jc.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)gi("REQUEST_TIME"===e.setToServerValue),n=new qc;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new zc(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new $c(t)}else"increment"in e?n=new Hc(t,e.increment):fi();const s=Fi.fromServerFormat(e.fieldPath);return new Xc(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Qu(t,e.update.name),i=new Aa({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Xo(e.map((t=>Fi.fromServerFormat(t))))}(e.updateMask);return new au(r,i,t,n,s)}return new ou(r,i,n,s)}if(e.delete){const s=Qu(t,e.delete);return new hu(s,n)}if(e.verify){const s=Qu(t,e.verify);return new du(s,n)}return fi()}function nl(t,e){return{documents:[Wu(t,e.path)]}}function sl(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=Wu(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Wu(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0!==t.length)return hl(Ba.create(t,"and"))}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:ul(t.field),direction:ol(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=Uu(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function rl(t){let e=Xu(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){gi(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=il(t);return e instanceof Ba&&qa(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new La(ll(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,uo(e)?null:e}(n.limit));let c=null;n.startAt&&(c=function(t){const e=!!t.before,n=t.values||[];return new Ma(n,e)}(n.startAt));let u=null;return n.endAt&&(u=function(t){const e=!t.before,n=t.values||[];return new Ma(n,e)}(n.endAt)),function(t,e,n,s,r,i,o,a){return new lc(t,e,n,s,r,i,o,a)}(e,r,o,i,a,"F",c,u)}function il(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=ll(t.unaryFilter.field);return Va.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=ll(t.unaryFilter.field);return Va.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=ll(t.unaryFilter.field);return Va.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=ll(t.unaryFilter.field);return Va.create(r,"!=",{nullValue:"NULL_VALUE"});default:return fi()}}(t):void 0!==t.fieldFilter?function(t){return Va.create(ll(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return fi()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return Ba.create(t.compositeFilter.filters.map((t=>il(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return fi()}}(t.compositeFilter.op))}(t):fi()}function ol(t){return Pu[t]}function al(t){return Fu[t]}function cl(t){return Vu[t]}function ul(t){return{fieldPath:t.canonicalString()}}function ll(t){return Fi.fromServerFormat(t.fieldPath)}function hl(t){return t instanceof Va?function(t){if("=="===t.op){if(Ea(t.value))return{unaryFilter:{field:ul(t.field),op:"IS_NAN"}};if(ba(t.value))return{unaryFilter:{field:ul(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Ea(t.value))return{unaryFilter:{field:ul(t.field),op:"IS_NOT_NAN"}};if(ba(t.value))return{unaryFilter:{field:ul(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ul(t.field),op:al(t.op),value:t.value}}}(t):t instanceof Ba?function(t){const e=t.getFilters().map((t=>hl(t)));return 1===e.length?e[0]:{compositeFilter:{op:cl(t.op),filters:e}}}(t):fi()}function dl(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function fl(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class gl{constructor(t,e,n,s,r=Oi.min(),i=Oi.min(),o=Jo.EMPTY_BYTE_STRING,a=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(t){return new gl(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new gl(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class ml{constructor(t){this.fe=t}}function pl(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:yl(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:Hu(t,e.key),fields:e.data.value.mapValue.fields,updateTime:ju(t,e.version.toTimestamp()),createTime:ju(t,e.createTime.toTimestamp())}}(t.fe,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:vl(e.version)};else{if(!e.isUnknownDocument())return fi();s.unknownDocument={path:n.path.toArray(),version:vl(e.version)}}return s}function yl(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function vl(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wl(t){const e=new Mi(t.seconds,t.nanoseconds);return Oi.fromTimestamp(e)}function bl(t,e){const n=(e.baseMutations||[]).map((e=>el(t.fe,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>el(t.fe,e))),r=Mi.fromMillis(e.localWriteTimeMs);return new fu(e.batchId,r,n,s)}function El(t){const e=wl(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?wl(t.lastLimboFreeSnapshotVersion):Oi.min();let s;var r;return void 0!==t.query.documents?(gi(1===(r=t.query).documents.length),s=gc(hc(Xu(r.documents[0])))):s=function(t){return gc(rl(t))}(t.query),new gl(s,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,Jo.fromBase64String(t.resumeToken))}function Il(t,e){const n=vl(e.snapshotVersion),s=vl(e.lastLimboFreeSnapshotVersion);let r;r=oc(e.target)?nl(t.fe,e.target):sl(t.fe,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:rc(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Tl(t){const e=rl({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?mc(e,e.limit,"L"):e}function Sl(t,e){return new mu(e.largestBatchId,el(t.fe,e.overlayMutation))}function _l(t,e){const n=e.path.lastSegment();return[t,ho(e.path.popLast()),n]}function Dl(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:vl(s.readTime),documentKey:ho(s.documentKey.path),largestBatchId:s.largestBatchId}}class xl{getBundleMetadata(t,e){return Cl(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:wl(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Cl(t).put({bundleId:(n=e).id,createTime:vl(Ku(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Al(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Tl(e.bundledQuery),readTime:wl(e.readTime)};var e}))}saveNamedQuery(t,e){return Al(t).put(function(t){return{name:t.name,readTime:vl(Ku(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Cl(t){return Uo(t,"bundles")}function Al(t){return Uo(t,"namedQueries")}class kl{constructor(t,e){this.serializer=t,this.userId=e}static de(t,e){const n=e.uid||"";return new kl(t,n)}getOverlay(t,e){return Nl(t).get(_l(this.userId,e)).next((t=>t?Sl(this.serializer,t):null))}getOverlays(t,e){const n=Cc();return Xi.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,r)=>{const i=new mu(e,r);s.push(this.we(t,i))})),Xi.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(ho(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(Nl(t).J("collectionPathOverlayIndex",s))})),Xi.waitFor(r)}getOverlaysForCollection(t,e,n){const s=Cc(),r=ho(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return Nl(t).j("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=Sl(this.serializer,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=Cc();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Nl(t).X({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=Sl(this.serializer,e);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}we(t,e){return Nl(t).put(function(t,e,n){const[s,r,i]=_l(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:tl(t.fe,n.mutation)}}(this.serializer,this.userId,e))}}function Nl(t){return Uo(t,"documentOverlays")}class Ml{constructor(){}_e(t,e){this.me(t,e),e.ge()}me(t,e){if("nullValue"in t)this.ye(e,5);else if("booleanValue"in t)this.ye(e,10),e.pe(t.booleanValue?1:0);else if("integerValue"in t)this.ye(e,15),e.pe(ea(t.integerValue));else if("doubleValue"in t){const n=ea(t.doubleValue);isNaN(n)?this.ye(e,13):(this.ye(e,15),lo(n)?e.pe(0):e.pe(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ye(e,20),"string"==typeof n?e.Ie(n):(e.Ie(`${n.seconds||""}`),e.pe(n.nanos||0))}else if("stringValue"in t)this.Te(t.stringValue,e),this.Ee(e);else if("bytesValue"in t)this.ye(e,30),e.Ae(na(t.bytesValue)),this.Ee(e);else if("referenceValue"in t)this.ve(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ye(e,45),e.pe(n.latitude||0),e.pe(n.longitude||0)}else"mapValue"in t?Sa(t)?this.ye(e,Number.MAX_SAFE_INTEGER):(this.Re(t.mapValue,e),this.Ee(e)):"arrayValue"in t?(this.Pe(t.arrayValue,e),this.Ee(e)):fi()}Te(t,e){this.ye(e,25),this.be(t,e)}be(t,e){e.Ie(t)}Re(t,e){const n=t.fields||{};this.ye(e,55);for(const t of Object.keys(n))this.Te(t,e),this.me(n[t],e)}Pe(t,e){const n=t.values||[];this.ye(e,50);for(const t of n)this.me(t,e)}ve(t,e){this.ye(e,37),Vi.fromName(t).path.forEach((t=>{this.ye(e,60),this.be(t,e)}))}ye(t,e){t.pe(e)}Ee(t){t.pe(2)}}function Ol(t){if(0===t)return 8;let e=0;return!(t>>4)&&(e+=4,t<<=4),!(t>>6)&&(e+=2,t<<=2),!(t>>7)&&(e+=1),e}function Rl(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=Ol(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}Ml.Ve=new Ml;class Ll{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.De(n.value),n=e.next();this.Ce()}xe(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ne(n.value),n=e.next();this.ke()}Me(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.De(t);else if(t<2048)this.De(960|t>>>6),this.De(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.De(480|t>>>12),this.De(128|63&t>>>6),this.De(128|63&t);else{const t=e.codePointAt(0);this.De(240|t>>>18),this.De(128|63&t>>>12),this.De(128|63&t>>>6),this.De(128|63&t)}}this.Ce()}$e(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ne(t);else if(t<2048)this.Ne(960|t>>>6),this.Ne(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ne(480|t>>>12),this.Ne(128|63&t>>>6),this.Ne(128|63&t);else{const t=e.codePointAt(0);this.Ne(240|t>>>18),this.Ne(128|63&t>>>12),this.Ne(128|63&t>>>6),this.Ne(128|63&t)}}this.ke()}Oe(t){const e=this.Fe(t),n=Rl(e);this.Be(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Le(t){const e=this.Fe(t),n=Rl(e);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(t){this.Be(t.length),this.buffer.set(t,this.position),this.position+=t.length}Qe(){return this.buffer.slice(0,this.position)}Fe(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=!!(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}De(t){const e=255&t;0===e?(this.Ue(0),this.Ue(255)):255===e?(this.Ue(255),this.Ue(0)):this.Ue(e)}Ne(t){const e=255&t;0===e?(this.Ge(0),this.Ge(255)):255===e?(this.Ge(255),this.Ge(0)):this.Ge(t)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(t){this.Be(1),this.buffer[this.position++]=t}Ge(t){this.Be(1),this.buffer[this.position++]=~t}Be(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Pl{constructor(t){this.je=t}Ae(t){this.je.Se(t)}Ie(t){this.je.Me(t)}pe(t){this.je.Oe(t)}ge(){this.je.qe()}}class Fl{constructor(t){this.je=t}Ae(t){this.je.xe(t)}Ie(t){this.je.$e(t)}pe(t){this.je.Le(t)}ge(){this.je.Ke()}}class Vl{constructor(){this.je=new Ll,this.ze=new Pl(this.je),this.We=new Fl(this.je)}seed(t){this.je.seed(t)}He(t){return 0===t?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class Bl{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}Je(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new Bl(this.indexId,this.documentKey,this.arrayValue,n)}}function Ul(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=jl(t.arrayValue,e.arrayValue),0!==n?n:(n=jl(t.directionalValue,e.directionalValue),0!==n?n:Vi.comparator(t.documentKey,e.documentKey)))}function jl(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class ql{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ye=t.orderBy,this.Xe=[];for(const e of t.filters){const t=e;t.isInequality()?this.Ze=t:this.Xe.push(t)}}tn(t){gi(t.collectionGroup===this.collectionId);const e=Ui(t);if(void 0!==e&&!this.en(e))return!1;const n=ji(t);let s=new Set,r=0,i=0;for(;r<n.length&&this.en(n[r]);++r)s=s.add(n[r].fieldPath.canonicalString());if(r===n.length)return!0;if(void 0!==this.Ze){if(!s.has(this.Ze.field.canonicalString())){const t=n[r];if(!this.nn(this.Ze,t)||!this.sn(this.Ye[i++],t))return!1}++r}for(;r<n.length;++r){const t=n[r];if(i>=this.Ye.length||!this.sn(this.Ye[i++],t))return!1}return!0}en(t){for(const e of this.Xe)if(this.nn(e,t))return!0;return!1}nn(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function zl(t){var e,n;if(gi(t instanceof Va||t instanceof Ba),t instanceof Va){if(t instanceof Za){const s=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>Va.create(t.field,"==",e))))||[];return Ba.create(s,"or")}return t}const s=t.filters.map((t=>zl(t)));return Ba.create(s,t.op)}function Kl(t){if(0===t.getFilters().length)return[];const e=Ql(zl(t));return gi(Hl(e)),$l(e)||Gl(e)?[e]:e.getFilters()}function $l(t){return t instanceof Va}function Gl(t){return t instanceof Ba&&qa(t)}function Hl(t){return $l(t)||Gl(t)||function(t){if(t instanceof Ba&&ja(t)){for(const e of t.getFilters())if(!$l(e)&&!Gl(e))return!1;return!0}return!1}(t)}function Ql(t){if(gi(t instanceof Va||t instanceof Ba),t instanceof Va)return t;if(1===t.filters.length)return Ql(t.filters[0]);const e=t.filters.map((t=>Ql(t)));let n=Ba.create(e,t.op);return n=Yl(n),Hl(n)?n:(gi(n instanceof Ba),gi(Ua(n)),gi(n.filters.length>1),n.filters.reduce(((t,e)=>Wl(t,e))))}function Wl(t,e){let n;return gi(t instanceof Va||t instanceof Ba),gi(e instanceof Va||e instanceof Ba),n=t instanceof Va?e instanceof Va?function(t,e){return Ba.create([t,e],"and")}(t,e):Xl(t,e):e instanceof Va?Xl(e,t):function(t,e){if(gi(t.filters.length>0&&e.filters.length>0),Ua(t)&&Ua(e))return Ga(t,e.getFilters());const n=ja(t)?t:e,s=ja(t)?e:t,r=n.filters.map((t=>Wl(t,s)));return Ba.create(r,"or")}(t,e),Yl(n)}function Xl(t,e){if(Ua(e))return Ga(e,t.getFilters());{const n=e.filters.map((e=>Wl(t,e)));return Ba.create(n,"or")}}function Yl(t){if(gi(t instanceof Va||t instanceof Ba),t instanceof Va)return t;const e=t.getFilters();if(1===e.length)return Yl(e[0]);if(za(t))return t;const n=e.map((t=>Yl(t))),s=[];return n.forEach((e=>{e instanceof Va?s.push(e):e instanceof Ba&&(e.op===t.op?s.push(...e.filters):s.push(e))})),1===s.length?s[0]:Ba.create(s,t.op)}class Jl{constructor(){this.rn=new Zl}addToCollectionParentIndex(t,e){return this.rn.add(e),Xi.resolve()}getCollectionParents(t,e){return Xi.resolve(this.rn.getEntries(e))}addFieldIndex(t,e){return Xi.resolve()}deleteFieldIndex(t,e){return Xi.resolve()}getDocumentsMatchingTarget(t,e){return Xi.resolve(null)}getIndexType(t,e){return Xi.resolve(0)}getFieldIndexes(t,e){return Xi.resolve([])}getNextCollectionGroupToUpdate(t){return Xi.resolve(null)}getMinOffset(t,e){return Xi.resolve($i.min())}getMinOffsetFromCollectionGroup(t,e){return Xi.resolve($i.min())}updateCollectionGroup(t,e,n){return Xi.resolve()}updateIndexEntries(t,e){return Xi.resolve()}}class Zl{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new Ho(Li.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new Ho(Li.comparator)).toArray()}}const th=new Uint8Array(0);class eh{constructor(t,e){this.user=t,this.databaseId=e,this.on=new Zl,this.un=new Ic((t=>rc(t)),((t,e)=>ic(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.on.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.on.add(e)}));const r={collectionId:n,parent:ho(s)};return nh(t).put(r)}return Xi.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[Ni(e),""],!1,!0);return nh(t).j(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(mo(s.parent))}return n}))}addFieldIndex(t,e){const n=rh(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete s.indexId;const r=n.add(s);if(e.indexState){const n=ih(t);return r.next((t=>{n.put(Dl(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return r.next()}deleteFieldIndex(t,e){const n=rh(t),s=ih(t),r=sh(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=sh(t);let s=!0;const r=new Map;return Xi.forEach(this.cn(e),(e=>this.an(t,e).next((t=>{s&&(s=!!t),r.set(e,t)})))).next((()=>{if(s){let t=Oc();const s=[];return Xi.forEach(r,((r,i)=>{var o;ui("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${rc(e)}`);const a=function(t,e){const n=Ui(e);if(void 0===n)return null;for(const e of ac(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,r),c=function(t,e){const n=new Map;for(const s of ji(e))for(const e of ac(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,r),u=function(t,e){const n=[];let s=!0;for(const r of ji(e)){const e=0===r.kind?cc(t,r.fieldPath,t.startAt):uc(t,r.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new Ma(n,s)}(i,r),l=function(t,e){const n=[];let s=!0;for(const r of ji(e)){const e=0===r.kind?uc(t,r.fieldPath,t.endAt):cc(t,r.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new Ma(n,s)}(i,r),h=this.hn(r,i,u),d=this.hn(r,i,l),f=this.ln(r,i,c),g=this.fn(r.indexId,a,h,u.inclusive,d,l.inclusive,f);return Xi.forEach(g,(r=>n.H(r,e.limit).next((e=>{e.forEach((e=>{const n=Vi.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return Xi.resolve(null)}))}cn(t){let e=this.un.get(t);return e||(e=0===t.filters.length?[t]:Kl(Ba.create(t.filters,"and")).map((e=>sc(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.un.set(t,e),e)}fn(t,e,n,s,r,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,r.length),c=a/(null!=e?e.length:1),u=[];for(let l=0;l<a;++l){const a=e?this.dn(e[l/c]):th,h=this.wn(t,a,n[l%c],s),d=this._n(t,a,r[l%c],i),f=o.map((e=>this.wn(t,a,e,!0)));u.push(...this.createRange(h,d,f))}return u}wn(t,e,n,s){const r=new Bl(t,Vi.empty(),e,n);return s?r:r.Je()}_n(t,e,n,s){const r=new Bl(t,Vi.empty(),e,n);return s?r.Je():r}an(t,e){const n=new ql(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.tn(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;const s=this.cn(e);return Xi.forEach(s,(e=>this.an(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Ho(Fi.comparator),n=!1;for(const s of t.filters)for(const t of s.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&s.length>1&&2===n?1:n))}mn(t,e){const n=new Vl;for(const s of ji(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.He(s.kind);Ml.Ve._e(t,r)}return n.Qe()}dn(t){const e=new Vl;return Ml.Ve._e(t,e.He(0)),e.Qe()}gn(t,e){const n=new Vl;return Ml.Ve._e(ya(this.databaseId,e),n.He(function(t){const e=ji(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Qe()}ln(t,e,n){if(null===n)return[];let s=[];s.push(new Vl);let r=0;for(const i of ji(t)){const t=n[r++];for(const n of s)if(this.yn(e,i.fieldPath)&&wa(t))s=this.pn(s,i,t);else{const e=n.He(i.kind);Ml.Ve._e(t,e)}}return this.In(s)}hn(t,e,n){return this.ln(t,e,n.position)}In(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Qe();return e}pn(t,e,n){const s=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new Vl;s.seed(n.Qe()),Ml.Ve._e(t,s.He(e.kind)),r.push(s)}return r}yn(t,e){return!!t.filters.find((t=>t instanceof Va&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=rh(t),s=ih(t);return(e?n.j("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.j()).next((t=>{const e=[];return Xi.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new zi(e.sequenceNumber,new $i(wl(e.readTime),new Vi(mo(e.documentKey)),e.largestBatchId)):zi.empty(),s=t.fields.map((([t,e])=>new qi(Fi.fromServerFormat(t),e)));return new Bi(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:Ai(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=rh(t),r=ih(t);return this.Tn(t).next((t=>s.j("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>Xi.forEach(e,(e=>r.put(Dl(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return Xi.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?Xi.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),Xi.forEach(r,(n=>this.En(t,e,n).next((e=>{const r=this.An(s,n);return e.isEqual(r)?Xi.resolve():this.vn(t,s,n,e,r)})))))))}))}Rn(t,e,n,s){return sh(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.gn(n,e.key),documentKey:e.key.path.toArray()})}Pn(t,e,n,s){return sh(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.gn(n,e.key),e.key.path.toArray()])}En(t,e,n){const s=sh(t);let r=new Ho(Ul);return s.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,e)])},((t,s)=>{r=r.add(new Bl(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}An(t,e){let n=new Ho(Ul);const s=this.mn(e,t);if(null==s)return n;const r=Ui(e);if(null!=r){const i=t.data.field(r.fieldPath);if(wa(i))for(const r of i.arrayValue.values||[])n=n.add(new Bl(e.indexId,t.key,this.dn(r),s))}else n=n.add(new Bl(e.indexId,t.key,th,s));return n}vn(t,e,n,s,r){ui("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=Wo(i),c=Wo(o);for(;a||c;){let t=!1,e=!1;if(a&&c){const s=n(a,c);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(c),c=Wo(o)):e?(r(a),a=Wo(i)):(a=Wo(i),c=Wo(o))}}(s,r,Ul,(s=>{i.push(this.Rn(t,e,n,s))}),(s=>{i.push(this.Pn(t,e,n,s))})),Xi.waitFor(i)}Tn(t){let e=1;return ih(t).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Ul(t,e))).filter(((t,e,n)=>!e||0!==Ul(t,n[e-1])));const s=[];s.push(t);for(const r of n){const n=Ul(r,t),i=Ul(r,e);if(0===n)s[0]=t.Je();else if(n>0&&i<0)s.push(r),s.push(r.Je());else if(i>0)break}s.push(e);const r=[];for(let t=0;t<s.length;t+=2){if(this.bn(s[t],s[t+1]))return[];const e=[s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,th,[]],n=[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,th,[]];r.push(IDBKeyRange.bound(e,n))}return r}bn(t,e){return Ul(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(oh)}getMinOffset(t,e){return Xi.mapArray(this.cn(e),(e=>this.an(t,e).next((t=>t||fi())))).next(oh)}}function nh(t){return Uo(t,"collectionParents")}function sh(t){return Uo(t,"indexEntries")}function rh(t){return Uo(t,"indexConfiguration")}function ih(t){return Uo(t,"indexState")}function oh(t){gi(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let s=1;s<t.length;s++){const r=t[s].indexState.offset;Gi(r,e)<0&&(e=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new $i(e.readTime,e.documentKey,n)}const ah={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ch{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new ch(t,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function uh(t,e,n){const s=t.store("mutations"),r=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=s.X({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{gi(1===a)})));const u=[];for(const t of n.mutations){const s=vo(e,t.key.path,n.batchId);i.push(r.delete(s)),u.push(t.key)}return Xi.waitFor(i).next((()=>u))}function lh(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw fi();e=t.noDocument}return JSON.stringify(e).length}ch.DEFAULT_COLLECTION_PERCENTILE=10,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ch.DEFAULT=new ch(41943040,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ch.DISABLED=new ch(-1,0,0);class hh{constructor(t,e,n,s){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=s,this.Vn={}}static de(t,e,n,s){gi(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new hh(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return fh(t).X({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=gh(t),i=fh(t);return i.add({}).next((o=>{gi("number"==typeof o);const a=new fu(o,e,n,s),c=function(t,e,n){const s=n.baseMutations.map((e=>tl(t.fe,e))),r=n.mutations.map((e=>tl(t.fe,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.serializer,this.userId,a),u=[];let l=new Ho(((t,e)=>Ai(t.canonicalString(),e.canonicalString())));for(const t of s){const e=vo(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),u.push(i.put(c)),u.push(r.put(e,wo))}return l.forEach((e=>{u.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Vn[o]=a.keys()})),Xi.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return fh(t).get(e).next((t=>t?(gi(t.userId===this.userId),bl(this.serializer,t)):null))}Sn(t,e){return this.Vn[e]?Xi.resolve(this.Vn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Vn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return fh(t).X({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(gi(e.batchId>=n),r=bl(this.serializer,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return fh(t).X({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return fh(t).j("userMutationsIndex",e).next((t=>t.map((t=>bl(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=yo(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return gh(t).X({range:s},((n,s,i)=>{const[o,a,c]=n,u=mo(a);if(o===this.userId&&e.path.isEqual(u))return fh(t).get(c).next((t=>{if(!t)throw fi();gi(t.userId===this.userId),r.push(bl(this.serializer,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ho(Ai);const s=[];return e.forEach((e=>{const r=yo(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=gh(t).X({range:i},((t,s,r)=>{const[i,o,a]=t,c=mo(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):r.done()}));s.push(o)})),Xi.waitFor(s).next((()=>this.Dn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=yo(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Ho(Ai);return gh(t).X({range:i},((t,e,r)=>{const[i,a,c]=t,u=mo(a);i===this.userId&&n.isPrefixOf(u)?u.length===s&&(o=o.add(c)):r.done()})).next((()=>this.Dn(t,o)))}Dn(t,e){const n=[],s=[];return e.forEach((e=>{s.push(fh(t).get(e).next((t=>{if(null===t)throw fi();gi(t.userId===this.userId),n.push(bl(this.serializer,t))})))})),Xi.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return uh(t.ht,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Cn(e.batchId)})),Xi.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Cn(t){delete this.Vn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Xi.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return gh(t).X({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=mo(t[1]);s.push(e)}else n.done()})).next((()=>{gi(0===s.length)}))}))}containsKey(t,e){return dh(t,this.userId,e)}xn(t){return mh(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function dh(t,e,n){const s=yo(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return gh(t).X({range:i,Y:!0},((t,n,s)=>{const[i,a,c]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function fh(t){return Uo(t,"mutations")}function gh(t){return Uo(t,"documentMutations")}function mh(t){return Uo(t,"mutationQueues")}class ph{constructor(t){this.Nn=t}next(){return this.Nn+=2,this.Nn}static kn(){return new ph(0)}static Mn(){return new ph(-1)}}class yh{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.$n(t).next((e=>{const n=new ph(e.highestTargetId);return e.highestTargetId=n.next(),this.On(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.$n(t).next((t=>Oi.fromTimestamp(new Mi(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.$n(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.$n(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.On(t,s))))}addTargetData(t,e){return this.Fn(t,e).next((()=>this.$n(t).next((n=>(n.targetCount+=1,this.Bn(e,n),this.On(t,n))))))}updateTargetData(t,e){return this.Fn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>vh(t).delete(e.targetId))).next((()=>this.$n(t))).next((e=>(gi(e.targetCount>0),e.targetCount-=1,this.On(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return vh(t).X(((i,o)=>{const a=El(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>Xi.waitFor(r))).next((()=>s))}forEachTarget(t,e){return vh(t).X(((t,n)=>{const s=El(n);e(s)}))}$n(t){return wh(t).get("targetGlobalKey").next((t=>(gi(null!==t),t)))}On(t,e){return wh(t).put("targetGlobalKey",e)}Fn(t,e){return vh(t).put(Il(this.serializer,e))}Bn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.$n(t).next((t=>t.targetCount))}getTargetData(t,e){const n=rc(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return vh(t).X({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const i=El(n);ic(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=bh(t);return e.forEach((e=>{const i=ho(e.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(t,n,e))})),Xi.waitFor(s)}removeMatchingKeys(t,e,n){const s=bh(t);return Xi.forEach(e,(e=>{const r=ho(e.path);return Xi.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=bh(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=bh(t);let r=Oc();return s.X({range:n,Y:!0},((t,e,n)=>{const s=mo(t[1]),i=new Vi(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=ho(e.path),s=IDBKeyRange.bound([n],[Ni(n)],!1,!0);let r=0;return bh(t).X({index:"documentTargetsIndex",Y:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}le(t,e){return vh(t).get(e).next((t=>t?El(t):null))}}function vh(t){return Uo(t,"targets")}function wh(t){return Uo(t,"targetGlobal")}function bh(t){return Uo(t,"targetDocuments")}function Eh([t,e],[n,s]){const r=Ai(t,n);return 0===r?Ai(e,s):r}class Ih{constructor(t){this.Ln=t,this.buffer=new Ho(Eh),this.qn=0}Un(){return++this.qn}Kn(t){const e=[t,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Eh(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Th{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(t){ui("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){eo(t)?ui("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Wi(t)}await this.Qn(3e5)}))}}class Sh{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.zn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Xi.resolve(co.ct);const n=new Ih(e);return this.jn.forEachTarget(t,(t=>n.Kn(t.sequenceNumber))).next((()=>this.jn.Wn(t,(t=>n.Kn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(ui("LruGarbageCollector","Garbage collection skipped; disabled"),Xi.resolve(ah)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(ui("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ah):this.Hn(t,e)))}getCacheSize(t){return this.jn.getCacheSize(t)}Hn(t,e){let n,s,r,i,o,a,c;const u=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(ui("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),ci()<=T.DEBUG&&ui("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-u}ms\n\tDetermined least recently used ${s} in `+(o-i)+"ms\n"+`\tRemoved ${r} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(c-a)+"ms\n"+`Total Duration: ${c-u}ms`),Xi.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class _h{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Sh(t,e)}(this,e)}zn(t){const e=this.Jn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Jn(t){let e=0;return this.Wn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Wn(t,e){return this.Yn(t,((t,n)=>e(n)))}addReference(t,e,n){return Dh(t,n)}removeReference(t,e,n){return Dh(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Dh(t,e)}Xn(t,e){return function(t,e){let n=!1;return mh(t).Z((s=>dh(t,s,e).next((t=>(t&&(n=!0),Xi.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Yn(t,((i,o)=>{if(o<=e){const e=this.Xn(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,Oi.min()),bh(t).delete([0,ho(i.path)]))))}));s.push(e)}})).next((()=>Xi.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Dh(t,e)}Yn(t,e){const n=bh(t);let s,r=co.ct;return n.X({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==co.ct&&e(new Vi(mo(s)),r),r=o,s=i):r=co.ct})).next((()=>{r!==co.ct&&e(new Vi(mo(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Dh(t,e){return bh(t).put(function(t,e){return{targetId:0,path:ho(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class xh{constructor(){this.changes=new Ic((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Na.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Xi.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Ch{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Mh(t).put(n)}removeEntry(t,e,n){return Mh(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],yl(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Zn(t,n))))}getEntry(t,e){let n=Na.newInvalidDocument(e);return Mh(t).X({index:"documentKeyIndex",range:IDBKeyRange.only(Oh(e))},((t,s)=>{n=this.ts(e,s)})).next((()=>n))}es(t,e){let n={size:0,document:Na.newInvalidDocument(e)};return Mh(t).X({index:"documentKeyIndex",range:IDBKeyRange.only(Oh(e))},((t,s)=>{n={document:this.ts(e,s),size:lh(s)}})).next((()=>n))}getEntries(t,e){let n=Sc();return this.ns(t,e,((t,e)=>{const s=this.ts(t,e);n=n.insert(t,s)})).next((()=>n))}ss(t,e){let n=Sc(),s=new Ko(Vi.comparator);return this.ns(t,e,((t,e)=>{const r=this.ts(t,e);n=n.insert(t,r),s=s.insert(t,lh(e))})).next((()=>({documents:n,rs:s})))}ns(t,e,n){if(e.isEmpty())return Xi.resolve();let s=new Ho(Lh);e.forEach((t=>s=s.add(t)));const r=IDBKeyRange.bound(Oh(s.first()),Oh(s.last())),i=s.getIterator();let o=i.getNext();return Mh(t).X({index:"documentKeyIndex",range:r},((t,e,s)=>{const r=Vi.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Lh(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?s.G(Oh(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,s){const r=e.path,i=[r.popLast().toArray(),r.lastSegment(),yl(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[r.popLast().toArray(),r.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Mh(t).j(IDBKeyRange.bound(i,o,!0)).next((t=>{let n=Sc();for(const r of t){const t=this.ts(Vi.fromSegments(r.prefixPath.concat(r.collectionGroup,r.documentId)),r);t.isFoundDocument()&&(wc(e,t)||s.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,s){let r=Sc();const i=Rh(e,n),o=Rh(e,$i.max());return Mh(t).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.ts(Vi.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(t){return new kh(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Nh(t).get("remoteDocumentGlobalKey").next((t=>(gi(!!t),t)))}Zn(t,e){return Nh(t).put("remoteDocumentGlobalKey",e)}ts(t,e){if(e){const t=function(t,e){let n;if(e.document)n=function(t,e,n){const s=Qu(t,e.name),r=Ku(e.updateTime),i=e.createTime?Ku(e.createTime):Oi.min(),o=new Aa({mapValue:{fields:e.fields}}),a=Na.newFoundDocument(s,r,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}(t.fe,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=Vi.fromSegments(e.noDocument.path),s=wl(e.noDocument.readTime);n=Na.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return fi();{const t=Vi.fromSegments(e.unknownDocument.path),s=wl(e.unknownDocument.version);n=Na.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new Mi(t[0],t[1]);return Oi.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(Oi.min()))return t}return Na.newInvalidDocument(t)}}function Ah(t){return new Ch(t)}class kh extends xh{constructor(t,e){super(),this.os=t,this.trackRemovals=e,this.us=new Ic((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new Ho(((t,e)=>Ai(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.us.get(r);if(e.push(this.os.removeEntry(t,r,o.readTime)),i.isValidDocument()){const a=pl(this.os.serializer,i);s=s.add(r.path.popLast());const c=lh(a);n+=c-o.size,e.push(this.os.addEntry(t,r,a))}else if(n-=o.size,this.trackRemovals){const n=pl(this.os.serializer,i.convertToNoDocument(Oi.min()));e.push(this.os.addEntry(t,r,n))}})),s.forEach((n=>{e.push(this.os.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.os.updateMetadata(t,n)),Xi.waitFor(e)}getFromCache(t,e){return this.os.es(t,e).next((t=>(this.us.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.os.ss(t,e).next((({documents:t,rs:e})=>(e.forEach(((e,n)=>{this.us.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Nh(t){return Uo(t,"remoteDocumentGlobal")}function Mh(t){return Uo(t,"remoteDocumentsV14")}function Oh(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Rh(t,e){const n=e.documentKey.path.toArray();return[t,yl(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Lh(t,e){const n=t.path.toArray(),s=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(r=Ai(n[t],s[t]),r)return r;return r=Ai(n.length,s.length),r||(r=Ai(n[n.length-2],s[s.length-2]),r||Ai(n[n.length-1],s[s.length-1]))}class Ph{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Fh{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((s=>(n=s,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&su(n.mutation,t,Xo.empty(),Mi.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,Oc()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=Oc()){const s=Cc();return this.populateOverlays(t,s,e).next((()=>this.computeViews(t,e,s,n).next((t=>{let e=Dc();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=Cc();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,Oc())))}populateOverlays(t,e,n){const s=[];return n.forEach((t=>{e.has(t)||s.push(t)})),this.documentOverlayCache.getOverlays(t,s).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,s){let r=Sc();const i=kc(),o=kc();return e.forEach(((t,e)=>{const o=n.get(e.key);s.has(e.key)&&(void 0===o||o.mutation instanceof au)?r=r.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),su(o.mutation,e,o.mutation.getFieldMask(),Mi.now())):i.set(e.key,Xo.empty())})),this.recalculateAndSaveOverlays(t,r).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Ph(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=kc();let s=new Ko(((t,e)=>t-e)),r=Oc();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const r of t)r.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Xo.empty();o=r.applyToLocalView(i,o),n.set(t,o);const a=(s.get(r.batchId)||Oc()).add(t);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,c=s.value,u=Ac();c.forEach((t=>{if(!r.has(t)){const s=eu(e.get(t),n.get(t));null!==s&&u.set(t,s),r=r.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,u))}return Xi.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return Vi.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):function(t){return null!==t.collectionGroup}(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-r.size):Xi.resolve(Cc());let o=-1,a=r;return i.next((e=>Xi.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(e)?Xi.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,r))).next((()=>this.computeViews(t,a,e,Oc()))).next((t=>({batchId:o,changes:xc(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new Vi(e)).next((t=>{let e=Dc();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const s=e.collectionGroup;let r=Dc();return this.indexManager.getCollectionParents(t,s).next((i=>Xi.forEach(i,(i=>{const o=function(t,e){return new lc(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(t,e,n){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((r=>(s=r,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s)))).next((t=>{s.forEach(((e,n)=>{const s=n.getKey();null===t.get(s)&&(t=t.insert(s,Na.newInvalidDocument(s)))}));let n=Dc();return t.forEach(((t,r)=>{const i=s.get(t);void 0!==i&&su(i.mutation,r,Xo.empty(),Mi.now()),wc(e,r)&&(n=n.insert(t,r))})),n}))}}class Vh{constructor(t){this.serializer=t,this.cs=new Map,this.hs=new Map}getBundleMetadata(t,e){return Xi.resolve(this.cs.get(e))}saveBundleMetadata(t,e){var n;return this.cs.set(e.id,{id:(n=e).id,version:n.version,createTime:Ku(n.createTime)}),Xi.resolve()}getNamedQuery(t,e){return Xi.resolve(this.hs.get(e))}saveNamedQuery(t,e){return this.hs.set(e.name,function(t){return{name:t.name,query:Tl(t.bundledQuery),readTime:Ku(t.readTime)}}(e)),Xi.resolve()}}class Bh{constructor(){this.overlays=new Ko(Vi.comparator),this.ls=new Map}getOverlay(t,e){return Xi.resolve(this.overlays.get(e))}getOverlays(t,e){const n=Cc();return Xi.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.we(t,e,s)})),Xi.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.ls.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.ls.delete(n)),Xi.resolve()}getOverlaysForCollection(t,e,n){const s=Cc(),r=e.length+1,i=new Vi(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return Xi.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new Ko(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=Cc(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=Cc(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return Xi.resolve(o)}we(t,e,n){const s=this.overlays.get(n.key);if(null!==s){const t=this.ls.get(s.largestBatchId).delete(n.key);this.ls.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new mu(e,n));let r=this.ls.get(e);void 0===r&&(r=Oc(),this.ls.set(e,r)),this.ls.set(e,r.add(n.key))}}class Uh{constructor(){this.fs=new Ho(jh.ds),this.ws=new Ho(jh._s)}isEmpty(){return this.fs.isEmpty()}addReference(t,e){const n=new jh(t,e);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.ys(new jh(t,e))}ps(t,e){t.forEach((t=>this.removeReference(t,e)))}Is(t){const e=new Vi(new Li([])),n=new jh(e,t),s=new jh(e,t+1),r=[];return this.ws.forEachInRange([n,s],(t=>{this.ys(t),r.push(t.key)})),r}Ts(){this.fs.forEach((t=>this.ys(t)))}ys(t){this.fs=this.fs.delete(t),this.ws=this.ws.delete(t)}Es(t){const e=new Vi(new Li([])),n=new jh(e,t),s=new jh(e,t+1);let r=Oc();return this.ws.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new jh(t,0),n=this.fs.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class jh{constructor(t,e){this.key=t,this.As=e}static ds(t,e){return Vi.comparator(t.key,e.key)||Ai(t.As,e.As)}static _s(t,e){return Ai(t.As,e.As)||Vi.comparator(t.key,e.key)}}class qh{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.vs=1,this.Rs=new Ho(jh.ds)}checkEmpty(t){return Xi.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,s){const r=this.vs;this.vs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new fu(r,e,n,s);this.mutationQueue.push(i);for(const e of s)this.Rs=this.Rs.add(new jh(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return Xi.resolve(i)}lookupMutationBatch(t,e){return Xi.resolve(this.Ps(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.bs(n),r=s<0?0:s;return Xi.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Xi.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(t){return Xi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new jh(e,0),s=new jh(e,Number.POSITIVE_INFINITY),r=[];return this.Rs.forEachInRange([n,s],(t=>{const e=this.Ps(t.As);r.push(e)})),Xi.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ho(Ai);return e.forEach((t=>{const e=new jh(t,0),s=new jh(t,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([e,s],(t=>{n=n.add(t.As)}))})),Xi.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;Vi.isDocumentKey(r)||(r=r.child(""));const i=new jh(new Vi(r),0);let o=new Ho(Ai);return this.Rs.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t.As)),!0)}),i),Xi.resolve(this.Vs(o))}Vs(t){const e=[];return t.forEach((t=>{const n=this.Ps(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){gi(0===this.Ss(e.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return Xi.forEach(e.mutations,(s=>{const r=new jh(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.Rs=n}))}Cn(t){}containsKey(t,e){const n=new jh(e,0),s=this.Rs.firstAfterOrEqual(n);return Xi.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,Xi.resolve()}Ss(t,e){return this.bs(t)}bs(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Ps(t){const e=this.bs(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class zh{constructor(t){this.Ds=t,this.docs=new Ko(Vi.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.Ds(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Xi.resolve(n?n.document.mutableCopy():Na.newInvalidDocument(e))}getEntries(t,e){let n=Sc();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Na.newInvalidDocument(t))})),Xi.resolve(n)}getDocumentsMatchingQuery(t,e,n,s){let r=Sc();const i=e.path,o=new Vi(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||Gi(Ki(o),n)<=0||(s.has(o.key)||wc(e,o))&&(r=r.insert(o.key,o.mutableCopy()))}return Xi.resolve(r)}getAllFromCollectionGroup(t,e,n,s){fi()}Cs(t,e){return Xi.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Kh(this)}getSize(t){return Xi.resolve(this.size)}}class Kh extends xh{constructor(t){super(),this.os=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.os.addEntry(t,s)):this.os.removeEntry(n)})),Xi.waitFor(e)}getFromCache(t,e){return this.os.getEntry(t,e)}getAllFromCache(t,e){return this.os.getEntries(t,e)}}class $h{constructor(t){this.persistence=t,this.xs=new Ic((t=>rc(t)),ic),this.lastRemoteSnapshotVersion=Oi.min(),this.highestTargetId=0,this.Ns=0,this.ks=new Uh,this.targetCount=0,this.Ms=ph.kn()}forEachTarget(t,e){return this.xs.forEach(((t,n)=>e(n))),Xi.resolve()}getLastRemoteSnapshotVersion(t){return Xi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Xi.resolve(this.Ns)}allocateTargetId(t){return this.highestTargetId=this.Ms.next(),Xi.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Ns&&(this.Ns=e),Xi.resolve()}Fn(t){this.xs.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Ms=new ph(e),this.highestTargetId=e),t.sequenceNumber>this.Ns&&(this.Ns=t.sequenceNumber)}addTargetData(t,e){return this.Fn(e),this.targetCount+=1,Xi.resolve()}updateTargetData(t,e){return this.Fn(e),Xi.resolve()}removeTargetData(t,e){return this.xs.delete(e.target),this.ks.Is(e.targetId),this.targetCount-=1,Xi.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.xs.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.xs.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),Xi.waitFor(r).next((()=>s))}getTargetCount(t){return Xi.resolve(this.targetCount)}getTargetData(t,e){const n=this.xs.get(e)||null;return Xi.resolve(n)}addMatchingKeys(t,e,n){return this.ks.gs(e,n),Xi.resolve()}removeMatchingKeys(t,e,n){this.ks.ps(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),Xi.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.ks.Is(e),Xi.resolve()}getMatchingKeysForTargetId(t,e){const n=this.ks.Es(e);return Xi.resolve(n)}containsKey(t,e){return Xi.resolve(this.ks.containsKey(e))}}class Gh{constructor(t,e){this.$s={},this.overlays={},this.Os=new co(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=t(this),this.Bs=new $h(this),this.indexManager=new Jl,this.remoteDocumentCache=function(t){return new zh(t)}((t=>this.referenceDelegate.Ls(t))),this.serializer=new ml(e),this.qs=new Vh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Bh,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.$s[t.toKey()];return n||(n=new qh(e,this.referenceDelegate),this.$s[t.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(t,e,n){ui("MemoryPersistence","Starting transaction:",t);const s=new Hh(this.Os.next());return this.referenceDelegate.Us(),n(s).next((t=>this.referenceDelegate.Ks(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Gs(t,e){return Xi.or(Object.values(this.$s).map((n=>()=>n.containsKey(t,e))))}}class Hh extends Qi{constructor(t){super(),this.currentSequenceNumber=t}}class Qh{constructor(t){this.persistence=t,this.Qs=new Uh,this.js=null}static zs(t){return new Qh(t)}get Ws(){if(this.js)return this.js;throw fi()}addReference(t,e,n){return this.Qs.addReference(n,e),this.Ws.delete(n.toString()),Xi.resolve()}removeReference(t,e,n){return this.Qs.removeReference(n,e),this.Ws.add(n.toString()),Xi.resolve()}markPotentiallyOrphaned(t,e){return this.Ws.add(e.toString()),Xi.resolve()}removeTarget(t,e){this.Qs.Is(e.targetId).forEach((t=>this.Ws.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Ws.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Us(){this.js=new Set}Ks(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Xi.forEach(this.Ws,(n=>{const s=Vi.fromPath(n);return this.Hs(t,s).next((t=>{t||e.removeEntry(s,Oi.min())}))})).next((()=>(this.js=null,e.apply(t))))}updateLimboDocument(t,e){return this.Hs(t,e).next((t=>{t?this.Ws.delete(e.toString()):this.Ws.add(e.toString())}))}Ls(t){return 0}Hs(t,e){return Xi.or([()=>Xi.resolve(this.Qs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gs(t,e)])}}class Wh{constructor(t){this.serializer=t}O(t,e,n,s){const r=new Yi("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",po,{unique:!0}),t.createObjectStore("documentMutations")}(t),Xh(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=Xi.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Xh(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Oi.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").j().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",po,{unique:!0});const s=e.store("mutations"),r=n.map((t=>s.put(t)));return Xi.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.Ys(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Xs(r))))),n<7&&s>=7&&(i=i.next((()=>this.Zs(r)))),n<8&&s>=8&&(i=i.next((()=>this.ti(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.ei(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:No});e.createIndex("collectionPathOverlayIndex",Mo,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Oo,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:bo});e.createIndex("documentKeyIndex",Eo),e.createIndex("collectionGroupIndex",Io)}(t))).next((()=>this.ni(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.si(t,r)))),n<15&&s>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:xo}).createIndex("sequenceNumberIndex",Co,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:Ao}).createIndex("documentKeyIndex",ko,{unique:!1})}(t)))),i}Xs(t){let e=0;return t.store("remoteDocuments").X(((t,n)=>{e+=lh(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Ys(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.j().next((e=>Xi.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",s).next((n=>Xi.forEach(n,(n=>{gi(n.userId===e.userId);const s=bl(this.serializer,n);return uh(t,e.userId,s).next((()=>{}))}))))}))))}Zs(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.X(((n,r)=>{const i=new Li(n),o=function(t){return[0,ho(t)]}(i);s.push(e.get(o).next((n=>n?Xi.resolve():(n=>e.put({targetId:0,path:ho(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>Xi.waitFor(s)))}))}ti(t,e){t.createObjectStore("collectionParents",{keyPath:Do});const n=e.store("collectionParents"),s=new Zl,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:ho(s)})}};return e.store("remoteDocuments").X({Y:!0},((t,e)=>{const n=new Li(t);return r(n.popLast())})).next((()=>e.store("documentMutations").X({Y:!0},(([t,e,n],s)=>{const i=mo(e);return r(i.popLast())}))))}ei(t){const e=t.store("targets");return e.X(((t,n)=>{const s=El(n),r=Il(this.serializer,s);return e.put(r)}))}ni(t,e){const n=e.store("remoteDocuments"),s=[];return n.X(((t,n)=>{const r=e.store("remoteDocumentsV14"),i=(o=n,o.document?new Vi(Li.fromString(o.document.name).popFirst(5)):o.noDocument?Vi.fromSegments(o.noDocument.path):o.unknownDocument?Vi.fromSegments(o.unknownDocument.path):fi()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>Xi.waitFor(s)))}si(t,e){const n=e.store("mutations"),s=Ah(this.serializer),r=new Gh(Qh.zs,this.serializer.fe);return n.j().next((t=>{const n=new Map;return t.forEach((t=>{var e;let s=null!==(e=n.get(t.userId))&&void 0!==e?e:Oc();bl(this.serializer,t).keys().forEach((t=>s=s.add(t))),n.set(t.userId,s)})),Xi.forEach(n,((t,n)=>{const i=new ii(n),o=kl.de(this.serializer,i),a=r.getIndexManager(i),c=hh.de(i,this.serializer,a,r.referenceDelegate);return new Fh(s,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Bo(e,co.ct),t).next()}))}))}}function Xh(t){t.createObjectStore("targetDocuments",{keyPath:So}).createIndex("documentTargetsIndex",_o,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",To,{unique:!0}),t.createObjectStore("targetGlobal")}const Yh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Jh{constructor(t,e,n,s,r,i,o,a,c,u,l=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.ii=r,this.window=i,this.document=o,this.ri=c,this.oi=u,this.ui=l,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=t=>Promise.resolve(),!Jh.D())throw new yi(pi.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new _h(this,s),this.di=e+"main",this.serializer=new ml(a),this.wi=new Ji(this.di,this.ui,new Wh(this.serializer)),this.Bs=new yh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Ah(this.serializer),this.qs=new xl,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===u&&li("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new yi(pi.FAILED_PRECONDITION,Yh);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Bs.getHighestSequenceNumber(t)))})).then((t=>{this.Os=new co(t,this.ri)})).then((()=>{this.Fs=!0})).catch((t=>(this.wi&&this.wi.close(),Promise.reject(t))))}Ii(t){return this.fi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.wi.B((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.ii.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>td(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Ti(t).next((t=>{t||(this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Ei(t))).next((e=>this.isPrimary&&!e?this.Ai(t).next((()=>!1)):!!e&&this.vi(t).next((()=>!0)))))).catch((t=>{if(eo(t))return ui("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return ui("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.ii.enqueueRetryable((()=>this.fi(t))),this.isPrimary=t}))}Ti(t){return Zh(t).get("owner").next((t=>Xi.resolve(this.Ri(t))))}Pi(t){return td(t).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Uo(t,"clientMetadata");return e.j().next((t=>{const n=this.Si(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return Xi.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this._i)for(const e of t)this._i.removeItem(this.Di(e.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.bi())).then((()=>this.pi()))))}Ri(t){return!!t&&t.ownerId===this.clientId}Ei(t){return this.oi?Xi.resolve(!0):Zh(t).get("owner").next((e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)){if(this.Ri(e)&&this.networkEnabled)return!0;if(!this.Ri(e)){if(!e.allowTabSynchronization)throw new yi(pi.FAILED_PRECONDITION,Yh);return!1}}return!(!this.networkEnabled||!this.inForeground)||td(t).j().next((t=>void 0===this.Si(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&ui("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new Bo(t,co.ct);return this.Ai(e).next((()=>this.Pi(e)))})),this.wi.close(),this.Mi()}Si(t,e){return t.filter((t=>this.Vi(t.updateTimeMs,e)&&!this.Ci(t.clientId)))}$i(){return this.runTransaction("getActiveClients","readonly",(t=>td(t).j().next((t=>this.Si(t,18e5).map((t=>t.clientId))))))}get started(){return this.Fs}getMutationQueue(t,e){return hh.de(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new eh(t,this.serializer.fe.databaseId)}getDocumentOverlayCache(t){return kl.de(this.serializer,t)}getBundleCache(){return this.qs}runTransaction(t,e,n){ui("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=15===(i=this.ui)?Vo:14===i?Fo:13===i?Po:12===i?Lo:11===i?Ro:void fi();var i;let o;return this.wi.runTransaction(t,s,r,(s=>(o=new Bo(s,this.Os?this.Os.next():co.ct),"readwrite-primary"===e?this.Ti(o).next((t=>!!t||this.Ei(o))).next((e=>{if(!e)throw li(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))),new yi(pi.FAILED_PRECONDITION,Hi);return n(o)})).next((t=>this.vi(o).next((()=>t)))):this.Oi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}Oi(t){return Zh(t).get("owner").next((t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)&&!this.Ri(t)&&!(this.oi||this.allowTabSynchronization&&t.allowTabSynchronization))throw new yi(pi.FAILED_PRECONDITION,Yh)}))}vi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Zh(t).put("owner",e)}static D(){return Ji.D()}Ai(t){const e=Zh(t);return e.get("owner").next((t=>this.Ri(t)?(ui("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):Xi.resolve()))}Vi(t,e){const n=Date.now();return!(t<n-e||t>n&&(li(`Detected an update time that is in the future: ${t} > ${n}`),1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;!function(){var t;const e=null===(t=a())||void 0===t?void 0:t.forceEnvironment;if("node"===e)return!0;if("browser"===e)return!1;try{return"[object process]"===Object.prototype.toString.call(n.g.process)}catch(t){return!1}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(t){var e;try{const n=null!==(null===(e=this._i)||void 0===e?void 0:e.getItem(this.Di(t)));return ui("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return li("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(t){li("Failed to set zombie client id.",t)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(t){}}Di(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Zh(t){return Uo(t,"owner")}function td(t){return Uo(t,"clientMetadata")}class ed{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Fi=n,this.Bi=s}static Li(t,e){let n=Oc(),s=Oc();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new ed(t,e.fromCache,n,s)}}class nd{constructor(){this.qi=!1}initialize(t,e){this.Ui=t,this.indexManager=e,this.qi=!0}getDocumentsMatchingQuery(t,e,n,s){return this.Ki(t,e).next((r=>r||this.Gi(t,e,s,n))).next((n=>n||this.Qi(t,e)))}Ki(t,e){if(dc(e))return Xi.resolve(null);let n=gc(e);return this.indexManager.getIndexType(t,n).next((s=>0===s?null:(null!==e.limit&&1===s&&(e=mc(e,null,"F"),n=gc(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((s=>{const r=Oc(...s);return this.Ui.getDocuments(t,r).next((s=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.ji(e,s);return this.zi(e,i,r,n.readTime)?this.Ki(t,mc(e,null,"F")):this.Wi(t,i,e,n)}))))})))))}Gi(t,e,n,s){return dc(e)||s.isEqual(Oi.min())?this.Qi(t,e):this.Ui.getDocuments(t,n).next((r=>{const i=this.ji(e,r);return this.zi(e,i,n,s)?this.Qi(t,e):(ci()<=T.DEBUG&&ui("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),vc(e)),this.Wi(t,i,e,function(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,r=Oi.fromTimestamp(1e9===s?new Mi(n+1,0):new Mi(n,s));return new $i(r,Vi.empty(),e)}(s,-1)))}))}ji(t,e){let n=new Ho(bc(t));return e.forEach(((e,s)=>{wc(t,s)&&(n=n.add(s))})),n}zi(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Qi(t,e){return ci()<=T.DEBUG&&ui("QueryEngine","Using full collection scan to execute query:",vc(e)),this.Ui.getDocumentsMatchingQuery(t,e,$i.min())}Wi(t,e,n,s){return this.Ui.getDocumentsMatchingQuery(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class sd{constructor(t,e,n,s){this.persistence=t,this.Hi=e,this.serializer=s,this.Ji=new Ko(Ai),this.Yi=new Ic((t=>rc(t)),ic),this.Xi=new Map,this.Zi=t.getRemoteDocumentCache(),this.Bs=t.getTargetCache(),this.qs=t.getBundleCache(),this.tr(n)}tr(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Fh(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Ji)))}}function rd(t,e,n,s){return new sd(t,e,n,s)}async function id(t,e){const n=mi(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.mutationQueue.getAllMutationBatches(t).next((r=>(s=r,n.tr(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=Oc();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({er:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function od(t){const e=mi(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Bs.getLastRemoteSnapshotVersion(t)))}function ad(t,e){const n=mi(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}async function cd(t,e,n){const s=mi(t),r=s.Ji.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!eo(t))throw t;ui("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.Ji=s.Ji.remove(e),s.Yi.delete(r.target)}function ud(t,e,n){const s=mi(t);let r=Oi.min(),i=Oc();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=mi(t),r=s.Yi.get(n);return void 0!==r?Xi.resolve(s.Ji.get(r)):s.Bs.getTargetData(e,n)}(s,t,gc(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.Bs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Hi.getDocumentsMatchingQuery(t,e,n?r:Oi.min(),n?i:Oc()))).next((t=>(function(t,e,n){let s=t.Xi.get(e)||Oi.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.Xi.set(e,s)}(s,function(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}(e),t),{documents:t,ir:i})))))}class ld{constructor(){this.activeTargetIds=Rc}lr(t){this.activeTargetIds=this.activeTargetIds.add(t)}dr(t){this.activeTargetIds=this.activeTargetIds.delete(t)}hr(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class hd{constructor(){this.Hr=new ld,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Hr.lr(t),this.Jr[t]||"not-current"}updateQueryState(t,e,n){this.Jr[t]=e}removeLocalQueryTarget(t){this.Hr.dr(t)}isLocalQueryTarget(t){return this.Hr.activeTargetIds.has(t)}clearQueryState(t){delete this.Jr[t]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(t){return this.Hr.activeTargetIds.has(t)}start(){return this.Hr=new ld,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class dd{Yr(t){}shutdown(){}}class fd{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(t){this.so.push(t)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){ui("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.so)t(0)}no(){ui("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.so)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let gd=null;function md(){return null===gd?gd=268435456+Math.round(2147483648*Math.random()):gd++,"0x"+gd.toString(16)}const pd={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class yd{constructor(t){this.ro=t.ro,this.oo=t.oo}uo(t){this.co=t}ao(t){this.ho=t}onMessage(t){this.lo=t}close(){this.oo()}send(t){this.ro(t)}fo(){this.co()}wo(t){this.ho(t)}_o(t){this.lo(t)}}const vd="WebChannelConnection";class wd extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.mo=e+"://"+t.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(t,e,n,s,r){const i=md(),o=this.To(t,e);ui("RestConnection",`Sending RPC '${t}' ${i}:`,o,n);const a={};return this.Eo(a,s,r),this.Ao(t,o,a,n).then((e=>(ui("RestConnection",`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw hi("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}vo(t,e,n,s,r,i){return this.Io(t,e,n,s,r)}Eo(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+oi,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}To(t,e){const n=pd[t];return`${this.mo}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Ao(t,e,n,s){const r=md();return new Promise(((i,o)=>{const a=new ei;a.setWithCredentials(!0),a.listenOnce(Xr.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case Wr.NO_ERROR:const e=a.getResponseJson();ui(vd,`XHR for RPC '${t}' ${r} received:`,JSON.stringify(e)),i(e);break;case Wr.TIMEOUT:ui(vd,`RPC '${t}' ${r} timed out`),o(new yi(pi.DEADLINE_EXCEEDED,"Request time out"));break;case Wr.HTTP_ERROR:const n=a.getStatus();if(ui(vd,`RPC '${t}' ${r} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(pi).indexOf(e)>=0?e:pi.UNKNOWN}(e.status);o(new yi(t,e.message))}else o(new yi(pi.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new yi(pi.UNAVAILABLE,"Connection failed."));break;default:fi()}}finally{ui(vd,`RPC '${t}' ${r} completed.`)}}));const c=JSON.stringify(s);ui(vd,`RPC '${t}' ${r} sending request:`,s),a.send(e,"POST",c,n,15)}))}Ro(t,e,n){const s=md(),r=[this.mo,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=Hr(),o=Qr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.xmlHttpFactory=new Zr({})),this.Eo(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const u=r.join("");ui(vd,`Creating RPC '${t}' stream ${s}: ${u}`,a);const l=i.createWebChannel(u,a);let h=!1,d=!1;const f=new yd({ro:e=>{d?ui(vd,`Not sending because RPC '${t}' stream ${s} is closed:`,e):(h||(ui(vd,`Opening RPC '${t}' stream ${s} transport.`),l.open(),h=!0),ui(vd,`RPC '${t}' stream ${s} sending:`,e),l.send(e))},oo:()=>l.close()}),g=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return g(l,ti.EventType.OPEN,(()=>{d||ui(vd,`RPC '${t}' stream ${s} transport opened.`)})),g(l,ti.EventType.CLOSE,(()=>{d||(d=!0,ui(vd,`RPC '${t}' stream ${s} transport closed`),f.wo())})),g(l,ti.EventType.ERROR,(e=>{d||(d=!0,hi(vd,`RPC '${t}' stream ${s} transport errored:`,e),f.wo(new yi(pi.UNAVAILABLE,"The operation could not be completed")))})),g(l,ti.EventType.MESSAGE,(e=>{var n;if(!d){const r=e.data[0];gi(!!r);const i=r,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){ui(vd,`RPC '${t}' stream ${s} received error:`,o);const e=o.status;let n=function(t){const e=yu[t];if(void 0!==e)return wu(e)}(e),r=o.message;void 0===n&&(n=pi.INTERNAL,r="Unknown error status: "+e+" with message "+o.message),d=!0,f.wo(new yi(n,r)),l.close()}else ui(vd,`RPC '${t}' stream ${s} received:`,r),f._o(r)}})),g(o,Yr.STAT_EVENT,(e=>{e.stat===Jr.PROXY?ui(vd,`RPC '${t}' stream ${s} detected buffering proxy`):e.stat===Jr.NOPROXY&&ui(vd,`RPC '${t}' stream ${s} detected no buffering proxy`)})),setTimeout((()=>{f.fo()}),0),f}}function bd(){return"undefined"!=typeof document?document:null}function Ed(t){return new Bu(t,!0)}class Id{constructor(t,e,n=1e3,s=1.5,r=6e4){this.ii=t,this.timerId=e,this.Po=n,this.bo=s,this.Vo=r,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(t){this.cancel();const e=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),s=Math.max(0,e-n);s>0&&ui("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.So} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,s,(()=>(this.Co=Date.now(),t()))),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class Td{constructor(t,e,n,s,r,i,o,a){this.ii=t,this.$o=n,this.Oo=s,this.connection=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new Id(t,e)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,(()=>this.zo())))}Wo(t){this.Ho(),this.stream.send(t)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(t,e){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==t?this.qo.reset():e&&e.code===pi.RESOURCE_EXHAUSTED?(li(e.toString()),li("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):e&&e.code===pi.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.ao(e)}Yo(){}auth(){this.state=1;const t=this.Xo(this.Fo),e=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Fo===e&&this.Zo(t,n)}),(e=>{t((()=>{const t=new yi(pi.UNKNOWN,"Fetching auth token failed: "+e.message);return this.tu(t)}))}))}Zo(t,e){const n=this.Xo(this.Fo);this.stream=this.eu(t,e),this.stream.uo((()=>{n((()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,(()=>(this.Ko()&&(this.state=3),Promise.resolve()))),this.listener.uo())))})),this.stream.ao((t=>{n((()=>this.tu(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Go(){this.state=5,this.qo.No((async()=>{this.state=0,this.start()}))}tu(t){return ui("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Xo(t){return e=>{this.ii.enqueueAndForget((()=>this.Fo===t?e():(ui("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Sd extends Td{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.serializer=r}eu(t,e){return this.connection.Ro("Listen",t,e)}onMessage(t){this.qo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:fi()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(gi(void 0===e||"string"==typeof e),Jo.fromBase64String(e||"")):(gi(void 0===e||e instanceof Uint8Array),Jo.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?pi.UNKNOWN:wu(t.code);return new yi(e,t.message||"")}(o);n=new Nu(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Qu(t,s.document.name),i=Ku(s.document.updateTime),o=s.document.createTime?Ku(s.document.createTime):Oi.min(),a=new Aa({mapValue:{fields:s.document.fields}}),c=Na.newFoundDocument(r,i,o,a),u=s.targetIds||[],l=s.removedTargetIds||[];n=new Au(u,l,c.key,c)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Qu(t,s.document),i=s.readTime?Ku(s.readTime):Oi.min(),o=Na.newNoDocument(r,i),a=s.removedTargetIds||[];n=new Au([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Qu(t,s.document),i=s.removedTargetIds||[];n=new Au([],i,r,null)}else{if(!("filter"in e))return fi();{e.filter;const t=e.filter;t.targetId;const{count:s=0,unchangedNames:r}=t,i=new pu(s,r),o=t.targetId;n=new ku(o,i)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return Oi.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Oi.min():e.readTime?Ku(e.readTime):Oi.min()}(t);return this.listener.nu(e,n)}su(t){const e={};e.database=Yu(this.serializer),e.addTarget=function(t,e){let n;const s=e.target;if(n=oc(s)?{documents:nl(t,s)}:{query:sl(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=qu(t,e.resumeToken);const s=Uu(t,e.expectedCount);null!==s&&(n.expectedCount=s)}else if(e.snapshotVersion.compareTo(Oi.min())>0){n.readTime=ju(t,e.snapshotVersion.toTimestamp());const s=Uu(t,e.expectedCount);null!==s&&(n.expectedCount=s)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return fi()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.Wo(e)}iu(t){const e={};e.database=Yu(this.serializer),e.removeTarget=t,this.Wo(e)}}class _d extends Td{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.serializer=r,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(t,e){return this.connection.Ro("Write",t,e)}onMessage(t){if(gi(!!t.streamToken),this.lastStreamToken=t.streamToken,this.ru){this.qo.reset();const e=function(t,e){return t&&t.length>0?(gi(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Ku(t.updateTime):Ku(e);return n.isEqual(Oi.min())&&(n=Ku(e)),new Yc(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Ku(t.commitTime);return this.listener.cu(n,e)}return gi(!t.writeResults||0===t.writeResults.length),this.ru=!0,this.listener.au()}hu(){const t={};t.database=Yu(this.serializer),this.Wo(t)}uu(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>tl(this.serializer,t)))};this.Wo(e)}}class Dd extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=s,this.lu=!1}fu(){if(this.lu)throw new yi(pi.FAILED_PRECONDITION,"The client has already been terminated.")}Io(t,e,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.connection.Io(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new yi(pi.UNKNOWN,t.toString())}))}vo(t,e,n,s){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.connection.vo(t,e,n,r,i,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new yi(pi.UNKNOWN,t.toString())}))}terminate(){this.lu=!0}}class xd{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve()))))}Iu(t){"Online"===this.state?this.yu("Unknown"):(this.wu++,this.wu>=1&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.yu("Offline")))}set(t){this.Tu(),this.wu=0,"Online"===t&&(this.mu=!1),this.yu(t)}yu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}pu(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(li(e),this.mu=!1):ui("OnlineStateTracker",e)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class Cd{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=r,this.Pu.Yr((t=>{n.enqueueAndForget((async()=>{Fd(this)&&(ui("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=mi(t);e.vu.add(4),await kd(e),e.bu.set("Unknown"),e.vu.delete(4),await Ad(e)}(this))}))})),this.bu=new xd(n,s)}}async function Ad(t){if(Fd(t))for(const e of t.Ru)await e(!0)}async function kd(t){for(const e of t.Ru)await e(!1)}function Nd(t,e){const n=mi(t);n.Au.has(e.targetId)||(n.Au.set(e.targetId,e),Pd(n)?Ld(n):tf(n).Ko()&&Od(n,e))}function Md(t,e){const n=mi(t),s=tf(n);n.Au.delete(e),s.Ko()&&Rd(n,e),0===n.Au.size&&(s.Ko()?s.jo():Fd(n)&&n.bu.set("Unknown"))}function Od(t,e){if(t.Vu.qt(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(Oi.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}tf(t).su(e)}function Rd(t,e){t.Vu.qt(e),tf(t).iu(e)}function Ld(t){t.Vu=new Ou({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),le:e=>t.Au.get(e)||null,ue:()=>t.datastore.serializer.databaseId}),tf(t).start(),t.bu.gu()}function Pd(t){return Fd(t)&&!tf(t).Uo()&&t.Au.size>0}function Fd(t){return 0===mi(t).vu.size}function Vd(t){t.Vu=void 0}async function Bd(t){t.Au.forEach(((e,n)=>{Od(t,e)}))}async function Ud(t,e){Vd(t),Pd(t)?(t.bu.Iu(e),Ld(t)):t.bu.set("Unknown")}async function jd(t,e,n){if(t.bu.set("Online"),e instanceof Nu&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.Au.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.Au.delete(s),t.Vu.removeTarget(s))}(t,e)}catch(n){ui("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await qd(t,n)}else if(e instanceof Au?t.Vu.Ht(e):e instanceof ku?t.Vu.ne(e):t.Vu.Xt(e),!n.isEqual(Oi.min()))try{const e=await od(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Vu.ce(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.Au.get(s);r&&t.Au.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const s=t.Au.get(e);if(!s)return;t.Au.set(e,s.withResumeToken(Jo.EMPTY_BYTE_STRING,s.snapshotVersion)),Rd(t,e);const r=new gl(s.target,e,n,s.sequenceNumber);Od(t,r)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){ui("RemoteStore","Failed to raise snapshot:",e),await qd(t,e)}}async function qd(t,e,n){if(!eo(e))throw e;t.vu.add(1),await kd(t),t.bu.set("Offline"),n||(n=()=>od(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{ui("RemoteStore","Retrying IndexedDB access"),await n(),t.vu.delete(1),await Ad(t)}))}function zd(t,e){return e().catch((n=>qd(t,n,e)))}async function Kd(t){const e=mi(t),n=ef(e);let s=e.Eu.length>0?e.Eu[e.Eu.length-1].batchId:-1;for(;$d(e);)try{const t=await ad(e.localStore,s);if(null===t){0===e.Eu.length&&n.jo();break}s=t.batchId,Gd(e,t)}catch(t){await qd(e,t)}Hd(e)&&Qd(e)}function $d(t){return Fd(t)&&t.Eu.length<10}function Gd(t,e){t.Eu.push(e);const n=ef(t);n.Ko()&&n.ou&&n.uu(e.mutations)}function Hd(t){return Fd(t)&&!ef(t).Uo()&&t.Eu.length>0}function Qd(t){ef(t).start()}async function Wd(t){ef(t).hu()}async function Xd(t){const e=ef(t);for(const n of t.Eu)e.uu(n.mutations)}async function Yd(t,e,n){const s=t.Eu.shift(),r=gu.from(s,e,n);await zd(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await Kd(t)}async function Jd(t,e){e&&ef(t).ou&&await async function(t,e){if(function(t){switch(t){default:return fi();case pi.CANCELLED:case pi.UNKNOWN:case pi.DEADLINE_EXCEEDED:case pi.RESOURCE_EXHAUSTED:case pi.INTERNAL:case pi.UNAVAILABLE:case pi.UNAUTHENTICATED:return!1;case pi.INVALID_ARGUMENT:case pi.NOT_FOUND:case pi.ALREADY_EXISTS:case pi.PERMISSION_DENIED:case pi.FAILED_PRECONDITION:case pi.ABORTED:case pi.OUT_OF_RANGE:case pi.UNIMPLEMENTED:case pi.DATA_LOSS:return!0}}(n=e.code)&&n!==pi.ABORTED){const n=t.Eu.shift();ef(t).Qo(),await zd(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Kd(t)}var n}(t,e),Hd(t)&&Qd(t)}async function Zd(t,e){const n=mi(t);n.asyncQueue.verifyOperationInProgress(),ui("RemoteStore","RemoteStore received new credentials");const s=Fd(n);n.vu.add(3),await kd(n),s&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.vu.delete(3),await Ad(n)}function tf(t){return t.Su||(t.Su=function(t,e,n){const s=mi(t);return s.fu(),new Sd(e,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(t.datastore,t.asyncQueue,{uo:Bd.bind(null,t),ao:Ud.bind(null,t),nu:jd.bind(null,t)}),t.Ru.push((async e=>{e?(t.Su.Qo(),Pd(t)?Ld(t):t.bu.set("Unknown")):(await t.Su.stop(),Vd(t))}))),t.Su}function ef(t){return t.Du||(t.Du=function(t,e,n){const s=mi(t);return s.fu(),new _d(e,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(t.datastore,t.asyncQueue,{uo:Wd.bind(null,t),ao:Jd.bind(null,t),au:Xd.bind(null,t),cu:Yd.bind(null,t)}),t.Ru.push((async e=>{e?(t.Du.Qo(),await Kd(t)):(await t.Du.stop(),t.Eu.length>0&&(ui("RemoteStore",`Stopping write stream with ${t.Eu.length} pending writes`),t.Eu=[]))}))),t.Du}class nf{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new vi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new nf(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new yi(pi.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function sf(t,e){if(li("AsyncQueue",`${e}: ${t}`),eo(t))return new yi(pi.UNAVAILABLE,`${e}: ${t}`);throw t}class rf{constructor(t){this.comparator=t?(e,n)=>t(e,n)||Vi.comparator(e.key,n.key):(t,e)=>Vi.comparator(t.key,e.key),this.keyedMap=Dc(),this.sortedSet=new Ko(this.comparator)}static emptySet(t){return new rf(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof rf))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new rf;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class of{constructor(){this.Cu=new Ko(Vi.comparator)}track(t){const e=t.doc.key,n=this.Cu.get(e);n?0!==t.type&&3===n.type?this.Cu=this.Cu.insert(e,t):3===t.type&&1!==n.type?this.Cu=this.Cu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Cu=this.Cu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Cu=this.Cu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Cu=this.Cu.remove(e):1===t.type&&2===n.type?this.Cu=this.Cu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Cu=this.Cu.insert(e,{type:2,doc:t.doc}):fi():this.Cu=this.Cu.insert(e,t)}xu(){const t=[];return this.Cu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class af{constructor(t,e,n,s,r,i,o,a,c){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(t,e,n,s,r){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new af(t,e,rf.emptySet(e),i,n,s,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&pc(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class cf{constructor(){this.Nu=void 0,this.listeners=[]}}class uf{constructor(){this.queries=new Ic((t=>yc(t)),pc),this.onlineState="Unknown",this.ku=new Set}}function lf(t,e){const n=mi(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.$u(t)&&(s=!0);r.Nu=t}}s&&df(n)}function hf(t,e,n){const s=mi(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function df(t){t.ku.forEach((t=>{t.next()}))}class ff{constructor(t,e,n){this.query=t,this.Ou=e,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new af(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.Fu?this.Lu(t)&&(this.Ou.next(t),e=!0):this.qu(t,this.onlineState)&&(this.Uu(t),e=!0),this.Bu=t,e}onError(t){this.Ou.error(t)}Mu(t){this.onlineState=t;let e=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,t)&&(this.Uu(this.Bu),e=!0),e}qu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.Ku||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}Lu(t){if(t.docChanges.length>0)return!0;const e=this.Bu&&this.Bu.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Uu(t){t=af.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.Fu=!0,this.Ou.next(t)}}class gf{constructor(t){this.key=t}}class mf{constructor(t){this.key=t}}class pf{constructor(t,e){this.query=t,this.Yu=e,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=Oc(),this.mutatedKeys=Oc(),this.tc=bc(t),this.ec=new rf(this.tc)}get nc(){return this.Yu}sc(t,e){const n=e?e.ic:new of,s=e?e.ec:this.ec;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,c="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const u=s.get(t),l=wc(this.query,e)?e:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.rc(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.tc(l,a)>0||c&&this.tc(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{ec:i,ic:n,zi:o,mutatedKeys:r}}rc(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.ec;this.ec=t.ec,this.mutatedKeys=t.mutatedKeys;const r=t.ic.xu();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return fi()}};return n(t)-n(e)}(t.type,e.type)||this.tc(t.doc,e.doc))),this.oc(n);const i=e?this.uc():[],o=0===this.Zu.size&&this.current?1:0,a=o!==this.Xu;return this.Xu=o,0!==r.length||a?{snapshot:new af(this.query,t.ec,s,r,t.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),cc:i}:{cc:i}}Mu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({ec:this.ec,ic:new of,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(t){return!this.Yu.has(t)&&!!this.ec.has(t)&&!this.ec.get(t).hasLocalMutations}oc(t){t&&(t.addedDocuments.forEach((t=>this.Yu=this.Yu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Yu=this.Yu.delete(t))),this.current=t.current)}uc(){if(!this.current)return[];const t=this.Zu;this.Zu=Oc(),this.ec.forEach((t=>{this.ac(t.key)&&(this.Zu=this.Zu.add(t.key))}));const e=[];return t.forEach((t=>{this.Zu.has(t)||e.push(new mf(t))})),this.Zu.forEach((n=>{t.has(n)||e.push(new gf(n))})),e}hc(t){this.Yu=t.ir,this.Zu=Oc();const e=this.sc(t.documents);return this.applyChanges(e,!0)}lc(){return af.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class yf{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class vf{constructor(t){this.key=t,this.fc=!1}}class wf{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.dc={},this.wc=new Ic((t=>yc(t)),pc),this._c=new Map,this.mc=new Set,this.gc=new Ko(Vi.comparator),this.yc=new Map,this.Ic=new Uh,this.Tc={},this.Ec=new Map,this.Ac=ph.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function bf(t,e){const n=function(t){const e=mi(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=If.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Pf.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Sf.bind(null,e),e.dc.nu=lf.bind(null,e.eventManager),e.dc.Pc=hf.bind(null,e.eventManager),e}(t);let s,r;const i=n.wc.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.lc();else{const t=await function(t,e){const n=mi(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Bs.getTargetData(t,e).next((r=>r?(s=r,Xi.resolve(s)):n.Bs.allocateTargetId(t).next((r=>(s=new gl(e,r,"TargetPurposeListen",t.currentSequenceNumber),n.Bs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.Ji.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ji=n.Ji.insert(t.targetId,t),n.Yi.set(e,t.targetId)),t}))}(n.localStore,gc(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await async function(t,e,n,s,r){t.Rc=(e,n,s)=>async function(t,e,n,s){let r=e.view.sc(n);r.zi&&(r=await ud(t.localStore,e.query,!1).then((({documents:t})=>e.view.sc(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return Nf(t,e.targetId,o.cc),o.snapshot}(t,e,n,s);const i=await ud(t.localStore,e,!0),o=new pf(e,i.ir),a=o.sc(i.documents),c=Cu.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState,r),u=o.applyChanges(a,t.isPrimaryClient,c);Nf(t,n,u.cc);const l=new yf(e,n,o);return t.wc.set(e,l),t._c.has(n)?t._c.get(n).push(e):t._c.set(n,[e]),u.snapshot}(n,e,s,"current"===i,t.resumeToken),n.isPrimaryClient&&Nd(n.remoteStore,t)}return r}async function Ef(t,e){const n=mi(t),s=n.wc.get(e),r=n._c.get(s.targetId);if(r.length>1)return n._c.set(s.targetId,r.filter((t=>!pc(t,e)))),void n.wc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await cd(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Md(n.remoteStore,s.targetId),Af(n,s.targetId)})).catch(Wi)):(Af(n,s.targetId),await cd(n.localStore,s.targetId,!0))}async function If(t,e){const n=mi(t);try{const t=await function(t,e){const n=mi(t),s=e.snapshotVersion;let r=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Zi.newChangeBuffer({trackRemovals:!0});r=n.Ji;const o=[];e.targetChanges.forEach(((i,a)=>{const c=r.get(a);if(!c)return;o.push(n.Bs.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Bs.addMatchingKeys(t,i.addedDocuments,a))));let u=c.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(a)?u=u.withResumeToken(Jo.EMPTY_BYTE_STRING,Oi.min()).withLastLimboFreeSnapshotVersion(Oi.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,s)),r=r.insert(a,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Bs.updateTargetData(t,u))}));let a=Sc(),c=Oc();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(function(t,e,n){let s=Oc(),r=Oc();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=Sc();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(Oi.min())?(e.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),s=s.insert(n,i)):ui("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{nr:s,sr:r}}))}(t,i,e.documentUpdates).next((t=>{a=t.nr,c=t.sr}))),!s.isEqual(Oi.min())){const e=n.Bs.getLastRemoteSnapshotVersion(t).next((e=>n.Bs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return Xi.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,c))).next((()=>a))})).then((t=>(n.Ji=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.yc.get(e);s&&(gi(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.fc=!0:t.modifiedDocuments.size>0?gi(s.fc):t.removedDocuments.size>0&&(gi(s.fc),s.fc=!1))})),await Rf(n,t,e)}catch(t){await Wi(t)}}function Tf(t,e,n){const s=mi(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.wc.forEach(((n,s)=>{const r=s.view.Mu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=mi(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.Mu(e)&&(s=!0)})),s&&df(n)}(s.eventManager,e),t.length&&s.dc.nu(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function Sf(t,e,n){const s=mi(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.yc.get(e),i=r&&r.key;if(i){let t=new Ko(Vi.comparator);t=t.insert(i,Na.newNoDocument(i,Oi.min()));const n=Oc().add(i),r=new xu(Oi.min(),new Map,new Ko(Ai),t,n);await If(s,r),s.gc=s.gc.remove(i),s.yc.delete(e),Of(s)}else await cd(s.localStore,e,!1).then((()=>Af(s,e,n))).catch(Wi)}async function _f(t,e){const n=mi(t),s=e.batch.batchId;try{const t=await function(t,e){const n=mi(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Zi.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=Xi.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);gi(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=Oc();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(n.localStore,e);Cf(n,s,null),xf(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Rf(n,t)}catch(t){await Wi(t)}}async function Df(t,e,n){const s=mi(t);try{const t=await function(t,e){const n=mi(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(gi(null!==e),s=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,s))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(s.localStore,e);Cf(s,e,n),xf(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await Rf(s,t)}catch(n){await Wi(n)}}function xf(t,e){(t.Ec.get(e)||[]).forEach((t=>{t.resolve()})),t.Ec.delete(e)}function Cf(t,e,n){const s=mi(t);let r=s.Tc[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.Tc[s.currentUser.toKey()]=r}}function Af(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t._c.get(e))t.wc.delete(s),n&&t.dc.Pc(s,n);t._c.delete(e),t.isPrimaryClient&&t.Ic.Is(e).forEach((e=>{t.Ic.containsKey(e)||kf(t,e)}))}function kf(t,e){t.mc.delete(e.path.canonicalString());const n=t.gc.get(e);null!==n&&(Md(t.remoteStore,n),t.gc=t.gc.remove(e),t.yc.delete(n),Of(t))}function Nf(t,e,n){for(const s of n)s instanceof gf?(t.Ic.addReference(s.key,e),Mf(t,s)):s instanceof mf?(ui("SyncEngine","Document no longer in limbo: "+s.key),t.Ic.removeReference(s.key,e),t.Ic.containsKey(s.key)||kf(t,s.key)):fi()}function Mf(t,e){const n=e.key,s=n.path.canonicalString();t.gc.get(n)||t.mc.has(s)||(ui("SyncEngine","New document in limbo: "+n),t.mc.add(s),Of(t))}function Of(t){for(;t.mc.size>0&&t.gc.size<t.maxConcurrentLimboResolutions;){const e=t.mc.values().next().value;t.mc.delete(e);const n=new Vi(Li.fromString(e)),s=t.Ac.next();t.yc.set(s,new vf(n)),t.gc=t.gc.insert(n,s),Nd(t.remoteStore,new gl(gc(hc(n.path)),s,"TargetPurposeLimboResolution",co.ct))}}async function Rf(t,e,n){const s=mi(t),r=[],i=[],o=[];s.wc.isEmpty()||(s.wc.forEach(((t,a)=>{o.push(s.Rc(a,e,n).then((t=>{if((t||n)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){r.push(t);const e=ed.Li(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.dc.nu(r),await async function(t,e){const n=mi(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Xi.forEach(e,(e=>Xi.forEach(e.Fi,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>Xi.forEach(e.Bi,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!eo(t))throw t;ui("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Ji.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.Ji=n.Ji.insert(e,r)}}}(s.localStore,i))}async function Lf(t,e){const n=mi(t);if(!n.currentUser.isEqual(e)){ui("SyncEngine","User change. New user:",e.toKey());const t=await id(n.localStore,e);n.currentUser=e,function(t){t.Ec.forEach((t=>{t.forEach((t=>{t.reject(new yi(pi.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.Ec.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Rf(n,t.er)}}function Pf(t,e){const n=mi(t),s=n.yc.get(e);if(s&&s.fc)return Oc().add(s.key);{let t=Oc();const s=n._c.get(e);if(!s)return t;for(const e of s){const s=n.wc.get(e);t=t.unionWith(s.view.nc)}return t}}function Ff(t){const e=mi(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=_f.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Df.bind(null,e),e}class Vf{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=Ed(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return rd(this.persistence,new nd,t.initialUser,this.serializer)}createPersistence(t){return new Gh(Qh.zs,this.serializer)}createSharedClientState(t){return new hd}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Bf extends Vf{constructor(t,e,n){super(),this.Vc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Vc.initialize(this,t),await Ff(this.Vc.syncEngine),await Kd(this.Vc.remoteStore),await this.persistence.Ii((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return rd(this.persistence,new nd,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Th(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new ao(e,this.persistence);return new oo(t.asyncQueue,n)}createPersistence(t){const e=function(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ch.withCacheSize(this.cacheSizeBytes):ch.DEFAULT;return new Jh(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,"undefined"!=typeof window?window:null,bd(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new hd}}class Uf{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Tf(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Lf.bind(null,this.syncEngine),await async function(t,e){const n=mi(t);e?(n.vu.delete(2),await Ad(n)):e||(n.vu.add(2),await kd(n),n.bu.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new uf}createDatastore(t){const e=Ed(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new wd(s));var s;return function(t,e,n,s){return new Dd(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>Tf(this.syncEngine,t,0),i=fd.D()?new fd:new dd,new Cd(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new wf(t,e,n,s,r,i);return o&&(a.vc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=mi(t);ui("RemoteStore","RemoteStore shutting down."),e.vu.add(5),await kd(e),e.Pu.shutdown(),e.bu.set("Unknown")}(this.remoteStore)}}class jf{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Sc(this.observer.next,t)}error(t){this.observer.error?this.Sc(this.observer.error,t):li("Uncaught Error in snapshot listener:",t.toString())}Dc(){this.muted=!0}Sc(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class qf{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=ii.UNAUTHENTICATED,this.clientId=Ci.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{ui("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(ui("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new yi(pi.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new vi;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=sf(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function zf(t,e){t.asyncQueue.verifyOperationInProgress(),ui("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await id(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function Kf(t,e){t.asyncQueue.verifyOperationInProgress();const n=await async function(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){ui("FirestoreClient","Using user provided OfflineComponentProvider");try{await zf(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!$f(n))throw n;hi("Error using user provided cache. Falling back to memory cache: "+n),await zf(t,new Vf)}}else ui("FirestoreClient","Using default OfflineComponentProvider"),await zf(t,new Vf);return t._offlineComponents}(t);ui("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>Zd(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Zd(e.remoteStore,n))),t._onlineComponents=e}function $f(t){return"FirebaseError"===t.name?t.code===pi.FAILED_PRECONDITION||t.code===pi.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function Gf(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(ui("FirestoreClient","Using user provided OnlineComponentProvider"),await Kf(t,t._uninitializedComponentsProvider._online)):(ui("FirestoreClient","Using default OnlineComponentProvider"),await Kf(t,new Uf))),t._onlineComponents}async function Hf(t){const e=await Gf(t),n=e.eventManager;return n.onListen=bf.bind(null,e.syncEngine),n.onUnlisten=Ef.bind(null,e.syncEngine),n}function Qf(t,e,n={}){const s=new vi;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new jf({next:n=>{e.enqueueAndForget((()=>async function(t,e){const n=mi(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}(t,o))),n.fromCache&&"server"===s.source?r.reject(new yi(pi.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new ff(n,i,{includeMetadataChanges:!0,Ku:!0});return async function(t,e){const n=mi(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new cf),r)try{i.Nu=await n.onListen(s)}catch(t){const n=sf(t,`Initialization of query '${vc(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.Mu(n.onlineState),i.Nu&&e.$u(i.Nu)&&df(n)}(t,o)}(await Hf(t),t.asyncQueue,e,n,s))),s.promise}function Wf(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const Xf=new Map;function Yf(t,e,n){if(!n)throw new yi(pi.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Jf(t){if(!Vi.isDocumentKey(t))throw new yi(pi.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Zf(t){if(Vi.isDocumentKey(t))throw new yi(pi.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function tg(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":fi()}function eg(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new yi(pi.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=tg(t);throw new yi(pi.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}class ng{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new yi(pi.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.cache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new yi(pi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}(function(t,e,n,s){if(!0===e&&!0===s)throw new yi(pi.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")})(0,t.experimentalForceLongPolling,0,t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Wf(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new yi(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&(e=this.experimentalLongPollingOptions,n=t.experimentalLongPollingOptions,e.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams;var e,n}}class sg{constructor(t,e,n,s){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ng({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new yi(pi.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new yi(pi.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ng(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new bi;switch(t.type){case"firstParty":return new Si(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new yi(pi.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Xf.get(t);e&&(ui("ComponentProvider","Removing Datastore"),Xf.delete(t),e.terminate())}(this),Promise.resolve()}}class rg{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new og(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new rg(this.firestore,t,this._key)}}class ig{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new ig(this.firestore,t,this._query)}}class og extends ig{constructor(t,e,n){super(t,e,hc(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new rg(this.firestore,null,new Vi(t))}withConverter(t){return new og(this.firestore,t,this._path)}}function ag(t,e,...n){if(t=y(t),Yf("collection","path",e),t instanceof sg){const s=Li.fromString(e,...n);return Zf(s),new og(t,null,s)}{if(!(t instanceof rg||t instanceof og))throw new yi(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(Li.fromString(e,...n));return Zf(s),new og(t.firestore,null,s)}}function cg(t,e,...n){if(t=y(t),1===arguments.length&&(e=Ci.A()),Yf("doc","path",e),t instanceof sg){const s=Li.fromString(e,...n);return Jf(s),new rg(t,null,new Vi(s))}{if(!(t instanceof rg||t instanceof og))throw new yi(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(Li.fromString(e,...n));return Jf(s),new rg(t.firestore,t instanceof og?t.converter:null,new Vi(s))}}class ug{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new Id(this,"async_queue_retry"),this.Xc=()=>{const t=bd();t&&ui("AsyncQueue","Visibility state changed to "+t.visibilityState),this.qo.Mo()};const t=bd();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Zc(),this.ta(t)}enterRestrictedMode(t){if(!this.jc){this.jc=!0,this.Jc=t||!1;const e=bd();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Xc)}}enqueue(t){if(this.Zc(),this.jc)return new Promise((()=>{}));const e=new vi;return this.ta((()=>this.jc&&this.Jc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Qc.push(t),this.ea())))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(t){if(!eo(t))throw t;ui("AsyncQueue","Operation failed with retryable error: "+t)}this.Qc.length>0&&this.qo.No((()=>this.ea()))}}ta(t){const e=this.Gc.then((()=>(this.Hc=!0,t().catch((t=>{this.Wc=t,this.Hc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw li("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Hc=!1,t))))));return this.Gc=e,e}enqueueAfterDelay(t,e,n){this.Zc(),this.Yc.indexOf(t)>-1&&(e=0);const s=nf.createAndSchedule(this,t,e,n,(t=>this.na(t)));return this.zc.push(s),s}Zc(){this.Wc&&fi()}verifyOperationInProgress(){}async sa(){let t;do{t=this.Gc,await t}while(t!==this.Gc)}ia(t){for(const e of this.zc)if(e.timerId===t)return!0;return!1}ra(t){return this.sa().then((()=>{this.zc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.zc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.sa()}))}oa(t){this.Yc.push(t)}na(t){const e=this.zc.indexOf(t);this.zc.splice(e,1)}}class lg extends sg{constructor(t,e,n,s){super(t,e,n,s),this.type="firestore",this._queue=new ug,this._persistenceKey=(null==s?void 0:s.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||dg(this),this._firestoreClient.terminate()}}function hg(t){return t._firestoreClient||dg(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function dg(t){var e,n,s;const r=t._freezeSettings(),i=function(t,e,n,s){return new oa(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,Wf(s.experimentalLongPollingOptions),s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,r);t._firestoreClient=new qf(t._authCredentials,t._appCheckCredentials,t._queue,i),(null===(n=r.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(s=r.cache)||void 0===s?void 0:s._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:r.cache.kind,_offline:r.cache._offlineComponentProvider,_online:r.cache._onlineComponentProvider})}class fg{constructor(t){this._byteString=t}static fromBase64String(t){try{return new fg(Jo.fromBase64String(t))}catch(t){throw new yi(pi.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new fg(Jo.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class gg{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new yi(pi.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Fi(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class mg{constructor(t){this._methodName=t}}class pg{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new yi(pi.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new yi(pi.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Ai(this._lat,t._lat)||Ai(this._long,t._long)}}const yg=/^__.*__$/;class vg{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new au(t,this.data,this.fieldMask,e,this.fieldTransforms):new ou(t,this.data,e,this.fieldTransforms)}}function wg(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw fi()}}class bg{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=s,void 0===r&&this.ua(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(t){return new bg(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.aa({path:n,la:!1});return s.fa(t),s}da(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.aa({path:n,la:!1});return s.ua(),s}wa(t){return this.aa({path:void 0,la:!0})}_a(t){return Ng(t,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}ua(){if(this.path)for(let t=0;t<this.path.length;t++)this.fa(this.path.get(t))}fa(t){if(0===t.length)throw this._a("Document fields must not be empty");if(wg(this.ca)&&yg.test(t))throw this._a('Document fields cannot begin and end with "__"')}}class Eg{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||Ed(t)}ya(t,e,n,s=!1){return new bg({ca:t,methodName:e,ga:n,path:Fi.emptyPath(),la:!1,ma:s},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Ig(t){const e=t._freezeSettings(),n=Ed(t._databaseId);return new Eg(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Tg(t,e,n,s,r,i={}){const o=t.ya(i.merge||i.mergeFields?2:0,e,n,r);xg("Data must be an object, but it was:",o,s);const a=_g(s,o);let c,u;if(i.merge)c=new Xo(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=Cg(e,s,n);if(!o.contains(r))throw new yi(pi.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Mg(t,r)||t.push(r)}c=new Xo(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new vg(new Aa(a),c,u)}function Sg(t,e){if(Dg(t=y(t)))return xg("Unsupported field value:",e,t),_g(t,e);if(t instanceof mg)return function(t,e){if(!wg(e.ca))throw e._a(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e._a(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.la&&4!==e.ca)throw e._a("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=Sg(r,e.wa(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=y(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Fc(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=Mi.fromDate(t);return{timestampValue:ju(e.serializer,n)}}if(t instanceof Mi){const n=new Mi(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:ju(e.serializer,n)}}if(t instanceof pg)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof fg)return{bytesValue:qu(e.serializer,t._byteString)};if(t instanceof rg){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e._a(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:$u(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e._a(`Unsupported field value: ${tg(t)}`)}(t,e)}function _g(t,e){const n={};return zo(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):qo(t,((t,s)=>{const r=Sg(s,e.ha(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function Dg(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Mi||t instanceof pg||t instanceof fg||t instanceof rg||t instanceof mg)}function xg(t,e,n){if(!Dg(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=tg(n);throw"an object"===s?e._a(t+" a custom object"):e._a(t+" "+s)}}function Cg(t,e,n){if((e=y(e))instanceof gg)return e._internalPath;if("string"==typeof e)return kg(t,e);throw Ng("Field path arguments must be of type string or ",t,!1,void 0,n)}const Ag=new RegExp("[~\\*/\\[\\]]");function kg(t,e,n){if(e.search(Ag)>=0)throw Ng(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new gg(...e.split("."))._internalPath}catch(s){throw Ng(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Ng(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${s}`),o&&(c+=` in document ${r}`),c+=")"),new yi(pi.INVALID_ARGUMENT,a+t+c)}function Mg(t,e){return t.some((t=>t.isEqual(e)))}class Og{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new rg(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Rg(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Lg("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Rg extends Og{data(){return super.data()}}function Lg(t,e){return"string"==typeof e?kg(t,e):e instanceof gg?e._internalPath:e._delegate._internalPath}class Pg{convertValue(t,e="none"){switch(la(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ea(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(na(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw fi()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const n={};return qo(t,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new pg(ea(t.latitude),ea(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=ra(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(ia(t));default:return null}}convertTimestamp(t){const e=ta(t);return new Mi(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Li.fromString(t);gi(fl(n));const s=new aa(n.get(1),n.get(3)),r=new Vi(n.popFirst(5));return s.isEqual(e)||li(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function Fg(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class Vg{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Bg extends Og{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Ug(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Lg("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Ug extends Bg{data(t={}){return super.data(t)}}class jg{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Vg(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Ug(this._firestore,this._userDataWriter,n.key,n,new Vg(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new yi(pi.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const s=new Ug(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Vg(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:s,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new Ug(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Vg(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:qg(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function qg(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return fi()}}class zg extends Pg{constructor(t){super(),this.firestore=t}convertBytes(t){return new fg(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new rg(this.firestore,null,e)}}function Kg(t){t=eg(t,ig);const e=eg(t.firestore,lg),n=hg(e),s=new zg(e);return function(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new yi(pi.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(t._query),Qf(n,t._query).then((n=>new jg(e,s,t,n)))}function $g(t,e,n){t=eg(t,rg);const s=eg(t.firestore,lg),r=Fg(t.converter,e,n);return Hg(s,[Tg(Ig(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,Jc.none())])}function Gg(t,e){const n=eg(t.firestore,lg),s=cg(t),r=Fg(t.converter,e);return Hg(n,[Tg(Ig(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,Jc.exists(!1))]).then((()=>s))}function Hg(t,e){return function(t,e){const n=new vi;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=Ff(t);try{const t=await function(t,e){const n=mi(t),s=Mi.now(),r=e.reduce(((t,e)=>t.add(e.key)),Oc());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=Sc(),c=Oc();return n.Zi.getEntries(t,r).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(c=c.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((r=>{i=r;const o=[];for(const t of e){const e=ru(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new au(t.key,e,ka(e.value.mapValue),Jc.exists(!0)))}return n.mutationQueue.addMutationBatch(t,s,o,e)})).next((e=>{o=e;const s=e.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(t,e.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:xc(i)})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.Tc[t.currentUser.toKey()];s||(s=new Ko(Ai)),s=s.insert(e,n),t.Tc[t.currentUser.toKey()]=s}(s,t.batchId,n),await Rf(s,t.changes),await Kd(s.remoteStore)}catch(t){const e=sf(t,"Failed to persist write");n.reject(e)}}(await function(t){return Gf(t).then((t=>t.syncEngine))}(t),e,n))),n.promise}(hg(t),e)}!function(t,e=!0){oi="9.23.0",St(new v("firestore",((t,{instanceIdentifier:n,options:s})=>{const r=t.getProvider("app").getImmediate(),i=new lg(new Ii(t.getProvider("auth-internal")),new Di(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new yi(pi.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new aa(t.options.projectId,e)}(r,n),r);return s=Object.assign({useFetchStreams:e},s),i._setSettings(s),i}),"PUBLIC").setMultipleInstances(!0)),Ct(ri,"3.13.0",t),Ct(ri,"3.13.0","esm2017")}();const Qg=function(t){const e="string"==typeof t?t:"(default)",n=function(t,e){const n=t.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),t.container.getProvider(e)}("object"==typeof t?t:function(t=wt){const e=Et.get(t);if(!e&&t===wt&&c())return xt();if(!e)throw _t.create("no-app",{appName:t});return e}(),"firestore").getImmediate({identifier:e});if(!n._initialized){const t=(t=>{const e=(t=>{var e,n;return null===(n=null===(e=a())||void 0===e?void 0:e.emulatorHosts)||void 0===n?void 0:n[t]})(t);if(!e)return;const n=e.lastIndexOf(":");if(n<=0||n+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(n+1),10);return"["===e[0]?[e.substring(1,n-1),s]:[e.substring(0,n),s]})("firestore");t&&function(t,e,n,s={}){var r;const i=(t=eg(t,sg))._getSettings(),a=`${e}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&hi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=ii.MOCK_USER;else{e=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=e||"demo-project",s=t.iat||0,r=t.sub||t.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:s,exp:s+3600,auth_time:s,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},t);return[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new yi(pi.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new ii(i)}t._authCredentials=new Ei(new wi(e,n))}}(n,...t)}return n}(xt({apiKey:"AIzaSyCg7xzeSJO7BtZgmetFzLHfRruhcDDISBI",authDomain:"budget-calculator-13b20.firebaseapp.com",projectId:"budget-calculator-13b20",storageBucket:"budget-calculator-13b20.firebasestorage.app",messagingSenderId:"913412660495",appId:"1:913412660495:web:cde3287ddd79827db0327a",measurementId:"G-Z2MR16FYB4"}));(function(t){!function(t){if(t._initialized||t._terminated)throw new yi(pi.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}(t=eg(t,lg));const e=hg(t);if(e._uninitializedComponentsProvider)throw new yi(pi.FAILED_PRECONDITION,"SDK cache is already specified.");hi("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),s=new Uf;return function(t,e,n){const s=new vi;return t.asyncQueue.enqueue((async()=>{try{await zf(t,n),await Kf(t,e),s.resolve()}catch(t){const e=t;if(!$f(e))throw e;hi("Error enabling indexeddb cache. Falling back to memory cache: "+e),s.reject(e)}})).then((()=>s.promise))}(e,s,new Bf(s,n.cacheSizeBytes,void 0))})(Qg).catch((t=>{"failed-precondition"===t.code?console.error("Persistence failed (multiple tabs open):",t):"unimplemented"===t.code&&console.error("Persistence is not available:",t)}))},212:(t,e,n)=>{function s(){this.expenses=[],this.monthlyGoals={}}n.d(e,{A:()=>r}),s.prototype.addExpense=function(t,e,n,s,r,i=!1){this.expenses.push({person:t.toUpperCase(),description:e,category:n,amount:parseFloat(s),date:r,pending:i})},s.prototype.setMonthlyGoal=function(t,e){this.monthlyGoals[t.toUpperCase()]=parseFloat(e)},s.prototype.calculateTotal=function(){return this.expenses.reduce(((t,e)=>t+e.amount),0)},s.prototype.getExpenses=function(){return this.expenses},s.prototype.clearExpenses=function(){this.expenses=[]},s.prototype.calculateMonthlyTotals=function(t,e){const n={},s=new Date(e,t-1,1),r=new Date(e,t,0);return this.expenses.forEach((t=>{const e=new Date(t.date+"T00:00");e>=s&&e<=r&&(n[t.person]=(n[t.person]||0)+t.amount)})),n};const r=s}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var n=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(t,e)=>{for(var n in e)__webpack_require__.o(e,n)&&!__webpack_require__.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var __webpack_exports__={},_budgetCalculator_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(212),_firebase_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(94);document.addEventListener("DOMContentLoaded",(()=>{const expenseForm=document.getElementById("expense-form"),expenseList=document.getElementById("expense-list"),totalDisplay=document.getElementById("total-display"),individualTotalsContainer=document.getElementById("Year-to-Date-Total"),calculator=new _budgetCalculator_js__WEBPACK_IMPORTED_MODULE_0__.A;async function loadExpenses(){try{(await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.GG)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"))).forEach((t=>{const e=t.data();calculator.addExpense(e.person,e.name,e.category,e.amount,e.date)})),updateExpenseList(),updateTotal(),updateIndividualTotals(),updateMonthlyTotals()}catch(t){console.error("Error loading expenses:",t)}}async function loadMonthlyGoals(){try{(await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.GG)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"monthlyGoals"))).forEach((t=>{const e=t.data();calculator.monthlyGoals[e.person]=parseFloat(e.goal)})),updateMonthlyTotals()}catch(t){console.error("Error loading monthly goals:",t)}}function updateExpenseList(){const t=calculator.getExpenses();expenseList.innerHTML="",t.forEach((t=>{const e=document.createElement("li");let n=t.description?` (${t.description})`:"";e.textContent=`${t.person} spent $${t.amount.toFixed(2)} on ${t.category}${n} on ${t.date}`,e.textContent+=t.pending?" - Pending":"",e.style.color=t.pending?"orange":"green",expenseList.appendChild(e)}))}function updateTotal(){const t=calculator.calculateTotal();totalDisplay.textContent=`HouseHold Total: $${t.toFixed(2)}`}function updateIndividualTotals(){const t=calculator.getExpenses(),e={};t.forEach((t=>{e[t.person]=(e[t.person]||0)+t.amount})),individualTotalsContainer.innerHTML="<h3>Year to Date Individual Totals:</h3>",Object.entries(e).forEach((([t,e])=>{const n=document.createElement("p");n.textContent=`${t}: $${e.toFixed(2)}`,individualTotalsContainer.appendChild(n)}))}function updateMonthlyTotals(){const t=new Date,e=t.getMonth()+1,n=t.getFullYear(),s=new Date(n,e-1,1),r=new Date(n,e,0),i={year:"numeric",month:"2-digit",day:"2-digit"},o=s.toLocaleDateString(void 0,i),a=r.toLocaleDateString(void 0,i),c=calculator.calculateMonthlyTotals(e,n),u=document.getElementById("monthly-totals");u.innerHTML=`<h3>Monthly Totals (from ${o} to ${a}):</h3>`,Object.entries(c).forEach((([t,e])=>{const n=calculator.monthlyGoals[t]||0;let s=`${t}: $${e.toFixed(2)}`;n&&(s+=` (Goal: $${n.toFixed(2)})`,e>=n&&(s+=" - Warning: Exceeds monthly goal!"));const r=document.createElement("p");r.textContent=s,u.appendChild(r)}))}loadExpenses(),loadMonthlyGoals(),expenseForm.addEventListener("submit",(t=>{t.preventDefault();const e=new FormData(expenseForm),n=e.get("person"),s=e.get("name"),r=e.get("category"),i=parseFloat(e.get("amount")),o=e.get("expense-date")||(new Date).toISOString().slice(0,10);if(!n||!r||isNaN(i)||!o)return void console.error("Invalid input:",{person:n,name:s,category:r,amount:i,expenseDate:o});const a={person:n.toUpperCase(),name:s,category:r,amount:i,date:o};calculator.addExpense(a.person,a.name,a.category,a.amount,a.date,!0),updateExpenseList(),updateTotal(),updateIndividualTotals(),updateMonthlyTotals(),expenseForm.reset(),(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.gS)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"),{person:n,name:s,category:r,amount:i,date:o,timestamp:new Date}).then((t=>{console.log("Expense added to Firebase",t.id)})).catch((t=>{console.error("Error adding expense to Firebase:",t)}))}));const amountInput=document.getElementById("amount"),calcModal=document.getElementById("calc-modal"),calcDisplay=document.getElementById("calc-display"),calcButtons=document.querySelectorAll(".calc-buttons button"),calcClear=document.getElementById("calc-clear"),calcEquals=document.getElementById("calc-equals"),calcDelete=document.getElementById("calc-delete");amountInput.addEventListener("click",(t=>{t.stopPropagation(),calcModal.style.display="block",calcDisplay.textContent=""})),document.addEventListener("click",(t=>{t.target===amountInput||calcModal.contains(t.target)||(calcModal.style.display="none")})),calcButtons.forEach((t=>{t.addEventListener("click",(()=>{const e=t.getAttribute("data-value");e&&(calcDisplay.textContent+=e)}))})),calcClear.addEventListener("click",(()=>{calcDisplay.textContent=""})),calcEquals.addEventListener("click",(()=>{try{const result=eval(calcDisplay.textContent);amountInput.value=result,calcModal.style.display="none"}catch(t){calcDisplay.textContent="Error"}})),calcDelete.addEventListener("click",(()=>{calcDisplay.textContent=calcDisplay.textContent.slice(0,-1)}));const monthlyGoalForm=document.getElementById("monthly-goal-form");function updateExpenseListFromSnapshot(t){expenseList.innerHTML="",t.forEach((t=>{const e=t.data(),n=t.metadata.hasPendingWrites,s=document.createElement("li");s.textContent=`${e.person} spent $${e.amount.toFixed(2)} on ${e.category} on ${e.date}`,s.textContent+=n?" - Pending":" - Added Successfully",s.style.color=n?"orange":"green",expenseList.appendChild(s)}))}monthlyGoalForm.addEventListener("submit",(async t=>{t.preventDefault();const e=t.target.elements["goal-person"].value,n=parseFloat(t.target.elements["goal-amount"].value);if(e&&!isNaN(n))try{const t=(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.H9)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"monthlyGoals",e.toUpperCase());await(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.BN)(t,{person:e.toUpperCase(),goal:n}),calculator.setMonthlyGoal(e,n),updateMonthlyTotals()}catch(t){console.error("Error setting monthly goal:",t)}monthlyGoalForm.reset()})),(0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.onSnapshot)((0,_firebase_js__WEBPACK_IMPORTED_MODULE_1__.rJ)(_firebase_js__WEBPACK_IMPORTED_MODULE_1__.db,"expenses"),{includeMetadataChanges:!0},(t=>{updateExpenseListFromSnapshot(t)}))}))})();